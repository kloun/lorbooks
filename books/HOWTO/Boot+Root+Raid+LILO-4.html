<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE>Мини HOWTO:Boot + Root + Raid + Lilo : Программный Raid: Переход с не-raid на RAID1/4/5</TITLE>
 <LINK HREF="Boot+Root+Raid+LILO-5.html" REL=next>
 <LINK HREF="Boot+Root+Raid+LILO-3.html" REL=previous>
 <LINK HREF="Boot+Root+Raid+LILO.html#toc4" REL=contents>
</HEAD>
<BODY>
<A HREF="Boot+Root+Raid+LILO-5.html">Next</A>
<A HREF="Boot+Root+Raid+LILO-3.html">Previous</A>
<A HREF="Boot+Root+Raid+LILO.html#toc4">Contents</A>
<HR>
<H2><A NAME="s4">4. Переход с не-raid на RAID1/4/5</A></H2>

<P>Переход с не-raid системы к raid достаточно прост, и состоит из нескольких последовательных шагов, приведенных ниже. Описание приведено для системы с загрузочным, корневым и swap-разделами.
<PRE>
СТАРЫЙ диск в существующей системе:

    /dev/hda1     загрузочный, возможно dos+loadlin или lilo
    /dev/hda2     корневой
    /dev/hda3     swap
</PRE>

Мы добавим дополнительный диск и преобразуем систему в RAID1. Вы можете легко добавить несколько дисков и сделать RAID5-массив, при помощи подобной процедуры.
<P>
<H2><A NAME="ss4.1">4.1 Шаг 1 - готовим новое ядро</A>
</H2>

<P>Скачайте новое чистое ядро, утилиты raidtools-0.90 (или более новую
версию), и патч к ядру, для поддержки raid версии 0.90.
<P>Соберите и установите raidtools и ПРОЧИТАЙТЕ документацию.
<P>Соберите и установите ядро с поддержкой тех видов (0/1/4/5 ?) raid, которые вы будете использовать. Убедитесь в том, что разрешили автозапуск raid-устройств в конфигурации ядра. Удостоверьтесь в том, что ядро нормально загружается и изучите файл /proc/mdstat, чтобы еще раз убедиться в том, что необходимые вам виды raid поддерживаются ядром.
<P>
<H2><A NAME="ss4.2">4.2 Шаг 2 - настраиваем raidtab для вашего нового raid-а.</A>
</H2>

<P>Новый диск будет добавлен на второй IDE-контроллер как главное устройство, поэтому станет /dev/hdc
<P>
<PRE>
    /dev/hdc1     16 Мб -- более чем достаточно для нескольких ядер
    /dev/hdc2     большая часть диска
    /dev/hdc3     еще немного swap-пространства, если необходимо. Если нет, увеличьте /dev/hdc2
</PRE>
<P>Измените виды разделов /dev/hdc1 и /dev/hdc2 на вид "fd" для автозапуска raid.
<P>Используя параметр <B>failed-disk</B>, создайте raidtab для необходимой конфигурации RAID1. Этот параметр (failed disk) должен быть последним в таблице.
<P>
<PRE>
# пример raidtab
# md0 - это корневой массив
raiddev                 /dev/md0
raid-level              1
nr-raid-disks           2
chunk-size              32
# Свободные диски для реконструкции данных "на-ходу"
nr-spare-disks          0
persistent-superblock   1
device                  /dev/hdc2
raid-disk               0
# это наш старый диск, временно пометим его как отказавший
device                  /dev/hda2
failed-disk             1

# md1 - это загрузочный /boot массив
raiddev                 /dev/md1
raid-level              1
nr-raid-disks           2
chunk-size              32
# Свободные диски для реконструкции данных "на-ходу"
nr-spare-disks          0
persistent-superblock   1
device                  /dev/hdc1
raid-disk               0
# boot также пометим сломанным
device                  /dev/hda1
failed-disk               1
</PRE>
<P>
<H2><A NAME="ss4.3">4.3 Создаем, форматируем и настраиваем RAID</A>
</H2>

<P>Создайте md-устройства следующими командами:
<PRE>
    mkraid /dev/md0
    mkraid /dev/md1
</PRE>
<P>Raid-устройства должны быть созданы, и запущены. Изучите /proc/mdstat, там должны быть указаны виды raid-устройств, поддерживаемые ядром, а также список работающих raid-устройств.
<P>Отформатируйте загрузочное и корневое устройства  командами:
<PRE>
    mke2fs /dev/md0
    mke2fs /dev/md1
</PRE>

Подключите новое корневое устройство туда, куда удобно, создайте в нем каталог /boot и подключите туда загрузочный раздел:
<P>
<PRE>
    mount /dev/md0 /mnt
    mkdir /mnt/boot
    mount /dev/md1 /mnt/boot
</PRE>
<P>
<H2><A NAME="ss4.4">4.4 Копируем текущую ОС на новое raid-устройство</A>
</H2>

<P>Это достаточно просто и понятно.
<PRE>
    cd /
    # настройте скрипт для того чтобы это сделать
    cp -a /bin /mnt
    cp -a /dev /mnt
    cp -a /etc /mnt
    cp -a (все каталоги кроме /mnt, /proc, и сетевых дисков) /mnt
</PRE>

Процедура может усложниться, если вы подключили или сделали ссылки
на другие диски к вашей корневой файловой системе. Пример, приведенный выше,
предполагает простую систему, вам, возможно, придется немного изменить
процедуру копирования.
<P>
<H2><A NAME="ss4.5">4.5 Проверяем ваш новый RAID</A>
</H2>

<P>Создайте загрузочный флоппи и запустите команду rdev для ядра.
<P>
<PRE>
    dd if=kernal.image of=/dev/fd0 bs=2k
    rdev /dev/fd0 /dev/md0
    rdev -r /dev/fd0 0
    rdev -R /dev/fd0 1
</PRE>
<P>Измените файл fstab на RAID-устройстве для отражения новых точек подключения, как указано ниже:
<PRE>
  /dev/md0        /       ext2    defaults        1 1
  /dev/md1        /boot   ext2    defaults        1 1
</PRE>
<P>Отключите raid-устройства и перезагрузите систему, чтобы убедиться в том, что все работает правильно.
<P>
<PRE>
    umount /mnt/boot
    umount /mnt
    raidstop /dev/md0
    raidstop /dev/md1
    shutdown -r now
</PRE>
<P>Ваша RAID-система должна загрузиться и  работать в сокращенном (degraded) режиме с загрузочным флоппи-диском. Аккуратно проверьте, что вы скопировали ВСЕ на вашу новую raid-систему. Если вы что-то на этом этапе напутаете без сохранения резервной копии, ВАМ БУДЕТ НЕСЛАДКО!
<P>Если что-то не заработало, перезагрузите вашу старую систему, вернитесь и исправьте все, пока все не будет нормально.
<P>
<H2><A NAME="ss4.6">4.6 Интегрируем старый диск в raid-массив</A>
</H2>

<P>Удачное завершение процедур предыдущего пункта означает, что raid-массив работает, но пока без излишеств. Теперь надо переделать разделы старого диска (дисков) для того, чтобы добавить его в raid-массив. Запомните, если геометрии дисков разные, то размер раздела на старом диске должен быть равен или больше размеров raid-разделов, а иначе их нельзя будет добавить в raid-массив.
<P>Переделайте нужным образом разделы на старом диске, например:
<PRE>
    /dev/hda1     равен или больше /dev/hdc1
    /dev/hda2     равен или больше /dev/hdc2
    /dev/hda3     нечто, оставшееся под swap или что-то еще...
</PRE>
<P>Смените параметр <B>failed-disk</B> в raidtab на <B>raid-disk</B> и добавьте новые (старые) разделы к raid-массиву, что называется "на ходу" (hot add).
<PRE>
    raidhotadd /dev/md1 /dev/hda1
    raidhotadd /dev/md0 /dev/hda2
</PRE>

В файле /proc/mdstat должны теперь появиться одно или более raid-устройств, перестраивающих данные для новых разделов. Через минуту или две...или несколько, raid-массивы должны быть полностью синхронизированы (эта процедура может занять длительное время для больших разделов).
<P>
<P>Использование вышеописанной процедуры настроит загружаемый raid на новой
raid-паре. Пользуйтесь загрузочным флоппи-диском, пока настраиваете
и тестируете последний шаг.
<P>
<HR>
<A HREF="Boot+Root+Raid+LILO-5.html">Next</A>
<A HREF="Boot+Root+Raid+LILO-3.html">Previous</A>
<A HREF="Boot+Root+Raid+LILO.html#toc4">Contents</A>
</BODY>
</HTML>
