<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE>NFS HOWTO: Настройка клиента NFS</TITLE>
 <LINK HREF="NFS-HOWTO-5.html" REL=next>
 <LINK HREF="NFS-HOWTO-3.html" REL=previous>
 <LINK HREF="NFS-HOWTO.html#toc4" REL=contents>
</HEAD>
<BODY>
<A HREF="NFS-HOWTO-5.html">Следующий</A>
<A HREF="NFS-HOWTO-3.html">Предыдущий</A>
<A HREF="NFS-HOWTO.html#toc4">Содержание</A>
<HR>
<H2><A NAME="nfs-client"></A> <A NAME="s4">4. Настройка клиента NFS</A></H2>

<P>Первым делом вам нужно ядро с поддержкой файловой системы NFS, либо
вкомпилированной в ядро, либо доступной как модуль. Это настраивается до
компиляции ядра. Если вы никогда не компилировали ядро, то вам может быть
нужно прочитать Rernel HOWTO и выяснить как это делается. Если вы
используете хороший дистрибутив (такой как RedHat) и вы никогда не
экспериментировали с ядром или модулями (и таким образом разрушали его ;-),
то вероятно, что поддержка nfs уже есть в ядре.
<P>
<P>Теперь вы можете, в командной строке администратора, ввести
соответствующую команду монтирования и файловая система появится у
вас. Продолжая пример из предыдущего раздела мы хотим смонтировать 
<CODE>/mn/eris/local</CODE> с машины eris. Это делается с помощью такой
команды:
<P>
<HR>
<PRE>
mount -o rsize=1024,wsize=1024 eris:/mn/eris/local /mnt
</PRE>
<HR>
<P>
<P>(Мы еще вернемся к опциям rsize и wsize). Файловая система сейчас
доступна в <CODE>/mnt</CODE> и вы можете перейти туда и выполнить в ней команду
<CODE>ls</CODE>, и посмотреть на индивидуальные файлы. Вы заметите, что эта
операция выполняется не так быстро как над локальной файловой системой, но
более удобно чем ftp. Если вместо монтирования файловой системы команда
mount выдаст сообщение об ошибке <CODE>mount: eris:/mn/eris/local failed,
reason given by server: Permission denied</CODE>, то файл exports является
неправильным или вы забыли запустить exportfs после редактирования файла
exports. Если команда сообщит <CODE>mount clntudp_create: RPC: Program not
registered</CODE> это означает, что nfsd или mountd не запущены на
сервере. Или у вас проблема с <CODE>hosts.{allow,deny}</CODE>, о которой упомянуто
выше.
<P>
<P>Чтобы прекратить пользоваться файловой системы вы можете выполнить:
<P>
<HR>
<PRE>
umount /mnt
</PRE>
<HR>
<P>
<P>Чтобы выполнялось автоматическое монтирование файловой системы nfs при
загрузке, вам необходимо отредактировать файл <CODE>/etc/fstab</CODE> как
обычно это делается. Для нашего примера требуется такая строка:
<P>
<HR>
<PRE>
# device      mountpoint     fs-type     options              dump fsckorder
...
eris:/mn/eris/local  /mnt    nfs        rsize=1024,wsize=1024 0    0
...
</PRE>
<HR>
<P>
<P>Это почти все, что необходимо. Читайте пожалуйста дальше.
<P>
<H2><A NAME="ss4.1">4.1 Опции монтирования</A>
</H2>

<P>Здесь перечислены некоторые опции, которые вы должны рассмотреть сразу,
добавляя их в файл настроек. Они управляют способом, которым клиент NFS
отрабатывает прекращение работы сервера или отключение сети. Одно из
свойств NFS в том, что он может изящно обрабатывать эти неполадки, если вы
правильно установите клиента. Существует два различающихся режима обработки
ошибок:
<P>
<DL>
<DT><B>soft</B><DD><P>NFS клиент будет сообщать об ошибке программе,
которая пытается получить доступ к файлу расположенному на файловой
системе, смонтированной через NFS. Некоторые программы довольно хорошо
обрабатыают такого рода ошибки, но большинство программ не делают
это. Я не рекомендую использование этой опции, она может привести к
появлению испорченных файлов и потерянных данных. Вы особенно не должны 
использовать эту опцию для дисков, используемых для почты, если ваша
почта что-то значит для вас.
<P>
<DT><B>hard</B><DD><P>Программа осуществляющая доступ к файлу на смонтированной по NFS 
файловой системе просто приостановит выполнение при разрыве связи с
сервером. Процесс не может быть прерван или убит до тех пор, пока вы
явно не укажите опцию <CODE>intr</CODE>. Когда сервер NFS будет запущен заново,
то программа продолжит безмятежно продолжать работу с прерванного
места. Это скорее всего то, что вам нужно. Я рекомендую использовать
опции <CODE>hard,intr</CODE> на всех файловых системах смонтированных через
NFS.
<P>
</DL>
<P>
<P>Продолжая предыдущий пример, теперь в нашем файле fstab запись будет
выглядеть так:
<P>
<HR>
<PRE>
# device      mountpoint     fs-type    options                  dump fsckorder
...
eris:/mn/eris/local  /mnt    nfs        rsize=1024,wsize=1024,hard,intr 0 0
...
</PRE>
<HR>
<P>
<P>
<H2><A NAME="optimizing"></A> <A NAME="ss4.2">4.2 Оптимизация NFS</A>
</H2>

<P>Обычно, если не заданы опции rsize и wsize, то NFS будет читать и писать
блоками по 4096 или по 8192 байтов. Некоторые комбинации ядер Linux и
сетевых карт не могут обрабатывать такие большие блоки, и это может быть
не оптимально. Так что нам нужно поэкспериментировать и найти значения rsize
и wsize, которые работают так быстр,о насколько это возможно. Вы можете
протестировать скорость передачи при заданных опциях при помощи нескольких
простых команд. Выполнив вышеприведенную команду монтирования и получив
доступ с правом записи на диск, вы можете выполнить тестирование
производительности последовательной записи:
<P>
<HR>
<PRE>
time dd if=/dev/zero of=/mnt/testfile bs=16k count=4096
</PRE>
<HR>
<P>
<P>Эта команда создает 64Mb файл, заполненный нулевыми значениями (этот
файл должен быть достаточно большим, настолько большим, чтобы кэширование
не сыграло значительную роль в производительности, используйте больший
размер файла, если у вас достаточно много памяти). Проделайте эту операцию
несколько раз (5-10?) и усредните полученные результаты. Полученная
величина&nbsp;-- это время `прохода', т.е. величина наиболее интересующая
нас в этом эксперименте. Затем вы можете измерить производительность
чтения, прочитав файл обратно на свою машину:
<P>
<HR>
<PRE>
time dd if=/mnt/testfile of=/dev/null bs=16k
</PRE>
<HR>
<P>выполните эту операцию несколько раз и усредните результат. Затем
отмонтируйте файловую систему и примонтируйте ее заново, с увеличенными
значениями rsize и wsize. Вероятно они должны быть кратными 1024, и не
больше чем 16384 байтов, поскольку это максимальный размер блока данных в
NFS версии 2. Прямо после монтирования с увеличенными значениями перейдите
в смонтированную файловую систему и выполните команду подобную ls,
исследуйте файловую систему, чтобы убедиться, что все в норме. Если
значения rsize/wsize слишком большие, то симптомы <EM>очень</EM> необычные и не
на 100% очевидные. Типичный симптом выражается в неполном списке файлов при
выполнении команды 'ls', и отсутствие сообщений об ошибках. Или чтение
файлов загадочно срывается без сообщения об ошибке. После того, как вы
установите, что заданные значения rsize/wsize работают, вы можете далее
продолжать тестировать производительность. Различные серверные платформы
вероятно имеют различные оптимальные размеры блоков. SunOS и Solaris по
общему мнению, работают довольно быстрее при размере блока равном 4096
байт, чем при других значениях.
<P>
<P>Новые ядра Linux (с версии 1.3) выполняют предваряющее чтение для
значений rsize больших или равных размеру страницы машины. На процессорах
Intel размер страницы равен 4096 байтам. Предваряющее чтение
<EM>значительно</EM> увеличивает производительность NFS при чтении. Так что на
машинах с процессором Intel вы можете захотеть использовать значение rsize
равное 4096 байтам.
<P>
<P>Помните, что вам нужно отредактировать <CODE>/etc/fstab</CODE> для
использования найденных значений rsize/wsize.
<P>
<P>Прием для увеличения производительности NFS при записи заключается в
запрещении синхронной записи на сервер. Спецификация NFS требует, чтобы
запросы NFS на запись не считались законченными до записи данных на
носитель (обычно диск). Это ограничивает производительность записи, а
асинхронная запись значительно увеличит скорость записи по NFS. Демон nfsd
для Linux никогда не делает синхронную запись, поскольку реализация
файловой системы Linux сама не дает сделать это, но серверах работающих на
отличных от Linux системах вы можете увеличить производительность этим
способом, поместив в ваш файл exports:
<P>
<HR>
<PRE>
/dir    -async,access=linuxbox
</PRE>
<HR>
<P>
<P>или что-то подобное. Пожалуйста посмотрите справочную страницу exports
на данной машине. Также запомните, что это увеличивает риск потери данных.
<P>
<HR>
<A HREF="NFS-HOWTO-5.html">Следующий</A>
<A HREF="NFS-HOWTO-3.html">Предыдущий</A>
<A HREF="NFS-HOWTO.html#toc4">Содержание</A>
</BODY>
</HTML>
