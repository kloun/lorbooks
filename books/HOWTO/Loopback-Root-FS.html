<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML
><HEAD
><TITLE
>Мини-HOWTO: Зацикленная корневая файловая система</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.57"></HEAD
><BODY
CLASS="ARTICLE"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="ARTICLE"
><DIV
CLASS="TITLEPAGE"
><H1
CLASS="TITLE"
><A
NAME="AEN2"
>Мини-HOWTO: Зацикленная корневая файловая система</A
></H1
><DIV
CLASS="AUTHORGROUP"
><A
NAME="AEN4"
></A
><H3
CLASS="AUTHOR"
><A
NAME="AEN5"
>Andrew Bishop</A
></H3
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
>amb@gedanken.demon.co.uk</P
></DIV
></DIV
><H3
CLASS="CORPAUTHOR"
> Перевод: <A
HREF="mailto:sam@asp-linux.com"
TARGET="_top"
>Станислав Рогин</A
>,
 <A
HREF="http://www.asplinux.com"
TARGET="_top"
>SWSoft Pte Ltd.</A
>
 </H3
></DIV
><P
CLASS="PUBDATE"
>Версия 1.1, 24 сентября 1999<BR></P
><DIV
><DIV
CLASS="ABSTRACT"
><A
NAME="AEN15"
></A
><P
></P
><P
>Этот HOWTO объясняет, как использовать зацикленное (loopback) устройство
Linux, чтобы создать файловую систему Linux, которая может запускаться из
DOS-раздела без изменения системы разделов. Другое применение этой
техники также обсуждается в этом документе.</P
><P
></P
></DIV
></DIV
><HR></DIV
><DIV
CLASS="TOC"
><DL
><DT
><B
>Содержание</B
></DT
><DT
>1. <A
HREF="Loopback-Root-FS.html#AEN17"
>Введение</A
></DT
><DD
><DL
><DT
>1.1. <A
HREF="Loopback-Root-FS.html#AEN19"
>Copyright</A
></DT
><DT
>1.2. <A
HREF="Loopback-Root-FS.html#AEN26"
>Авторские права</A
></DT
><DT
>1.3. <A
HREF="Loopback-Root-FS.html#AEN35"
>История изменений документа</A
></DT
></DL
></DD
><DT
>2. <A
HREF="Loopback-Root-FS.html#AEN51"
>Общие принципы зацикленных устройств и электронных дисков (Ramdisks)</A
></DT
><DD
><DL
><DT
>2.1. <A
HREF="Loopback-Root-FS.html#AEN54"
>Зацикленные устройства</A
></DT
><DT
>2.2. <A
HREF="Loopback-Root-FS.html#AEN66"
>Электронные диски</A
></DT
><DT
>2.3. <A
HREF="Loopback-Root-FS.html#AEN75"
>Загрузочный электронный диск</A
></DT
><DT
>2.4. <A
HREF="Loopback-Root-FS.html#AEN84"
>Корневая файловая система</A
></DT
><DT
>2.5. <A
HREF="Loopback-Root-FS.html#AEN94"
>Последовательность загрузки Linux</A
></DT
></DL
></DD
><DT
>3. <A
HREF="Loopback-Root-FS.html#AEN120"
>Как создать зацикленное корневое устройство</A
></DT
><DD
><DL
><DT
>3.1. <A
HREF="Loopback-Root-FS.html#AEN123"
>Требования</A
></DT
><DT
>3.2. <A
HREF="Loopback-Root-FS.html#AEN146"
>Создаем ядро Linux</A
></DT
><DT
>3.3. <A
HREF="Loopback-Root-FS.html#AEN196"
>Создаем загрузочный электронный диск</A
></DT
><DT
>3.4. <A
HREF="Loopback-Root-FS.html#AEN277"
>Создаем корневое устройство</A
></DT
><DT
>3.5. <A
HREF="Loopback-Root-FS.html#AEN298"
>Создаем Swap-устройство</A
></DT
><DT
>3.6. <A
HREF="Loopback-Root-FS.html#AEN304"
>Создаем каталог MSDOS</A
></DT
><DT
>3.7. <A
HREF="Loopback-Root-FS.html#AEN317"
>Создаем загрузочный флоппи-диск</A
></DT
></DL
></DD
><DT
>4. <A
HREF="Loopback-Root-FS.html#AEN345"
>Загрузка системы</A
></DT
><DD
><DL
><DT
>4.1. <A
HREF="Loopback-Root-FS.html#AEN370"
>Возможные проблемы и их решение</A
></DT
><DT
>4.2. <A
HREF="Loopback-Root-FS.html#AEN390"
>Ссылки на другие документы</A
></DT
></DL
></DD
><DT
>5. <A
HREF="Loopback-Root-FS.html#AEN408"
>Другие возможности зацикленных корневых устройств</A
></DT
><DD
><DL
><DT
>5.1. <A
HREF="Loopback-Root-FS.html#AEN411"
>Установка на DOS-жесткий-диск</A
></DT
><DT
>5.2. <A
HREF="Loopback-Root-FS.html#AEN417"
>Установка с загрузкой при помощи LILO</A
></DT
><DT
>5.3. <A
HREF="Loopback-Root-FS.html#AEN426"
>Установка на VFAT / NTFS</A
></DT
><DT
>5.4. <A
HREF="Loopback-Root-FS.html#AEN433"
>Установка Linux без изменения разделов</A
></DT
><DT
>5.5. <A
HREF="Loopback-Root-FS.html#AEN438"
>Загрузка с незагружаемого (Non-bootable) устройства</A
></DT
></DL
></DD
></DL
></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="AEN17"
>1. Введение</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN19"
>1.1. Copyright</A
></H2
><P
>The Loopback Root Filesystem HOWTO
Copyright (C) 1998,99  Andrew M. Bishop (amb@gedanken.demon.co.uk).</P
><P
>This documentation is free documentation; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or
(at your option) any later version.</P
><P
>This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.</P
><P
>The GNU General Public License is available from <A
HREF="http://www.fsf.org/"
TARGET="_top"
>http://www.fsf.org/</A
>
or, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111 USA</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN26"
>1.2. Авторские права</A
></H2
><P
>Авторские права на русский перевод этого текста принадлежат &copy; 2000 SWSoft Pte Ltd.
Все права зарезервированы.</P
><P
>Этот документ является частью проекта Linux HOWTO.</P
><P
>Авторские права на документы Linux HOWTO принадлежат их авторам, если явно
не указано иное. Документы Linux HOWTO, а также их переводы, могут
быть воспроизведены и распространены полностью или частично на любом
носителе, физическом или электронном, при условии сохранения этой заметки об
авторских правах на всех копиях. Коммерческое распространение разрешается и
поощряется; но, так или иначе, автор текста и автор перевода желали бы знать о
таких дистрибутивах.</P
><P
>Все переводы и производные работы, выполненные по документам Linux HOWTO
должны сопровождаться этой заметкой об авторских правах. Это делается в
целях предотвращения случаев наложения дополнительных ограничений на
распространение документов HOWTO. Исключения могут составить случаи
получения специального разрешения у координатора Linux HOWTO, с которым
можно связаться по адресу приведенному ниже.</P
><P
>Мы бы хотели распространить эту информацию по всем возможным каналам. Но
при этом сохранить авторские права и быть уведомленными о всех планах
распространения HOWTO. Если у вас возникли вопросы, пожалуйста, обратитесь
к координатору проекта Linux HOWTO по электронной почте:
<TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:linux-howto@metalab.unc.edu"
>linux-howto@metalab.unc.edu</A
>&#62;</TT
>, или к координатору русского
перевода Linux HOWTO компании SWSoft Pte Ltd. по адресу
<TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:linux-howto@asplinux.ru"
>linux-howto@asplinux.ru</A
>&#62;</TT
></P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN35"
>1.3. История изменений документа</A
></H2
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Версия 1.0.0</DT
><DD
><P
>Первоначальная версия (Июнь 1998)</P
></DD
><DT
>Версия 1.0.1-1.0.3</DT
><DD
><P
>Небольшие изменения, подправки версий ядра, опечаток и т.п. (1998 - Июль 1999)</P
></DD
><DT
>Версия 1.1</DT
><DD
><P
>Добавлена информация о Copyright (Сентябрь 1999)</P
></DD
></DL
></DIV
></P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN51"
>2. Общие принципы зацикленных устройств и электронных дисков (Ramdisks)</A
></H1
><P
>Сначала я опишу некоторые общие принципы, используемые при настройке зацикленной файловой системы в качестве корневого устройства.</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN54"
>2.1. Зацикленные устройства</A
></H2
><P
><I
CLASS="EMPHASIS"
>Зацикленное (loopback) устройство</I
> Linux - это виртуальное устройство, которое можно использовать так же, как и любой другой носитель информации.</P
><P
>Обычные носители информации - это, например, разделы жесткого диска
<TT
CLASS="LITERAL"
>/dev/hda1</TT
>, <TT
CLASS="LITERAL"
>/dev/hda2</TT
>, <TT
CLASS="LITERAL"
>/dev/sda1</TT
>
или полностью диски, как, например, флоппи-диск <TT
CLASS="LITERAL"
>/dev/fd0</TT
> и т.п. Все эти устройства могут содержать в
себе файлы и структуры каталогов. Они могут быть отформатированы в формате
необходимой файловой системы (ext2fs, msdos, ntfs и т.п.) и затем
подключены (mount).</P
><P
>Зацикленная файловая система представляет файл на другой файловой системе
как полноценное устройство. Она может быть отформатирована и подключена
так же, как и любое другое устройство, описанное выше. Чтобы сделать это,
устройства под названиями <TT
CLASS="LITERAL"
>/dev/loop0</TT
>,
<TT
CLASS="LITERAL"
>/dev/loop1</TT
> и т.п. сопоставляются с файлами, и
затем может быть подключено новое виртуальное устройство.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN66"
>2.2. Электронные диски</A
></H2
><P
>В Linux также может использоваться другой тип виртуального устройства, подключаемый как файловая система, под названием <I
CLASS="EMPHASIS"
>электронный диск</I
>.</P
><P
>В этом случае, устройство ссылается не на какое-то физическое устройство, а
на часть оперативной памяти, выделенной для этой цели. Эта память
никогда не сбрасывается в swap на диск, но остается в дисковом кэше.</P
><P
>Электронный диск может быть создан в любой момент путем записи в устройство
электронного диска <TT
CLASS="LITERAL"
>/dev/ram0</TT
>, <TT
CLASS="LITERAL"
>/dev/ram1</TT
> и т.п. Затем его можно отформатировать и
подключить так же, как и зацикленное устройство.</P
><P
>Когда электронный диск используется при загрузке (что часто применяется на инсталляционных дисках Linux или дисках аварийного восстановления), тогда образ диска (полное содержимое диска в виде отдельного файла) может содержаться на загрузочном флоппи-диске в закомпрессированной форме. Эта ситуация  автоматически  распознается ядром, когда оно загружается, и этот образ разжимается в электронный диск перед его подключением.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN75"
>2.3. Загрузочный электронный диск</A
></H2
><P
><I
CLASS="EMPHASIS"
>Загрузочный электронный диск</I
> Linux - еще один важный механизм, который нам понадобится при использовании зацикленного устройства в качестве корневой файловой системы.</P
><P
>Когда используется загрузочный электронный диск, образ файловой системы
загружается в память и подключается для того, чтобы файлы на нем были
доступны. Затем запускается программа на этом диске (файл под именем
<TT
CLASS="LITERAL"
>/linuxrc</TT
>), и, когда она заканчивает работу,
другое устройство подключается в виде корневой файловой системы. Старый
электронный диск также остается доступен и подключен к каталогу <TT
CLASS="LITERAL"
>/initrd</TT
>, если такой каталог присутствует, или может
использоваться через  устройство <TT
CLASS="LITERAL"
>/dev/initrd</TT
>.</P
><P
>Такая необычная процедура необходима потому, что при обычной загрузке система начинает и продолжает загрузку с корневой файловой системы. С загрузочным электронным диском корневая файловая система может быть изменена до начала основной последовательности загрузки Linux.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN84"
>2.4. Корневая файловая система</A
></H2
><P
>Корневая файловая система - это устройство, которое подключается первым, поэтому бывает представлено в виде каталога <TT
CLASS="LITERAL"
>/</TT
> после загрузки.</P
><P
>Существует некоторое количество проблем с корневой файловой системой
благодаря тому факту, что она содержит все файлы. Когда загрузочные
<TT
CLASS="LITERAL"
>rc</TT
>-скрипты загружаются, они содержатся в
файлах <TT
CLASS="LITERAL"
>/etc/rc.d</TT
> или <TT
CLASS="LITERAL"
>/etc/rc?.d</TT
>, в зависимости от версии программы <TT
CLASS="LITERAL"
>/etc/init</TT
>.</P
><P
>Когда система загрузилась, нельзя отключить корневую файловую систему или
изменить ее из-за того, что все программы используют ее тем или иным
образом. Вот почему так полезен загрузочный электронный диск, поскольку
его можно использовать, чтобы конечная корневая файловая система могла быть
отлична от той, которая  была в момент начала загрузки.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN94"
>2.5. Последовательность загрузки Linux</A
></H2
><P
>Чтобы понять, как загрузочный электронный диск работает в процессе загрузки системы, изучим порядок событий при загрузке системы.</P
><P
>&#13;<P
></P
><OL
TYPE="1"
><LI
><P
>Ядро загружается в память. Эту операцию производит <TT
CLASS="LITERAL"
>LILO</TT
> или
<TT
CLASS="LITERAL"
>LOADLIN</TT
>. В этот момент  выводится сообщение <TT
CLASS="LITERAL"
>Loading...</TT
></P
></LI
><LI
><P
>Образ электронного диска загружается в память, это тоже делает
<TT
CLASS="LITERAL"
>LILO</TT
> или <TT
CLASS="LITERAL"
>LOADLIN</TT
>. В этот момент также выводится сообщение <TT
CLASS="LITERAL"
>Loading...</TT
></P
></LI
><LI
><P
>Производится инициализация ядра, включая обработку опций командной строки и подключение электронного диска в виде корневой файловой системы.</P
></LI
><LI
><P
>На загрузочном электронном диске запускается программа <TT
CLASS="LITERAL"
>/linuxrc</TT
>.</P
></LI
><LI
><P
>Корневое устройство переключается в соответствии с параметром ядра.</P
></LI
><LI
><P
>Запускается программа <TT
CLASS="LITERAL"
>/etc/init</TT
>, которая уже производит настраиваемую пользователем последовательность загрузки.</P
></LI
></OL
>&#13;</P
><P
>Это упрощенное описание того, что происходит на самом деле, но этого
достаточно, чтобы описать, как запускается ядро и как используется
электронный диск.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN120"
>3. Как создать зацикленное корневое устройство</A
></H1
><P
>Теперь, когда все основные принципы объяснены, можно перейти к созданию зацикленного корневого устройства.</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN123"
>3.1. Требования</A
></H2
><P
>Создание зацикленного корневого устройства потребует от вас нескольких вещей.</P
><P
>&#13;<P
></P
><UL
><LI
><P
>Систему с работающим Linux-ом.</P
></LI
><LI
><P
>Способ скопировать большие файлы на DOS-раздел.</P
></LI
></UL
>&#13;</P
><P
>Наиболее важно иметь доступ к работающему Linux-у. Это необходимо по причине того, что зацикленное устройство может быть создано только в Linux-е. Это означает, что нельзя создать работающую машину с зацикленной корневой файловой системой из ничего. От этой Linux-системы потребуется возможность собрать на ней ядро.</P
><P
>После создания зацикленное устройство будет представлять из себя большой файл. Я использовал примерно 80 Мб файлов, но этого достаточно только, чтобы сделать Х-терминал, а возможно, если вы захотите чего-то большего, вам потребуется больше места. Этот файл должен быть скопирован на DOS-раздел, то есть придется использовать или сеть, или кучу флоппи-дисков.</P
><P
>Вам также понадобится следующее программное обеспечение:</P
><P
>&#13;<P
></P
><UL
><LI
><P
><TT
CLASS="LITERAL"
>LOADLIN</TT
> версии 1.6 или новее</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>mount</TT
>, поддерживающий зацикленные устройства</P
></LI
><LI
><P
>ядро, поддерживающее все необходимые условия.</P
></LI
></UL
>&#13;</P
><P
>Это все должно входить в последние инсталляции дистрибутивов Linux.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN146"
>3.2. Создаем ядро Linux</A
></H2
><P
>Я создал зацикленное устройство с использованием ядра версии 2.0.31,
другие версии тоже должны работать, но они  должны поддерживать все опции,
перечисленные ниже.</P
><P
>Опции ядра, которые вам надо будет включить:

<P
></P
><UL
><LI
><P
>Поддержка электронных дисков (RAM disk support) (<TT
CLASS="LITERAL"
>CONFIG_BLK_DEV_RAM</TT
>).</P
></LI
><LI
><P
>Поддержка загрузочного электронного диска (Initial RAM disk (initrd) support) (<TT
CLASS="LITERAL"
>CONFIG_BLK_DEV_INITRD</TT
>).</P
></LI
><LI
><P
>Поддержка зацикленных устройств (Loop device support) (<TT
CLASS="LITERAL"
>CONFIG_BLK_DEV_LOOP</TT
>).</P
></LI
><LI
><P
>Поддержка файловой системы FAT (fat fs support) (<TT
CLASS="LITERAL"
>CONFIG_FAT_FS</TT
>).</P
></LI
><LI
><P
>Поддержка файловой системы MSDOS (msdos fs support) (<TT
CLASS="LITERAL"
>CONFIG_MSDOS_FS</TT
>).</P
></LI
></UL
>&#13;</P
><P
>Первые две опции - это сам электронный диск и загрузочный электронный диск. Следующая - это зацикленная файловая система. Последние две - это поддержка файловой системы msdos, которая необходима для подключения DOS-раздела.</P
><P
>Сборка ядра без модулей - это наиболее простой способ, но если вы все-таки решили использовать модули, это возможно, хотя я этого и не пробовал. Если вы используете модули, вы должны убедиться в том, что опции, используемые выше, встроены в ядро, а не собраны в виде модулей.</P
><P
>В зависимости от версии вашего ядра, вам, возможно, придется установить патч к
ядру. Это очень простой патч, который разрешает использование зацикленной
файловой системы в виде корневой.

<P
></P
><UL
><LI
><P
>Ядра версий до 2.0.0 - у меня нет информации по этому поводу.</P
></LI
><LI
><P
>Ядра версий 2.0.0 - 2.0.34 - вам придется использовать патч для ядер 2.0.х, приведенный ниже.</P
></LI
><LI
><P
>Ядра версий 2.0.35 - 2.0.x - патч  не требуется.</P
></LI
><LI
><P
>Ядра версий 2.1.x - вам придется использовать патч для ядер 2.0.х или 2.2.х,  приведенный ниже, в зависимости от конкретной версии ядра 2.1.x.</P
></LI
><LI
><P
>Ядра версий 2.2.0 - 2.2.10 - вам придется использовать патч для ядер 2.2.х, приведенный ниже.</P
></LI
><LI
><P
>Ядра версий 2.3.x - вам придется использовать патч для ядер 2.2.х, приведенный ниже.</P
></LI
></UL
>&#13;</P
><P
>Для ядер версий 2.0.x в файл <TT
CLASS="LITERAL"
>/init/main.c</TT
> надо добавить одну строку, в соответствии с уже измененной  версией, приведенной ниже. В строке, которую надо добавить написано
<TT
CLASS="LITERAL"
>"loop", 0x0700</TT
>.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>static void parse_root_dev(char * line)
{
	int base = 0;
	static struct dev_name_struct {
		const char *name;
		const int num;
	} devices[] = {
		{ "nfs",     0x00ff },
		{ "loop",    0x0700 },
		{ "hda",     0x0300 },

...

		{ "sonycd",  0x1800 },
		{ NULL, 0 }
	};

...

}</PRE
>&#13;</P
><P
>Для ядер версий 2.2.x в файл <TT
CLASS="LITERAL"
>/init/main.c</TT
> надо добавить три строки, в соответствии с уже измененной  версией, приведенной ниже. Надо добавить строку, в которой написано <TT
CLASS="LITERAL"
>"loop",
0x0700</TT
>, а также предшествующую и следующую за ней:</P
><P
>&#13;<PRE
CLASS="SCREEN"
>static struct dev_name_struct {
	const char *name;
	const int num;
} root_dev_names[] __initdata = {
#ifdef CONFIG_ROOT_NFS
	{ "nfs",     0x00ff },
#endif
#ifdef CONFIG_BLK_DEV_LOOP
        { "loop",    0x0700 },
#endif
#ifdef CONFIG_BLK_DEV_IDE
	{ "hda",     0x0300 },

...

	{ "ddv", DDV_MAJOR &#60;&#60; 8},
#endif
	{ NULL, 0 }
};</PRE
>&#13;</P
><P
>После того, как ядро настроено, его необходимо собрать в файл <TT
CLASS="LITERAL"
>zImage</TT
> (<TT
CLASS="LITERAL"
>команда make zImage</TT
>). Этот файл будет находиться в каталоге <TT
CLASS="LITERAL"
>arch/i386/boot/zImage</TT
>.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN196"
>3.3. Создаем загрузочный электронный диск</A
></H2
><P
>Загрузочный электронный диск проще всего создавать, как зацикленное
устройство с самого начала. Вы должны делать это в качестве root-а. Список
команд, которые вы должны запустить, приведен ниже. Они предполагают запуск
из личного  каталога root-а (<TT
CLASS="LITERAL"
>/root</TT
>).</P
><P
>&#13;<PRE
CLASS="SCREEN"
>mkdir /root/initrd
dd if=/dev/zero of=initrd.img bs=1k count=1024
mke2fs -i 1024 -b 1024 -m 5 -F -v initrd.img
mount initrd.img /root/initrd -t ext2 -o loop
cd initrd
[create the files]
cd ..
umount /root/initrd
gzip -c -9 initrd.img &gt; initrdgz.img</PRE
>&#13;</P
><P
>Здесь производится несколько действий, которые можно вкратце описать так:

<P
></P
><OL
TYPE="1"
><LI
><P
>Создаем точку подключения загрузочного электронного диска (пустой каталог).</P
></LI
><LI
><P
>Создаем пустой файл необходимого размера. Я здесь использовал 1024 Кб, вам может понадобиться меньше или больше, в зависимости от содержимого (размер задается в последней опции).</P
></LI
><LI
><P
>Создаем файловую систему ext2 в пустом файле.</P
></LI
><LI
><P
>Подключаем этот файл к точке подключения, с использованием зацикленного устройства.</P
></LI
><LI
><P
>Переходим ко вновь подключенному зацикленному устройству.</P
></LI
><LI
><P
>Создадим там все необходимые файлы (см. ниже).</P
></LI
><LI
><P
>Выходим из подключенного зацикленного устройства.</P
></LI
><LI
><P
>Отключаем устройство.</P
></LI
><LI
><P
>Создаем компрессированную версию для дальнейшего использования.</P
></LI
></OL
>&#13;</P
><P
><I
CLASS="EMPHASIS"
>Содержимое загрузочного электронного диска</I
></P
><P
>На загрузочном диске нужно иметь все файлы, необходимые для запуска любых команд:</P
><P
>&#13;<P
></P
><UL
><LI
><P
><TT
CLASS="LITERAL"
>/linuxrc</TT
> скрипт, который подключает файловую систему msdos (см. ниже).</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>/lib/*</TT
> система динамических связей (dynamic linker) и библиотеки, необходимые программам.</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>/etc/*</TT
> Кэш, используемый системой динамических связей (не очень нужен, но после этого перестают  выдаваться жалобные сообщения).</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>/bin/*</TT
> Интерпретатор оболочки (shell) (<TT
CLASS="LITERAL"
>ash</TT
>, потому что он меньше размером, чем <TT
CLASS="LITERAL"
>bash</TT
>. Программы<TT
CLASS="LITERAL"
>mount</TT
> и <TT
CLASS="LITERAL"
>losetup</TT
> для работы с DOS-диском и настройки зацикленных устройств.</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>/dev/*</TT
> Устройства, которые будут использоваться. Вам потребуется устройство
<TT
CLASS="LITERAL"
>/dev/zero</TT
> для библиотеки <TT
CLASS="LITERAL"
>ld-linux.so</TT
>, <TT
CLASS="LITERAL"
>/dev/hda*</TT
> для подключения msdos-диска и <TT
CLASS="LITERAL"
>/dev/loop*</TT
> для зацикленных устройств.</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>/mnt</TT
> Пустой каталог для подключения msdos-диска.</P
></LI
></UL
>&#13;</P
><P
>Содержимое загрузочного электронного диска, которое я использовал, приведено ниже. Оно заняло примерно 800 Кб, если принимать в расчет излишки файловой системы.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>total 18
drwxr-xr-x   2 root     root         1024 Jun  2 13:57 bin
drwxr-xr-x   2 root     root         1024 Jun  2 13:47 dev
drwxr-xr-x   2 root     root         1024 May 20 07:43 etc
drwxr-xr-x   2 root     root         1024 May 27 07:57 lib
-rwxr-xr-x   1 root     root          964 Jun  3 08:47 linuxrc
drwxr-xr-x   2 root     root        12288 May 27 08:08 lost+found
drwxr-xr-x   2 root     root         1024 Jun  2 14:16 mnt

./bin:
total 168
-rwxr-xr-x   1 root     root        60880 May 27 07:56 ash
-rwxr-xr-x   1 root     root         5484 May 27 07:56 losetup
-rwsr-xr-x   1 root     root        28216 May 27 07:56 mount
lrwxrwxrwx   1 root     root            3 May 27 08:08 sh -&gt; ash

./dev:
total 0
brw-r--r--   1 root     root       3,   0 May 20 07:43 hda
brw-r--r--   1 root     root       3,   1 May 20 07:43 hda1
brw-r--r--   1 root     root       3,   2 Jun  2 13:46 hda2
brw-r--r--   1 root     root       3,   3 Jun  2 13:46 hda3
brw-r--r--   1 root     root       7,   0 May 20 07:43 loop0
brw-r--r--   1 root     root       7,   1 Jun  2 13:47 loop1
crw-r--r--   1 root     root       1,   3 May 20 07:42 null
crw-r--r--   1 root     root       5,   0 May 20 07:43 tty
crw-r--r--   1 root     root       4,   1 May 20 07:43 tty1
crw-r--r--   1 root     root       1,   5 May 20 07:42 zero

./etc:
total 3
-rw-r--r--   1 root     root         2539 May 20 07:43 ld.so.cache

./lib:
total 649
lrwxrwxrwx   1 root     root           18 May 27 08:08 ld-linux.so.1 -&gt; ld-linux.so.1.7.14
-rwxr-xr-x   1 root     root        21367 May 20 07:44 ld-linux.so.1.7.14
lrwxrwxrwx   1 root     root           14 May 27 08:08 libc.so.5 -&gt; libc.so.5.3.12
-rwxr-xr-x   1 root     root       583795 May 20 07:44 libc.so.5.3.12

./lost+found:
total 0

./mnt:
total 0</PRE
>&#13;</P
><P
>Единственным сложным пунктом здесь являются устройства в каталоге <TT
CLASS="LITERAL"
>dev</TT
>. Используйте команду
<TT
CLASS="LITERAL"
>mknod</TT
>, чтобы создать эти устройства, или используйте устройства в каталоге <TT
CLASS="LITERAL"
>/dev</TT
>, 
как шаблон для необходимых устройств.</P
><P
><I
CLASS="EMPHASIS"
>Файл /linuxrc</I
></P
><P
>Файл<TT
CLASS="LITERAL"
>/linuxrc</TT
> на загрузочном электронном диске нужен для того, чтобы произвести  все приготовления, необходимые для подключения зацикленного устройства  как корневого.</P
><P
>Скрипт, приведенный ниже пытается подключить <TT
CLASS="LITERAL"
>/dev/hda1</TT
> как раздел msdos, и если это происходит
удачно, то он настраивает файлы <TT
CLASS="LITERAL"
>/linux/linuxdsk.img</TT
> как <TT
CLASS="LITERAL"
>/dev/loop0</TT
> и <TT
CLASS="LITERAL"
>/linux/linuxswp.img</TT
> как <TT
CLASS="LITERAL"
>/dev/loop1</TT
>.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>#!/bin/sh

echo INITRD: Trying to mount /dev/hda1 as msdos
# echo INITRD: Попытка подключить /dev/hda1 как msdos

if /bin/mount -n -t msdos /dev/hda1 /mnt; then

   echo INITRD: Mounted OK
   # echo INITRD: Подключение  успешно
   /bin/losetup /dev/loop0 /mnt/linux/linuxdsk.img
   /bin/losetup /dev/loop1 /mnt/linux/linuxswp.img
   exit 0

else

   echo INITRD: Mount failed
   # echo INITRD: Подключение не удалось
   exit 1

fi</PRE
>&#13;</P
><P
>Первое устройство <TT
CLASS="LITERAL"
>/dev/loop0</TT
> станет корневым, а второе - <TT
CLASS="LITERAL"
>/dev/loop1</TT
> - станет swap-пространством.</P
><P
>Если вы хотите иметь возможность писать на DOS-раздел, не будучи root-ом,
когда все будет  завершено, то вы должны использовать команду <TT
CLASS="LITERAL"
>mount -n -t msdos /dev/hda1 /mnt -o
uid=0,gid=0,umask=000,quiet</TT
>, вместо приведенной выше. В этом
режиме доступ к DOS-разделу буду исполняться так, как будто это делает root.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN277"
>3.4. Создаем корневое устройство</A
></H2
><P
>Корневое устройство, которое вы будете использовать - это файл <TT
CLASS="LITERAL"
>linuxdsk.img</TT
>. Его вам придется создать самим так же,
как вы создавали загрузочный электронный диск, но значительно большего
размера. Вы можете установить любой дистрибутив Linux, который вам
понравится, на этот диск.</P
><P
>Наиболее простой путь для этого - скопировать существующую инсталляцию Linux в этот файл. Другой путь - установить туда Linux с дистрибутива. Предполагая, что вы это сделали, внесем некоторые незначительные изменения.</P
><P
>Файл <TT
CLASS="LITERAL"
>/etc/fstab</TT
> должен ссылаться на корневой раздел и swap-пространство через два зацикленных устройства, настроенных загрузочным электронным диском.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>/dev/loop0     /      ext2   defaults 1 1
/dev/loop1     swap   swap   defaults 1 1</PRE
>&#13;</P
><P
>Таким образом, вы будете уверены в том, что ядро не ошибется относительно
реального местоположения корневой файловой системы. Также swap-пространство
будет организовано обычным образом так, как будто используется обычный
swap-раздел. Вы должны удалить все строки, ссылающиеся на корневое
файловое устройство или swap-раздел.</P
><P
>Если хотите иметь возможность читать DOS-раздел под Linux-ом? вам придется
внести еще несколько небольших изменений.</P
><P
>Создайте каталог <TT
CLASS="LITERAL"
>/initrd</TT
>, куда будет подключен загрузочный  электронный диск после подключения зацикленной корневой файловой системы.</P
><P
>Создайте символьную ссылку <TT
CLASS="LITERAL"
>/DOS</TT
>, которая будет
указывать на <TT
CLASS="LITERAL"
>/initrd/mnt</TT
>, куда, в свою
очередь, будет подключен реальный DOS-раздел.</P
><P
>Добавьте строку в rc-файл, которая будет подключать диски. Там должна быть
команда <TT
CLASS="LITERAL"
>mount -f -t msdos /dev/hda1
/initrd/mnt</TT
>, которая создаст 'поддельное' подключение
DOS-раздела, чтобы программы (например, <TT
CLASS="LITERAL"
>df</TT
>)
знали, что DOS-раздел подключен, и где его найти. Если вы использовали
другие опции в файле <TT
CLASS="LITERAL"
>/linuxrc</TT
>, то, очевидно,
вам придется их использовать и здесь.</P
><P
>Нет необходимости в том, чтобы иметь ядро Linux на этом корневом
зацикленном устройстве, так как  оно загружено ранее. Если вы используете
модули, можете включить их в это устройство обычным образом.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN298"
>3.5. Создаем Swap-устройство</A
></H2
><P
>Swap-устройство, которое вы будете использовать - это файл <TT
CLASS="LITERAL"
>linuxswap.img</TT
>. Swap-устройство очень просто создать.
Создайте пустой файл так же, как делали это для загрузочного электронного
диска, и затем запустите <TT
CLASS="LITERAL"
>mkswap linuxswap.img</TT
>
для его инициализации.</P
><P
>Размер swap-устройства, которое вы будете использовать, зависит от ваших планов по использованию новой системы, но я бы рекомендовал его от 8 Мб до размера вашей оперативной памяти.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN304"
>3.6. Создаем каталог MSDOS</A
></H2
><P
>Файлы, которые  будут нами использоваться, необходимо переписать на DOS-раздел.</P
><P
>В DOS-каталоге <TT
CLASS="LITERAL"
>C:\LINUX</TT
> должны находиться следующие файлы:</P
><P
>&#13;<P
></P
><UL
><LI
><P
><TT
CLASS="LITERAL"
>LINUXDSK.IMG</TT
> Образ диска, который станет корневой файловой системой.</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>LINUXSWP.IMG</TT
> Swap-пространство.</P
></LI
></UL
>&#13;</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN317"
>3.7. Создаем загрузочный флоппи-диск</A
></H2
><P
>Загрузочный флоппи-диск, который мы будем использовать, является простым загрузочным диском DOS.</P
><P
>Он создается командой DOS <TT
CLASS="LITERAL"
>format a: /s</TT
>.</P
><P
>На этом диске вам надо создать файл <TT
CLASS="LITERAL"
>AUTOEXEC.BAT</TT
> (пример приведен ниже) и скопировать туда ядро, компрессированный загрузочный электронный диск и программу <TT
CLASS="LITERAL"
>LOADLIN</TT
>.</P
><P
>&#13;<P
></P
><UL
><LI
><P
><TT
CLASS="LITERAL"
>AUTOEXEC.BAT</TT
> Автоматически запускаемый командный файл DOS.</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>LOADLIN.EXE</TT
> Программа <TT
CLASS="LITERAL"
>LOADLIN</TT
>.</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>ZIMAGE</TT
> Ядро Linux.</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>INITRDGZ.IMG</TT
> Компрессированный образ загрузочного электронного диска.</P
></LI
></UL
>&#13;</P
><P
>В файле <TT
CLASS="LITERAL"
>AUTOEXEC.BAT</TT
> должна быть только одна строка.</P
><P
>&#13;<PRE
CLASS="SCREEN"
>\loadlin \zImage initrd=\initrdgz.img root=/dev/loop0 ro</PRE
>&#13;</P
><P
>Здесь указано, какой образ ядра использовать, какой образ  загрузочного
электронного диска использовать, а также корневая файловая система, которая
должна быть подключена "только для чтения".</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN345"
>4. Загрузка системы</A
></H1
><P
>Для загрузки нового корневого устройства необходимо, чтобы флоппи-диск, описанный выше, был вставлен в компьютер при его загрузке.</P
><P
>Вы увидите следующую последовательность событий.

<P
></P
><OL
TYPE="1"
><LI
><P
>Загрузка DOS</P
></LI
><LI
><P
>Запуск AUTOEXEC.BAT</P
></LI
><LI
><P
>Запуск LOADLIN</P
></LI
><LI
><P
>Загрузка в память ядра Linux</P
></LI
><LI
><P
>Загрузка в память загрузочного электронного диска</P
></LI
><LI
><P
>Запуск ядра Linux</P
></LI
><LI
><P
>Запуск файла <TT
CLASS="LITERAL"
>/linuxrc</TT
> с загрузочного электронного диска</P
></LI
><LI
><P
>Подключение DOS-раздела и настройка корневого и swap-устройств</P
></LI
><LI
><P
>Последовательность загрузки продолжается с зацикленного устройства</P
></LI
></OL
>&#13;</P
><P
>Когда все это пройдет, вы можете убрать флоппи-диск и использовать Linux.</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN370"
>4.1. Возможные проблемы и их решение</A
></H2
><P
>Существует ряд причин, по которым что-то в этом процессе идет не так. Я
попытаюсь объяснить, в чем они заключаются, и что необходимо проверить.</P
><P
>Загрузку DOS легко узнать по сообщению <TT
CLASS="LITERAL"
>MS-DOS
Starting ...</TT
> на экране. Если его нет, то диск либо не является загружаемым, либо сам компьютер не может загрузиться с этого дисковода.</P
><P
>Когда запускается файл <TT
CLASS="LITERAL"
>AUTOEXEC.BAT</TT
>, то
команды, входящие в него, выводятся на экран. В нашем случае, это одна
строка, содержащая запуск <TT
CLASS="LITERAL"
>LOADLIN</TT
>.</P
><P
>Когда загружается <TT
CLASS="LITERAL"
>LOADLIN</TT
>, то он выводит две очень хорошо заметные строки, сначала он загрузит ядро  в память, затем также будет загружать загрузочный электронный диск. Обе этих загрузки сопровождаются сообщением <TT
CLASS="LITERAL"
>Loading...</TT
>.</P
><P
>Когда ядро декомпрессирует себя, оно может выдать сообщение о <I
CLASS="EMPHASIS"
>crc</I
>-ошибках, если ядро повреждено. Затем начнется инициализационная последовательность, которая содержит очень много диагностических сообщения. Загрузка в память загрузочного электронного диска также видна на этой фазе.</P
><P
>Когда запускается файл <TT
CLASS="LITERAL"
>/linuxrc</TT
>, тогда нет
диагностических сообщения, но их вы можете добавить сами для того, чтобы
помочь себе в поисках причин возможных проблем. Если  на этой фазе не
удается настроить зацикленное устройство, вы увидите сообщение о том, что
"Не найдено корневое устройство (No root device)", и ядро прекратит работу.</P
><P
>Затем должна продолжиться нормальная последовательность  загрузки уже с
новой корневой файловой системой, и она также насыщена сообщениями. Могут
появиться проблемы типа "Корневое устройство подключено в режиме
чтение/запись", но с этим должна справиться опция '<TT
CLASS="LITERAL"
>ro</TT
>' команды <TT
CLASS="LITERAL"
>LOADLIN</TT
>.
Другая проблема, которая может возникнуть - это вопрос о реальном
местоположении корневой файловой системы, это возникнет, возможно, из-за
проблем с файлом <TT
CLASS="LITERAL"
>/etc/fstab</TT
>.</P
><P
>Когда последовательность загрузки закончится, может возникнуть проблема,
состоящая в том, что  некоторые программы  не очень хорошо понимают, подключен ли
DOS-раздел. Поэтому я советую использовать "поддельную" команды mount,
описанную выше. Она значительно упростит жизнь, если вы хотите использовать
файлы на DOS-устройстве.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN390"
>4.2. Ссылки на другие документы</A
></H2
><P
>При создании моей первой зацикленной корневой файловой системы я использовал следующие источники информации:</P
><P
>&#13;<P
></P
><UL
><LI
><P
>Исходные тексты ядра Linux, в особенности <TT
CLASS="LITERAL"
>init/main.c</TT
></P
></LI
><LI
><P
>Документацию к ядру Linux, в особенности
<TT
CLASS="LITERAL"
>Documentation/initrd.txt</TT
> и <TT
CLASS="LITERAL"
>Documentation/ramdisk.txt</TT
>.</P
></LI
><LI
><P
>Документацию <TT
CLASS="LITERAL"
>LILO</TT
>.</P
></LI
><LI
><P
>Документацию <TT
CLASS="LITERAL"
>LOADLIN</TT
>.</P
></LI
></UL
>&#13;</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN408"
>5. Другие возможности зацикленных корневых устройств</A
></H1
><P
>Мы подробно описали возможность загрузки корневой файловой системы из
DOS-раздела, но существует много других вещей, которые вы можете сделать.</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN411"
>5.1. Установка на DOS-жесткий-диск</A
></H2
><P
>Если возможно загрузить Linux из файла на жестком диске с раздела DOS, используя загружаемый флоппи, то, очевидно, возможно загрузить его и с самого жесткого диска.</P
><P
>Для того, чтобы загрузить
<TT
CLASS="LITERAL"
>LOADLIN</TT
> из <TT
CLASS="LITERAL"
>AUTOEXEC.BAT</TT
>. можно использовать загрузочное меню. Этот способ значительно ускоряет загрузку, а в остальном совершенно идентичен вышеописанному.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN417"
>5.2. Установка с загрузкой при помощи LILO</A
></H2
><P
>Использование <TT
CLASS="LITERAL"
>LOADLIN</TT
> - это только один способ загрузки ядра Linux. Существует также <TT
CLASS="LITERAL"
>LILO</TT
>, которое делает то же самое, но без использования DOS.</P
><P
>В этом случае DOS-флоппи диск можно заменить на диск, отформатированный как ext2fs. Остальные детали очень похожи  потому, что ядро и загрузочный электронный диск - это файлы на этом флоппи-диске.</P
><P
>Одна из причин, по которой я использовал <TT
CLASS="LITERAL"
>LOADLIN</TT
> - это то, что параметры, передаваемые <TT
CLASS="LITERAL"
>LILO</TT
>, немного сложнее. И еще очевидна причина,
что обычный пользователь сможет узнать, что записано на диске, находясь в
DOS-е.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN426"
>5.3. Установка на VFAT / NTFS</A
></H2
><P
>Я использовал этот метод и с NTFS, и у меня не возникло никаких проблем. Драйвер файловой системы NTFS не входит в стандартную поставку ядра версий 2.0.x, но доступен в виде патча по адресу <A
HREF="http://www.informatik.hu-berlin.de/~loewis/ntfs/"
TARGET="_top"
>http://www.informatik.hu-berlin.de/~loewis/ntfs/</A
>. В версиях 2.2.x драйвер NTFS включен в стандартную поставку ядра.</P
><P
>Единственное изменение, касающееся VFAT или NTFS, должно быть внесено в
загрузочный электронный диск, а конкретнее, в файл <TT
CLASS="LITERAL"
>/linuxrc</TT
>: при подключении файловой системы необходимо
указать тип файловой системы vfat или ntfs, вместо msdos.</P
><P
>Я не знаю причин, по которым  это не должно работать в разделе VFAT.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN433"
>5.4. Установка Linux без изменения разделов</A
></H2
><P
>Процесс установки Linux на компьютер со  стандартного дистрибутива
предполагает загрузку с флоппи-диска и изменение структуры разделов диска. Вместо
этого можно создать загружаемый флоппи-диск, который создаст пустое
зацикленное устройство и swap-файл. После этого установка может быть
продолжена обычным образом, просто система будет установлена в зацикленное
устройство вместо раздела.</P
><P
>Этот метод может быть альтернативой установке в раздел <TT
CLASS="LITERAL"
>UMSDOS</TT
> - он значительно более эффективен в использовании дискового пространства, так как минимальный размер кластера в файловой системе ext2 - 1 Кб, а в DOS он достигает 32 Кб. Его можно использовать и на дисках VFAT и NTFS, которые сами по себе являются проблемой :-).</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN438"
>5.5. Загрузка с незагружаемого (Non-bootable) устройства</A
></H2
><P
>Вышеописанный метод можно также использовать для загрузки Linux-а с устройства, которое обычно не является загружаемым.</P
><P
>&#13;<P
></P
><UL
><LI
><P
>CD-Rom</P
></LI
><LI
><P
>Zip-диски</P
></LI
><LI
><P
>Диски на параллельном порте</P
></LI
></UL
>&#13;</P
><P
>Очевидно, что и многие другие устройства могут быть использованы также.
Корневые файловые системы NFS включены в ядро в виде опции, но этот
способ может быть использован в качестве альтернативы.</P
></DIV
></DIV
></DIV
></BODY
></HTML
>