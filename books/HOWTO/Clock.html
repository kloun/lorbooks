<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML
><HEAD
><TITLE
>The Clock Mini-HOWTO</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.57"></HEAD
><BODY
CLASS="ARTICLE"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="ARTICLE"
><DIV
CLASS="TITLEPAGE"
><H1
CLASS="TITLE"
><A
NAME="AEN2"
>The Clock Mini-HOWTO</A
></H1
><DIV
CLASS="AUTHORGROUP"
><A
NAME="AEN4"
></A
><H3
CLASS="AUTHOR"
><A
NAME="AEN5"
>Ron Bean</A
></H3
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
>&nbsp;&nbsp;&nbsp;&nbsp;    rbean@execpc.com
    <br>
&nbsp;&nbsp;&nbsp;</P
></DIV
></DIV
><H3
CLASS="CORPAUTHOR"
>  Перевод: <A
HREF="mailto:kmic@asp-linux.com"
TARGET="_top"
>Михаил Корепанов</A
>,
  <A
HREF="http://www.asplinux.com"
TARGET="_top"
>SWSoft Pte Ltd.</A
>
 </H3
></DIV
><P
CLASS="PUBDATE"
>версия 2, Июль 1999<BR></P
><DIV
><DIV
CLASS="ABSTRACT"
><A
NAME="AEN15"
></A
><P
></P
><P
>Установка часов компьютера и поддержка их работы.</P
><P
></P
></DIV
></DIV
><HR></DIV
><DIV
CLASS="TOC"
><DL
><DT
><B
>Содержание</B
></DT
><DT
>1. <A
HREF="Clock.html#AEN17"
>Введение</A
></DT
><DT
>2. <A
HREF="Clock.html#AEN52"
>Основные способы для Linux</A
></DT
><DT
>3. <A
HREF="Clock.html#AEN94"
>Программное обеспечение</A
></DT
><DD
><DL
><DT
>3.1. <A
HREF="Clock.html#AEN96"
>Clock(8) и Hwclock(8)</A
></DT
><DT
>3.2. <A
HREF="Clock.html#AEN131"
>Adjtimex(8)</A
></DT
><DT
>3.3. <A
HREF="Clock.html#AEN147"
>Xntpd и ntpd: сетевой протокол времени (Network Time Protocol)</A
></DT
><DT
>3.4. <A
HREF="Clock.html#AEN168"
>Chrony</A
></DT
></DL
></DD
><DT
>4. <A
HREF="Clock.html#AEN177"
>Радио часы</A
></DT
><DD
><DL
><DT
>4.1. <A
HREF="Clock.html#AEN179"
>CHU и декодер</A
></DT
><DT
>4.2. <A
HREF="Clock.html#AEN190"
>WWV и "Most Accurate Clock"</A
></DT
><DT
>4.3. <A
HREF="Clock.html#AEN205"
>GPS и "Totally Accurate Clock"</A
></DT
><DT
>4.4. <A
HREF="Clock.html#AEN213"
>Низкочастотные сигналы точного времени: DCF77, MSF(Rugby), WWVB</A
></DT
></DL
></DD
><DT
>5. <A
HREF="Clock.html#AEN226"
>Подробная инструкция к clock(8)</A
></DT
><DD
><DL
><DT
>5.1. <A
HREF="Clock.html#AEN238"
>Проверка настроек</A
></DT
><DT
>5.2. <A
HREF="Clock.html#AEN259"
>Измерение величины коррекции</A
></DT
><DT
>5.3. <A
HREF="Clock.html#AEN277"
>Пример</A
></DT
><DD
><DL
><DT
>5.3.1. <A
HREF="Clock.html#AEN279"
>Как установить время</A
></DT
><DT
>5.3.2. <A
HREF="Clock.html#AEN291"
>Как переустановить время и изменить величину коррекции</A
></DT
><DT
>5.3.3. <A
HREF="Clock.html#AEN303"
>Как вычислить величину коррекции</A
></DT
></DL
></DD
></DL
></DD
><DT
>6. <A
HREF="Clock.html#AEN317"
>Авторские права</A
></DT
></DL
></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="AEN17"
>1. Введение</A
></H1
><P
>Микросхема часов реального времени (ЧРВ), используемая на материнских
платах (и даже на дорогих рабочих станциях), не особенно точна и обычно
отстает, или забегает вперед на определенное время каждый день. Linux может
обеспечить их коррекцию путем программирования, которое может сделать часы
<I
CLASS="EMPHASIS"
>*очень*</I
> точными, и, в дальнейшем, они не будут нуждаться в корректировке по
внешним часам. Но большинство не знают, как это сделать, по
нескольким причинам:
<P
></P
><UL
><LI
><P
>Это не упоминается в основных руководствах по установке Linux, и они не
устанавливаются автоматически без внешних часов, именно поэтому они и не
используются.</P
></LI
><LI
><P
>Набрав <B
CLASS="COMMAND"
>man clock</B
>, вы увидите инструкцию к
<TT
CLASS="LITERAL"
>clock(3)</TT
>, которая вам не нужна
(попробуйте "<TT
CLASS="LITERAL"
>man 8 clock</TT
>" или
"<TT
CLASS="LITERAL"
>man 8 hwclock</TT
>"-- некоторые дистрибутивы производят поиск в
порядке возрастания цифр, если не указан раздел, другие ищут в порядке,
установленом в <TT
CLASS="FILENAME"
>/etc/man.config</TT
>).</P
></LI
><LI
><P
>Большинство людей не интересует, который сейчас час.</P
></LI
><LI
><P
>Те, которым это надо, зачастую попросту синхронизируют часы по внешним,
сетевым или радио. Это делает точность часов относительной.</P
></LI
></UL
></P
><P
>Данный Мини-HOWTO описывает решение на уровне ядра (которое является почти
непогрешимым по своей сути). В основном, документация по этой проблеме
хорошо написана, и я не собираюсь повторяться, но я включил дополнения для
старой программы <TT
CLASS="LITERAL"
>clock(8)</TT
> для тех, кто ее еще использует.</P
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Замечание</DT
><DD
><P
>Вы должны зайти в систему в качестве пользователя "<I
CLASS="EMPHASIS"
>root</I
>" для того, чтобы запустить любую
программу, касающуюся ЧРВ, или системное время. Это обязательное условие
работы описанных здесь программ.&#13;</P
></DD
></DL
></DIV
></P
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Замечание</DT
><DD
><P
>Если вы используете более, чем одну систему на вашей машине, вы должны
сделать так, чтобы только одна из них из них контролировала часы CMOS, не
конфликтуя с другими. Эта технология предусматривает корректировку,
проводимую дважды в год во время перехода на летнее и зимнее время.&#13;</P
></DD
></DL
></DIV
></P
><P
>Если вы используете систему с двойной загрузкой, которая большинство
времени работает под Windows, то, вероятно, вы захотите попробовать
использовать программы для этой ОС. Для этого взгляните на страницу
<A
HREF="http://www.eecis.udel.edu/~ntp/software.html"
TARGET="_top"
>http://www.eecis.udel.edu/~ntp/software.html</A
>.
Многие радио-часы, указанные там, поддерживаются Windows.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN52"
>2. Основные способы для Linux</A
></H1
><P
>В действительности, в Linux имеются две параллельные системы учета времени:
одна - это часы с питанием от батарей - "Часы Реального Времени" (так же
известные как "ЧРВ", "RTC", "CMOS clock",  "аппаратные часы"), которые идут
тогда, когда компьютер выключен, но не используются, когда система
функционирует. Другая - "системные часы" (иногда называемые "часы ядра" или
"программные часы") является программным счетчиком, основанном на системном
прерывании. Системные часы не идут, когда система выключена, поэтому они
устанавливаются от ЧРВ (или какого-либо другого источника) во время
загрузки. Ссылки на часы в документации <TT
CLASS="LITERAL"
>ntpd</TT
> относятся к системным часам, а
не ЧРВ.</P
><P
>Обе системы будут идти с разной скоростью, отрываться друг от друга и от
реального времени. Самый простой способ корректировать их - это измерить
величину их отклонения и внести его в программу, контролирующую их. ЧРВ
используется только, когда система выключена, они корректируются во время
загрузки, при помощи <TT
CLASS="LITERAL"
>clock(8)</TT
> или <TT
CLASS="LITERAL"
>hwclock(8)</TT
>. Системные часы корректируются при помощи
ранее заданной величины, которую система учитывает при каждой команде
прерывания, пришедшей от часов, используя программу <TT
CLASS="LITERAL"
>adjtimex(8)</TT
>.</P
><P
>Альтернативой <TT
CLASS="LITERAL"
>adjtimex(8)</TT
> может служить
<TT
CLASS="LITERAL"
>chron</TT
>, которая после запуска <TT
CLASS="LITERAL"
>clock(8)</TT
> или <TT
CLASS="LITERAL"
>hwclock(8)</TT
>
периодически синхронизирует системное время с (корректированными) ЧРВ. Эта
схема работы рекомендуется в документации к <TT
CLASS="LITERAL"
>clock(8)</TT
>, ее можно использовать, если вы
запускаете ее часто и не делаете больших "прыжков" в системных часах, но
but <TT
CLASS="LITERAL"
>adjtimex(8)</TT
> - это более красивое решение. Некоторые программы могут
привести к ошибке, если будет совершен "прыжок" назад.&#13;</P
><P
>Следующий шаг - это использование программ типа <TT
CLASS="LITERAL"
>ntpd</TT
>, которые регулярно
сверяют часы в сети или с радио, и постоянно корректируют системное время.
Если у вас есть постоянное подключение к сети во время загрузки, вы можете
не использовать ЧРВ, а вместо этого, использовать программу <TT
CLASS="LITERAL"
>ntpdate</TT
> (которая
входит в состав <TT
CLASS="LITERAL"
>ntpd</TT
>) для установки системных часов при помощи часового
сервера в Интернете или локальной сети. Но, если у вас иногда не будет
сетевого соединения, или вам понадобится точное время во время загрузки до
того, как соединение будет активировано, то вам придется использовать ЧРВ.</P
><P
>Но, в этом случае, вам , наверное, хотелось бы синхронизировать ЧРВ с
откорректированными системными часами. Но это будет иметь практическое
значение, если система выключена лишь несколько минут.</P
><P
>Но если система все время находится в рабочем состоянии, и перезагружается
сразу после того, как выключится, тогда вы можете корректировать ЧРВ,
основываясь на показаниях системных часов перед самой перезагрузкой. ЧРВ во
время перезагрузки не отклонятся на значительную величину, и поэтому у вас
не возникнет необходимости выяснять эту погрешность.</P
><P
>Конечно система может перезагрузиться во внештатном режиме, поэтому
некоторые ядра синхронизируют ЧРВ с системными часами каждые 11 минут, в
случае, если системные часы корректируются другой программой. Погрешность
на ЧРВ не будет большой за 11 минут, но если система была отключена на
большее время, то возникает проблема - программам, которые
корректируют ЧРВ, понадобится узнать точное время последнего выключения
системы, а ядро не сохраняет такую информацию.</P
><P
>Некоторые "закоренелые" пользователи Unix могут пожать плечами, если
услышат, что Linux установлен на машину, которая не работает круглосуточно,
но некоторые из нас работают на двойных платформах или используют Linux на
портативных компьютерах, которые выключают после работы. Другие просто не
любят оставлять машину включенной на долгое время, если на ней не работают.
Таким образом, достоинство проверки "каждые 11 минут" превращается в
недостаток.
&#13;</P
><P
>Это "достоинство/недостаток" ведет себя по-разному в разных версиях ядра
(возможно, и в различных версиях <TT
CLASS="LITERAL"
>xntpd</TT
> и
<TT
CLASS="LITERAL"
>ntpd</TT
>), поэтому, если вы используете <TT
CLASS="LITERAL"
>ntpd</TT
>
совместно с <TT
CLASS="LITERAL"
>hwclock</TT
>, то вам, очевидно, потребуется проверить свою систему
для того, чтобы узнать в точности, что происходит. Если у вас нет
возможности предотвратить коррекцию ЧРВ ядром, то вам лучше работать с
нулевой величиной коррекции.</P
><P
>Исходный текст части ядра, который управляет этим процессом, находится в
файле <TT
CLASS="FILENAME"
>/usr/src/linux-номер_версии/arch/i386/kernel/time.c</TT
> (где
номер_версии - это версия вашего ядра). Если переменная  <TT
CLASS="LITERAL"
>time_status</TT
>
установлена на  <TT
CLASS="LITERAL"
>TIME_OK</TT
> , то ядро будет копировать системное время в ЧРВ
каждые 11 минут, иначе ядро не корректирует ЧРВ. Эту процедуру можно также
выполнить при помощи <TT
CLASS="LITERAL"
>adjtimex(2)</TT
> (это делается, например, в <TT
CLASS="LITERAL"
>ntpd</TT
> и <TT
CLASS="LITERAL"
>timed</TT
>).
Обращение к <TT
CLASS="LITERAL"
>settimeofday(2)</TT
> установит <TT
CLASS="LITERAL"
>time_status</TT
> в <TT
CLASS="LITERAL"
>TIME_UNSYNC</TT
>; в
результате этого, ядро не будет корректировать ЧРВ. Я не нашел документации
по этому вопросу.</P
><P
>Если вам требуется точность в доли секунды, вам потребуется лишь <TT
CLASS="LITERAL"
>hwclock(8)</TT
>
и <TT
CLASS="LITERAL"
>adjtimex(8)</TT
>. В принципе, можно легко установить часы по сети, но я
использую старую программу <TT
CLASS="LITERAL"
>clock(8)</TT
> и она меня еще ни разу не подводила. С
другой стороны, если у вас есть несколько машин в локальной сети, то было
бы сподручнее синхронизировать их друг с другом.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN94"
>3. Программное обеспечение</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN96"
>3.1. Clock(8) и Hwclock(8)</A
></H2
><P
>Все дистрибутивы Linux содержат или старую <TT
CLASS="LITERAL"
>clock(8)</TT
>,
 или новую <TT
CLASS="LITERAL"
>hwclock(8)</TT
>,
но не содержат величины коррекции. Так же обычно в них есть программа
<TT
CLASS="LITERAL"
>adjtimex(8)</TT
>, но она может быть включена в CD,
как дополнительное приложение
(или вы можете ее скачать по сети). Некоторые дистрибутивы включают в себя
графическую программу корректировки часов, работающую под X-windows, но все
они предназначены для интерактивного использования, и система все равно
установит <TT
CLASS="LITERAL"
>clock(8)</TT
> или <TT
CLASS="LITERAL"
>hwclock(8)</TT
> для их использования при коррекции в
процессе загрузки.</P
><P
><TT
CLASS="LITERAL"
>Clock(8)</TT
> требует, чтобы вы вычислили величину
коррекции сами, а <TT
CLASS="LITERAL"
>hwclock(8)</TT
>
вычисляет ее автоматически (использование другой программы для коррекции
часов повлечет за собой несовпадение величин, поэтому предпочтительно
использование одной программы, если используется величина коррекции).
Если у вас старая система, которая использует <TT
CLASS="LITERAL"
>clock(8)</TT
>, и вы хотите ее
заменить, то найдите <TT
CLASS="LITERAL"
>hwclock(8)</TT
> в архиве "util-linux" версии 2.7
или более поздней. Посмотрите инструкцию для получения более подробной
информации.</P
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Замечание</DT
><DD
><P
>Инструкция к <TT
CLASS="LITERAL"
>hwclock(8)</TT
> может называться
"<TT
CLASS="LITERAL"
>clock</TT
>" для обеспечения обратной
совместимости, поэтому попробуйте оба имени. <TT
CLASS="LITERAL"
>Hwclock(8)</TT
> будет работать с командами для <TT
CLASS="LITERAL"
>clock(8)</TT
>, но результаты могут различаться, потому что
"<TT
CLASS="LITERAL"
>hwclock -a</TT
>" - это не совсем то же самое, что
и "<TT
CLASS="LITERAL"
>clock -a</TT
>", поэтому я рекомендую при
установке <TT
CLASS="LITERAL"
>hwclock</TT
> заменить все обращения и
ссылки к "<TT
CLASS="LITERAL"
>clock</TT
>", в вашем загрузочном скрипте,
на обращения к <TT
CLASS="LITERAL"
>hwclock</TT
>, используя ее команды.</P
></DD
></DL
></DIV
></P
><P
>Загрузочные скрипты различаются в разных дистрибутивах, поэтому вам
придется поискать то место, где производится коррекция времени. Обычно это
производится в <TT
CLASS="FILENAME"
>/etc/rc.local</TT
>,
<TT
CLASS="FILENAME"
>/etc/rc.d/rc.sysinit</TT
>, <TT
CLASS="FILENAME"
>/etc/rc.d/boot</TT
> и т.п.
Величина коррекции для ЧРВ находится в файле <TT
CLASS="FILENAME"
>/etc/adjtime</TT
>.</P
><P
>Когда вы устанавливаете точное время на часах для определения величины
коррекции, помните, что сигнал по телефонной линии не может быть абсолютно
точным.
&#13;</P
><P
>Если ваши ЧРВ ведут себя странно, то, возможно, у вас проблемы с
оборудованием. Некоторые чипы ЧРВ содержат литиевую батарейку, которая
могла разрядиться, и, поэтому, в некоторых материнских платах есть разъемы
для внешнего источника питания (удостоверьтесь в том, что переключатель
стоит в правильном положении). Эта же батарея питает CMOS RAM, но часы
потребляют больше энергии, и быстрее выходят из строя. Так же
странные результаты могут возникнуть из-за проблем с прерываниями.

&#13;</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN131"
>3.2. Adjtimex(8)</A
></H2
><P
><TT
CLASS="LITERAL"
>Adjtimex(8)</TT
>
 позволяет пользователю изменять в ядре переменные времени, и
таким образом изменять скорость хода системных часов (для этого вы должны
зайти в систему пользователем "<I
CLASS="EMPHASIS"
>root</I
>").
 Очень удобно сравнивать системные
часы с ЧРВ, используя величину коррекции, указанную в
<TT
CLASS="FILENAME"
>/etc/adjtime</TT
>. Таким образом, очень легко корректировать
системные часы, один раз установив величину коррекции ЧРВ. Найдя верное
значение коррекции, вы можете добавить строку в ваш загрузочный скрипт,
выставляющую правильные значения переменных ядра во время загрузки системы.
Так как <TT
CLASS="LITERAL"
>adjtimex(8)</TT
>
 предназначен для работы с <TT
CLASS="LITERAL"
>clock(8)</TT
>
 или <TT
CLASS="LITERAL"
>hwclock(8)</TT
>, то
вам придется немного потрудится для того, чтобы устранить недостаток
"каждых 11 минут".
&#13;</P
><P
>После завершения установки <TT
CLASS="LITERAL"
>adjtimex(8)</TT
>,
вы можете почерпнуть больше
информации, набрав команду "<TT
CLASS="LITERAL"
>man 8 adjtimex</TT
>" (так же есть инструкция к
<TT
CLASS="LITERAL"
>adjtimex(2)</TT
>,
которая, к сожалению, не очень подробна). Можно
прочитать файл <TT
CLASS="LITERAL"
>README</TT
>, расположенный в
<TT
CLASS="FILENAME"
>/usr/doc/adjtimex-1.3/README</TT
> (где номер версии, в указанном
пути, должен соответствовать версии <TT
CLASS="LITERAL"
>adjtimex(8)</TT
>).</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN147"
>3.3. Xntpd и ntpd: сетевой протокол времени (Network Time Protocol)</A
></H2
><P
><TT
CLASS="LITERAL"
>Xntpd</TT
>
(NTPv3) заменено на <TT
CLASS="LITERAL"
>ntpd</TT
> (NTPv4); более ранние версии не поддерживаются.</P
><P
><TT
CLASS="LITERAL"
>Ntpd</TT
>
является стандартной программой, при помощи которой синхронизируют
время в сети. Она поставляется со списком серверов проверки времени. Ее
сложнее установить, чем другие программы, описанные здесь, но если вам это
интересно, то я бы советовал взглянуть на нее. Домашняя страница <TT
CLASS="LITERAL"
>ntpd</TT
>
расположена по адресу <A
HREF="http://www.eecis.udel.edu/~ntp/"
TARGET="_top"
>http://www.eecis.udel.edu/~ntp/</A
>.
Там есть ссылки
на все виды интересующего вас программного обеспечения, связанного с точным
временем (включая программы для других ОС). <TT
CLASS="LITERAL"
>ntpd</TT
> входит в состав некоторых
дистрибутивов.</P
><P
>Сравнительно новая особенность <TT
CLASS="LITERAL"
>ntpd</TT
> - это "моментальный режим",
спроектированный для машин с ограниченным dial-up доступом к сети .</P
><P
><TT
CLASS="LITERAL"
>Ntpd</TT
> включает в себя драйвера к нескольким видом радио-часов. Большинство
радио-часов предназначены для коммерческого использования и стоят тысячи
долларов, но есть и несколько дешевых видов (о них мы поговорим позже).
NIST поддерживает PDF-файл, в котором находится список производителей радио-часов. Он находится по адресу
<A
HREF="http://www.boulder.nist.gov/~timefreq/links.htm"
TARGET="_top"
>http://www.boulder.nist.gov/timefreq/links.htm</A
>
(в самом конце страницы).
Так же на сайтах
<A
HREF="http://www.eecis.udel.edu/~ntp/hardware.htm"
TARGET="_top"
>http://www.eecis.udel.edu/ntp/hardware.htm</A
> и
<A
HREF="http://www.eecis.udel.edu/~mills/ntp/refclock.htm"
TARGET="_top"
>http://www.eecis.udel.edu/~mills/ntp/refclock.htm</A
>
можно найти ссылки на
этих производителей. Любой из этих списков может устареть :-). Список
драйверов <TT
CLASS="LITERAL"
>ntpd</TT
> находится на
<A
HREF="http://www.eecis.udel.edu/~ntp/ntp_spool/html/refclock.htm"
TARGET="_top"
>http://www.eecis.udel.edu/ntp/ntp_spool/html/refclock.htm.</A
>.</P
><P
>В состав <TT
CLASS="LITERAL"
>Ntpd</TT
> входят несколько драйверов некоторых служб точного
времени для работы через dial-up. Это все - очень дальние (скорее всего, международные)
звонки, поэтому сначала подсчитайте во сколько вам это обойдется :-).</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN168"
>3.4. Chrony</A
></H2
><P
><TT
CLASS="LITERAL"
>Xntpd</TT
> изначально был написан для машин с постоянным соединением с сетевыми
радио-часами. Теоретически, она может быть использована машинами,
которые соединяются на короткое время, но Richard Curnow не смог заставить
программу работать так, как он того хотел, поэтому он написал "<TT
CLASS="LITERAL"
>chrony</TT
>"  как
выход для тех из нас, кто соединяется с сетью при помощи dial-up (для
решения этой проблемы существует "моментальное соединение" в <TT
CLASS="LITERAL"
>ntpd</TT
>).
Текущая версия <TT
CLASS="LITERAL"
>chrony</TT
> включает в себя величину коррекции ЧРВ для машин,
отключенных от сети на долгое время.</P
><P
>Вы можете получить больше информации, посетив страницу Richard Curnow на
<A
HREF="http://www.rrbcurnow.freenet.co.uk/chrony/index.html"
TARGET="_top"
>http://www.rrbcurnow.freenet.co.uk/chrony/index.html.</A
>.
Вы можете получить
исходные тексты программы не только там, но и на других Linux-сайтах.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN177"
>4. Радио часы</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN179"
>4.1. CHU и декодер</A
></H2
><P
>CHU - это канадская коротковолновая станция около Оттавы. Она очень похожа
на WWV в США, но с одним важным отличием: в добавление к обычному
объявлению точного времени на английском и французском, она раз в минуту
передает сигналы точного времени, используя старые модемные сигналы "Bell
103" (300 бод). Эти сигналы очень хорошо декодируются, и Bill Rossi
выдвинул идею, что вам не нужен модем, а только радиоприемник и звуковая карта.
Если вам удастся поймать сигнал CHU, то это было бы наиболее дешевым
способом использования радио-часов. Частота приема коротковолновых передач
может меняться в течении дня, но Bill заявляет, что путем настройки частот
дважды в день (утром и вечером) он имеет связь 24 часа в сутки. CHU вещает
на частотах 3.33, 7.335 и 14.670 МГц.</P
><P
>Для получения более подробной информации обратитесь к домашней странице
Bill Rossi по адресу
<A
HREF="http://www.rossi.com/chu/"
TARGET="_top"
>http://www.rossi.com/chu/</A
>.
 Исходный файл вы можете
найти на архивных сайтах Linux. Для получения информации о службе времени
на CHU загляните на
<A
HREF="http://www.nrc.ca/inms/time/ctse.html"
TARGET="_top"
>http://www.nrc.ca/inms/time/ctse.html</A
>.</P
><P
>Сайт NTP собирается поставить "декодер" для расшифровки сигналов времени
CHU или любого другого коротковолнового канала, используя недорогую
микросхему 300-бод на
<A
HREF="http://www.eecis.udel.edu/~ntp/ntp_spool/html/gadget.htm"
TARGET="_top"
>http://www.eecis.udel.edu/ntp/ntp_spool/html/gadget.htm</A
>.
Там можно
найти принципиальную схему двухсторонней платы, которую легко
сделать самому (или попросить кого-либо помочь).</P
><P
><TT
CLASS="LITERAL"
>Ntpd</TT
> включает в себя драйвер для приема CHU, который работает и с
"<TT
CLASS="LITERAL"
>декодерами</TT
>" такого типа , или посылает сигнал на вход микрофона на Sun
SPARCstation (или другой машины с "совместимыми аудио-драйверами").</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN190"
>4.2. WWV и "Most Accurate Clock"</A
></H2
><P
>Возможно, вы уже слышали о Heathkit's "Most Accurate Clock", которые
получают и расшифровывают сигнал с WWV и имеют дополнительный
последовательный порт для подключения к компьютеру. Heathkit давно перестал
их продавать, но их еще можно было приобрести до 1995 года. Если желаете
окунуться в атмосферу Heathkit, загляните на
<A
HREF="http://www.heathkit-museum.com"
TARGET="_top"
>http://www.heathkit-museum.com</A
>.
 Компания Heathkit до сих пор существует и
продает образовательную литературу. Взгляните на
<A
HREF="http://www.heathkit.com"
TARGET="_top"
>http://www.heathkit.com</A
>.</P
><P
>По информации Dave Mills, патент Heathkit на "Most Accurate Clock" скоро
закончится, и, возможно, кто-то захочет сделать нечто подобное на отдельной
микросхеме.</P
><P
>На сайте NTP находится DSP-программа (и файл PDF, ее описывающий)
<A
HREF="http://www.eecis.udel.edu/~mills/resource.htm"
TARGET="_top"
>http://www.eecis.udel.edu/mills/resource.htm</A
>
, которая расшифровывает
сигналы точного времени с WWV, используя коротковолновой радиопередатчик и
TAPR/AMSAT DSP-93. Это очень редкий DSP-прибор. Он основан на микросхеме
Texas Instruments TMS320C25 DSP. Веб-сайт TAPR находится по адресу
<A
HREF="http://www.tapr.org"
TARGET="_top"
>http://www.tapr.org</A
>
 и содержит много информации по системам такого рода.&#13;</P
><P
><TT
CLASS="LITERAL"
>Ntpd</TT
>
также и драйвер для кодов точного времени IRIG-B и IRIG-E ,
использующий <TT
CLASS="FILENAME"
>/dev/audio</TT
> на Sun SPARCstation, с пометкой, что
эта программа вполне подходит для других систем. WWV использует код IRIG-H.</P
><P
>WWV используется NIST, вебсайт которых находится по адресу
<A
HREF="http://www.boulder.nist.gov/timefreq/index.html"
TARGET="_top"
>http://www.boulder.nist.gov/timefreq/index.html</A
>.
 Этот сайт содержит текст
"Special Publication 432", который описывает их службу точного времени,
расположенную по адресу
<A
HREF="http://www.boulder.nist.gov/timefreq/pubs/sp432/sp432.htm"
TARGET="_top"
>http://www.boulder.nist.gov/timefreq/pubs/sp432/sp432.htm</A
>.
WWV вещает на 2.5, 5, 10, 15, и 20 Mhz.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN205"
>4.3. GPS и "Totally Accurate Clock"</A
></H2
><P
>Сигналы GPS включают в себя точное время. В некоторые приемники GPS
встроены последовательные порты. <TT
CLASS="LITERAL"
>Ntpd</TT
> содержит драйвера для некоторых таких
приемников. Системе 1PPS ("One Pulse Per Second", требуется для высокой
точности) требуется отдельный интерфейс для подключения к компьютеру.</P
><P
>TAPR (Tuscon Amateur Packet Radio) делает приспособления "TAC-2" ("Totally
Accurate Clock") для интерфейсов, которые встраиваются в  последовательный
порт и работают с любым приемником GPS. Таким образом вы можете получить на
выходе 1PPS. Некоторые модели могут быть установлены непосредственно на
плату. Для получения более подробной информации загляните на
<A
HREF="http://www.tapr.org"
TARGET="_top"
>http://www.tapr.org</A
>.
Цена (на июнь 1999) составляет около $140, не включая
стоимость приемника GPS. В комплект поставки не входят какие-либо средства
установки оборудования.</P
><P
>"Декодер"  CHU  (описанный в другой главе) может использоваться как
интерфейс к сигналам 1PPS. Эта проблема обсуждается на сайте NTP по адресу
<A
HREF="http://www.eecis.udel.edu/~ntp/ntp_spool/html/pps.htm"
TARGET="_top"
>http://www.eecis.udel.edu/ntp/ntp_spool/html/pps.htm</A
>.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN213"
>4.4. Низкочастотные сигналы точного времени: DCF77, MSF(Rugby), WWVB</A
></H2
><P
>Эти низкочастотные станции передают сигнал точного времени, путем включения
и отключения модуляции. Каждая станция использует собственную схему кодов,
и их описание можно найти на сервере NTP

<A
HREF="http://www.eecis.udel.edu/~mills/ntp/index.htm"
TARGET="_top"
>http://www.eecis.udel.edu/mills/ntp/index.htm</A
>
(в конце страницы). DCF77 в
Германии вещает на частоте 77.5 кГц. MSF в Англии (называемая
"Rugby") и WWVB в Колорадо вещают на частоте 60 кГц.</P
><P
>Дорогие приемники, встроенные в последовательный порт, получили
распространение в Европе. В <TT
CLASS="LITERAL"
>Ntpd</TT
> есть драйверы для некоторых
MSF-приемников.&#13;</P
><P
>В США есть много компаний, которые продают относительно дорогие приемники
WWVB со встроенными радио-часами (включая несколько с настенными часами),
но меня интересуют только две модели, которые могут быть подключены к
компьютеру:&#13;</P
><P
>Ultralink Model 320 стоит примерно $120 (на июнь 1999). В нем имеется
последовательный интерфейс, и он может управляться кодами ASCII, поэтому его
не так сложно запрограммировать. Он потребляет 1mA с последовательного
порта. Антенна может находиться на расстоянии до 30 метров от компьютера.
Блок содержит свои собственные часы, сохраняющие время, если
радиосигнал будет утерян. Выпускается и упрощенная версия за $80. Она
предназначена для использования с последовательными микроконтроллерами
"BASIC Stamp".
Взгляните на
<A
HREF="http://www.ulio.com/timepr.html"
TARGET="_top"
>http://www.ulio.com/timepr.html</A
>.&#13;</P
><P
>Arcron Technology продает за $130 настольные часы с дополнительным
последовательным портом, вместе с программным обеспечением для  Windows.
Взгляните на
<A
HREF="http://www.arctime.com"
TARGET="_top"
>http://www.arctime.com</A
></P
><P
>Уверенность приема WWVB может различаться. Станция обещает увеличить свою
мощность в ближайшем будущем. Вы можете ознакомится с этой информацией на
сайте NIST
<A
HREF="http://www.boulder.nist.gov/timefreq/wwvstatus.html"
TARGET="_top"
> http://www.boulder.nist.gov/timefreq/wwvstatus.html</A
>.
&#13;</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN226"
>5. Подробная инструкция к clock(8)</A
></H1
><P
>Эта глава сделана на основе предыдущей версии мини-HOWTO и предназначена
для тех, кто использует <TT
CLASS="LITERAL"
>clock(8)</TT
>. Все, что вам надо знать, находится в
инструкции.
&#13;</P
><P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>Замечание</DT
><DD
><P
>Вы должны зайти в систему в качестве пользователя <I
CLASS="EMPHASIS"
>root</I
>
для того, чтобы
запустить "<TT
CLASS="LITERAL"
>clock</TT
>", или другую программу, затрагивающую системное время или
ЧРВ.&#13;</P
></DD
></DL
></DIV
></P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN238"
>5.1. Проверка настроек</A
></H2
><P
>Проверьте ваши загрузочные файлы на наличие команд типа "<TT
CLASS="LITERAL"
>clock -a</TT
>"
или
"<TT
CLASS="LITERAL"
>clock -ua</TT
>".
 В зависимости от дистрибутива, они могут находиться в
<TT
CLASS="FILENAME"
>/etc/rc.local</TT
>, или <TT
CLASS="FILENAME"
>/etc/rc.d/rc.sysinit</TT
> или
где-нибудь рядом.</P
><P
>Если в строке написано "<TT
CLASS="LITERAL"
>clock -s</TT
>"
 или "<TT
CLASS="LITERAL"
>clock -us</TT
>", смените  "<TT
CLASS="LITERAL"
>s</TT
>" на "<TT
CLASS="LITERAL"
>a</TT
>", и
посмотрите, есть ли у вас файл <TT
CLASS="FILENAME"
>/etc/adjtime</TT
>, который содержит
строку типа:

<PRE
CLASS="SCREEN"
>0.000000 842214901 0.000000</PRE
>&#13;</P
><P
>Эти числа являются величиной коррекции (в секундах за день), время, когда
была произведена последняя коррекция (в секундах с 1 января, 1970), и часть
секунды, которая была округлена последний раз. Если у вас нет этого файла,
зайдите как пользователь <I
CLASS="EMPHASIS"
>root</I
> и создайте его. В нем должна быть лишь одна
строка, содержащая нули:
<PRE
CLASS="SCREEN"
>0.0 0 0.0</PRE
>
&#13;</P
><P
>Затем запустите  "<TT
CLASS="LITERAL"
>clock -a</TT
>" или "<TT
CLASS="LITERAL"
>clock -ua</TT
>" вручную из командной строки для
того, чтобы установить 2-ое число (используйте "<TT
CLASS="LITERAL"
>u</TT
>", если ваши часы
показывают универсальное время, вместо местного).</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN259"
>5.2. Измерение величины коррекции</A
></H2
><P
>Для начала вам надо узнать, который час <TT
CLASS="LITERAL"
>:-)</TT
>.
Мой любимый способ - позвонить на WWV по телефону (303)499-7111 (это
дорого). Если у вас есть доступ к серверу точного времени, вы можете
воспользоваться программой <TT
CLASS="LITERAL"
>ntpdate</TT
>, входящей
в приложение <TT
CLASS="LITERAL"
>xntpd</TT
>
 (поставьте флажок <TT
CLASS="LITERAL"
>-b</TT
> для того, чтобы ядро не сверяло
системное время с ЧРВ). Иначе используйте "<TT
CLASS="LITERAL"
>date -s
hh:mm:ss</TT
>" для установки
времени вручную, а затем выполните  "<TT
CLASS="LITERAL"
>clock -w</TT
>" для того, чтобы
синхронизировать ЧРВ с системными часами. Вам потребуется знать, когда вы
последний раз устанавливали время на часах, поэтому запишите эту информацию
туда, где вы ее не потеряете. Если вы используете <TT
CLASS="LITERAL"
>ntpdate</TT
>, напишите  "<TT
CLASS="LITERAL"
>date +%s</TT
>" и запишите число секунд,
прошедших с 1 января 1970 года.</P
><P
>Затем зайдите в систему несколько дней спустя и посмотрите на сколько
отклонились ваши часы. Если вы устанавливаете часы вручную, я бы
посоветовал подождать две недели и высчитать отклонение в сек/день.
После нескольких месяцев высчитайте отклонение в долях секунд за день. Если
вы используете <TT
CLASS="LITERAL"
>ntpdate</TT
>, то вам придется долго ждать. Но позже можно их
точно настроить.</P
><P
>Активируйте синхронизацию "<TT
CLASS="LITERAL"
>clock -a</TT
>" через некоторые промежутки
времени для того, чтобы время на системных часах и ЧРВ не различалось. Эта
команда также будет выполнятся каждый раз при запуске системы. Если вы
делаете это часто, то этого будет достаточно для синхронности.</P
><P
>Помните, что в некоторых программах может произойти сбой, если коррекция
часов произойдет более, чем на секунду, или, если время будет
скорректировано назад. Если возникли подобные проблемы, то
используйте <TT
CLASS="LITERAL"
>xntpd</TT
> или
 <TT
CLASS="LITERAL"
>ntpdate</TT
> для более плавной корректировки.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN277"
>5.3. Пример</A
></H2
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="AEN279"
>5.3.1. Как установить время</A
></H3
><P
>Зайдите как пользователь <I
CLASS="EMPHASIS"
>root</I
>.
 Наберите (303)499-7111 (голос), прослушайте
сигналы. Затем напишите:
<PRE
CLASS="SCREEN"
>date -s hh:mm:ss</PRE
>

но не нажимайте Enter, пока не услышите сигнала. (вы можете воспользоваться
"<TT
CLASS="LITERAL"
>ntpdate</TT
>", вместо "<TT
CLASS="LITERAL"
>date</TT
>",
 и не звонить в этом случае) Эта команда
устанавливает системное время. Затем напишите:
<PRE
CLASS="SCREEN"
>clock -w</PRE
>

Эта команда устанавливает ЧРВ по системному времени. Затем наберите:

<PRE
CLASS="SCREEN"
>date +%j</PRE
>

(или "<TT
CLASS="LITERAL"
>date +%s</TT
>",
 если вы используете  "<TT
CLASS="LITERAL"
>ntpdate</TT
>" вместо "<TT
CLASS="LITERAL"
>date</TT
>" ) и запишите
число, которое вам понадобится в следующий раз.&#13;</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN291"
>5.3.2. Как переустановить время и изменить величину коррекции</A
></H3
><P
>Найдите дату, когда вы последний раз устанавливали часы. Зайдите как
пользователь <I
CLASS="EMPHASIS"
>root</I
> и напишите:

<PRE
CLASS="SCREEN"
>clock -a</PRE
>
Это синхронизирует системное время по ЧРВ. Позвоните по телефону (303)499-7111 (голос), наберите:

<PRE
CLASS="SCREEN"
>date</PRE
>
и нажмите ввод, когда услышите сигнал. Пока вы ждете, запишите точное время. Затем наберите

<PRE
CLASS="SCREEN"
>date hh:mm:00</PRE
>
напишите время на одну минуту вперед и нажмите ввод, когда опять услышите
сигнал. Для графы <TT
CLASS="LITERAL"
>hh</TT
>
 поставьте местное время. Итак, вы установили системное
время. Теперь наберите:

<PRE
CLASS="SCREEN"
>clock -w</PRE
>
эта команда поставит правильное время в ЧРВ. Напишите:

<PRE
CLASS="SCREEN"
>date +%j</PRE
>

(или "<TT
CLASS="LITERAL"
>date +%s</TT
>" в случае прежде описанном)&#13;</P
><P
>Теперь у вас есть все для того, чтобы определить величину коррекции.&#13;</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN303"
>5.3.3. Как вычислить величину коррекции</A
></H3
><P
>Когда вы запускаете "<TT
CLASS="LITERAL"
>date</TT
>",
определите, забежали ли ваши часы вперед, или
они отстают? Если забежали, то придется вычесть несколько секунд,
то есть написать их со знаком минус. Если они отставали, то вам придется
добавить секунды, то есть записать их с положительным знаком.&#13;</P
><P
>Теперь вычтите одну дату из другой. Если использована команда "<TT
CLASS="LITERAL"
>date
+%j</TT
>", то числа - это дни в году (1-365, или 1-366 в високосном). Если вы
использовали команду "<TT
CLASS="LITERAL"
>date +%s</TT
>" ,
то это число в секундах, и вы должны
разделить его на 86400, чтобы получить дни.&#13;</P
><P
>Если у вас уже есть величина коррекции в <TT
CLASS="FILENAME"
>/etc/adjtime</TT
>, то
откорректируйте ее в зависимости от полученного результата.
Умножьте старую величину на количество дней и прибавьте новую величину.
&#13;</P
><P
>Затем разделите количество секунд на дни, и получите новую величину
коррекции, которую надо записать вместо старой в <TT
CLASS="FILENAME"
>/etc/adjtime</TT
>. Запишите количество дней для следующего раза.
&#13;</P
><P
><TT
CLASS="FILENAME"
>/etc/adjtime</TT
> выглядит примерно так:


<PRE
CLASS="SCREEN"
>-9.600000 845082716 -0.250655</PRE
>

(заметьте, 9.6 секунд в день это почти 5 минут в месяц!)</P
></DIV
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN317"
>6. Авторские права</A
></H1
><P
>Авторские права на русский перевод этого текста принадлежат &copy; 2000 SWSoft Pte Ltd.
Все права зарезервированы.</P
><P
>Этот документ является частью проекта Linux HOWTO.</P
><P
>Авторские права на документы Linux HOWTO принадлежат их авторам, если явно
не указано иное. Документы Linux HOWTO, а также их переводы, могут
быть воспроизведены и распространены полностью или частично на любом
носителе физическом или электронном, при условии сохранения этой заметки об
авторских правах на всех копиях. Коммерческое распространение разрешается и
поощряется; но так или иначе автор текста и автор перевода желали бы знать о
таких дистрибутивах.</P
><P
>Все переводы и производные работы, выполненные по документам Linux HOWTO
должны сопровождаться этой заметкой об авторских правах. Это делается в
целях предотвращения случаев наложения дополнительных ограничений на
распространение документов HOWTO. Исключения могут составить случаи
получения специального разрешения у координатора Linux HOWTO с которым
можно связаться по адресу приведенному ниже.</P
><P
>Мы бы хотели распространить эту информацию по всем возможным каналам. Но
при этом сохранить авторские права и быть уведомленными о всех планах
распространения HOWTO. Если у вас возникли вопросы, пожалуйста, обратитесь
к координатору проекта Linux HOWTO по электронной почте:
<TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:linux-howto@metalab.unc.edu"
>linux-howto@metalab.unc.edu</A
>&#62;</TT
>, или к координатору русского
перевода Linux HOWTO компании SWSoft Pte Ltd. по адресу
<TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:linux-howto@asplinux.ru"
>linux-howto@asplinux.ru</A
>&#62;</TT
></P
></DIV
></DIV
></BODY
></HTML
>