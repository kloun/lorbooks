<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE>NFS HOWTO: Безопасность и NFS</TITLE>
 <LINK HREF="NFS-HOWTO-7.html" REL=next>
 <LINK HREF="NFS-HOWTO-5.html" REL=previous>
 <LINK HREF="NFS-HOWTO.html#toc6" REL=contents>
</HEAD>
<BODY>
<A HREF="NFS-HOWTO-7.html">Следующий</A>
<A HREF="NFS-HOWTO-5.html">Предыдущий</A>
<A HREF="NFS-HOWTO.html#toc6">Содержание</A>
<HR>
<H2><A NAME="nfs-security"></A> <A NAME="s6">6. Безопасность и NFS</A></H2>

<P>Я ни коим образом не являюсь экспертом в области компьютерной
безопасности. Но у меня есть <EM>маленький</EM> совет для сознающих проблему
безопасность. Но будьте предупреждены: этот список ни в коем случае не
является полным списком проблем относящихся к NFS, и если вы думаете, что
вы обезопасились один раз прочитав и выполнив, все что я даю здесь, то я
хочу предупредить вас.
<P>
<P>Этот раздел не должен беспокоить вас, если вы находитесь в <EM>закрытой</EM>
сети, где вы доверяете всем пользователям, и никто из тех кому вы не
доверяете ни может получить доступ к машинам в сети. Например, не должно
быть dial-соединения в сеть, и не должно быть никакого способа подключиться
к сети, в которой вы есть люди, которым вы не доверяете. Вы думаете я
параноик? Я не параноик. Это базовый совет по
безопасности. <EM>Безопасность</EM> требует наличия тщательного и знающего
администратора, который знает где найти информацию о текущих и
потенциальных проблемах безопасности.
<P>
<P>Основная проблема NFS в том, что клиент, если не задано, будет доверять
серверу и наоборот. Это может быть плохо. Это значит, что если запись
администратора сервера NFS взломана, то также легко может быть взломана
запись администратора клиентской машины. И наоборот. Существует набор
полицейских стратегий для этого, мы к ним еще вернемся.
<P>
<P>Что вам необходимо прочитать&nbsp;-- это консультационные материалы CERT
относящиеся к NFS. Большинство текстов приведенных ниже, связаны с
советами, написанными в выпусках CERT. Смотрите 
<A HREF="ftp://ftp.cert.org/01-README">ftp.cert.org/01-README</A> для
обновленного списка консультативных материалов CERT. Здесь приведены
некоторые относящиеся к NFS консультативные материалы:
<P>
<HR>
<PRE>
CA-91:21.SunOS.NFS.Jumbo.and.fsirand                            12/06/91
     Уязвимость в отношении сетевой файловой системы (NFS) Sun
     Microsystems, Inc. (Sun) и программы fsirand. Эта уязвимость
     возможна в версиях SunOS 4.1.1, 4.1, and 4.0.3 на всех
     архитектурах. Заплатки (Patches) доступны для SunOS
     4.1.1. Также доступна начальная заплатка для SunOS 4.1 NFS. Sun
     будет обеспечит полные заплатки для SunOS 4.1 и SunOS 4.0.3 позже.

CA-94:15.NFS.Vulnerabilities                                    12/19/94
     Этот консультационный материал обеспечивает измерение
     безопасности для охраны против против некоторых дыр в безопасности
     в сетевой файловой системе (NFS). Этот материал выпущен в связи с
     увеличением случаев взлома машин, используя утилиты для
     взлома через уязвимые точки.

CA-96.08.pcnfsd                                                 04/18/96
     Этот материал описывает проблемы с безопасностью в программе pcnfsd
     (также известной как rpc.pcnfsd). Заплатка для исправления ошибки
     прилагается. 
</PRE>
<HR>
<P>
<H2><A NAME="ss6.1">6.1 Безопасность клиента</A>
</H2>

<P>На клиентской стороне мы можем решить, что мы не хотим слишком сильно
доверять серверу. Это делается несколькими способами, используя опции
монтирования. Например, мы можем запретить выполнение программ с
установленным битом suid в файловой системе NFS, это делается опцией
монтирования <CODE>nosuid</CODE>. Это хорошая идея и вы должны рассмотреть ее,
используя смонтированные через NFS файловые системы. Это означает, что
администратор сервера не сможет сделать программы с установленным
suid-администратора на файловой системе, затем войти на машину клиента как
обычный пользователь и используя программу с suid-администратора приобрести
также права администратора на машине клиента. Мы также можем запретить
выполнение файлов на смонтированной файловой системе с помощью опции
<CODE>noexec</CODE>. Но она применяется реже по сравнению с опцией <CODE>nosuid</CODE>,
поскольку файловая система может содержать по крайней мере <EM>некоторые</EM>
скрипты, или программы, которые необходимо выполнять. Вы можете ввести эти
опции в колонке опций вместе с опциями <CODE>rsize</CODE> и <CODE>wsize</CODE>, разделяя их
запятыми.
<P>
<H2><A NAME="ss6.2">6.2 Безопасность сервера: nfsd</A>
</H2>

<P>На стороне сервера мы можем решить, что мы не хотим доверять
администратору клиента. Мы можем сделать это указав опцию root_squash в
файле exports:
<P>
<HR>
<PRE>
/mn/eris/local apollon(rw,root_squash)
</PRE>
<HR>
<P>
<P>Теперь, если пользователь с UID 0 на стороне клиента попытается получить
доступ (чтение, запись, удаление), то файловый сервер выполнит подстановку
UID пользователя `nobody' на сервере. Это означает, что администратор
клиента не сможет получить доступ или изменять файлы, которые может
изменять или иметь доступ к которым может только администратор сервера. Это
хорошо и вы должны использовать опцию <CODE>root_squash</CODE> на всех
экспортируемых файловых системах. Вы скажете, что "Администратор клиента
все равно может выполняить команду 'su', чтобы зайти как любой другой
пользователь и получить доступ и изменить любые пользовательские файлы". На
это есть ответ: "Да есть такой способ, и это работает в Unix и NFS. Это
имеет одно важное заключение: Все важные файлы и программы должны иметь
владельцем пользователя <CODE>root</CODE>, а не пользователя <CODE>bin</CODE> или другого
пользователя не-администратора, поскольку только администратор клиента не
может получить доступ как администратор сервера. С справочной странице NFSd
есть несколько других подобных опций, так что вы можете решить, что вы (не)
доверяете кому-либо со стороны клиента. У вас также имеются опции для
осечения любых диапазонов UID и GID. Это описывается в справочной странице
Linux NFSd.
<P>
<P>Опция root_squash является установленной по умолчанию для NFSd в Linux,
для передачи администраторских полномочий для доступа к файловой системе
используйте опцию <CODE>no_root_squash</CODE>.
<P>
<P>Другая важная вещь, которую необходимо сделать, это проверить, что nfsd
проверяет, все ли запросы приходят с привелигированного порта. Если он
принимает запросы с любого старого порта на клиенте, то пользователь без
специальных привилегий может запустить программу, которую легко получить по
Internet. Он умеет "говорить" на языке протокола nfs и будет притворяться,
что пользователь является любым пользователем, которым он хочет быть. NFSD
на Linux делает эту проверку по умолчанию, но для других операционных
систем вы должны разрешить эту проверку сами. Это должно быть описано в
справочной странице nfsd для вашей операционной системы.
<P>
<P>Другая вещь. Никогда не экспортируйте файловую систему для машины с
именем 'localhost' или 127.0.0.1. Доверяйте мне.
<P>
<H2><A NAME="ss6.3">6.3 Безопасность сервера: portmapper</A>
</H2>

<P>Основа portmapper, в соединении с nfsd имеет проблему в проектировании,
которая делает возможной получить файлы с серверов NFS без каких-либо
привилегий. К счастью portmapper используемый в большинстве дистрибутивов
Linux использует относительную безопасность против такой атаки, и может
быть сделано более безопасной настройкой списка доступа в двух файлах.
<P>
<P>Не все дистрибутивы Linux обладают равными возможностями. Некоторые
дистрибутивы, которые кажутся современными, <EM>не</EM> включают в свой состав
безопасный вариант программы portmapper, даже сейчас, через много лет после
того как стало известно о ее уязвимостях. По крайней мере один дистрибутив
даже содержит справочную страницу более безопасного portmapper, но на самом
деле его portmapper <EM>не является</EM> безопасным. Самым легким способом
проверить является ли ваш portmapper хорошим или нет, является запуск
программы strings(1) и просмотр ее вывода на наличие файлов,
<CODE>/etc/hosts.deny</CODE> и <CODE>/etc/hosts.allow</CODE>.  Предполагая, что ваш
portmapper находится <CODE>/usr/sbin/portmap</CODE>, вы можете проверить это
выполнив следующую команду: <CODE>strings /usr/sbin/portmap | grep
hosts</CODE>.  на моей машине это выполнилось со следующими результатами:
<P>
<HR>
<PRE>
/etc/hosts.allow
/etc/hosts.deny
@(#) hosts_ctl.c 1.4 94/12/28 17:42:27
@(#) hosts_access.c 1.20 96/02/11 17:01:27
</PRE>
<HR>
<P>
<P>Сначала мы отредактируем файл <CODE>/etc/hosts.deny</CODE>. Он должен
содержать строку
<P>
<HR>
<PRE>
portmap: ALL
</PRE>
<HR>
<P>
<P>которая запретит доступ <EM>всем</EM>. Поскольку это закрыло доступ всем,
запустите <CODE>rpcinfo -p</CODE> просто для проверки того, что ваш portmapper
читает этот файл и выполняет данные инструкции. Команда rpcinfo не должна
ничего вывести или должна выдать сообщение об ошибке. Перезапуск portmapper
<EM>не</EM> является необходимым.
<P>
<P>Закрытие portmap для всех может быть слишком кардинальным, поэтому мы
снова откроем доступ, изменив файл <CODE>/etc/hosts.allow</CODE>. Но
сначала нам надо определить, что мы туда поместим. В этом файле
перечисляются все машины, которые могут получить доступ к вашему
portmapper. Среди множества работающих под Linux систем только некоторым
машинам нужен полный доступ для любой работы. Portmapper обслуживает nfsd,
mountd, ypbind/ypserv, pcnfsd, и 'r' сервисы, такие как ruptime и
rusers. Из них только nfsd, mountd, ypbind/ypserv и возможно pcnfsd имеют
какое-либо важное значение. Всем машинам, которым необходим доступ к
сервисам на вашей машине должно быть разрешено делать это. Скажем адрес
машины равен 129.240.223.254 и она находится в подсети 129.240.223.0, и ей
нужен доступ к сервисам на вашей машине (эти термины введены HOWTO по
сетям, вернитесь к нему и освежите свои знания, если это необходимо). Для
этого мы напишем в файле <CODE>hosts.allow</CODE>
<P>
<HR>
<PRE>
portmap: 129.240.223.0/255.255.255.0
</PRE>
<HR>
<P>Это тоже самое, что и сетевой адрес, который вы даете командой route и
маска подсети, которую вы передаете команде ifconfig. Для устройства
<CODE>eth0</CODE> на этой машине <CODE>ifconfig</CODE> должен показывать
<P>
<HR>
<PRE>
...
eth0      Link encap:10Mbps Ethernet  HWaddr 00:60:8C:96:D5:56
          inet addr:129.240.223.254  Bcast:129.240.223.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:360315 errors:0 dropped:0 overruns:0
          TX packets:179274 errors:0 dropped:0 overruns:0
          Interrupt:10 Base address:0x320 
...
</PRE>
<HR>
<P>а программа <CODE>netstat -rn</CODE> должна показывать
<P>
<HR>
<PRE>
Kernel routing table
Destination     Gateway         Genmask         Flags Metric Ref Use    Iface
...
129.240.223.0   0.0.0.0         255.255.255.0   U     0      0   174412 eth0
...
</PRE>
<HR>
<P>(Сетевой адрес находится в первой колонке).
<P>Файлы <CODE>hosts.deny</CODE> и <CODE>hosts.allow</CODE> описаны в справочных страницах с
теми же именами. 
<P>
<P><B>ВАЖНО:</B> <EM>Не</EM> помещайте в этих файлах <EM>ничего</EM>, кроме <EM>IP
НОМЕРОВ</EM> в строках для настройки portmap. Поиск имен машин может вызвать
активность portmap, которая вызовет поиск имен машин, которое вызовет
portmap, которое вызовет...
<P>
<P>Вышеприведенные вещи должны вызвать переключение вашего
сервера. Остающаяся проблема в том, что кто-то взломает администратора (или
загрузит MS-DOS) на машине, которой доверяют и использует эти привилегии
для посылки запросов на безопасный порт, как любой пользователь, которым он
захочет быть.
<P>
<H2><A NAME="security-firewalls"></A> <A NAME="ss6.4">6.4 NFS и firewall</A>
</H2>

<P>Очень хорошая идея защитить порты nfs и portmap с помощью firewall на
вашем маршрутизаторе. Nfsd работает на порту 2049, используя оба
протокола&nbsp;-- udp и tcp. Portmapper работает на порту 111, tcp и udp, а
mountd работает на портах 745 и 747, tcp и udp. По умолчанию. Вы должны
проверить номера используемых портов, используя команду <CODE>rpcinfo -p</CODE>.
<P>
<P>Если вы хотите использовать NFS сквозь firewall, то есть опции для новых 
версий NFSd и mountd, для того, чтобы заставить их использовать
нестандартные порты, которые могут быть открыты в firewall.
<P>
<H2><A NAME="security-summary"></A> <A NAME="ss6.5">6.5 Резюме</A>
</H2>

<P>Если вы используете hosts.allow/deny, root_squash, nosuid и
привилегированные порты в программном обеспечении portmapper/nfs, то вы
можете избежать известных ошибок в nfs и можете чувствовать себя почти в
безопасности. Но все равно: когда взломщик имеет доступ к вашей сети, то
он/она может добавить странные команды в ваш файл <CODE>.forward</CODE> или
почтовый ящик, когда <CODE>/home</CODE> или <CODE>/var/spool/mail</CODE>
смонтирован через NFS. По той же причине, вы никогда не должны осуществлять
доступ к вашим личным ключам PGP через nfs. Или по крайней мере вы должны
знать какой риск существует. И знать о нем хотя бы немного.
<P>
<P>NFS и portmapper создают комплексную систему и поэтому не полностью
невероятно,что новые ошибки будут найдены, либо в основе проекта, либо в
реализации, которую мы используем. Также могут быть известные дыры, которые
кто-нибудь использует. Но такова жизнь. Чтобы быть в курсе таких вещей, вы
должны как минимум читать группы новостей 
<A HREF="news:comp.os.linux.announce">comp.os.linux.announce</A> и 
<A HREF="news:comp.security.announce">comp.security.announce</A>.
<P>
<HR>
<A HREF="NFS-HOWTO-7.html">Следующий</A>
<A HREF="NFS-HOWTO-5.html">Предыдущий</A>
<A HREF="NFS-HOWTO.html#toc6">Содержание</A>
</BODY>
</HTML>
