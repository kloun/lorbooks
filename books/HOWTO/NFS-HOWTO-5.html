<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE>NFS HOWTO: NFS через медленные линии</TITLE>
 <LINK HREF="NFS-HOWTO-6.html" REL=next>
 <LINK HREF="NFS-HOWTO-4.html" REL=previous>
 <LINK HREF="NFS-HOWTO.html#toc5" REL=contents>
</HEAD>
<BODY>
<A HREF="NFS-HOWTO-6.html">Следующий</A>
<A HREF="NFS-HOWTO-4.html">Предыдущий</A>
<A HREF="NFS-HOWTO.html#toc5">Содержание</A>
<HR>
<H2><A NAME="slow-lines"></A> <A NAME="s5">5. NFS через медленные линии</A></H2>

<P>Медленные линии включают в себя модемы, ISDN и другие соединения на
дальние расстояния.
<P>
<P>Этот раздел базируется на знании об используемых протоколах, а не на
настоящих экспериментах. Пожалуйста дайте мне знать, если вы попробуете
сделать это :-)
<P>
<P>Первая вещь которую вы должны помнить, что NFS&nbsp;-- медленный
протокол. Использование NFS в большинстве своем подобно использованию
протокола kermit для переноса файлов. Это&nbsp;-- <EM>медлено</EM>. Почти все
быстрее чем NFS.  FTP быстрее. HTTP быстрее.  rcp быстрее. ssh быстрее.
<P>
<P>Вы все еще хотите попробовать его в работе? Ok.
<P>
<P>Параметры по умолчанию для NFS установлены для довольно быстрых линий с
малым временем запаздывания. Если вы будете использовать эти настройки для
линий с высоким временем запаздывания, то это приведет к выдаче сообщений
об ошибках, прерыванию операций, система может притворяться, что файлы
короче, чем они есть на самом деле и странно работать в других случаях.
<P>
<P>Первое, что вам необходимо сделать&nbsp;-- это <EM>не</EM> использовать
опцию монтирования <CODE>soft</CODE>. Это вызовет возвращение программному
обеспечению сигналов об ошибках при таймаутах. В основном обычное
программное обеспечение не слишком хорошо обрабатывает такие ошибки. Это
хороший способ получить странные сбои. Вместо этого используйте опцию
монтирования <CODE>hard</CODE>. Когда активна опция <CODE>hard</CODE>, то таймауты вызывают
бесконечные попытки возобновления вместо прерывания работы ваших
программ. Это то, что вам действительно нужно.
<P>
<P>Следующая вещь, которую нужно сделать&nbsp;-- это поэкспериментировать с
опциями монтирования <CODE>timeo</CODE> и <CODE>retrans</CODE>. Они описаны в
справочной странице nfs(5), здесь приводится выдержка из нее:
<P>
<HR>
<PRE>
       timeo=n        Величина в десятых долях секунды до посылки
                      первой ретрансляции после таймаута RPC. По
                      умолчанию эта величина равна 7 десятых
                      секунды. После первого таймаута, время таймаута
                      удваивается после каждого таймаута, пока не
                      будет достигнута величина максимального таймаута 
                      равна 60 секундам, или произойдет достаточно
                      ретрансляции, вызвав главный таймаут. Затем если 
                      файловая система смонтирована с опцией hard, то
                      каждый новый таймаут каскадно запускается с
                      начальным значением в два раза больше, чем при
                      предыдущем каскаде, кроме того удваиваясь на
                      каждой ретрансляции. Максимальный таймаут всегда 
                      равен 60 секундам. Наилучшая общая
                      производительность может быть достигнута
                      увеличением таймаута при монтировании на
                      загруженной сети, к медленному серверу, или
                      сквозь несколько маршрутизаторов.

       retrans=n      Эта величина задает количество неосновных
                      таймаутов и ретрансляций, которые должны
                      произойти до возникновения главного таймаута. По 
                      умолчанию эта величина равна 3. Когда возникает
                      главный таймаут, то файловые операции либо
                      прерываются или на консоли печатается сообщение 
                      "server  not responding".
</PRE>
<HR>
<P>
<P>Другими словами: Если запрос не будет передан за таймаут равный 0.7
секунды (700ms), то клиент NFS повторит запрос и увеличит таймаут в два
раза, до 1.4 секунды. Если ответ не придет в течении 1.4 секунды, то запрос
повторится снова и таймаут будет увеличен до 2.8 секунды.
<P>
<P>Скорость линии может быть измерена с помощью команды ping с размером
пакета равным значению, установленному опциями rsize/wsize.
<P>
<HR>
<PRE>
$ ping -s 8192 lugulbanda
PING lugulbanda.uio.no (129.240.222.99): 8192 data bytes
8200 bytes from 129.240.222.99: icmp_seq=0 ttl=64 time=15.2 ms
8200 bytes from 129.240.222.99: icmp_seq=1 ttl=64 time=15.9 ms
8200 bytes from 129.240.222.99: icmp_seq=2 ttl=64 time=14.9 ms
8200 bytes from 129.240.222.99: icmp_seq=3 ttl=64 time=14.9 ms
8200 bytes from 129.240.222.99: icmp_seq=4 ttl=64 time=15.0 ms

--- lugulbanda.uio.no ping statistics ---
5 packets transmitted, 5 packets received, 0% packet loss
round-trip min/avg/max = 14.9/15.1/15.9 ms
</PRE>
<HR>
<P>
<P>Здесь время показывает как долго пакет программы ping идет туда и
обратно к машине lugulbanda.  15ms это довольно быстро.  При работе через
модем со скоростью 28.000 бод вы можете ожидать где-то 4000-5000ms, и если
линия нагружена еще кем-то, то время будет даже выше, может быть раза в
два. Когда это время высоко, мы говорим что это 'высокое запаздывание'. В
общем для больших пакетов и для более загруженных линий запаздывание будет
увеличиваться. Увеличьте <CODE>timeo</CODE> соответственно вашей линии и
загрузке. И поскольку запаздывание увеличивается когда вы используете линию
для других вещей: даже если вы хотите использовать FTP и NFS в одно и тоже
время, то вы должны попытаться измерить <CODE>timeo</CODE> ping во время
использования FTP для передачи файлов.
<P>
<HR>
<A HREF="NFS-HOWTO-6.html">Следующий</A>
<A HREF="NFS-HOWTO-4.html">Предыдущий</A>
<A HREF="NFS-HOWTO.html#toc5">Содержание</A>
</BODY>
</HTML>
