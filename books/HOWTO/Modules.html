<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML
><HEAD
><TITLE
>Мини-HOWTO: Модули ядра Linux</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.57"><META
NAME="KEYWORD"
CONTENT="Linux"><META
NAME="KEYWORD"
CONTENT="kernel"><META
NAME="KEYWORD"
CONTENT="module"><META
NAME="KEYWORD"
CONTENT="модуль"><META
NAME="KEYWORD"
CONTENT="ядро"></HEAD
><BODY
CLASS="ARTICLE"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="ARTICLE"
><DIV
CLASS="TITLEPAGE"
><H1
CLASS="TITLE"
><A
NAME="AEN2"
>Мини-HOWTO: Модули ядра Linux</A
></H1
><DIV
CLASS="AUTHORGROUP"
><A
NAME="AEN4"
></A
><H3
CLASS="AUTHOR"
><A
NAME="AEN5"
></A
></H3
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rhw@bigfoot.com<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</P
></DIV
></DIV
><H3
CLASS="CORPAUTHOR"
>        Перевод: <A
HREF="mailto:sam@asp-linux.com"
TARGET="_top"
>Станислав Рогин</A
>,
        <A
HREF="http://www.asplinux.com"
TARGET="_top"
>SWSoft Pte Ltd.</A
>
     </H3
></DIV
><DIV
CLASS="REVHISTORY"
><TABLE
WIDTH="100%"
BORDER="0"
><TR
><TH
ALIGN="LEFT"
VALIGN="TOP"
COLSPAN="3"
><B
>История изменений</B
></TH
></TR
><TR
><TD
ALIGN="LEFT"
>Издание 1.0</TD
><TD
ALIGN="LEFT"
>Дата неизвестна</TD
><TD
ALIGN="LEFT"
>Под редакцией: rhw</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Исходная версия</TD
></TR
></TABLE
></DIV
><DIV
><DIV
CLASS="ABSTRACT"
><A
NAME="AEN12"
></A
><P
></P
><P
>        В этом документе описывается установка и использование модулей ядра Linux.
      </P
><P
></P
></DIV
></DIV
><HR></DIV
><DIV
CLASS="TOC"
><DL
><DT
><B
>Содержание</B
></DT
><DT
>1. <A
HREF="Modules.html#AEN28"
>License</A
></DT
><DT
>2. <A
HREF="Modules.html#AEN31"
>Авторские права</A
></DT
><DT
>3. <A
HREF="Modules.html#PURPOSE"
>Для чего создан этот документ</A
></DT
><DT
>4. <A
HREF="Modules.html#REQUIRE"
>Обязательные условия</A
></DT
><DT
>5. <A
HREF="Modules.html#SPEEDUP"
>Ускорение работы компилятора</A
></DT
><DT
>6. <A
HREF="Modules.html#KERNEL"
>Пересобираем ядро для включения поддержки модулей</A
></DT
><DD
><DL
><DT
>6.1. <A
HREF="Modules.html#REDHAT"
>Настройка поддержки модулей в дистрибутивах Debian и RedHat</A
></DT
><DT
>6.2. <A
HREF="Modules.html#SLACKWARE"
>Настройка поддержки модулей в дистрибутиве Slackware</A
></DT
><DT
>6.3. <A
HREF="Modules.html#OTHERDIST"
>Настройка поддержки модулей в других дистрибутивах</A
></DT
></DL
></DD
></DL
></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="AEN28"
>1. License</A
></H1
><P
>      This document is covered by the terms of the GNU General Public
      Licence (GPL), and all terms and limitations therein apply.
    </P
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN31"
>2. Авторские права</A
></H1
><P
>  Авторские права на русский перевод этого текста принадлежат &copy; 2000 SWSoft Pte Ltd.
  Все права зарезервированы.
  </P
><P
>  Этот документ является частью проекта Linux HOWTO.
  </P
><P
>  Авторские права на документы Linux HOWTO принадлежат их авторам, если явно
  не указано иное. Документы Linux HOWTO, а также их переводы, могут
  быть воспроизведены и распространены полностью или частично на любом
  носителе физическом или электронном, при условии сохранения этой заметки об
  авторских правах на всех копиях. Коммерческое распространение разрешается и
  поощряется; но так или иначе автор текста и автор перевода желали бы знать о
  таких дистрибутивах.
  </P
><P
>  Все переводы и производные работы, выполненные по документам Linux HOWTO
  должны сопровождаться этой заметкой об авторских правах. Это делается в
  целях предотвращения случаев наложения дополнительных ограничений на
  распространение документов HOWTO. Исключения могут составить случаи
  получения специального разрешения у координатора Linux HOWTO с которым
  можно связаться по адресу приведенному ниже.
  </P
><P
>  Мы бы хотели распространить эту информацию по всем возможным каналам. Но
  при этом сохранить авторские права и быть уведомленными о всех планах
  распространения HOWTO. Если у вас возникли вопросы, пожалуйста, обратитесь
  к координатору проекта Linux HOWTO по электронной почте:
  <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:linux-howto@metalab.unc.edu"
>linux-howto@metalab.unc.edu</A
>&#62;</TT
>, или к координатору русского
  перевода Linux HOWTO компании SWSoft Pte Ltd. по адресу
  <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:linux-howto@asplinux.ru"
>linux-howto@asplinux.ru</A
>&#62;</TT
>
  </P
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="PURPOSE"
>3. Для чего создан этот документ</A
></H1
><P
>      В процессе моей работы с Linux и модулями ядра, я столкнулся с тем,
      что ни в одном документе нет удовлетворительного описания того,
      как настроить и использовать модули ядра Linux. Советы, приведенные
      в этом документе, проверялись и использовались не один раз как на
      моей машине, так и на многих других машинах, разбросанных по Internet.
      Здесь я опишу, как пользоваться тем или иныи устройством, драйвер
      которого может быть собран только в виде модуля.
    </P
><P
>      На моей машине установлен RedHat Linux 4.1, и я использовал именно этот
      дистрибутив для проверки советов, приведенных в этом документе. Я
      проверил эти советы и на различных версиях дистрибутива Slackware, а также
      на Debian. Все необходимые коррективы, связанные с различием дистрибутивов,
      также приведены в этом документе.
    </P
><DIV
CLASS="WARNING"
><P
></P
><TABLE
CLASS="WARNING"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="http://www.linux.org.ru/books/images/warning.gif"
HSPACE="5"
ALT="Внимание"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>        Совсем недавно я проверил эти советы в RedHat 4.2, но получил разные
        результаты на практически одинаковых системах. Я пока еще не определил,
        в чем возникла проблема, поэтому на данный момент я не могу дать
        никаких гарантий работоспособности этих советов на вашей системе.
      </P
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="REQUIRE"
>4. Обязательные условия</A
></H1
><P
></P
><UL
><LI
><P
>          Для того, чтобы использовать советы, приведенные в этом документе,
          у вас должна быть работающая Linux-система, в которую вы можете
          войти как <I
CLASS="EMPHASIS"
>root</I
>, так как большинство шагов, описанных здесь, 
          требуют прав именно этого пользователя.
        </P
></LI
><LI
><P
>          Существующее ядро может быть собрано как с поддержкой загружаемых модулей,
          так и без них, даже если при загрузке системы выдаются сообщения об
          ошибках, возникающих из-за отсутствия необходимых модулей. Главное, чтобы
          выполнялись вышеуказанные условия.
        </P
></LI
><LI
><P
>          Я предполагаю, что в вашей системе исходные тексты ядра
          находятся в каталоге <TT
CLASS="FILENAME"
>/usr/src/linux</TT
>.
          Также я предполагаю, что при исполнении любых команд, приведенных
          в это тексте, вы находитесь именно в этом каталоге.
        </P
></LI
></UL
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="SPEEDUP"
>5. Ускорение работы компилятора</A
></H1
><P
>      Если на вашей машине 16 или больше Мегабайт ОЗУ, то вы можете использовать
      полезную вещь, которая позволит вам компилировать несколько модулей ядра
      одновременно. Это увеличит степень загрузки процессора при компиляции, но
      серьезно уменьшит время сборки модулей.
    </P
><P
>      Перед тем, как использовать это ускорение, вам надо проверить объем
      оперативной памяти вашего компьютера, потому что, если вы установите
      слишком большое значение ускорения, компиляция может сильно замедлиться.
      Опыт показал, что оптимальное значение зависит от объема ОЗУ компьютера
      по следующей формуле (по крайней мере, для компьютеров с ОЗУ до 32 Мб. На
      компютерах с большим объемом памяти все может немного отличаться):
    </P
><P
>      N = [Объем ОЗУ в Мегебайтах] / 8 + 1
    </P
><P
>      Если вы не любите считать по формулам, то вы можете взять значения
      из следующей таблицы:
    </P
><P
>      
      <DIV
CLASS="TABLE"
><A
NAME="AEN64"
></A
><P
><B
>Таблица 1. Таблица коэффициентов</B
></P
><TABLE
BORDER="1"
CLASS="CALSTABLE"
><THEAD
><TR
><TH
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>Объем ОЗУ</TH
><TH
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>Значение коэффициента</TH
></TR
></THEAD
><TBODY
><TR
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>16 Мб</TD
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>3</TD
></TR
><TR
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>24 Мб</TD
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>4</TD
></TR
><TR
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>32 Мб</TD
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>5</TD
></TR
><TR
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>40 Мб</TD
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>6</TD
></TR
><TR
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>48 Мб</TD
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>7</TD
></TR
><TR
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>56 Мб</TD
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>8</TD
></TR
><TR
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>64 Мб</TD
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>9</TD
></TR
><TR
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>80 Мб</TD
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>11</TD
></TR
><TR
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>96 Мб</TD
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>13</TD
></TR
><TR
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>112 Мб</TD
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>15</TD
></TR
><TR
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>128 Мб</TD
><TD
WIDTH="50%"
ALIGN="LEFT"
VALIGN="TOP"
>17</TD
></TR
></TBODY
></TABLE
></DIV
>
    </P
><P
>      После того, как вы выберете для себя значение коэффициента,
      откройте файл <TT
CLASS="FILENAME"
>/usr/src/linux/Makefile</TT
>
      и найдите строку, в которой написано следующее:
    </P
><PRE
CLASS="PROGRAMLISTING"
>MAKE=make
    </PRE
><P
>      И замените ее на:
    </P
><PRE
CLASS="PROGRAMLISTING"
>MAKE=make -j N
    </PRE
><P
>      где <TT
CLASS="VARNAME"
>N</TT
> - это значение коэффициента ускорения.
    </P
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="KERNEL"
>6. Пересобираем ядро для включения поддержки модулей</A
></H1
><P
>      Почти все функции ядра могут быть собраны в виде модулей. Исключением
      является драйвер файловой системы, на которой находится корневой раздел
      (обычно это файловая система ext2)
    </P
><P
>      Однако, некоторые вещи очень сложно настроить, если их поддержка собрана
      в виде модуля, и я бы рекомендовал встроить в ядро:
    </P
><P
></P
><UL
><LI
><P
>          Драйверы сетевых карт Ethernet.
        </P
></LI
><LI
><P
>          Драйверы SCSI CD-ROM.
        </P
></LI
></UL
><P
>      С другой стороны, существуют такие комбинации драйверов, которые
      работают <I
CLASS="EMPHASIS"
>ТОЛЬКО</I
> если они собраны в виде
      модулей, особенно если их несколько:
    </P
><P
></P
><UL
><LI
><P
>          Драйвер принтера на параллельном порту,
        </P
></LI
><LI
><P
>          Драйвер внешнего дисковода, подключаемого к параллельному порту
          (такие как <I
CLASS="EMPHASIS"
>IOMEGA</I
> ZipDrive или
          JazzDrive, или <I
CLASS="EMPHASIS"
>BackPack</I
> CD-ROM), и
        </P
></LI
><LI
><P
>          Демон <I
CLASS="EMPHASIS"
>PLIP</I
>
        </P
></LI
></UL
><P
>      Вам надо самим решить, что вы встроите в ядро, а что соберете в виде
      модулей. Не забудьте про то, что я вам говорил выше. Выбирать вы будете в 
      процессе исполнения второй из следующих трех команд:
    </P
><PRE
CLASS="PROGRAMLISTING"
>cd /usr/src/linux
make menuconfig
make dep clean modules modules_install zImage
    </PRE
><P
>      После этого надо обновить зависимости модулей. Это делается
      следующей командой:
    </P
><PRE
CLASS="PROGRAMLISTING"
>depmod -a
    </PRE
><P
>      Теперь новое ядро надо включить в процедуру загрузки системы.
      Я предполагаю, что вы для этого используете <SPAN
CLASS="APPLICATION"
>LILO</SPAN
>,
      потому что это единственный загрузчик, с которым я имел дело.
    </P
><P
>      Я настоятельно рекомендую вам НЕ использовать автоматическую процедуру
      установки нового ядра в процедуру загрузки, потому что, если это ядро не
      загрузится, вам будет очень сложно восстановить систему без полной
      переустановки, что не очень приятно. По этой причине у меня в файле
      <TT
CLASS="FILENAME"
>/etc/lilo.conf</TT
> есть следующие строки:
    </P
><PRE
CLASS="PROGRAMLISTING"
>image=/usr/src/linux/arch/i386/boot/zImage
  label=new
  alias=n
  read-only
  vga=ask
  optional
    </PRE
><P
>      Здесь указано, что существует еще один ВАРИАНТ загрузки системы (который
      не будет работать, если образ этого ядра не существует), при котором
      ядро загружается из файла <TT
CLASS="FILENAME"
>/boot/newlinux</TT
>. При его запуске
      система предложит вам выбрать видеорежим, в котором будет загружаться ядро.
    </P
><P
>      Я предполагаю, что у вас есть подобные строки в файле <TT
CLASS="FILENAME"
>/etc/lilo.conf</TT
>,
      и что вы поместили в вышеуказанное место правильно собранное ядро.
      Теперь его можно установить в процедуру загрузки командой:
    </P
><PRE
CLASS="PROGRAMLISTING"
>lilo
    </PRE
><P
>      После этого вам надо перейти к одному из следующих разделов
      (это зависит от того, какой дистрибутив у вас установлен):
    </P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="REDHAT"
>6.1. Настройка поддержки модулей в дистрибутивах Debian и RedHat</A
></H2
><P
>        Перед тем, как переходить к исполнению советов, приведенных в этой
        главе, убедитесь в том, что вы проделали все, что описано в разделе
        <SPAN
CLASS="QUOTE"
>"<A
HREF="Modules.html#KERNEL"
><I
>Пересобираем ядро для включения поддержки модулей</I
></A
>"</SPAN
>.
      </P
><P
>        Процедуры загрузки системы дистрибутивов Debian и RedHat идентичны,
        поэтому у них совпадает и процедура настройки модулей.
      </P
><P
></P
><OL
TYPE="1"
><LI
><P
>            Зайдите в систему в качестве root-а, и, при помощи вашего
            любимого текстового редактора, создайте файл
            <TT
CLASS="FILENAME"
>/etc/rc.d/init.d/modules.init</TT
>, написав в
            нем следующее:
          </P
><PRE
CLASS="PROGRAMLISTING"
># Modules initialisation.
# Инициализация модулей.
#
# Start up the module auto-loading daemon.
# Запуск демона автозагрузки модулей
/sbin/kerneld

# Mount all currently unmounted auto-mounted partitions.
# подключаем все неподключенные разделы.
/sbin/mount -a
          </PRE
></LI
><LI
><P
>            После создания этого файла в качестве root-а сделайте следующее:
          </P
><PRE
CLASS="PROGRAMLISTING"
>cd /etc/rc.d
chmod 755 init.d/*
cd rc3.d
ln -s ../init.d/modules.init 05modules.init
          </PRE
></LI
></OL
><P
>        Теперь систему можно перезагрузить, и, если все пойдет хорошо,
        то модули будут прекрасно работать.
      </P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="SLACKWARE"
>6.2. Настройка поддержки модулей в дистрибутиве Slackware</A
></H2
><P
>        Перед тем, как переходить к исполнению советов, приведенных в этой
        главе, убедитесь в том, что вы проделали все, что описано в разделе
        <SPAN
CLASS="QUOTE"
>"<A
HREF="Modules.html#KERNEL"
><I
>Пересобираем ядро для включения поддержки модулей</I
></A
>"</SPAN
>.
      </P
><P
>        Теперь вам надо отредактировать файл <TT
CLASS="FILENAME"
>/etc/rc.d/rc.M</TT
>
        примерно следующим образом:
      </P
><P
></P
><OL
TYPE="1"
><LI
><P
>            В районе строки 18 есть раздел, содержащий следующее:
          </P
><PRE
CLASS="PROGRAMLISTING"
># Экран отключается после 15 минут простоя
# Screen blanks after 15 minutes idle time.
/bin/setterm -blank 15
          </PRE
><P
>            Сразу после этого раздела вставьте следующее:
          </P
><PRE
CLASS="PROGRAMLISTING"
># Load the kernel module auto-loader.
# Загружаем демон автозагрузки модулей.
/sbin/kerneld
          </PRE
></LI
><LI
><P
>            Примерно через 12 строк вы увидите следующее:
          </P
><PRE
CLASS="PROGRAMLISTING"
># if there is no /etc/HOSTNAME, fall back on this default:
# если файл /etc/HOSTNAME не существует, то используем значение по умолчанию:
          </PRE
><P
>            Непосредственно перед этими строками вставьте следующее (не
            забывайте про пустые строки):
          </P
><PRE
CLASS="PROGRAMLISTING"
># Mount remaining unmounted auto-mount drives.
# Подключаем оставшиеся неподключенные разделы.
/sbin/mount -a
          </PRE
></LI
></OL
><P
>        После внесения этих изменений запишите файл.
      </P
><P
>        Более никаких изменений в Slackware не требуется.
      </P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="OTHERDIST"
>6.3. Настройка поддержки модулей в других дистрибутивах</A
></H2
><P
>        Перед тем, как переходить к исполнению советов, приведенных в этой
        главе, убедитесь в том, что вы проделали все, что описано в разделе
        <SPAN
CLASS="QUOTE"
>"<A
HREF="Modules.html#KERNEL"
><I
>Пересобираем ядро для включения поддержки модулей</I
></A
>"</SPAN
>.
      </P
><P
>        Точная последовательность действий в других дистрибутивах, конечно же,
        не может быть определена, но, скорее всего, она будет совпадать с одной
        из вышеописанных. Для того, чтобы определить, которая из них вам 
        подходит, вы можете просмотреть содержимое каталога <TT
CLASS="FILENAME"
>/etc/rc.d</TT
>,
        следующим образом:
      </P
><PRE
CLASS="PROGRAMLISTING"
>cd /etc/rc.d
ls -l *.d rc.*
      </PRE
><P
>        В зависимости от того, что вы увидите на экране, у вас есть три варианта
        действий:
      </P
><P
></P
><OL
TYPE="1"
><LI
><P
>            Если в этом списке есть каталог <TT
CLASS="FILENAME"
>init.d</TT
> и несколько
            каталогов с именем вида <TT
CLASS="FILENAME"
>rc?.d</TT
>, где вместо знака вопроса
            стоят различные цифры, и в этом списке <I
CLASS="EMPHASIS"
>НЕТ</I
> файла
            с именем <TT
CLASS="FILENAME"
>rc.M</TT
>, то этот дистрибутив можно настроить так,
            как описано в главе <SPAN
CLASS="QUOTE"
>"<A
HREF="Modules.html#REDHAT"
><I
>Настройка поддержки модулей в дистрибутивах Debian и RedHat</I
></A
>"</SPAN
>.
          </P
></LI
><LI
><P
>            Если в этом списке НЕТ каталога <TT
CLASS="FILENAME"
>init.d</TT
>, но есть
            файл <TT
CLASS="FILENAME"
>rc.M</TT
>, то этот дистрибутив можно настроить так,
            как описано в главе <SPAN
CLASS="QUOTE"
>"<A
HREF="Modules.html#SLACKWARE"
><I
>Настройка поддержки модулей в дистрибутиве Slackware</I
></A
>"</SPAN
>.
          </P
></LI
><LI
><P
>            Если ваш список не удовлетворил предыдущим двум вариантам, то
            процедура загрузки вашей системы не описана в этом HowTo. В этом
            случае вы можете связаться с автором этого документа, и он
            вам поможет настолько, насколько это возможно.
          </P
></LI
></OL
></DIV
></DIV
></DIV
></BODY
></HTML
>