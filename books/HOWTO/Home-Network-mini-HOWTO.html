<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML
><HEAD
><TITLE
>Использование Red Hat Linux версии 6.X в качестве Интернет-шлюза для домашней сети</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.57"></HEAD
><BODY
CLASS="ARTICLE"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="ARTICLE"
><DIV
CLASS="TITLEPAGE"
><H1
CLASS="TITLE"
><A
NAME="AEN2"
>Использование Red Hat Linux версии 6.X в качестве Интернет-шлюза для домашней сети</A
></H1
><DIV
CLASS="AUTHORGROUP"
><A
NAME="AEN4"
></A
><H3
CLASS="AUTHOR"
><A
NAME="AEN5"
>Paul Ramsey</A
></H3
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
>&nbsp;&nbsp;&nbsp;&nbsp;     pramsey@refractions.net
    <br>
&nbsp;&nbsp;&nbsp;</P
></DIV
></DIV
><H3
CLASS="CORPAUTHOR"
> Перевод: <A
HREF="mailto:sam@asp-linux.com"
TARGET="_top"
>Станислав Рогин</A
>,
 <A
HREF="http://www.asplinux.com"
TARGET="_top"
>SWSoft Pte Ltd.</A
>
 </H3
></DIV
><P
CLASS="PUBDATE"
>June 22, 2000
 <BR></P
><DIV
><DIV
CLASS="ABSTRACT"
><A
NAME="AEN15"
></A
><P
></P
><P
>Простое руководство по настройке Red Hat 6 и похожих дистрибутивов для
использования в качестве интернет-шлюза для небольшой домашней или офисной
сети. Затрагиваются темы маскарадинга, DNS, DHCP и основ системы
безопасности.</P
><P
></P
></DIV
></DIV
><HR></DIV
><DIV
CLASS="TOC"
><DL
><DT
><B
>Содержание</B
></DT
><DT
>1. <A
HREF="Home-Network-mini-HOWTO.html#AEN17"
>Введение</A
></DT
><DD
><DL
><DT
>1.1. <A
HREF="Home-Network-mini-HOWTO.html#AEN39"
>Версии</A
></DT
><DT
>1.2. <A
HREF="Home-Network-mini-HOWTO.html#AEN56"
>Copyright</A
></DT
><DT
>1.3. <A
HREF="Home-Network-mini-HOWTO.html#AEN71"
>Авторские права</A
></DT
></DL
></DD
><DT
>2. <A
HREF="Home-Network-mini-HOWTO.html#AEN80"
>Подключаем аппаратуру</A
></DT
><DD
><DL
><DT
>2.1. <A
HREF="Home-Network-mini-HOWTO.html#AEN83"
>Используя хаб</A
></DT
><DT
>2.2. <A
HREF="Home-Network-mini-HOWTO.html#AEN91"
>Не используя хаб</A
></DT
><DT
>2.3. <A
HREF="Home-Network-mini-HOWTO.html#AEN98"
>С одной сетевой картой</A
></DT
></DL
></DD
><DT
>3. <A
HREF="Home-Network-mini-HOWTO.html#AEN109"
>Настройка сети</A
></DT
><DD
><DL
><DT
>3.1. <A
HREF="Home-Network-mini-HOWTO.html#AEN128"
>Настройка драйвера сетевой карты</A
></DT
><DD
><DL
><DT
>3.1.1. <A
HREF="Home-Network-mini-HOWTO.html#AEN177"
>Две одинаковых сетевых карты</A
></DT
></DL
></DD
><DT
>3.2. <A
HREF="Home-Network-mini-HOWTO.html#AEN186"
>Настройка внутренней сети</A
></DT
><DD
><DL
><DT
>3.2.1. <A
HREF="Home-Network-mini-HOWTO.html#AEN189"
>Сетевое устройство</A
></DT
><DT
>3.2.2. <A
HREF="Home-Network-mini-HOWTO.html#AEN213"
>Сервер DHCP</A
></DT
><DT
>3.2.3. <A
HREF="Home-Network-mini-HOWTO.html#AEN246"
>Клиентские компьютеры</A
></DT
><DT
>3.2.4. <A
HREF="Home-Network-mini-HOWTO.html#AEN257"
>Сервер DNS</A
></DT
><DT
>3.2.5. <A
HREF="Home-Network-mini-HOWTO.html#AEN298"
>Проверяем внутреннюю сеть</A
></DT
></DL
></DD
><DT
>3.3. <A
HREF="Home-Network-mini-HOWTO.html#AEN304"
>Настройка внешней сети</A
></DT
><DD
><DL
><DT
>3.3.1. <A
HREF="Home-Network-mini-HOWTO.html#AEN312"
>Со статическим IP-адресом</A
></DT
><DT
>3.3.2. <A
HREF="Home-Network-mini-HOWTO.html#AEN322"
>С использованием DHCP</A
></DT
><DT
>3.3.3. <A
HREF="Home-Network-mini-HOWTO.html#AEN332"
>Хитрости и проблемы</A
></DT
><DT
>3.3.4. <A
HREF="Home-Network-mini-HOWTO.html#AEN369"
>Изучаем настройки сети</A
></DT
></DL
></DD
><DT
>3.4. <A
HREF="Home-Network-mini-HOWTO.html#AEN382"
>Безопасность</A
></DT
></DL
></DD
><DT
>4. <A
HREF="Home-Network-mini-HOWTO.html#AEN394"
>Настройка маскарадинга</A
></DT
><DT
>5. <A
HREF="Home-Network-mini-HOWTO.html#AEN422"
>Проблемы</A
></DT
><DD
><DL
><DT
>5.1. <A
HREF="Home-Network-mini-HOWTO.html#AEN426"
>Не работает ICQ</A
></DT
><DT
>5.2. <A
HREF="Home-Network-mini-HOWTO.html#AEN432"
>А у меня Caldera 2.X, а не Red Hat 6.X</A
></DT
><DT
>5.3. <A
HREF="Home-Network-mini-HOWTO.html#AEN457"
>Я хочу, чтобы одна из моих внутренних машин была Web-сервером</A
></DT
></DL
></DD
></DL
></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="AEN17"
>1. Введение</A
></H1
><P
>Этот документ является пошаговой инструкцией по настройке вашего Red Hat
6.X в качестве интернет-шлюза для домашней или небольшой офисной сети.
Инструкции предельно упрощены: никаких специфических случаев, многие
предположения будут положены в основу, в том числе и сетевые адреса.
Основные требования этого документа:</P
><P
>&#13;<P
></P
><UL
><LI
><P
>У вас есть постоянное подключение к Интернет при помощи кабеля или ADSL.</P
></LI
><LI
><P
>Вы нормально установили <A
HREF="http://www.redhat.com"
TARGET="_top"
>Red Hat 6.X</A
>, минимум, на один из ваших
компьютеров. Заметьте, что эти инструкции подходят и к производным от
RedHat дистрибутивам, таким как <A
HREF="http://www.linux-mandrake.com"
TARGET="_top"
>Mandrake 6.X</A
>, который распространяется
печатным агентством "MacMillan Publishing" под различными торговыми
марками.</P
></LI
><LI
><P
>В ваш компьютер с Linux установлены две сетевые карты, и обе они совместимы
с Linux.</P
></LI
><LI
><P
>У вас имеется ethernet-хаб, если вы работаете с сетью более, чем из одного
компьютера, или кросс-кабель, если ваша сеть состоит из одного компьютера
(не считая Linux).</P
></LI
><LI
><P
>Вы знаете, как редактировать текстовые файлы в Linux.</P
></LI
><LI
><P
>Вы можете войти в свою машину в качестве пользователя <TT
CLASS="LITERAL"
>root</TT
>. Вы знаете, как
устанавливать RPM-пакеты с вашего CDROM в Linux.</P
></LI
></UL
>&#13;</P
><P
>Если ваши условия не соответствуют, хотя бы одному из этих требований, то,
скорее всего, этот документ не для вас.</P
><P
>Ничего особенного в процессе установки системы вам делать не надо.
Просто установите то, что имеет для вас хоть какой-нибудь смысл, и все. В
этом документе приводятся подробные инструкции о том, как с нуля установить
все, что нужно, для работы в сети, чтобы избежать предположений о том, что вы
установили или настроили в процессе инсталляции системы. Для пущей
уверенности в том, что не возникнет никаких проблем с информацией,
приведенной здесь, вся настройка будет производиться путем прямого
редактирования системных файлов, вместо использования графических утилит,
поставляемых вместе с Red Hat. С одной стороны, это вроде бы сложнее; с
другой стороны, опыт, полученный вами в процессе такой настройки будет
незаменим, если вам придется настраивать Linux, например, в других
дистрибутивах или ситуациях (если, предположим, X не работает, или вы
настраиваете сервер, который не будет рабочей станцией).</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN39"
>1.1. Версии</A
></H2
><P
>Самую свежую версию этого документа всегда можно найти по адресу
<A
HREF="http://www.coastnet.com/~pramsey/linux/homenet.html"
TARGET="_top"
>http://www.coastnet.com/~pramsey/linux/homenet.html</A
> (HTML-версия) и
<A
HREF="http://www.coastnet.com/~pramsey/linux/homenet.sgml"
TARGET="_top"
>http://www.coastnet.com/~pramsey/linux/homenet.sgml</A
> (SGML-версия).</P
><P
>&#13;<P
></P
><UL
><LI
><P
>21 декабря 1999 : Изначальная версия.</P
></LI
><LI
><P
>2 января 2000 : Внесены предложения John Mellor по поводу хитростей на
внешних соединениях.</P
></LI
><LI
><P
>22 января 2000 : Небольшие дополнения по поводу двух аналогичных сетевых
карт, а также информация Chris Lea о IP-алиасинге.&#13;</P
></LI
><LI
><P
>16 марта 2000 : Дополнения на тему безопасности DNS-сервера и поддержка
Caldera - спасибо Nelson Gibbs.&#13;</P
></LI
><LI
><P
>22 июня 2000 : Red Hat 6.2 описана хитрость в настройке . Немного подробнее
о PPPoE (Kerr First).</P
></LI
></UL
>&#13;</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN56"
>1.2. Copyright</A
></H2
><P
>Copyright &copy; 2000, Paul Ramsey.</P
><P
>This manual may be reproduced in whole or in part, without fee, subject
to the following restrictions:</P
><P
>&#13;<P
></P
><UL
><LI
><P
>The copyright notice above and this permission notice must be preserved
complete on all complete or partial copies.</P
></LI
><LI
><P
>Any translation or derived work must be approved by the author in writing
before distribution.</P
></LI
><LI
><P
>If you distribute this work in part, instructions for obtaining the complete
version of this manual must be included, and a means for obtaining a complete
version provided.</P
></LI
><LI
><P
>Small portions may be reproduced as illustrations for reviews or quotes
in other works without this permission notice if proper citation is given.</P
></LI
></UL
>&#13;</P
><P
>Exceptions to these rules may be granted for academic purposes: Write to
the author and ask. These restrictions are here to protect us as authors, not
to restrict you as learners and educators.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN71"
>1.3. Авторские права</A
></H2
><P
>Авторские права на русский перевод этого текста принадлежат &copy; 2000 SWSoft Pte Ltd.
Все права зарезервированы.</P
><P
>Этот документ является частью проекта Linux HOWTO.</P
><P
>Авторские права на документы Linux HOWTO принадлежат их авторам, если явно
не указано иное. Документы Linux HOWTO, а также их переводы, могут
быть воспроизведены и распространены полностью или частично на любом
носителе, физическом или электронном, при условии сохранения этой заметки об
авторских правах на всех копиях. Коммерческое распространение разрешается и
поощряется; но, так или иначе, автор текста и автор перевода желали бы знать о
таких дистрибутивах.</P
><P
>Все переводы и производные работы, выполненные по документам Linux HOWTO
должны сопровождаться этой заметкой об авторских правах. Это делается в
целях предотвращения случаев наложения дополнительных ограничений на
распространение документов HOWTO. Исключения могут составить случаи
получения специального разрешения у координатора Linux HOWTO, с которым
можно связаться по адресу приведенному ниже.</P
><P
>Мы бы хотели распространить эту информацию по всем возможным каналам. Но
при этом сохранить авторские права и быть уведомленными о всех планах
распространения HOWTO. Если у вас возникли вопросы, пожалуйста, обратитесь
к координатору проекта Linux HOWTO по электронной почте:
<TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:linux-howto@metalab.unc.edu"
>linux-howto@metalab.unc.edu</A
>&#62;</TT
>, или к координатору русского
перевода Linux HOWTO компании SWSoft Pte Ltd. по адресу
<TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:linux-howto@asplinux.ru"
>linux-howto@asplinux.ru</A
>&#62;</TT
></P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN80"
>2. Подключаем аппаратуру</A
></H1
><P
>Топология вашей сети может немного различаться - это зависит от того,
используете вы хаб или нет. Я опишу лишь работу с кабелями витой пары RJ45
(они выглядят, как немного потолстевшие обычные телефонные провода), и не
буду описывать тонкий коаксиал. При помощи тонкого коаксиала, вы можете
соединить в сеть несколько машин без использования хаба, но вам придется
быть более внимательным в вопросе терминаторов и тому подобного. Эти
инструкции вам практически не нужны, если вам уже знакома работа с сетью.</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN83"
>2.1. Используя хаб</A
></H2
><P
>Если вы собираетесь использовать хаб, то ваша сеть будет выглядеть примерно
<A
HREF="http://www.coastnet.com/~pramsey/linux/w_hub.gif"
TARGET="_top"
>так</A
>.</P
><P
>Подсоедините карту <TT
CLASS="LITERAL"
>eth0</TT
>, установленную в Linux-машину, к кабельному или
ADSL-модему, используя кабель, установленный фирмой-продавцом (или тот кабель, о котором вы знаете, что он работает. Это очень
важно, потому что некоторые кабельные модемы должны подключаться к сети при
помощи кросс-кабеля, а другие при помощи обычного: используйте тот, который
установила фирма-продавец).</P
><P
>Подсоедините установленную в Linux карту <TT
CLASS="LITERAL"
>eth1</TT
>
к хабу при помощи обычного
"прямого" кабеля. Подключите все ваши локальные компьютеры к хабу при
помощи обычных кабелей.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN91"
>2.2. Не используя хаб</A
></H2
><P
>Если у вас нет хаба, то вы все-таки можете подключить еще один компьютер к
Linux, используя кросс-кабель. Топология вашей сети будет выглядеть
примерно <A
HREF="http://www.coastnet.com/~pramsey/linux/wo_hub.gif"
TARGET="_top"
>так</A
>.</P
><P
>Подключите сетевую карту <TT
CLASS="LITERAL"
>eth0</TT
>, установленную в Linux-машину, к кабельному
или ADSL-модему, используя кабель, предоставленный фирмой-продавцом.
Подключите карту <TT
CLASS="LITERAL"
>eth1</TT
> к другому компьютеру, используя росс-кабель.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN98"
>2.3. С одной сетевой картой</A
></H2
><P
>Я бы не рекомендовал вам использовать подобную конфигурацию (в ней внешняя
и внутренняя сеть находятся в одной физической сети, что приводит к меньшей
защищенности - хотя в реальной жизни шанс возникновения проблем достаточно
низок), но ее <I
CLASS="EMPHASIS"
>можно</I
> использовать. Каждому свое.</P
><P
>Ядро Linux включает в себя поддержку "IP-алиасинга", который позволяет
одной сетевой карте обрабатывать одновременно два IP-адреса. Стандартные
ядра, поставляемые в комплекте Red Hat или Mandrake, по умолчанию включают
в себя поддержку IP-алиасинга . Чтобы настроить интернет-шлюз, имея лишь
одну сетевую карту, во всех последующих примерах настройки, просто поменяйте
<TT
CLASS="LITERAL"
>eth1</TT
> на <TT
CLASS="LITERAL"
>eth0:0</TT
>.</P
><P
><I
CLASS="EMPHASIS"
>В конфигурации с одной сетевой картой <I
CLASS="EMPHASIS"
>не</I
> рекомендуется запуск DHCP сервера.</I
></P
><P
>Подключите все ваши машины и кабельный (или ADSL) модем в хаб. Продолжайте,
перекрестив пальцы.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN109"
>3. Настройка сети</A
></H1
><P
>Хорошо, к этому моменту на ваш шлюзовой компьютер установлен Linux. Вы
даже, наверное, настроили одну из сетевых карт и сконфигурировали выход в
Интернет. Однако мы предположим, что у вас ничего не настроено, и начнем с
"чистого листа".</P
><P
>Зайдите в компьютер <TT
CLASS="LITERAL"
>root</TT
>-ом. Все инструкции в этом документе приводятся с
предположением, что вы вошли в компьютер в качестве root-а.</P
><P
>Ядро Linux называет ваши сетевые карты как <TT
CLASS="LITERAL"
>eth0</TT
> и <TT
CLASS="LITERAL"
>eth1</TT
>, поэтому я буду с
этого момента называть их так же. Проблема состоит в том,
которая из них <TT
CLASS="LITERAL"
>eth0</TT
>, а которая <TT
CLASS="LITERAL"
>eth1</TT
>?
Существует "простой" способ выяснить это, работающий как минимум в
50% случаев: положите компьютер на стол, чтобы материнская плата была
горизонтальна и задняя панель "смотрела" на вас (так, как будто вы
собираетесь открыть кожух и внести какие-то изменения). Левая карта
будет <TT
CLASS="LITERAL"
>eth0</TT
> -- вы можете ее чем-нибудь пометить, например, липкой лентой.
Теперь запишите на листе бумаги производителей и модели обеих карт.</P
><P
>Хорошо, давайте теперь проверим, распознаются ли <TT
CLASS="LITERAL"
>eth0</TT
> и <TT
CLASS="LITERAL"
>eth1</TT
> ядром
автоматически. Наберите команды <TT
CLASS="LITERAL"
>ifconfig eth0</TT
> и <TT
CLASS="LITERAL"
>ifconfig eth1</TT
>. В обоих
случаях, если ядро распознало вашу карту, вы должны увидеть примерно
следующее (не учитывая цифры):</P
><P
>eth0   Link encap: Ethernet   HWaddr 00:60:67:4A:02:0A
       inet addr:0.0.0.0  Bcast:0.0.0.0  Mask:255.255.255.255
       UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
       RX packets:466 errors:0 dropped:0 overruns:0 frame:0
       TX packets:448 errors:0 dropped:0 overruns:0 carrier:0
       collisions:85 txqueuelen:100
       Interrupt:10 Base address:0xe400</P
><P
>Если ядро не смогло распознать вашу карту, вы увидите следующее:&#13;</P
><P
>eth0: error fetching interface information: Device not found.</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN128"
>3.1. Настройка драйвера сетевой карты</A
></H2
><P
>Вы можете пропустить этот раздел, если обе ваших карты удачно распознаны
ядром. В противном случае, эта секция для вас.</P
><P
>Так, значит одна из ваших карт не распознана ядром. На самом деле в этом
нет ничего страшного. Что вам надо сделать, так это дать ядру немного более
подробную информацию о том, как обнаружить ваши карты. В этом вопросе
существует много хитростей и тонкостей, и я не собираюсь описывать их все.
Запомните, если с этим возникнут трудности, то обращайтесь к "<A
HREF="http://www.linuxdoc.org/HOWTO/Ethernet-HOWTO.html"
TARGET="_top"
>Ethernet HOWTO</A
>". Вот несколько обобщенных советов:</P
><P
>&#13;<P
></P
><UL
><LI
><P
><I
CLASS="EMPHASIS"
>У вас сетевая карта на шине PCI.</I
> Скорее всего причина в том, что несмотря
на то, что у вас такая новая и хорошая карта, драйверов к ней в ядре до сих
пор нет. Много интересного вы узнаете, прочитав о своей сетевой карте (и
других устройствах) в каталоге <TT
CLASS="LITERAL"
>/proc/pci</TT
>, записывая их производителей и
модели.</P
></LI
><LI
><P
><I
CLASS="EMPHASIS"
>У вас сетевая карта на шине ISA.</I
>
Видимо, вам придется узнать адрес и IRQ,
на которых работает карта. У вас ведь есть документация, не так ли? Если
нет, то, наверное, вам стоит в поисках документации посетить web-сайт
производителя карты (или чипа на ней: примечание переводчика). Или же у вас
должна быть DOS-дискета - загрузите DOS и поищите на ней программу
настройки, которая и укажет либо настроит необходимые адрес и IRQ.</P
></LI
><LI
><P
><I
CLASS="EMPHASIS"
>У вас ISA PnP сетевая карта.</I
> Вам придется настроить эту карту -- как это
сделать, подробно описано в "<A
HREF="http://www.linuxdoc.org/HOWTO/Plug-and-Play-HOWTO.html"
TARGET="_top"
>Plug'n'Play HOWTO</A
>". К счастью, когда вы
настроите карту, вы будете точно знать адрес порта и IRQ сетевой карты.</P
></LI
></UL
>&#13;</P
><P
>Теперь, когда вы знаете производителя и модель сетевой карты eth0 и eth1,
вы можете перейти к разделу "<A
HREF="http://www.linuxdoc.org/HOWTO/Ethernet-HOWTO-5.html"
TARGET="_top"
>Совместимость</A
>" документа "<A
HREF="http://www.linuxdoc.org/HOWTO/Ethernet-HOWTO.html"
TARGET="_top"
>Ethernet HOWTO</A
>" и
найти в нем свою карту. Запишите название рекомендуемого драйвера и любую
информацию о дополнительных параметрах, которые вам могут понадобиться.</P
><P
>Теперь наступило время редактировать конфигурационный файл! Мы будем
править файл <TT
CLASS="FILENAME"
>/etc/conf.modules</TT
>. Откройте этот файл любым текстовым
редактором. В этом файле может существовать много различных вариантов
настроек и их комбинаций, поэтому я приведу здесь пример, основанный на
моем шлюзе. У меня PCI 10/100Мбит-карта на чипе VIA Rhine, и обычная 10Мб
ISA NE2000-совместимая карта. Я использую 100Мб для внутренней сети и 10Мб
для внешнего соединения. Мой файл <TT
CLASS="FILENAME"
>/etc/conf.modules</TT
> выглядит примерно так:</P
><P
>alias parport_lowlevel parport_pc
alias eth0 ne
options ne io=0x300 irq=10
alias eth1 via-rhine&#13;</P
><P
>В нем проделывается примерно следующее:&#13;</P
><P
>&#13;<P
></P
><UL
><LI
><P
>Первая строчка указывает, что мой параллельный порт предназначен для
печати. У вас, наверно, тоже есть такая строчка. Оставьте ее без изменений.</P
></LI
><LI
><P
>Вторая строчка (<TT
CLASS="LITERAL"
>alias eth0 ne</TT
>) указывает ядру использовать драйвер "ne" для
устройства <TT
CLASS="LITERAL"
>eth0</TT
>.</P
></LI
><LI
><P
>В третьей строчке(<TT
CLASS="LITERAL"
>options ne io=0x300 irq=10</TT
>) написано, какой порт и IRQ
использовать драйверу "ne" для работы с ISA-картой. Если у вас тоже
ISA-карта, то вам тоже придется использовать эту директиву. Просто
подставьте имя драйвера, соответствующий порт и номер IRQ.</P
></LI
><LI
><P
>В четвертой строке (<TT
CLASS="LITERAL"
>alias eth1 via-rhine</TT
>) указано использовать для
устройства <TT
CLASS="LITERAL"
>eth1</TT
> драйвер "via-rhine". Моя карта <TT
CLASS="LITERAL"
>eth1</TT
> установлена на шине
PCI, поэтому я не указываю номер порта или IRQ: шина PCI настраивает карту
автоматически.</P
></LI
></UL
>&#13;</P
><P
>Вам обязательно надо убедиться в наличии строчек в файле <TT
CLASS="LITERAL"
>conf.modules</TT
> для
обеих карт, а также строчек, задающих опции ISA-карт. Эти строчки уже могут
присутствовать в файле <TT
CLASS="LITERAL"
>conf.modules</TT
>, если вы задавали их параметры в
процессе инсталляции системы.&#13;</P
><P
>Когда вы закончите редактировать <TT
CLASS="LITERAL"
>conf.modules</TT
>, попробуйте снова запустить
команды <TT
CLASS="LITERAL"
>ifconfig eth0</TT
> и <TT
CLASS="LITERAL"
>ifconfig
eth1</TT
>. Вы можете снова получить на экране
различные предупреждения или ошибки, если перепутали адреса портов
ввода-вывода или IRQ.</P
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN177"
>3.1.1. Две одинаковых сетевых карты</A
></H3
><P
>Итак, мои дорогие умники - купили две одинаковые сетевые карты для
Linux-шлюза и не можете заставить их работать вместе? Не волнуйтесь - их
работа зависит лишь от написания правильных опций в файле
<TT
CLASS="LITERAL"
>/etc/conf.modules</TT
>. В этом примере я использовал придуманные адреса портов и
номера IRQ, и предположил, что вы купили пару NE2000-совместимых карт (что
очень распространено). Ваш файл <TT
CLASS="LITERAL"
>/etc/conf.modules</TT
> должен выглядеть примерно
так:</P
><P
>alias eth0 ne
alias eth1 ne
options ne io=0x330,0x360 irq=7,9&#13;</P
><P
>Опции адреса порта и номера IRQ задаются в одной строке, и каждое первое
число соответствует <TT
CLASS="LITERAL"
>eth0</TT
>, а второе, соответственно - <TT
CLASS="LITERAL"
>eth1</TT
>.</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN186"
>3.2. Настройка внутренней сети</A
></H2
><P
>"Внутренняя сеть" - это сеть, в которой будут общаться ваши домашние или
офисные компьютеры. "Внешняя сеть" - это большой и страшный Интернет по
другую сторону вашего Linux-а. В общем и целом внутренняя сеть будет
полностью защищена от внешней при помощи Linux, который будет играть роль
firewall среднего класса.</P
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN189"
>3.2.1. Сетевое устройство</A
></H3
><P
>Теперь драйверы ваших карт работают, и вы видите <TT
CLASS="LITERAL"
>eth0</TT
> и <TT
CLASS="LITERAL"
>eth1</TT
> в команде
<TT
CLASS="LITERAL"
>ifconfig</TT
> - теперь наступило время настроить внутреннюю сеть. Я предполагаю,
что ваша внутренняя сеть подключена к <TT
CLASS="LITERAL"
>eth1</TT
>, а внешнее устройство подключено
к <TT
CLASS="LITERAL"
>eth0</TT
>.</P
><P
>Ваша внутренняя сеть будет частной, и поэтому мы используем для нее
специальный номер сети, зарезервированный для внутренних частных сетей:
<TT
CLASS="LITERAL"
>192.168.1.0</TT
>. Это будет "частная сеть класса C" - вы можете хвалиться этим
названием перед своими друзьями.</P
><P
>Во-первых, необходимо убедиться в том, что поддержка сети включена. Откройте
файл <TT
CLASS="LITERAL"
>/etc/sysconfig/network</TT
> и найдите в нем следующие строки (если их нет,
создайте):</P
><P
>NETWORKING=yes
FORWARD_IPV4=yes</P
><P
>Первая строка указывает, что мы хотим, чтобы сетевые устройства
стартовали в процессе загрузки системы. Во второй строке разрешается
пересылка IP-пакетов. Эта строка будет нам необходима в процессе настройки
маскарадинга в разделе 4.</P
><P
><I
CLASS="EMPHASIS"
>Замечание для пользователей Redhat версии 6.2:</I
> Чтобы система Red Hat 6.2
нормально поддерживала IP-пересылку и маскарадинг, необходимо
отредактировать файл <TT
CLASS="LITERAL"
>/etc/sysctl.conf</TT
>. Убедитесь в наличии следующих
строчек и проставьте в них соответствующие значения:</P
><P
>net.ipv4.ip_forward = 1
net.ipv4.ip_always_defrag = 1&#13;</P
><P
>Все настройки сетевых интерфейсов в Red Hat и его производных находятся в
файлах в каталоге <TT
CLASS="LITERAL"
>/etc/sysconfig/network-scripts</TT
>. Зайдите в этот каталог и
создайте в нем файл <TT
CLASS="LITERAL"
>ifcfg-eth1</TT
>. В этом файле напишите следующее:</P
><P
>DEVICE=eth1
IPADDR=192.168.1.1
ONBOOT=yes&#13;</P
><P
>Таким образом, загрузочный скрипт, отвечающий за настройку сети, будет
инициализировать eth1 в процессе загрузки и отведет ему конкретный
IP-адрес. Активизируйте свою сеть с учетом этих новых настроек командой
<TT
CLASS="LITERAL"
>/etc/rc.d/init.d/network restart</TT
></P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN213"
>3.2.2. Сервер DHCP</A
></H3
><P
>Сервер DHCP будет автоматически снабжать IP-адресами сетевые устройства
компьютеров вашей внутренней сети. Это достаточно удобно, особенно при
использовании Notebook-ов: можно просто подключить свою машину к сети, и она
сразу автоматически будет настроена. Если вам не нужен DHCP-сервер, то
просто пропустите эту главу.</P
><P
>Во-первых, вам надо установить DHCP-сервер. Подключите CD-ROM с вашим
дистрибутивом Linux CD и установите RPM-пакет <TT
CLASS="LITERAL"
>dhcp</TT
>. Затем откройте файл
<TT
CLASS="LITERAL"
>/etc/dhcpd.conf</TT
> и напишите в нем следующее (удалив все остальное):</P
><P
>subnet 192.168.1.0 netmask 255.255.255.0 &lcub;
  range 192.168.1.2 192.168.1.60;
  default-lease-time 86400;
  max-lease-time 86400;
  option routers 192.168.1.1;
  option ip-forwarding off;
  option broadcast-address 192.168.1.255;
  option subnet-mask 255.255.255.0;
&rcub;&#13;</P
><P
>Если ваш Linux будет и кэширующим DNS-сервером, то добавьте следующую
строку:</P
><P
>option domain-name-servers 192.168.1.1;&#13;</P
><P
>Если вы знаете адреса внешних DNS-серверов и <I
CLASS="EMPHASIS"
>не</I
> собираетесь использовать
свой Linux в качестве DNS-сервера, то добавьте следующую опцию (где x.x.x.x
и y.y.y.y - это IP-адреса внешних DNS-серверов):</P
><P
>option domain-name-servers x.x.x.x, y.y.y.y;&#13;</P
><P
>Если вы собираетесь использовать Samba-сервер для доступа к файлам Linux с
ваших компьютеров с Windows, то добавьте следующие строки, чтобы Linux был
WINS-сервером и сервером поиска машин по умолчанию:</P
><P
>option netbios-name-servers 192.168.1.1;
option netbios-dd-server 192.168.1.1;
option netbios-node-type 8;
option netbios-scope &quot;&quot;;&#13;</P
><P
>Процедура настройка Samba и WINS не входит в этот документ. Если вам нужны
подсказки или советы по этому поводу - читайте "<A
HREF="http://www.linuxdoc.org/HOWTO/SMB-HOWTO.html"
TARGET="_top"
>SMB HOWTO</A
>".</P
><P
>Осталась еще пара шагов. Откройте файл <TT
CLASS="LITERAL"
>/etc/rc.d/init.d/dhcpd</TT
> и найдите в
нем следующую строку:</P
><P
>&#13;/sbin/route add -host 255.255.255.255 dev eth1&#13;</P
><P
>DHCP-клиентам Windows необходим специальный широковещательный адрес в
DHCP-запросах, и эта команда добавляет данный адрес в настройки TCP/IP вашего
Linux. Если вы не нашли эту строку, то добавьте ее. Если же вы ее нашли, то
убедитесь в том, что она ссылается на устройство <TT
CLASS="LITERAL"
>eth1</TT
>.</P
><P
>Следующий шаг будет состоять в том, чтобы указать в файле
<TT
CLASS="LITERAL"
>/etc/rc.d/init.d/dhcpd</TT
> использовать по умолчанию устройство <TT
CLASS="LITERAL"
>eth1</TT
>. Замените
строку:</P
><P
>daemon /usr/sbin/dhcpd&#13;</P
><P
>На строку:</P
><P
>daemon /usr/sbin/dhcpd eth1&#13;</P
><P
>Итак, вы готовы к запуску DHCP. Сначала запустите DHCP-сервер командой:
<TT
CLASS="LITERAL"
>/etc/rc.d/init.d/dhcpd start</TT
>.</P
><P
>И последнее - вам надо убедиться в том, что DHCP-сервер загрузится после
перезагрузки системы. Некоторые RPM-пакеты с DHCP-сервером не включали
директив, которые бы его запускали после перезагрузки системы, поэтому мы
подстрахуем себя командой <TT
CLASS="LITERAL"
>chkconfig dhcpd on</TT
>.</P
><P
>Эта команда заставляет RedHat указать запуск dhcpd в некоторых уровнях
загрузки в каталоге <TT
CLASS="LITERAL"
>/etc/rc.d</TT
>. На уровнях 3 и 5 (многопользовательская
консоль и многопользовательские X) DHCP-сервер запускается. На уровнях 0, 1
и 6 (отключение, однопользовательский режим и перезагрузка) DHCP-сервер
останавливается.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN246"
>3.2.3. Клиентские компьютеры</A
></H3
><P
>Если вы включили DHCP, то настройка ваших клиентских компьютеров будет
очень простой - просто разрешите автоконфигурирование при помощи DHCP. В
Windows это делается примерно так - откройте "Панель управления", в ней
опцию "Сеть". Найдите протокол "TCP/IP" и нажмите на нем "Свойства".
Установите галочку около надписи "Получить IP-адрес автоматически", нажмите
OK и перезагрузите компьютер.</P
><P
>Перед тем, как вы его перезагрузите, вы можете использовать в Linux
следующую команду: <TT
CLASS="LITERAL"
>tail -f
/var/log/messages</TT
>. Таким образом, вы будете
видеть сообщения, поступающие в системный журнал Linux. Если все пойдет
хорошо, вы увидите в этом журнале запрос на IP-адрес и ответ DHCP-сервера.
Выйти из команды <TT
CLASS="LITERAL"
>tail -f</TT
> можно клавишами Ctrl+C.</P
><P
>Если у вас не включен DHCP, то настройка также достаточно проста. Итак,
снова откройте "Сеть" в "Панели Управления" и выберите свойства протокола
TCP/IP. Вы можете давать вашим компьютерам любые адреса в сети 192.168.1.0,
кроме 192.168.1.0 (собственно сама сеть), 192.168.1.255 (широковещательный
адрес) и 192.168.1.1 (ваш Linux-сервер). Никогда не давайте двум
компьютерам одинаковые IP-адреса. Установите "Шлюз по умолчанию" в
192.168.1.1, чтобы весь ваш исходящий трафик шел через Linux-шлюз.</P
><P
>В
<A
HREF="http://www.linuxdoc.org/HOWTO/IP-Masquerade-HOWTO.html"
TARGET="_top"
>"HOWTO: IP-маскарадинг"</A
> в главе <A
HREF="http://www.linuxdoc.org/HOWTO/IP-Masquerade-HOWTO-4.html"
TARGET="_top"
>Configuration Section</A
> приведена очень
подробная информация о настройке клиентских компьютеров.</P
><P
>Одним словом, чтобы настроить клиентский компьютер, вам необходимо либо
включить использование DHCP, либо вручную указать любой адрес в сети
192.168.1.X и шлюз 192.168.1.1. DNS-сервером будет 192.168.1.1 (если вы
используете кэширующий DNS-сервер(см. ниже) или укажите адрес сервера DNS,
данный вашим провайдером.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN257"
>3.2.4. Сервер DNS</A
></H3
><P
>Настройка вашего Linux в качестве DNS-сервера ускорит (правда ненамного)
скорость вашей работы с внешней сетью, потому что часто используемые
DNS-адреса будут находиться в кэше внутри вашей сети и не будут
запрашиваться наружу.</P
><P
>Если вам интересна настройка "полноразмерного" DNS, то вам придется изучить
очень много сложной документации. На этот предмет существует <A
HREF="http://www.linuxdoc.org/HOWTO/DNS-HOWTO.html"
TARGET="_top"
>DNS HOWTO</A
> и
книга <A
HREF="http://www.oreilly.com/catalog/dns3"
TARGET="_top"
>DNS и BIND</A
>.</P
><P
>Для работы с DNS клиентские машины должны использовать Linux-шлюз в
качестве своего главного DNS-сервера. Директивы DHCP, описанные в разделе
3.2.2 - это один из способов этого достичь. Если вы настраивали ваши
компьютеры вручную, то вы должны настроить свойства DNS почти там же, где
вводили IP-адрес машины.</P
><P
>Для установки DNS-сервера, сначала установите RPM-пакет <TT
CLASS="LITERAL"
>bind</TT
>, а затем
RPM-пакет <TT
CLASS="LITERAL"
>caching-nameserver</TT
>. К этому моменту у вас почти все готово.</P
><P
>После стандартной установки кэширующий DNS-сервер будет работать прекрасно,
но если вы знаете IP-адрес DNS-сервера вашего провайдера, то вы можете
немного ускорить работу сети немного подредактировав файл <TT
CLASS="LITERAL"
>/etc/named.conf</TT
>,
добавив в него следующую строку после опции <TT
CLASS="LITERAL"
>directory</TT
> (x.x.x.x и y.y.y.y -
это первичный и вторичный DNS-сервера провайдера):</P
><P
>forwarders &lcub; x.x.x.x; y.y.y.y; &rcub;;&#13;</P
><P
>После этих изменений ваш DNS-сервер сначала будет запрашивать адрес у
DNS-серверов провайдера, и только затем в общем Интернете. У провайдеров
обычно бывает большой запас готовой DNS-информации, и он может ответить
значительно быстрее, чем через обычный запрос.</P
><P
>У демона  <TT
CLASS="LITERAL"
>named</TT
> были проблемы с безопасностью, продолжавшиеся последние 12
месяцев, поэтому очень важно иметь наиболее свежую версию и внести
некоторые изменения в стандартные настройки для повышения безопасности.</P
><P
>&#13;<P
></P
><OL
TYPE="1"
><LI
><P
>Проверьте версию пакета <TT
CLASS="LITERAL"
>bind</TT
>
 - она должна быть минимум 8.2.2. Проверьте
сайты <A
HREF="ftp://updates.redhat.com"
TARGET="_top"
>Обновления Red Hat</A
> или <A
HREF="ftp://ftp.linux-mandrake.com/pub/updates"
TARGET="_top"
>Обновления Mandrake</A
> на наличие новых версий.</P
></LI
><LI
><P
>Ограничьте доступ к вашему DNS-серверу только с локальной сети, добавив
строку <TT
CLASS="LITERAL"
>allow-query &lcub; 192.168.1/24; 127.0.0.1/32; &rcub;;</TT
>; в файл
<TT
CLASS="LITERAL"
>/etc/named.conf</TT
> после строки с опцией <TT
CLASS="LITERAL"
>forwarders</TT
>.</P
></LI
><LI
><P
>Избегайте запуска вашего DNS-сервера в качестве <TT
CLASS="LITERAL"
>root</TT
>-а. Если вы запустите
ваш DNS-сервер под root-ом, то при его использовании запрашивающему будут
даны привилегии администратора. Если же вы запустите сервер под безобидным
пользователем, таким как <TT
CLASS="LITERAL"
>nobody</TT
>, то вы можете снизить риск недопустимого
использования DNS-сервера. Чтобы ваш DNS-сервер запускался с правами
пользователя <TT
CLASS="LITERAL"
>nobody</TT
>, отредактируйте файл <TT
CLASS="LITERAL"
>/etc/rc.d/init.d/named</TT
>, исправив в
нем строку <TT
CLASS="LITERAL"
>daemon named</TT
> на <TT
CLASS="LITERAL"
>daemon named -u nobody -g nobody</TT
>.</P
></LI
></OL
>&#13;</P
><P
>Убедитесь в том, что DNS-сервер запустится в процессе загрузки: <TT
CLASS="LITERAL"
>chkconfig named on</TT
>. Таким образом, DNS-сервер будет автоматически запускаться на
стандартных уровнях (3 и 5).</P
><P
>Итак, теперь вы можете запустить свой DNS-сервер: <TT
CLASS="LITERAL"
>/etc/rc.d/init.d/named start</TT
>
start</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN298"
>3.2.5. Проверяем внутреннюю сеть</A
></H3
><P
>Пока мы не настроим внешнюю сеть, DNS работать не будет (ему надо
связываться с внешними DNS-серверам), но мы можем проверить простое
подключение командой <TT
CLASS="LITERAL"
>ping</TT
>.</P
><P
>Откройте окно MSDOS на одном из ваших клиентских компьютеров, затем
наберите <TT
CLASS="LITERAL"
>ping 192.168.1.1</TT
>. Эта команда будет посылать пакеты на ваш Linux
через определенные интервалы, а ваш Linux будет посылать их обратно. Если
все работает нормально, то вы увидите список со временем хождения пакетов
по сети.</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN304"
>3.3. Настройка внешней сети</A
></H2
><P
>Теперь мы готовы к настройке внешней сети. Иногда этот процесс бывает
довольно сложным - это зависит от того, насколько хорошо ваш провайдер
поддерживает Linux. Если у вас возникли трудности, читайте "<A
HREF="http://www.linuxdoc.org/HOWTO/mini/ADSL.html"
TARGET="_top"
>ADSL mini-HOWTO</A
>". Если я смогу обнаружить где-нибудь Мини-HOWTO по кабельным модемам,
то я добавлю здесь ссылку и на него.</P
><P
>Одной из основных проблем, возникающей с внешними соединениями, является
получение IP-адреса. Некоторые провайдеры выделяют статические IP-адреса
кабельным или ADSL-клиентам - в этом случае настройка будет достаточно
простой. Однако, большинство провайдеров перешли на динамическую настройку
при помощи (вы уже наверное угадали...) DHCP. Это означает, что скорее
всего ваш Linux будет DHCP-сервером на интерфейсе <TT
CLASS="LITERAL"
>eth1</TT
>, и, одновременно,
DHCP-клиентом на интерфейсе <TT
CLASS="LITERAL"
>eth0</TT
>.</P
><P
>Более того, некоторые провайдеры применяют
специализированные нестандартные методы, предполагая, что их клиенты будут
использовать Windows. Некоторые из таких случаев будут описаны в конце
раздела 3.3.2.</P
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN312"
>3.3.1. Со статическим IP-адресом</A
></H3
><P
>Если ваш провайдер выделил вам статический IP-адрес, то у вас все
достаточно просто. Во-первых, создайте новый файл конфигурации интерфейса
<TT
CLASS="LITERAL"
>/etc/sysconfig/network-scripts/ifcfg-eth0</TT
> и внесите в него следующее:</P
><P
>DEVICE=eth0
IPADDR=x.x.x.x
NETMASK=y.y.y.y
ONBOOT=yes&#13;</P
><P
>Подставьте вместо x.x.x.x и y.y.y.y значения, данные вашим провайдером.
Затем отредактируйте файл <TT
CLASS="LITERAL"
>/etc/resolv.conf</TT
>, внеся в него следующее:</P
><P
>search provider_domain_here
nameserver n.n.n.n
nameserver m.m.m.m&#13;</P
><P
>Значение поля "домен_провайдера" должно быть предоставлено провайдером.
Вместо m.m.m.m и n.n.n.n подставьте адреса первичного и вторичного
DNS-сервера провайдера соответственно. Если вы настроили свой Linux в
качестве кэширующего DNS-сервера, то добавьте перед строками nameserver
строку <TT
CLASS="LITERAL"
>nameserver 127.0.0.1</TT
>. В результате этого ваш Linux будет сначала
обращаться к своему кэширующему DNS-серверу перед обращением к внешним
серверам.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN322"
>3.3.2. С использованием DHCP</A
></H3
><P
>Если ваш провайдер использует автоконфигурирование при помощи DHCP, то вам
надо создать новый файл конфигурации интерфейса
<TT
CLASS="LITERAL"
>/etc/sysconfig/network-scripts/ifcfg-eth0</TT
>, и написать в нем следующее:</P
><P
>DEVICE=eth0
BOOTPROTO=dhcp
ONBOOT=yes&#13;</P
><P
>Теперь убедитесь в том, что клиентский демон dhcpcd установлен в вашей
системе. Перейдите на CD с дистрибутивом вашего Linux и установите
RPM-пакет <TT
CLASS="LITERAL"
>dhcpcd</TT
>.</P
><P
>Наступило время испытать вашу новую конфигурацию сети. Дайте команду
<TT
CLASS="LITERAL"
>/etc/rc.d/init.d/network restart</TT
>. Попробуйте увидеть внешний компьютер в Интернете, например,
<TT
CLASS="LITERAL"
>www.yahoo.com</TT
> и посмотрите, получаете ли вы ответ.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN332"
>3.3.3. Хитрости и проблемы</A
></H3
><P
>В вашем конкретном случае ситуация может отличаться от вышеописанной. Ниже
приведены несколько коротких примечаний о различных сложностях, а также
ссылки на более авторитетные ресурсы по этой теме. Спасибо John Mellor за
предоставленные ссылки и настойчивые требования написать эту главу.</P
><DIV
CLASS="SECT4"
><HR><H4
CLASS="SECT4"
><A
NAME="AEN335"
>3.3.3.1. PPP по Ethernet (PPPoE)</A
></H4
><P
>Некоторые ADSL-провайдеры (например Bell Atlantic) с недавних пор начали
настаивать на том, чтобы их новые пользователи подключались к ним при
помощи протокола "PPP по Ethernet" (PPPoE). К этому они прилагают
клиентскую программу для Windows: это не совсем удобно для пользователей
Linux. К счастью, PPPoE - достаточно простой протокол, и существует
несколько способов его поддержки и в Linux.</P
><P
>&#13;<P
></P
><UL
><LI
><P
><A
HREF="http://www.roaringpenguin.com/pppoe.html"
TARGET="_top"
>PPPoE-клиент "Рев пингвина"</A
>
 - его очень настойчиво рекомендует наш читатель
Kerr First</P
></LI
><LI
><P
>&#13;<A
HREF="http://www.panix.com/~dfoster/prog/linux/pppoe.html"
TARGET="_top"
>PPPoE на Linux для Bell Sympatico </A
></P
></LI
><LI
><P
>PPPoE на Linux для Sympatico  (<A
HREF="http://www.carricksolutions.com/pppoe.htm"
TARGET="_top"
>Общая информация</A
>) (<A
HREF="http://www.carricksolutions.com/linuxpppoe.htm"
TARGET="_top"
>Информация по применению в Linux</A
>)</P
></LI
></UL
>&#13;</P
></DIV
><DIV
CLASS="SECT4"
><HR><H4
CLASS="SECT4"
><A
NAME="AEN350"
>3.3.3.2. Хитрые свойства DHCP</A
></H4
><P
>Одним из излюбленных глуповатых трюков сетевых провайдеров является
привязывание вашего сервиса к конкретному имени машины или даже к
конкретной сетевой карте. Это делается обычно ради того, чтобы вы не
подключали к интернету через хаб несколько компьютеров (конечно,
использование Linux и маскарадинга вам позволит это сделать и без ведома
компании-провайдера, к тому же значительно более защищенным образом!).</P
><P
>Если провайдер дал вам имя машины и настаивает на том, чтобы вы назвали
свой Windows именно этим именем в сети для использования сервиса
подключения к интернету, то вы должны сделать так, чтобы ваш Linux посылал
это имя при запросе адреса с DHCP-сервера.</P
><P
>Клиент DHCP в Red Hat вызывается в том случае, если вы установите в файле
конфигурации интерфейса переменную BOOTPROTO в значение "dhcp", но это
производится без предоставления DHCP-серверу имени машины. Чтобы
предоставить ему такое имя, отредактируйте файл  <TT
CLASS="LITERAL"
>/etc/sysconfig/network</TT
> и
измените строку:</P
><P
><TT
CLASS="LITERAL"
>HOSTNAME=</TT
></P
><P
>на</P
><P
><TT
CLASS="LITERAL"
>HOSTNAME=your&lowbar;isp&lowbar;assigned&lowbar;name</TT
></P
><P
>В некоторых вариантах Red Hat это может и не сработать. Если такой вариант
не пройдет, откройте скрипт <TT
CLASS="LITERAL"
>/sbin/ifup</TT
>, найдите в нем вызов dhcpcd и pump и
добавьте к ним опцию -h $HOSTNAME. Если таких строк в нем нет, то добавьте
их: <TT
CLASS="LITERAL"
>/sbin/dhcpcd -i &dollar;DEVICE -h &dollar;HOSTNAME</TT
> и <TT
CLASS="LITERAL"
>/sbin/pump -i &dollar;DEVICE
-h &dollar;HOSTNAME</TT
>.</P
></DIV
><DIV
CLASS="SECT4"
><HR><H4
CLASS="SECT4"
><A
NAME="AEN365"
>3.3.3.3. "Road Runner"</A
></H4
><P
>В кабельном сервисе "Road Runner" для получения возможности использования
сервера должна запускаться специальная процедура входа. К счастью,
существует детально описывающий эту тему "<A
HREF="http://usmcug.usm.maine.edu/~kpesce/rr"
TARGET="_top"
>Linux Road Runner HOWTO</A
>".</P
></DIV
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN369"
>3.3.4. Изучаем настройки сети</A
></H3
><P
>Теперь вы можете полюбоваться своей сетью. Запустите команду <TT
CLASS="LITERAL"
>ifconfig</TT
>, чтобы
увидеть настройку всех ваших сетевых устройств. На моем шлюзе это выглядит
примерно так:</P
><P
>eth0  Link encap:Ethernet  HWaddr 00:60:67:4A:02:0A
      inet addr:24.65.182.43  Bcast:24.65.182.255  Mask:255.255.255.0
      UP BROADCAST RUNNING MULTICAST  MTU:1500 Metric:1
      RX packets:487167 errors:0 dropped:0 overruns:0 frame:0
      TX packets:467064 errors:0 dropped:0 overruns:0 carrier:0
      collisions:89 txqueuelen:100
      Interrupt:10 Base address:0xe400
eth1  Link encap:Ethernet  HWaddr 00:80:C8:D3:30:2C
      inet addr:192.168.1.1  Bcast:192.168.1.255  Mask:255.255.255.0
      UP BROADCAST RUNNING MULTICAST  MTU:1500 Metric:1
      RX packets:284112 errors:0 dropped:0 overruns:0 frame:1
      TX packets:311533 errors:0 dropped:0 overruns:0 carrier:0
      collisions:37938 txqueuelen:100
      Interrupt:5 Base address:0xe800
lo    Link encap:Local Loopback
      inet addr:127.0.0.1  Mask:255.0.0.0
      UP LOOPBACK RUNNING  MTU:3924  Metric:1
      RX packets:12598 errors:0 dropped:0 overruns:0 frame:0
      TX packets:12598 errors:0 dropped:0 overruns:0 carrier:0
      collisions:0 txqueuelen:0&#13;</P
><P
>Заметьте, что у <TT
CLASS="LITERAL"
>eth0</TT
> имеется красивый внешний IP-адрес, а у <TT
CLASS="LITERAL"
>eth1</TT
> - частный
внутренний.</P
><P
>Вы также можете взглянуть на маршруты пакетов командой <TT
CLASS="LITERAL"
>route</TT
>. На моем шлюзе
это выглядит примерно так:</P
><P
>  Kernel IP routing table
  Destination     Gateway      Genmask         Flags Metric Ref Use Iface
  255.255.255.255 *            255.255.255.255 UH    0      0     0 eth1
  192.168.1.0     *            255.255.255.0   U     0      0     0 eth1
  24.65.182.0     *            255.255.255.0   U     0      0     0 eth0
  127.0.0.0       *            255.0.0.0       U     0      0     0 lo
  default         24.65.182.1  0.0.0.0         UG    0      0     0 eth0&#13;</P
><P
>Теперь у нас настроена внешняя и внутренняя сети, сетевые устройства,
специальный широковещательный адрес 255.255.255.255, и маршрут по умолчанию
указывает на шлюз провайдера. Великолепно!</P
><P
>Теперь у вас есть внешняя и внутренняя стороны. Все что осталось настроить
- это дверь между ними. Самое главное - мы должны убедиться в том, что
чудовища извне к нам не проникнут.</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN382"
>3.4. Безопасность</A
></H2
><P
>Одним из самых больших недостатков постоянного соединения с Интернетом при
помощи ADSL или кабеля является то, что ваш компьютер открыт для
потенциальных атак на систему защиты 24 часа в день, 7 дней в неделю.
Использование Linux в качестве шлюза снижает этот риск, потому что он
скрывает все ваши компьютеры - по мнению всех внешних компьютеров все
соединения устанавливает ваш Linux. Это означает что ваша сеть защищена
ровно настолько, насколько защищен ваш Linux, поэтому здесь я дам немного
советов о том, как защитить Linux.</P
><P
>Во-первых, надо отключить доступ всем нехорошим парням. Чтобы сделать это,
откройте файл <TT
CLASS="LITERAL"
>/etc/hosts.deny</TT
> и убедитесь что он выглядит примерно так:</P
><P
>#
# hosts.deny  Этот файл описывает имена хостов, которым
#             *запрещено* использовать локальные сервисы INET, вызываемые
#             при помощи '/usr/sbin/tcpd'.
#
#             Строка portmap в настройке устарела, но она напоминает вам,
#             что новая защищенная версия portmap использует hosts.deny и hosts.allow. В частности,
#             вы должны знать, что NFS использует portmap!
ALL: ALL</P
><P
>Здесь указано, чтобы "TCP-wrapper", контролирующий примерно 95% входящих
соединений, отказывал во входе всем соединениям со всех машин. Достаточно
полезное правило! Но в результате этого правила ваша внутренняя сеть также
не сможет соединиться с Linux, что неправильно - поэтому мы внесем пару
исключений. Откройте файл <TT
CLASS="LITERAL"
>/etc/hosts.allow</TT
> и напишите в нем следующее:</P
><P
>#
# hosts.allow Этот файл описывает имена хостов, которым
#             *разрешено* использовать локальные сервисы INET, вызываемые
#             при помощи '/usr/sbin/tcpd'.
#
ALL: 127.0.0.1
ALL: 192.168.1.</P
><P
>Здесь указано, чтобы "TCP-wrapper" разрешал все виды соединений с локальной
машины (127.0.0.1) и с внутренней сети (192.168.1.).</P
><P
>Теперь вы отгородились от внешних чудищ достаточно прочным заграждением с
хорошим замком. Если вам еще нужна сигнализация, ров и вал, то все намного
усложняется. Читайте "<A
HREF="http://www.linuxdoc.org/HOWTO/Security-HOWTO.html"
TARGET="_top"
>HOWTO: Защита</A
>" - это хороший первый шаг к большей
защищенности вашего Linux-а.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN394"
>4. Настройка маскарадинга</A
></H1
><P
>Прекрасно! Все приготовления окончены, наконец мы займемся волшебством.
IP-маскарадинг - это один из настоящих волшебных сервисов, возможных при
помощи Linux. Существуют, правда, коммерческие продукты, делающие то же
самое, но не так эффективно: античная 386 машина может при помощи Linux
предоставлять сервисы IP-маскарадинга целому офису средних размеров, но на
нем нельзя запустить нормальным образом Windows 95, чтобы использовать эти
коммерческие продукты. (Надо добавить, что я читал несколько очерков, где
утверждалось, что Windows 2000 будет поддерживать "совместное использование
соединений" без дополнительных программ. Это выглядит так, как будто опять
Microsoft поглотил сферу деятельности фирм, продававших программы
использования совместных соединений. Однако, я бы не рекомендовал запускать
Windows 2000 на 386-ой машине.)</P
><P
>В Linux встроены очень разносторонние возможности firewall, и мы будем
использовать самые простые и понятные. Если вы хотите быть экспертом
firewall-ов, то вам надо прочитать "<A
HREF="http://www.linuxdoc.org/HOWTO/Firewall-HOWTO.html"
TARGET="_top"
>Firewalling HOWTO</A
>" для понимания теории и
"" для получения подробных инструкций по использованию
утилиты <TT
CLASS="LITERAL"
>ipchains</TT
>, поставляемой вместе с ядром Linux версий 2.2.X (в
комплекте дистрибутивов Red Hat 6.X). Теперь есть еще и достаточно полный
"<A
HREF="http://www.linuxdoc.org/HOWTO/IP-Masquerade-HOWTO.html"
TARGET="_top"
>IP Masquerading HOWTO</A
>", описывающий в деталях возможности IP-маскарадинга.&#13;</P
><P
>Настроить простой маскарадинг очень просто после настройки вашей сети.
Откройте файл <TT
CLASS="LITERAL"
>/etc/rc.d/rc.local</TT
> и добавьте в его конце следующие строки:</P
><P
># 1) Очищаем все таблицы правил.
/sbin/ipchains -F input
/sbin/ipchains -F forward
/sbin/ipchains -F output
# 2) Задаем времена задержек MASQ и разрешаем вход пакетам для конфигурирования DHCP.
/sbin/ipchains -M -S 7200 10 60
/sbin/ipchains -A input -j ACCEPT -i eth0 -s 0/0 68 -d 0/0 67 -p udp
# 3) Отключаем любую пересылку пакетов, кроме идущих с внутренней сети.
#    Такие пакеты маскируем.
/sbin/ipchains -P forward DENY
/sbin/ipchains -A forward -s 192.168.1.0/24 -j MASQ
# 4) Загружаем модули, предназначенные для специальных сервисов.
/sbin/modprobe ip_masq_ftp
/sbin/modprobe ip_masq_raudio
&#13;</P
><P
>Последние две строки загружают модули ядра, позволяющие компьютерам
внутренней сети работать с FTP и RealAudio. Вы также можете загрузить
другие модули для использования специальных сервисов:</P
><P
>&#13;<P
></P
><UL
><LI
><P
>CUSeeMe (<TT
CLASS="LITERAL"
>/sbin/modprobe ip&lowbar;masq&lowbar;cuseeme</TT
>)</P
></LI
><LI
><P
>Internet Relay Chat (<TT
CLASS="LITERAL"
>/sbin/modprobe ip&lowbar;masq&lowbar;irc</TT
>)</P
></LI
><LI
><P
>Quake (<TT
CLASS="LITERAL"
>/sbin/modprobe ip&lowbar;masq&lowbar;quake</TT
>)</P
></LI
><LI
><P
>VDOLive (<TT
CLASS="LITERAL"
>/sbin/modprobe ip&lowbar;masq&lowbar;vdolive</TT
>)</P
></LI
></UL
>&#13;</P
><P
>Теперь вы готовы испытать маскарадинг! Запустите скрипт <TT
CLASS="LITERAL"
>rc.local</TT
> командой
<TT
CLASS="LITERAL"
>/etc/rc.d/rc.local</TT
>, и у вас все готово! Сядьте за один из ваших компьютеров
во внутренней сети и попробуйте походить по web. Если вам повезет, то все
будет оки-доки.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN422"
>5. Проблемы</A
></H1
><P
>Существует очень-очень много вещей, которые могут неправильно работать
после использования такого простого документа, как этот, потому что почти в
каждом случае бывают какие-то исключения или хитрости. Большинство проблем
возникает при настройке и конфигурировании внутренних и внешних
сетевых устройств. Я буду пытаться отвечать на все вопросы, выяснять, что
пошло не так, и добавлять ссылки здесь, чтобы те, у кого возникли проблемы,
могли найти соответствующую документацию. Не стесняйтесь писать мне по
адресу <A
HREF="mailto:pramsey@refractions.net"
TARGET="_top"
>pramsey@refractions.net</A
>.</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN426"
>5.1. Не работает ICQ</A
></H2
><P
>Некоторые свойства ICQ прекрасно работают с маскарадингом. Другие не
работают совсем. Существует экспериментальный модуль поддержки ICQ(<A
HREF="http://members.xoom.com/djsf/masq-icq/"
TARGET="_top"
>beta quality ICQ module</A
>) для
ядра, все еще находящийся в стадии разработки, однако с ним некоторые,
ранее не работавшие, свойства ICQ начинают работать с маскарадингом. Файл
<TT
CLASS="LITERAL"
>README</TT
> в исходных текстах этого модуля описывает, как его собрать и
установить. После его сборки и установки, загрузите модуль командой
<TT
CLASS="LITERAL"
>/sbin/modprobe ip&lowbar;masq&lowbar;icq</TT
>.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN432"
>5.2. А у меня Caldera 2.X, а не Red Hat 6.X</A
></H2
><P
>Во-первых, большое спасибо за пожертвования на хорошее дело! Во-вторых
Nelson Gibbs (ngibbs@pacbell.net) пишет, что многие из этих советов будут
работать и у вас. Правда, существуют достаточно серьезные отличия:</P
><P
>&#13;<P
></P
><OL
TYPE="1"
><LI
><P
>Опция <TT
CLASS="LITERAL"
>GATEWAY=xxx.xxx.xxx.xxx</TT
> в файле настройки интерфейсов
<TT
CLASS="LITERAL"
>/etc/sysconfig/network-scripts/ifcfg-eth0</TT
> и <TT
CLASS="LITERAL"
>eth1</TT
> (для локального интерфейса
надо проставить адрес внешнего, а для внешнего - адрес IP-шлюза
провайдера).</P
></LI
><LI
><P
>Убедитесь в том, что в скрипте <TT
CLASS="LITERAL"
>/etc/sysconfig/daemons/dhcpd</TT
> опция
<TT
CLASS="LITERAL"
>ROUTE&lowbar;DEVICE</TT
> указывает
 на <TT
CLASS="LITERAL"
>eth1</TT
>, а не на <TT
CLASS="LITERAL"
>eth0</TT
>.</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>/etc/dhcpd.conf</TT
> необходимо внести указание подсети для обоих
интерфейсов (Я не знаю почему, но после того, как я добавил команду subnet
216.102.154.201 netmask 255.255.255.255 &lcub; &rcub; без опций, сервер
DHCP начинает работать на обоих интерфейсах eth0 и eth1, и даже на lo0).
Если же указать только одну подсеть, то DHCP-сервер не работает, выдавая
ошибку.</P
></LI
><LI
><P
>Не добавляйте маршрут на машину <TT
CLASS="LITERAL"
>255.255.255.255</TT
>, скрипт
<TT
CLASS="LITERAL"
>/etc/rc.d/init.d/dhcpd</TT
>. Caldera сам исправляет эту проблему. Убедитесь в
том, что изменили в скриптах все ссылки на <TT
CLASS="LITERAL"
>eth0</TT
> на <TT
CLASS="LITERAL"
>eth1</TT
>.</P
></LI
></OL
>&#13;</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN457"
>5.3. Я хочу, чтобы одна из моих внутренних машин была Web-сервером</A
></H2
><P
>Очень просто! Однако для этого вам надо иметь статический IP-адрес,
чтобы использовать эти советы. Если же у вас динамический IP-адрес, то вам
понадобятся дополнительные скрипты, меняющие IP-адреса в командах
переназначения портов.</P
><P
>Вам также надо помнить, что переназначение внешнего порта на внутреннюю
машину делает вашу "внутреннюю" машину менее "внутренней", но это можно
сделать достаточно просто без потери производительности. Одним из побочных
эффектов IP-маскарадинга, встроенного в ядро Linux, является возможность
вносить достаточно веселые изменения в пакеты, проходящие по сети - этим
занимается утилита <TT
CLASS="LITERAL"
>ipmasqadm</TT
>.</P
><P
>По каким-то причинам <TT
CLASS="LITERAL"
>ipmasqadm</TT
> не поставляется в комплекте Red Hat и
Mandrake, поэтому вам придется взять его с <A
HREF="http://juanjox.kernelnotes.org"
TARGET="_top"
>веб-сайта создателя</A
> --
существует и <A
HREF="http://juanjox.kernelnotes.org/ipmasqadm-0.4.2-2.i386.rpm"
TARGET="_top"
>RPM-пакет</A
>, и исходный текст.</P
><P
>После того, как вы получите RPM, установите его и добавьте следующие строки
в скрипт <TT
CLASS="LITERAL"
>/etc/rc.d/rc.local</TT
>:</P
><P
>/usr/sbin/ipmasqadm portfw -f
/usr/sbin/ipmasqadm portfw -a -P tcp -L x.x.x.x 80 -R 192.168.1.x 80&#13;</P
><P
>Первая команда очищает таблицу правил переназначения портов, а вторая
добавляет переназначение порта 80 с внешнего интерфейса на порт 80
внутренней машины. Заметьте, что вместо x.x.x.x надо подставить внешний
статический IP-адрес, а вместо 192.168.1.x.- IP-адрес внутренней машины.</P
><P
>Теперь внешние запросы на порт 80 будут переназначаться на порт 80
внутренней машины.  Вы можете проверить эту настройку следующим образом:
используйте команду telnet или ей подобную на внешний IP-адрес вашего
шлюза: код переназначения портов обрабатывает только запросы, идущие с
<I
CLASS="EMPHASIS"
>внешнего</I
> интерфейса.

Now external requests for port 80 will be transparently sent to port 80
of the internal machine. Note that you cannot test this by telnetting or connecting
to your gateway's port 80 from one of your inside machine: the port forwarder
only honors requests coming in on the <I
CLASS="EMPHASIS"
>external</I
> interface.</P
></DIV
></DIV
></DIV
></BODY
></HTML
>