<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML
><HEAD
><TITLE
>Мини-HOWTO: Мост + Firewall + DSL</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.57"></HEAD
><BODY
CLASS="ARTICLE"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="ARTICLE"
><DIV
CLASS="TITLEPAGE"
><H1
CLASS="TITLE"
><A
NAME="AEN2"
>Мини-HOWTO: Мост + Firewall + DSL</A
></H1
><DIV
CLASS="AUTHORGROUP"
><A
NAME="AEN4"
></A
><H3
CLASS="AUTHOR"
><A
NAME="AEN5"
>Derek Ney</A
></H3
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
>&nbsp;&nbsp;&nbsp;&nbsp;     derek@hipgraphics.com
    <br>
&nbsp;&nbsp;&nbsp;</P
></DIV
></DIV
><H3
CLASS="CORPAUTHOR"
> Перевод: <A
HREF="mailto:sam@asp-linux.com"
TARGET="_top"
>Станислав Рогин</A
>,
 <A
HREF="http://www.asplinux.com"
TARGET="_top"
>SWSoft Pte Ltd.</A
>
 </H3
></DIV
><P
CLASS="PUBDATE"
>24 марта 2000<BR></P
><DIV
><DIV
CLASS="ABSTRACT"
><A
NAME="AEN15"
></A
><P
></P
><P
>Настройка моста+firewall на Linux-системе, использующей DSL-соединение</P
><P
></P
></DIV
></DIV
><HR></DIV
><DIV
CLASS="TOC"
><DL
><DT
><B
>Содержание</B
></DT
><DT
>1. <A
HREF="Bridge+Firewall+DSL.html#INTRODUCTION"
>Введение</A
></DT
><DD
><DL
><DT
>1.1. <A
HREF="Bridge+Firewall+DSL.html#HISTORY"
>История</A
></DT
><DT
>1.2. <A
HREF="Bridge+Firewall+DSL.html#AEN23"
>Новые версии</A
></DT
><DD
><DL
><DT
>1.2.1. <A
HREF="Bridge+Firewall+DSL.html#AEN27"
>История изменения версий</A
></DT
></DL
></DD
><DT
>1.3. <A
HREF="Bridge+Firewall+DSL.html#AEN44"
>Copyrights</A
></DT
><DT
>1.4. <A
HREF="Bridge+Firewall+DSL.html#AEN49"
>Авторские права</A
></DT
></DL
></DD
><DT
>2. <A
HREF="Bridge+Firewall+DSL.html#AEN58"
>Мосты, Firewall-ы, и DSL-соединения</A
></DT
><DD
><DL
><DT
>2.1. <A
HREF="Bridge+Firewall+DSL.html#AEN63"
>Суть проблемы</A
></DT
><DT
>2.2. <A
HREF="Bridge+Firewall+DSL.html#AEN67"
>Решение</A
></DT
><DT
>2.3. <A
HREF="Bridge+Firewall+DSL.html#AEN82"
>Общий обзор настроек</A
></DT
><DT
>2.4. <A
HREF="Bridge+Firewall+DSL.html#AEN87"
>Литература</A
></DT
></DL
></DD
><DT
>3. <A
HREF="Bridge+Firewall+DSL.html#AEN98"
>Настройка</A
></DT
><DD
><DL
><DT
>3.1. <A
HREF="Bridge+Firewall+DSL.html#AEN111"
>Пример конфигурации</A
></DT
><DT
>3.2. <A
HREF="Bridge+Firewall+DSL.html#HARDWARE-SETUP"
>Настройка оборудования</A
></DT
><DT
>3.3. <A
HREF="Bridge+Firewall+DSL.html#AEN127"
>Настройка моста</A
></DT
><DT
>3.4. <A
HREF="Bridge+Firewall+DSL.html#AEN136"
>Конфигурация ядра</A
></DT
><DT
>3.5. <A
HREF="Bridge+Firewall+DSL.html#AEN142"
>Соединяем все вместе</A
></DT
><DT
>3.6. <A
HREF="Bridge+Firewall+DSL.html#AEN174"
>Настройка Firewall</A
></DT
><DT
>3.7. <A
HREF="Bridge+Firewall+DSL.html#AEN179"
>Настройка локальных машин</A
></DT
></DL
></DD
><DT
>4. <A
HREF="Bridge+Firewall+DSL.html#AEN182"
>Проблемы</A
></DT
><DD
><DL
><DT
>4.1. <A
HREF="Bridge+Firewall+DSL.html#AEN184"
>Странные сообщения команды <I
CLASS="EMPHASIS"
>ipchains -X</I
></A
></DT
><DT
>4.2. <A
HREF="Bridge+Firewall+DSL.html#AEN192"
>Совместное использование прерываний</A
></DT
></DL
></DD
></DL
></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="INTRODUCTION"
>1. Введение</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="HISTORY"
>1.1. История</A
></H2
><P
>Этот документ был начат 10 декабря 1999 автором Derek Ney <A
HREF="mailto:derek@hipgraphics.com"
TARGET="_top"
>derek@hipgraphics.com</A
> после трех дней настройки моста и firewall (после перехода с PPP-сети на DSL-соединение).</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN23"
>1.2. Новые версии</A
></H2
><P
>Самую свежую версию этого документа можно найти в различных форматах на домашней странице "Проекта документирования Linux" (LDP) по адресу <A
HREF="http://www.linuxdoc.org/"
TARGET="_top"
>http://www.linuxdoc.org/</A
>.</P
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN27"
>1.2.1. История изменения версий</A
></H3
><P
>версия 0.03 (24 марта 2000)</P
><P
>&#13;<P
></P
><UL
><LI
><P
>Исправлен ошибочный URL на файл BRCFG.tgz</P
></LI
></UL
>&#13;</P
><P
>версия 0.02 (13 декабря 1999)</P
><P
>&#13;<P
></P
><UL
><LI
><P
>Учтены замечания Leonard Dickens (спасибо Leonard!)</P
></LI
></UL
>&#13;</P
><P
>версия 0.01 (10 декабря 1999)</P
><P
>&#13;<P
></P
><UL
><LI
><P
>Исходная версия</P
></LI
></UL
>&#13;</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN44"
>1.3. Copyrights</A
></H2
><P
>(c) 1999,2000 Derek R. Ney</P
><P
>This document may be distributed under the terms set forth in the LDP license
at <A
HREF="http://www.linuxdoc.org/COPYRIGHT.html"
TARGET="_top"
>http://www.linuxdoc.org/COPYRIGHT.html</A
>.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN49"
>1.4. Авторские права</A
></H2
><P
>Авторские права на русский перевод этого текста принадлежат &copy; 2000 SWSoft Pte Ltd.
Все права зарезервированы.</P
><P
>Этот документ является частью проекта Linux HOWTO.</P
><P
>Авторские права на документы Linux HOWTO принадлежат их авторам, если явно
не указано иное. Документы Linux HOWTO, а также их переводы, могут
быть воспроизведены и распространены полностью или частично на любом
носителе, физическом или электронном, при условии сохранения этой заметки об
авторских правах на всех копиях. Коммерческое распространение разрешается и
поощряется; но, так или иначе, автор текста и автор перевода желали бы знать о
таких дистрибутивах.</P
><P
>Все переводы и производные работы, выполненные по документам Linux HOWTO,
должны сопровождаться этой заметкой об авторских правах. Это делается в
целях предотвращения случаев наложения дополнительных ограничений на
распространение документов HOWTO. Исключения могут составить случаи
получения специального разрешения у координатора Linux HOWTO, с которым
можно связаться по адресу приведенному ниже.</P
><P
>Мы бы хотели распространить эту информацию по всем возможным каналам. Но
при этом сохранить авторские права и быть уведомленными о всех планах
распространения HOWTO. Если у вас возникли вопросы, пожалуйста, обратитесь
к координатору проекта Linux HOWTO по электронной почте:
<TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:linux-howto@metalab.unc.edu"
>linux-howto@metalab.unc.edu</A
>&#62;</TT
> или к координатору русского
перевода Linux HOWTO компании SWSoft Pte Ltd. по адресу
<TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:linux-howto@asplinux.ru"
>linux-howto@asplinux.ru</A
>&#62;</TT
></P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN58"
>2. Мосты, Firewall-ы, и DSL-соединения</A
></H1
><P
>До недавних пор наша сеть была подключена к Интернету, при помощи модема и
протокола PPP. Я установил на шлюз сети firewall, используя IPChains
(<A
HREF="http://www.linuxdoc.org/HOWTO/IPCHAINS-HOWTO.html"
TARGET="_top"
>cмотрите
"Мини-HOWTO: IPChains"</A
>), и все работало прекрасно. Недавно мы
перешли на использование DSL-соединения. Я думал, что все будет очень
просто - переключить firewall на DSL-соединение, и все будет работать, как
раньше, однако я ошибался. На полную настройку и запуск мне понадобилось
три дня. Я прочел огромный объем сопутствующей информации в сети, которая
порой противоречила одна другой. Этот документ был создан потому, что, как я
предполагаю, в будущем DSL станет значительно более распространен, и
мои советы могут понадобиться многим. Я надеюсь, при помощи этого Мини-HOWTO,
вы сможете сэкономить значительное время.</P
><P
>Я предполагаю, что эти советы можно применить и к нуль-модемной конфигурации, но это лишь предположение - я ничего не знаю о нуль-модемных соединениях.</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN63"
>2.1. Суть проблемы</A
></H2
><P
>Передо мной встала следующая проблема: настроить систему так, чтобы код firewall-а в ядре (управляемый ipchains) мог быть использован для фильтрации пакетов, идущих между глобальной и локальной сетью. Мне также требовалось, чтобы локальные машины были "видны" в глобальной сети (не исключая работы firewall). Вроде, казалось, IP-маскарадинг (смотрите
<A
HREF="http://www.linuxdoc.org/HOWTO/IP-Masquerade-HOWTO.html"
TARGET="_top"
>HOWTO: IP-маскарадинг</A
>) - наиболее простое решение в моей ситуации. Но все оказалось не так просто.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN67"
>2.2. Решение</A
></H2
><P
>Чтобы достигнуть нашей цели - изолировать локальную сеть от глобальной (к
которой мы подключены при помощи DSL), используя нашу Linux-машину - необходимы
две сетевых карты. Одна карта подключена к локальной сети,
вторая - к глобальной. Единственная машина, которая может свободно общаться
с окружающим миром - это наш Linux. Все остальные машины должны общаться с
внешним миром через firewall, установленный на Linux.</P
><P
>Настройка системы состоит из двух частей, выполняющих разные задачи:</P
><P
>&#13;<P
></P
><UL
><LI
><P
>Маршрутизация пакетов между глобальной и локальной сетями (мост)</P
></LI
><LI
><P
>Фильтрация ненужных, неразрешенных и опасных пакетов (firewall)</P
></LI
></UL
>&#13;</P
><P
>В <A
HREF="http://www.linuxdoc.org/HOWTO/mini/Bridge.html"
TARGET="_top"
>"Мини-Howto:
Мосты"</A
> приведены подробные инструкции, решающие первую проблему -
маршрутизацию пакетов между двумя сторонами сети (локальной и глобальной).
Это проделывается следующим способом: обе карты переводятся в режим
"promisc", в котором они обрабатывают все пакеты, проходящие по сети, и
передают пакеты на другую сторону моста, если там находится их получатель.
Эта процедура прозрачна для сети - другие компьютеры даже не видят мост,
потому что он даже не имеет IP-адреса. Но это - неполное решение проблемы.
Мне нужно, чтобы firewall имел IP-адрес (для административных функций, если
не более), и, что гораздо важнее, код моста в ядре перехватывает и передает
пакеты до того, как они попадут в firewall, и поэтому в этой ситуации
firewall не работает.</P
><P
>Выяснилось, что возможно одновременно назначить IP-адреса сетевым картам и использовать их в качестве моста. Несмотря на то, что в <A
HREF="http://www.linuxdoc.org/HOWTO/mini/Bridge.html"
TARGET="_top"
>"Мини-Howto: Мосты"</A
>
это не делается (ну, на самом деле, там используются внутренние адреса) - все прекрасно работает. Это полностью разрешает первую проблему. Чтобы решить вторую, мы установим патч ядра (он находится по адресу <A
HREF="http://ac2i.tzo.com/bridge_filter/"
TARGET="_top"
>http://ac2i.tzo.com/bridge_filter/</A
>), который позволяет применять правила firewall к пакетам, проходящим через сеть, добавляя в таблицу firewall новое правило "bridgein".</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN82"
>2.3. Общий обзор настроек</A
></H2
><P
>Этот мини-HOWTO предназначен для ситуаций, когда ваш Linux является
шлюзом/firewall. В системе установлены две сетевых карты. Одна из карт
подключена к внешнему миру (в нашем случае это DSL-модем), и ничто больше к
нему не подключено. Вторая карта находится в нашей локальной сети.</P
><P
>Заметьте, что я описываю все с моих позиций: машина i386 (ABIT BP6 MOBO, с 2-мя Celeron-ами), RedHat 6.0 с ядром версии 2.2.13, и DSL-модем, подключенный к маршрутизатору, и две сетевых карты Netgear FA310TX. В вашем случае все может отличаться.</P
><P
>Также учтите, что некоторые шаги, описанные здесь, оставляют вашу сеть незащищенной от потенциальных атак извне (до полного запуска firewall). Если для вас это неприемлемо - вам придется применить дополнительные меры безопасности.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN87"
>2.4. Литература</A
></H2
><P
>Я прочитал достаточно большой объем информации до того, как пришел к полностью работающему варианту. Часть информации оказалась полезной, но не совсем корректной.</P
><P
><A
HREF="http://www.linuxdoc.org/HOWTO/mini/Bridge.html"
TARGET="_top"
>"Мини-Howto: Мосты"</A
>
был первым инструментом, примененным в настройках. К сожалению, его использование не включает в себя firewall.</P
><P
><A
HREF="http://www.linuxdoc.org/HOWTO/mini/Bridge+Firewall.html"
TARGET="_top"
>"Мини-Howto: Мост+Firewall"</A
> вначале казался именно тем, что мне
нужно. Однако теперь я считаю, что этот документ не совсем корректен. При
помощи этого документа у меня вроде бы все заработало, но, в конце концов, я
понял, что совсем не нужно разделять свою подсеть на две половины, как
советует этот мини-HOWTO, и потом отказался от этого метода. Если вы
все-таки будете читать этот документ, то отнеситесь к нему с изрядной долей
критики.</P
><P
><A
HREF="http://ac2i.tzo.com/bridge_filter/"
TARGET="_top"
>Патч "Фильтр
моста"</A
> - ключ к запуску всего. Как ни странно, информация на сайте
предлагает вам использовать советы "Мини-Howto: Мост+Firewall" . Чтобы все
запустить, вам эти советы не понадобятся. Понадобится лишь этот патч.</P
><P
><A
HREF="http://www.linuxdoc.org/HOWTO/IPCHAINS-HOWTO.html"
TARGET="_top"
>"Howto:
IPCHAINS"</A
> бесценен при настройке собственно firewall. Я не пытаюсь
в этом документе детально описывать настройку firewall - лишь упомяну о
вещах, которые отличаются, в связи с использованием моста, описанного здесь.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN98"
>3. Настройка</A
></H1
><P
>Полная настройка состоит из следующих шагов:</P
><P
>&#13;<P
></P
><UL
><LI
><P
>Настройка оборудования (и проверка того, что оно работает)</P
></LI
><LI
><P
>Патч и конфигурирование ядра</P
></LI
><LI
><P
>Настройка сети (ifconfig, маршрутизация, мост)</P
></LI
><LI
><P
>Настройка firewall</P
></LI
></UL
>&#13;</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN111"
>3.1. Пример конфигурации</A
></H2
><P
>В процессе описания настроек я буду предполагать, что у вас установлены две
сетевых карты, имеется внешнее DSL-соединение (DSL-модем подключен к одной
из сетевых карт), и локальная сеть, подключенная ко второй сетевой карте. Я
называю карту, подключенную к DSL-модему "eth1", а карту локальной сети -
"eth0". Имена карт в системе зависят от того, в какой слот они
включены.</P
><P
>Я также предполагаю, что вам выделена подсеть IP-адресов 192.168.2.128-191,
т.е маска сети будет - 255.255.255.192, а DSL-маршрутизатор имеет адрес
192.168.2.129. Все эти значение - фиктивные, они здесь приведены
исключительно для иллюстрации сути настройки. Я буду использовать IP-адрес
192.168.2.130 для firewall-машины (на обеих сетевых картах), хотя я выяснил,
что можно иметь и различные адреса для сетевых карт, если вам это
необходимо.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="HARDWARE-SETUP"
>3.2. Настройка оборудования</A
></H2
><P
>Вам понадобятся две сетевые карты. Самая большая проблема, с которой я
столкнулся, возникла после того, как я выбрал первый попавшийся PCI-слот
для второй карты на материнской плате, и оказалось, что этот слот
использовал то же прерывание, что и первая карта. Я вообще не знал, что
из-за этого могут возникнуть проблемы (на этот предмет не было никакой
информации, и я думал, что все будет нормально работать). Обе карты тихо
умерли (без индикации каких-либо ошибок) и перестали вообще передавать и
принимать пакеты. Обычно, когда вы пытаетесь изменить конфигурацию,
последнее, что делаете - меняете слоты карт. Я не знаю, существует ли эта
проблема для всех сетевых карт, или только для наших, но я бы никому не
советовал использовать общие прерывания. Драйвер, который мы будем
использовать, выдает на экран IRQ каждой сетевой карты при загрузке
системы. Существует большое количество советов, как заставить ядро
обнаружить несколько сетевых карт (смотрите <A
HREF="http://www.linuxdoc.org/HOWTO/Ethernet-HOWTO.html"
TARGET="_top"
>"Howto:
Ethernet"</A
> , раздел <A
HREF="http://www.linuxdoc.org/HOWTO/Ethernet-HOWTO-3.html#ss3.2"
TARGET="_top"
>Использование нескольких сетевых карт на одной машине</A
>); однако,
мне это не понадобилось (мое ядро обнаруживало обе карты без каких-либо
аргументов).</P
><P
>Затем вам надо подключить вторую карту к DSL-модему (или к тому, что
соединяет вас с внешним миром) и убедиться, что это соединение работает. Вы
должны дать команду ifconfig для второй карты с соответствующим IP-адресом
и увидеть работающий ping до маршрутизатора на дальнем конце подключения к
глобальной сети. Таким образом вы проверите, можно ли вы посылать пакеты
по DSL-соединению. Например, в нашей сети нужно сделать следующее:</P
><P
>  ifconfig eth1 192.168.2.130 netmask 255.255.255.192 broadcast 192.168.2.191</P
><P
>чтобы настроить вторую карту. А затем</P
><PRE
CLASS="PROGRAMLISTING"
>  ifconfig eth0 down # чтобы быть уверенным в том, что эта карта не мешает работе
  ping 192.168.2.129</PRE
><P
>чтобы проверить доступность маршрутизатора. Для пущей уверенности проверьте
доступность машин локальной сети через первую карту:</P
><PRE
CLASS="PROGRAMLISTING"
>  ifconfig eth1 down # чтобы быть уверенным в том, что эта карта не мешает работе
  ifconfig eth0 up 
  ping 192.168.2.x # где x - это адрес машины в локальной сети
 </PRE
><P
>К этому моменту вы имеете полную уверенность в том, что оборудование исправно и работает.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN127"
>3.3. Настройка моста</A
></H2
><P
>Вам понадобится <A
HREF="ftp://ftp.tux.org/people/alan-cox/BRCFG.tgz"
TARGET="_top"
>утилита конфигурирования моста</A
> (автор Alan Cox) - она позволит
контролировать работу моста, встроенного в ядро при включенной опции
CONFIG_BRIDGE. <I
CLASS="EMPHASIS"
>BRCFG</I
> распространяется в
виде исходных текстов и заранее скомпилированных исполняемых файлов. Я не
знаю, с каким ядром были собраны эти файлы, но у меня все несколько
разошлось, когда я попытался собрать их с include-файлами моего ядра
(2.2.13). Поэтому, к сожалению, эти исходные тексты пришлось немного
подправить. Ниже приведен сам патч:</P
><PRE
CLASS="PROGRAMLISTING"
>diff -C 3 -r /tmp/BRCFG/brcfg.c ./brcfg.c
*** /tmp/BRCFG/brcfg.c  Wed Feb 21 19:11:59 1996
--- ./brcfg.c   Wed Dec  8 12:52:23 1999
***************
*** 1,6 ****
  
! #include &#60;sys/types.h&#62;
! #include &#60;sys/socket.h&#62;
  #include &#60;skbuff.h&#62;
  
  #include "br.h"
--- 1,6 ----
  
! #include &#60;types.h&#62;
! #include &#60;socket.h&#62;
  #include &#60;skbuff.h&#62;
  
  #include "br.h"
 </PRE
><P
>Используйте этот патч, пересоберите <I
CLASS="EMPHASIS"
>brcfg</I
> и установите их в соответствующее место (Я выбрал <I
CLASS="EMPHASIS"
>/usr/sbin</I
>).</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN136"
>3.4. Конфигурация ядра</A
></H2
><P
>Вам придется собрать свое ядро с применением включенной опции "Мост" и патча фильтрования моста (а также firewall-а, сети и т.п., если у вас еще это не встроено). Вам, как минимум, потребуются следующие опции ядра:</P
><PRE
CLASS="PROGRAMLISTING"
>  CONFIG_EXPERIMENTAL=y
  CONFIG_BRIDGE=y
  CONFIG_FIREWALL=y           
  CONFIG_IP_FIREWALL=y        </PRE
><P
>Вам также придется взять <A
HREF="http://ac2i.tzo.com/bridge_filter/"
TARGET="_top"
>Патч фильтрования моста</A
>
и применить его к ядру. Пересоберите, установите новое ядро и перезагрузитесь.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN142"
>3.5. Соединяем все вместе</A
></H2
><P
>Итак, теперь у нас имеются две сетевые карты, вновь собранное ядро и установленный пакет <I
CLASS="EMPHASIS"
>brcfg</I
>.
Теперь вам понадобится стартовый скрипт, запускающий все это при загрузке системы. Я использовал загрузочные скрипты в стиле RedHat (<I
CLASS="EMPHASIS"
>/etc/rc.d</I
>). Специфические данные: сетевые адреса и маски я поместил в файл <I
CLASS="EMPHASIS"
>/etc/sysconfig/network</I
>:</P
><PRE
CLASS="PROGRAMLISTING"
> GATEWAY=192.168.2.129          # адрес DSL-маршрутизатора
 GATEWAYDEV=eth1                # сетевая карта, к которой подключен DSL
 ETH0_ADDR=192.168.2.130        # IP-адрес сетевой карты в локальной сети
 ETH0_MASK=255.255.255.192	# Сетевая маска нашей локальной сети
 ETH0_BROAD=192.168.2.191       # Широковещательный (broadcast) адрес локальной сети
 ETH1_ADDR=192.168.2.130        # IP-адрес сетевой карты, подключенной к DSL
                                # (он может отличаться от адреса карты в локальной сети)
 ETH1_MASK=$ETH0_MASK           # Сетевая маска на стороне DSL, она должна быть аналогична маске eth0
 ETH1_BROAD=$ETH1_BROAD         # то же самое и для широковещательного адреса</PRE
><P
>(Примечание переводчика: Видимо в эти настройки вкралась ошибка. В последней строке, по видимому, должно быть написано ETH1_BROAD=$ETH0_BROAD)</P
><P
>Затем я создал скрипт под именем <I
CLASS="EMPHASIS"
>/etc/rc.d/init.d/bridge</I
>, занимающийся настройкой моста:</P
><PRE
CLASS="PROGRAMLISTING"
>#!/bin/sh
#
# bridge      Этот скрипт настраивает мост на DSL
#
# Описание: Скрипт использует brcfg для запуска моста и ifconfig для настройки сетевых карт
# имя процесса: bridge
# config: 

# Исходный текст библиотеки функций.
. /etc/rc.d/init.d/functions

# Исходная конфигурация сети.
. /etc/sysconfig/network

# Обработка способа вызова скрипта.
case "$1" in
  start)
        echo -n "Настройка моста (Configuring bridge): "
        ifconfig eth0 $ETH0_ADDR netmask $ETH0_MASK broadcast $ETH0_BROAD
        ifconfig eth1 $ETH1_ADDR netmask $ETH1_MASK broadcast $ETH1_BROAD
        route add $GATEWAY dev $GATEWAYDEV
        route add default gw $GATEWAY dev $GATEWAYDEV
        ifconfig eth0 promisc
        ifconfig eth1 promisc
        brcfg -enable
        echo
        ;;
  stop)
        # Остановка демонов.
        brcfg -disable
        ifconfig eth0 down
        ifconfig eth1 down
        ;;
  restart)
        $0 stop
        $0 start
        ;;
  status)
        ifconfig eth0
        ifconfig eth1
        brcfg
        ;;
  *)
        echo "Использование: bridge {start|stop|restart|status}"
        exit 1
esac

exit 0
 </PRE
><P
>Этот скрипт запускается при загрузке системы. Он выделяет адреса каждой карте, добавляет маршрут по умолчанию, указывающий на маршрутизатор DSL, добавляет специальный маршрут именно на DSL-маршрутизатор, устанавливает обе карты в режим "promisc", и затем включает мост. Я также создал ссылки на этот скрипт в следующих каталогах в <I
CLASS="EMPHASIS"
>/etc/rc.d</I
>: </P
><PRE
CLASS="PROGRAMLISTING"
> /etc/rc.d/rc0.d/K90bridge
 /etc/rc.d/rc1.d/K90bridge
 /etc/rc.d/rc2.d/S11bridge
 /etc/rc.d/rc3.d/S11bridge
 /etc/rc.d/rc4.d/S11bridge
 /etc/rc.d/rc5.d/S11bridge
 /etc/rc.d/rc6.d/K90bridge</PRE
><P
>В результате этого, скрипт запускается после запуска сети. Вам также необходимо убрать любое другое конфигурирование сетевых карт, которое делается в скрипте <I
CLASS="EMPHASIS"
>/etc/rc.d/init.d/network</I
> (в RedHat это достигается удалением файлов <I
CLASS="EMPHASIS"
>ifcfg-eth?</I
> в каталоге <I
CLASS="EMPHASIS"
>/etc/sysconfig/network-scripts/</I
>).</P
><P
>Чтобы проверить, все ли работает, я бы советовал загрузиться вам в однопользовательском режиме (укажите ядру опцию <I
CLASS="EMPHASIS"
>"single"</I
>
, т.е. в lilo наберите "lilo: linux single"), а затем по одному загружать скрипты из каталога <I
CLASS="EMPHASIS"
>/etc/rc.d/rc3.d</I
>, пока не запустите мост. Запустив мост, проверьте, доступны ли вам некоторые машины (возможно вам придется использовать команду "<I
CLASS="EMPHASIS"
>ping -n</I
>", чтобы не включенный еще DNS не вызывал проблем):</P
><P
>&#13;<P
></P
><UL
><LI
><P
>используйте команду ping для DSL-маршрутизатора</P
></LI
><LI
><P
>используйте команду ping для локальной машины</P
></LI
><LI
><P
>используйте команду ping для машины в глобальной сети</P
></LI
></UL
>&#13;</P
><P
>Если вам доступны все три вида машин, то, скорее всего, все работает. Заметьте, что настройка моста практически не занимает времени при загрузке системы. Вы всегда можете проверить состояние моста командой <I
CLASS="EMPHASIS"
>brcfg</I
> без параметров.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN174"
>3.6. Настройка Firewall</A
></H2
><P
>Вы все еще не настроили firewall (если таковой вам нужен) для предотвращения неавторизованного доступа к локальной сети. <A
HREF="http://ac2i.tzo.com/bridge_filter/"
TARGET="_top"
>Патч "Фильтрование моста"</A
>
, который вы установили, позволяет вам использовать новое встроенное правило "bridgein" в команде ipchains. Это правило используется, когда пакет передается по мосту от eth0 к eth1, или наоборот. Это правило не используется, когда пакет назначается самому firewall-у; вместо этого вам надо использовать правило input. Я не буду углубляться в детали настройки firewall; для этого читайте
<A
HREF="http://www.linuxdoc.org/HOWTO/IPCHAINS-HOWTO.html"
TARGET="_top"
>Howto: ipchains</A
>.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN179"
>3.7. Настройка локальных машин</A
></H2
><P
>На каждой локальной машине вам надо просто правильно настроить IP-адрес, маску сети и использовать DSL-маршрутизатор в качестве шлюза по умолчанию. Firewall/мост будет направлять пакеты к DSL-маршрутизатору и от него.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="AEN182"
>4. Проблемы</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN184"
>4.1. Странные сообщения команды <I
CLASS="EMPHASIS"
>ipchains -X</I
></A
></H2
><P
>Те изменения, котрые мы внесли в ядро патчем "Фильтрование моста" приводят к тому, что команда <I
CLASS="EMPHASIS"
>ipchains -X</I
>, выдает следующую ошибку:</P
><P
><PRE
CLASS="PROGRAMLISTING"
> ipchains: Device or resource busy
 ipchains: Устройство или ресурс занят</PRE
></P
><P
>Насколько я могу об этом судить - это безобидная ошибка. Я предполагаю, что ipchains не рассматривает новое правило bridgein, как встроенное.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN192"
>4.2. Совместное использование прерываний</A
></H2
><P
>Как я уже упоминал в разделе "<A
HREF="Bridge+Firewall+DSL.html#HARDWARE-SETUP"
><I
>Настройка оборудования</I
></A
>", нежелательно использовать одно и тоже
прерывание для обеих сетевых карт, как, наверно, и нежелательно разделять их
IRQ и с другими устройствами.</P
></DIV
></DIV
></DIV
></BODY
></HTML
>