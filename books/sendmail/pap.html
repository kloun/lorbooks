<HTML>
<HEAD>
<TITLE>SENDMAIL</TITLE>
</HEAD>
<BODY LINK="#0000ff" VLINK="#800080">
<center>
<b>
<P>SENDMAIL - Межсетевой почтовый роутер </p>
<p>Eric Allman<a name=1a><a href="pap.html#1"><SUP>1</SUP></a></p>
<U><P>University of California, Berkeley Mammoth Project</P></U></b>
Перевод <a href=mailto:asp@pvrr.ru> Плотникова Александра</a> 
</center>
<hr>
<center><B><P>Предисловие переводчика</P></B></center>
<p>Это первый документ, который я взялся переводить при моей разборке с sendmail. Супер-точности перевода не гарантирую, но основной смысл я, надеюсь, сумел донести. </p>
<p>Против распространения не возражаю, единственное условие: оставить все как есть, не внося никаких изменений.<br>
Эту и много другой документации вы сможете найти <a href=http://gyro.pvrr.ru/index.html>у меня на страничке</a>.<br>
Приму любые конструктивные замечания и предложения, направляйте их на адрес <a href=mailto:asp@pvrr.ru>asp@pvrr.ru</a>.
<hr>
<center><b><P>ABSTRACT</P></b></center>
<P> Маршрутизация почты в гетерогенном Internet представляет много новых проблем. Одна из худших - это преобразование адресов. Исторически, это производилось на<u> специальной</u> основе. Однако, этот подход при росте Internet  стал неуправляемым.</P>
<P> Sendmail работает как обьединенное "почтовое отделение",  куда может быть доставлена  вся почта. Интерпретация адресов контролируется рабочей системой, которая может производить синтаксический анализ адресов на основе доменов и старых адресов в специализированном виде. Рабочая система  достаточно мощна для того, чтобы переделывать адреса в заголовках сообщений, чтобы они соответствовали стандартам ряда общедоступных сетей, включая старую (NCP/RFC733) Arpanet, новую (TCP/RFC822) Arpanet, UUCP, и Phonenet. Sendmail также обеспечивает SMTP сервер, организацию очередей сообщений, и совмещение имен (aliasing).</P>
<U><P>Sendmail</U> представляет средство общей межсетевой почтовой маршрутизации, обеспечивающее совмещение имен (aliasing) и пересылку (forwarding), автоматическую маршрутизацию к сетевым шлюзам, и гибкую конфигурацию.</P>
<P> В простой сети, каждый узел имеет адрес, и ресурсы могут быть идентифицированы парой хост-ресурс; в частности, почтовая система может идентифицировать пользователей, используя пару хост-имя пользователя. Имена хостов и их число должны управляться централизованно, но имена пользователей  могут быть назначены локально на каждом хосте.</P>
<P> В internet, множество сетей с различными характеристиками и управлением должны связываться. В частности, синтаксис и семантика идентификации ресурса измененяются. Особые конкретные случаи могут быть обработаны заранее используя специальную технологию, типа обеспечения сетевых имен, являющихся локальными для хостов в других сетях, как в случае Ethernet в Xerox PARC. Однако, общий случай чрезвычайно сложен. Например, некоторые сети требуют маршрутизации для соединений точка-точка, что упрощает проблему обновления базы данных, так как в системные таблицы  должны быть введены только смежные хосты, в то время как другие используют сквозную адресацию. Некоторые сети используют лево-ассоциативный синтаксис, а другие используют право-ассоциативный синтаксис, вызывая неоднозначность в смешанных адресах.</P>
<P> Стандарты Internet пытаются устранить эти проблемы. Первоначально, они предложили расширять пары адресов, чтобы адресовать тройки, состоящие из сети, хоста, ресурса. Номера сетей должны быть универсально согласованы, и хосты могут быть назначены локально для каждой сети. Представление на пользовательском уровне  было быстро расширено, чтобы адресовать домены составленные из локальной идентификации ресурса и иерархической спецификации домена с общим статическим корнем. Технология домена отделяет проблему физической адресации от логической. Например, адрес в виде "eric@a.cc.berkeley.arpa" описывает только логическую организацию адресного пространства.</P>
<U><P> Sendmail</u> предназначен для того, чтобы помочь проложить мост над пропастью между полностью специализированными сетями, которые не знают ничего  друг о друге и чистым, взаимосвязанным миром уникальных сетевых номеров. Он может принимать старые  адреса с произвольным синтаксисом, разрешая неоднозначности используя определенную администратором системы эвристику, а также адреса на основе доменов. Он помогает производить преобразование форматов сообщений между несопоставимыми сетями. Короче говоря, <U> sendmail </U> разработан для того, чтобы помочь постепенному переходу к согласованной межсетевой адресной схеме.</P>
<P> Раздел <a href="pap.html#r1">1</a> обсуждает цели проекта  <U> sendmail </U>. Раздел <a href="pap.html#r2">2</a> дает краткий обзор основных функций системы. В разделе <a href="pap.html#r3">3</a> обсуждены детали использования . Раздел <a href="pap.html#r4">4</a> сравнивает <U> sendmail </U> с другими  программами маршрутизации почты в internet, и в  разделе <a href="pap.html#r5">5</a>  дана оценка <U> sendmail </U>, включая будущие планы.</P>
<a name=r1><B><P>1. ЦЕЛИ ПРОЕКТА</P></B>
<P> Цели проекта <U>sendmail</U> включают:</P>
<P>(1)Совместимость с существующими почтовыми программами, включая Bell version 6 mail, Bell version 7 mail [UNIX83], Berkeley <U>Mail</U> [Shoens79], BerkNet mail [Schmidt79], и UUCP mail [Nowitz78a, Nowitz78b]. Так же требуется совместимость с ARPANET mail [Crocker77a, Postel77].</P>
<P>(2)Надежность, в смысле гарантия корректной доставки каждого сообщения или, по крайней мере уведомление человека о корректной пересылке; ни одно сообщение не должно быть полностью утеряно. Эта цель была необходимой из-за акцентирования на почте в нашем окружении. Это стало одной из самых самых труднодоступных целей , особенно из-за множества аномальных форматов сообщений, произведимых различными сайтами ARPANET. Например, некоторые сайты генерируют  адреса в неправильном формате, иногда вызывая циклические сообщения об ошибках. Некоторые хосты используют пробелы в именах, вызывая проблемы с почовыми программами UNIX, которые считают адрес одним словом. Семантика некоторых полей интерпретируется немного по-разному различными сайтами. В сумме, малопонятные, но используемые особенности протокола почты ARPANET  трудно поддерживать, но это необходимо.</P>
<P>(3) По возможности, для настоящей доставки сообщений должно использоваться существующее программное обеспечение. Эта цель происходит как из политических и практических рассмотрений, так и из технических.</P>
<P>(4) Простое наращивание в довольно сложных окружениях, включающих многократные соединения с одиночным сетевым типом (типа с многократным UUCP или сетью Ether [Metcalfe76]). Эта цель требует рассмотрения содержания адреса,а  также  синтаксиса, чтобы определить какой шлюз использовать. Например, ARPANET переходит на протокол TCP, заменяя старый NCP протокол. Ни один хост в Berkeleyне имеет одновременно TCP и NCP, так что необходимо рассмотреть имя хоста ARPANET, чтобы определить,  направить ли почту к шлюзу NCP  или TCP. </P>
<P>(5) Конфигурация не должна быть вкомпилирована в код. Единственная скомпилированная программа должна быть способна работать как есть на любом сайте (за исключением таких существенных изменений как тип CPU или операционной системы). Мы обнаружили, что эта кажущаяся незначительной цель  критична в реальной жизни. Кроме простых проблем, случающихся при перекомпилляции программы в  различных окружениях, множество сайтов, любят "поиграться" с чем - нибудь, что они  все равно перекомпиллируют.</P>
<P>(6)<u>Sendmail</U> должен позволять различным группам поддерживать их собственные списки рассылки, и позволять некоторым лицам определять их собственное перенаправление, без  изменений в файле псевонимов.</P>
<P>(7) Каждому пользователю должно быть позволено определять какую почтовую программу (mailer) выполнить для обработки почты,  доставляемой для него. Эта особенность позволяет пользователям, использующим специализированные почтовые программы с различными форматами, построить их окружение без изменения системы, и облегчает специализированные функции (типа возврата сообщения " я нахожусь на каникулах ").</P>
<P>(8) Сетевой траффик должен быть минимизирован посредством группирования адресов одного хоста, где это возможно, без помощи  пользователя. Этиь целям соответствует архитектура, иллюстрируемая на Рис.1. Пользователь взаимодействует с программой генерирующей и посылающей почту. Когда почта создана, генератор вызывает <U>sendmail</U>, который маршрутизирует сообщение к правильной почтовой программе. Так как некоторые из отправителей могут быть сетевыми серверами, а некоторые из почтовых программ могут быть клиентами сети, <U> sendmail </U> может использоваться как межсетевой почтовый шлюз.</P>
<P>
<Pre>
    ____________________________________________________
         +---------+    +---------+    +---------+
         | sender1 |    | sender2 |    | sender3 |
         +---------+    +---------+    +---------+
              |              |              |
              +----------+   +   +----------+
                         |   |   |
                         v   v   v
                      +-------------+ 
                      |  sendmail   | 
                      +-------------+
                         |   |   | 
              +----------+   +   +----------+
              |              |              |
              v              v              v
        +---------+     +---------+    +---------+
        | mailer1 |     | mailer2 |    | mailer3 |
        +---------+     +---------+    +---------+
            Рис. 1 - Структура системы Sendmail. 
    ____________________________________________________
</Pre>
<P></P>
<a name=r2><B><P>2. ВВЕДЕНИЕ</P></B>
<B><P>2.1. Организация системы</P></B>
<P><U>Sendmail</U> не взаимодействует с пользователем и на самом деле не производит доставку почты. Точнее, он собирает сообщения созданные интерфейсной пользовательской программой (user interface program (UIP)) типа Berkeley <U>Mail</U>, MS [Crocker77b], или MH [Borden79], редактирует сообщение так, как этого требует сеть назначения, и вызывает соответствующую программу доставки почты для ее доставки или постановки в очередь для передачи через сеть <a name=2a><a href="pap.html#2"><SUP>2</SUP></a>. Этот алгоритм  позволяет использовать новую программу доставки почты при  минимальной стоимости. В этом смысле <U>sendmail</U> походит на Модуль Обработки Сообщений (Message Processing Module (MPM))  [Postel79b].</P>
<B><P>2.2. Интерфейсы во Внешний Мир</P></B>
<P>Для <U>sendmail</U> имеется три способа связи с внешним миром, как для получения, так и для посылки почты. Они используют традиционный UNIX-овый статус вектора/возврата состояния, разговаривая по SMTP через пару UNIX-овых труб (pipe-ов), и разговаривая по SMTP через канал между процессами.</P>
<B><P>2.2.1. Статус вектора/возврата Состояния</P></B>
<P>Эта технология является стандартным для UNIX методом взаимодействия с процессом. Список получателей посылается в векторе состояния, а тело сообщения посылается через стандартный ввод. При возникновении какой-нибудь проблемы, все, что печатает посылающая программа, просто собирается и посылается назад отправителю. После посылки сообщения от почтовой программы собирается статус выхода, и при необходимости печатается диагностика.</P>
<B><P>2.2.2. SMTP через трубы (pipes)</P></B>
<P>Протокол SMTP [Postel82] может быть использован для запуска интерактивного интерфейса с программой посылки почты. В этом случае все еще создается подпроцесс, но адреса получателей почты не передаются в посылающую программу через список аргументов. Вместо этого, они передаются во одному в командах, посылаемых на стандартный вход процесса. Все, что приходит на стандартный выход, должно быть кодом возврата в специальном формате.</P>
<B><P>2.2.3. SMTP через IPC соединение</P></B>
<P>Эта технология похожа на предыдущую, кроме того, что здесь используется 4.2bsd IPC канал [UNIX83]. Этот метод исключительно гибок в том, что программа посылки сообщений не должна находиться на той же машине. Обычно это используется для соединения с процессом sendmail на другой машине.</P>
<B><P>2.3. Описание Работы </P></B>
<P>Когда отправитель хочет отправить сообщение, он обращается к <U>sendmail</U> используя один из дрех вышеописанных методов. <U>Sendmail</U> работает в два этапа. На первом этапе он собирает и сохраняет сообщение. На втором этапе происходит доставка сообщения. Если в процессе второго этапа происходит какая-либо ошибка, <U>sendmail</U> создает и возвращает новое сообщение, описывающее ошибку и/или возвращает код статуса, говорящий о том, что пошло неправильно.</P>
<B><P>2.3.1. Обработка аргументов и синтаксический разбор адреса</P></B>
<P>Если <U>sendmail</U> вызывается с использованием одного из двух методов подпроцесса, сначала сканируются аргументы, а потом обрабатываются опции. Затем собираются адреса получателей, как через командную строку, так и через использование команды SMTP RCPT, и создается список получателей. На этом шаге раскрываются псевдонимы (aliases), включая списки рассылки. На этом этапе выполняются все возможные проверки: проверяется синтаксис, проверяются локальные адреса, но детальная проверка имен хостов и адресов откладывается до самой доставки. После проверки локальных адресов также выполняется пересылка (forwarding).</P>
<U><P>Sendmail</U> после синтаксического разбора добавляет каждый адрес к списку получателей. Когда имя имеет псевдоним или пересылку, старое имя остается в списке, и выставляется соответствующий флаг, говорящий фазе доставки о том, что этого получателя нужно игнорировать. Этот список содержится свободным от дубликатов, предотвращая таким образом петли псевдонимов или вторичную доставку сообщения одному и тому же получателю, что может случиться, если данный товарищ находится в двух группах.</P>
<B><P>2.3.2. Забирание Сообщения</P></B>
<P>Затем <U>Sendmail</U> забирает сообщение. Сообщение должно иметь в начале заголовок (header). к самому сообщению не выдвигается никаких требований по его формату, кроме того, что оно должно состоять из строк текста (то есть бинарные данные не дозволяются). Заголовок проходит синтаксический разбор и сохраняется в памяти, а тело сообщения сохраняется во временном файле. Для упрощения программного интерфейса, сообщение забирается даже в том случае, если нет ни одного правильного адреса. Просто это сообщение будет возвращено с ошибкой.</P>
<B><P>2.3.3. Доставка Сообщения</P></B>
<P>Для каждой уникальной программы доставки почты и хоста в списке получателей, <U>sendmail</U> вызывает соответствующую программу доставки почты. Если получатели сообщения находятся на одном хосте, то доставка к ним сообщения производится за один вызов программы доставки. Несмотря на это, программы доставки позволяющие только одного получателя за один раз, также корректно отрабатываются.</P>
<P>Сообщение посылается в программу доставки с использованием одного из трех интерфейсов, используемых для представления сообщения в sendmail. Каждая копия сообщения предваряется приспособленным заголовком. Код статуса программы доставки отлавливается и проверяется, и если что выдается соответствующее сообщение об ошибке. Код выхода должен соответствовать системным стандартам, в противном случае выдается общее сообщение ("Service unavailable").</P>
<B><P>2.3.4. Постановка в очередь для последующей передачи </P></B>
<P>Если программа доставки возвратила статус, показывающий, что возможно эта почта может быть обслужена позднее, <U>sendmail</U> поставит эту почту в очередь и попытается передать его позднее.</P>
<B><P>2.3.5. Возврат Посылателю </P></B>
<P>Если во время обработки происходит ошибка, <U>sendmail</U> возвращает сообщение посылателю для повторной передачи. Письмо может быть отослано назад , или записано в файл "dead.letter" в домашнем каталоге посылателя <a name=3a><a href="pap.html#3"><SUP>3</SUP></a>.</P>
<B><P>2.4. Редактирование Заголовка Сообщения </P></B>
<P>Автоматически происходит некоторое редактирование заголовка сообщения. Строки заголовка могут быть всавлены под управлением файла конфигурации. Некоторые строки могут быть добавлены; например, при некоторых условиях могут быть добавлены строка "From:" и строка "Full-name:".</P>
<B><P>2.5. Файл Конфигурации </P></B>
<P>Практически вся конфигурационная информация считывается во время запуска из текстового файла: закодированные макроопределения (определяющие значения внутренних макросов), объявления заголовков (сообщающие sendmail формат строк заголовка, которые он будет обрабатывать специально, то есть строки, которые он будет добавлять или переформатировать), определения почтовых программ (дающие информацию о месте нахождения и характеристиках каждой почтовой программы), и правила переписывания адресов (ограниченная система обработки и перезаписи адресов, используемая при синтаксическом разборе и перезаписи адресов).</P>
<P>Для увеличения скорости чтения конфигурационного файла, может быть использован его имидж в памяти. Это может быть обеспечено "компиллированной" формой конфигурационного файла.</P>
<a name=r3><B><P>3. ИСПОЛЬЗОВАНИЕ И РЕАЛИЗАЦИЯ</P></B>
<B><P>3.1. Аргументы</P></B>
<P>Аргументами могут быть флаги и адреса. Флаги выставляют различные опции обработки. Пока не запущен режим SMTP, следом за флагами могут быть заданы аргументы адреса. Адреса следуют синтаксису, описанному в RFC822 [Crocker82] для формата адресов ARPANET. В кратце, формат такой:</P>
<P>(1) Все, что находится в круглых скобках выкидывается (как комментарий).</P>
<P>(2) Все, что находится в угловых скобках ("&lt;&gt;") имеет преимущество перед всем остальным. Это правило представляет собой стандарт ARPANET о том, что адрес в виде</p>
<p> user name &lt;machine-address&gt; 
<p>будет посылаться на электронный "адрес машины" а не на человеческий "user name".</P>
<P>(3) Двойные кавычки ( " ) отделяют фразы; обратные наклонные линии отделяют символы. Обратные наклонные линии имеют большую силу, так как они могут заставить различные эквивалентные фразы рассматривать по-разному, например, <U>user</U> и <U>"user"</U> эквивалентны, но <U>\user</U> - это что-то совсем от них отличное. Круглые скобки, угловые скобки, и двойные кавычки должны быть соответственно сбалансированы и размещены. Правила переписывания управляют оставшимся синтаксическим разбором <a name=4a><a href="pap.html#4"><SUP>4</SUP></a>.</P>
<P><B>3.2. Посылка Почты в Файлы и Программы </P></B>
<P>Файлы и программы - законные получатели почты. Файлы обеспечивают архивное хранение сообщений, полезное для администрирования и архивирования. Программы полезны в качестве получателей почты в самых различных ситуациях, например, для поддержания публичного репозитория системных сообщений (тпа программы Berkeley <U>msgs</U>, или системы MARS [Sattley78]).</P>
<P>Любой адрес, проходящий через начальный алгоритм синтаксического разбора локальных адресов (то есть не являющийся действительным адресом для другой почтовой программы) сканируется на два специальных случая. Если он предварен вертикальной чертой ("|"), то оставшаяся часть адреса будет обработана как команда оболочки (shell command). Если имя пользователя начинается со знака косой черты ("/"), то это имя используется как имя файла, вместо имени пользователя. Файлы, имеющие выставленные биты смены владельца (setuid) или смены группы (setgid) но не имеющие битов выполнения имеют эти биты, если  <U>sendmail</U> запущен от пользователя root.</P>
<B><P>3.3. Псевдонимы, Пересылка, Включение</P></B>
<U><P>Sendmail</U> перемаршрутизирует почту тремя способами. Псевдонимы применяются для всей системы. Пересылка позволяет каждому пользователю перенаправлять входящую почту по заданному назначению. Включение говорит <U>sendmail</U> прочитать файл со списком адресов, и обычно используется совместно с псевдонимами.</P>
<B><P>3.3.1. Псевдонимы</P></B>
<P>Псевдонимы преобразуют имена в списки адресов используя общесистемный файл. Для ускорения доступа этот файл индексирован. Только локальные имена позволены в качестве псевдонимов; это гарантирует уникальность (в случае, если локальный хост не имеет других имен).</P>
<B><P>3.3.2. Перенаправление</P></B>
<P>После псевдонимизации, локальные и действительные получатели проверяются на наличие файла ".forward" в их домашнем каталоге. Если он существует, то это сообщение <U>не</U> посылается этому пользователю, а посылается списку пользователей в этом файле. Обычно этот файл содержит всего один адрес, и эта особенность используется для перенаправления почты в сети. Пренаправление также позволяет пользователю определить его собственную программу для обработки входящей почты. Например, перенаправление на: </P>
<P>"|/usr/local/newmail myname"</P>
<P>будет использовать другую почтовую программу для входящей почты.</P>
<B><P>3.3.3. Включение </P></B>
<P>Включение имеет определенный в RFC 733 [Crocker77a] синтаксис:</P>
<P>:Include: pathname</P>
<P>Адрес такого типа считывает файл определенный <U>pathname</U> и рассылка производится по всем адресам, перечисленным в этом файле. Целью является <U>не</U> поддержка прямого использования этой особенности, а скорее использование такой разновидности псевдонимизации. Например, псевдоним в виде:</P>
<P>project: :include:/usr/project/userlist</P>
<P>позволяет project поддерживать список рассылки без взаимодействия с системным администратором, даже если файл псевдонимов защищен. При этом нет необходимости перестраивать индексы в базе данных псевдонимов при изменении списка :include: .</P>
<B><P>3.4. Сбор Сообщений</P></B>
<P>После синтаксического анализа и проверки адресов всех получателей происходит сбор самого сообщения. Сообщение поступает двумя частями: в виде занголовка и тела сообщения, разделенных постой строкой.</P>
<P>Заголовок представляет собой некоторое количество строчек следующего вида </p>
<p>имя_поля: значение_поля </P>
<P>Значение поля может быть разбито на несколько строк, при этом каждая следующая строка этого поля должна начинаться с пробела или табуляции. Некоторые поля заголовка имеют специальное внутреннее значение, и соответствующую специальную обработку. Остальные поля заголовка просто передаются. Некоторые поля заголовка могут быть добавлены автоматически, например отметка о времени.</P>
<P>Тело - это последовательность текстовых строк. Оно абсолютно не интерпретируется и не трогается, за исключением строк, начинающихся с точки, эта точка дублируется при передаче через канал SMTP. Эта дополнительная точка обрезается принимающей стороной.</P>
<B><P>3.5. Доставка Сообщения </P></B>
<P>очередь на отсылку организуется принимающим хостом до начала передачи для того, чтобы использовать пакетную обработку сообщений. Каждый адрес маркируется как отосланный, поэтому пересканирование списка вполне безопасно. Список аргументов строится после окончания сканирования. Почта в файлы определяется во время сканирования списка отсылаемых сообщений. Интервейс к почтовой программе обеспечивается с использованием одного из трех методов, описанных в разделе 2.2.</P>
<P>После установки соединения,<U>sendmail</U> делает изменения в заголовке, относящиеся к почтовой программе и отсылает результат почтовой программе. Если какое-либо сообщение отвергается почтовой программой, то выставляется соответствующий флаг для возврата сообщения пользователю после окончания псех передач.</P>
<B><P>3.6. Очередь сообщений</P></B>
<P>Если программа отправки почты возвращает статус выхода "temporary failure" (временная неудача), сообщение ставится в очередь. Для описания получателей почты и различных других параметров используется контрольный файл (control file). Этот контрольный файл содержит последовательности строк, каждая из которых описывает отправителя, получателя, время передачи, или некоторые другие явновыраженные параметры сообщения. Заголовок сообщения также сохраняется в контрольном файле, так что соответствующий файл данных в очереди - всего лишь временный файл, который был изначально получен.</P>
<B><P>3.7. Конфигурация</P></B>
<P>Конфигурация в основном управляется конфигурационным файлом, считываемым при запуске. <U>Sendmail</U> не нуждается в перекомпилляции, за исключением следующих случаев</P>
<P>(1) Смена операционной системы (V6, V7/32V, 4BSD). </P>
<P>(2) Удаление или вставка библиотеки DBM (база данных в UNIX).</P>
<P>(3) Изменение кодов ответа ARPANET.</P>
<P>(4) Добавление полей заголовков, требующих специальной обработки.</P>
<P>Добавление программ отправителей или изменение синтаксической обработки (т.е., перезаписи) или информации о маршрутизации не требует перекомпилляции.</P>
<P>Если почта отправляется локальным пользователем, и в домашнем каталоге этого пользователя существует файл ".mailcf", то этот файл так же будет прочитан как файл конфигурации после системного файла конфигурации. Эта особенность в основном используется для добавления строк в заголовок.</P>
<P>Файл конфигурации кодирует макроопределения, определения заголовка, определения программы-отправителя, правила перезаписи и опции.</P>
<B><P>3.7.1. Макросы</P></B>
<P>Макросы могут быть использованы тремя образами. Некоторые макросы  передают неструктурированную текстовую информацию в почтовую систему, типа имени <U> sendmail </U> используемого, для идентифицировать самого себя в сообщениях об ошибках.</P>
<P>Другие макросы передают информацию из <U>sendmail</U> в файл конфигурации для использования при создании других полей (типа вектора аргументов в программу-отправитель); например, имя отправителя, хоста и имени получателя. Другие макросы не используются для внутренних нужд и могут быть использованы как стенография в конфигурационном файле.</P>
<B><P>3.7.2.Объявления заголовка</P></B>
<P>Объявления заголовка информируют <U>sendmail</U> о формате известных строк в заголовка. Знание о нескольких строках заголовка встроены в <U>sendmail</U>, например строки "From:" и "Date:".</P>
<P>Если во входящем сообщении отсутствуют какие-либо сконфигурированные заголовки, то большинство из них будет автоматически вставлено в исходящее сообщение. Некоторые заголовки подавляются некоторыми программами-отправителями.</P>
<B><P>3.7.3. Объявления Программы-Отправителя</P></B>
<P>Объявления программы-отправителя говорят <U>sendmail</U> о том, какие программы отправки для него доступны. Объявления определяют внутреннее имя программы-отправителя, путь для его вызова, некоторые флаги, необходимые для него и вектор аргументов, используемый при вызове; этот вектор перед использование может быть расширен макросом.</P>
<B><P>3.7.4. Правила перезаписи адреса</P></B>
<P>Сердце синтаксического разбора адреса в <U>sendmail</U> - набор правил перезаписи. Это упорядоченный список правил замены по образцу (порядок здесь очень важен), применяемых к каждому адресу. Адрес буквально переписывается до тех пор, пока он не будет записан в специальной канонической форме (т.е., (mailer, host, user), например {arpanet, usc-isif, postel} для адреса "postel@uscisif"), или пока он в конце концов не дойдет до конца. При соответствии образца, правило будет применяться пока не произойдет ошибки.</P>
<P>Файл конфигурации также поддерживает редактирование адресов в различные форматы. Например, адрес в виде:</P>
<P>ucsfcgl!tef</P>
<P>должен быть переделан в:</P>
<P>tef@ucsfcgl.UUCP</P>
<P>для соответствия синтаксису домена. Так же может быть произведен и обратный перевод.</P>
<B><P>3.7.5. Установка опций</P></B>
<P>Есть несколько опций, которые могут быть установлены из конфигурационного файла. Они включают пути к различным дополнительным файлам, таймауты, режимы по умолчанию, и др.</P>
<a name=r4><B><P>4. СРАВНЕНИЕ С ДРУГМИ ОТПРАВИТЕЛЯМИ ПОЧТЫ</P></B>
<B><P>4.1. Delivermail</P></B>
<U><P>Sendmail</U> является потомком <U>delivermail</U>. Основные отличия:</P>
<P>(1) Отсутствие вкомпилированной информации о конфигурации. Это изменение упрощает многие проблемы переноса на другие машины. Это также позволяет упростить отладку новых программ отправки почты.</P>
<P>(2) Более гибкий синтаксический анализ адресов. Например, <U>delivermail</U> поддерживает только один шлюз в любую сеть, в то время как <U>sendmail</U> может быть чувствителен к именам хостов может перенаправлять почту через различные шлюзы.</P>
<P>(3) Forwarding и :include: устраняют требование к тому, чтобы системный файл псевдонимов (aliases) должен быть доступен на запись для любого пользователя (или наличия программы обновления, или внесения всех изменений системным администратором).</P>
<P>(4) <U>Sendmail</U> поддерживает группирование сообщений при посылке сообщения многочисленным получателям.</P>
<P>(5) В <U>sendmail</U> обеспечивается почтовая очередь. Почта, которая не может быть доставлена немедренно, но вообще-то потенциально может быть доставлена позже сохраняется в этой очереди для дальнейшей повторной передачи. Очередь также обеспечивает буфер, защищающий от крахов системы; после получения сообщения, оно может быть надежно доставлено, даже если система "упадет" во время первичной доставки.</P>
<P>(6) <U>Sendmail</U> использует поддержку сети, обеспечиваемую 4.2BSD, для обеспечения прямого взаимодествия с сетями типа ARPANET и/или Ethernet, использующими  SMTP (Simple Mail Transfer Protocol) поверх соединений TCP/IP.</P>
<B><P>4.2. MMDF</P></B>
<P>MMDF [Crocker79] имеет намного больше проблем, чем <U>sendmail</U>. Например, MMDF включает посылатель "phone network", в то время как <U>sendmail</U> во многих случаях производит вызов программмы доставки почты.</P>
<P>И MMDF, и <U>sendmail</U> поддерживают псевдонимы, настраиваемые программы доставки, группирование сообщений, автоматическое перенаправление на шлюзы, очереди сообщений и повторные передачи. MMDF поддерживает двухуровневый таймаут, не поддерживаемый <U>sendmail</U>.</P>
<P>Конфигурация для MMDF компиллируется вместе с кодом<a name=5a><a href="pap.html#5"><SUP>5</SUP></a>.</P>
<P>Из-за того, что задача обратной совместимости для MMDF не является одной из целей проекта, синтаксический анализ адресов нем проще, но намного менее гибок.</P>
<P>Интегрирование новых каналов<a name=6a><a href="pap.html#6"><SUP>6</SUP></a> в MMDF - что-то очень тяжелое и сложное. В частности, MMDF должен знать местонахождение и формат таблиц хостов для всех каналов, и каналы должны "говорить" на специальном протоколе. Это позволяет MMDF делать дополнительную проверку (типа проверки имен хостов) во время передачи.</P>
<P>MMDF строго разделяет фазы передачи и доставки. <U>Sendmail</U> также имеет концепции каждой из этих стадий, они интегрированы в одну программу, тогда как в MMDF они разбиты на две программы.</P>
<B><P>4.3. Модуль Обработки Сообщений</P></B>
<P>Модуль обработки сообщений (Message Processing Module) (MPM) описанный в [Postel79b] очень похож на <U>sendmail</U> в смысле его основной архитектуры. Однако, как и MMDF, MPM включает программное обеспечение для взаимодействия с сетью в виде части самой программы.</P>
<P>MPM также как и MMDF, требует дуплексный канал к приемнику, таким образом делая более простой обработку ошибок программой доставки, чем это возможно в <U>sendmail</U>. Когда сообщение, лежащее в очереди <U>sendmail</U> отослано, любые ошибки должны быть возвращены отправителю самой программой доставки. И у MPM, и у MMDF программы доставки могут немедленно возвращать сообщения об ошибках, и даже одна единственная ошибка может вызвать соответствующую реакцию.</P>
<P>MPM предпочитает передавать сообщение как структурированный объект, с наборами тип-длина-значение<a name=7a><a href="pap.html#7"><SUP>7</SUP></a>. Такое соглашение требует намного более высокий уровень взаимодействия между программами доставки, чем это требует <U>sendmail</U>. MPM также подразумевает универсальную в пространстве имен internet адресацию (в которой адреса имеют вид набора сеть-хост-пользователь), отсутствующую в <U>sendmail</U>.</P>
<a name=r5><B><P>5. ОЦЕНКИ И ПЛАНЫ НА БУДУЩЕЕ </P></B>
<U><P>Sendmail</U> разработан для работы в негомогенном окружении. Сделано все возможное во избежание возможных ненужных ограничений в основных программах доставки почты. Эта цель была основной в проекте. Одной из основных проблем было отсутствие единого адресного пространства, как это показано в [Postel79a] и [Postel79b].</P>
<P>Неединое адресное пространство подразумевает, что путь будет определен для всех адресов, как явно (как часть адреса) так и неявно (с использованием перенаправления на шлюзы). Это ограничение имеет такой неприятный эффект - ответить на сообщение чрезвычайно трудно, из-за того, что нет конкретного "адреса" для конкретного человека, есть только путь, ведущий к нему от того места, где вы находитесь.</P>
<P>Взаимодействие с почтовыми программами, которое в начале не предполагалось к применению в окружении internet, было осуществлено очень успешно.</P>
<U><P>Sendmail</U> имеет встроенные знания о сложностях некоторых сред. Он при необходимости выдает сообщения об ошибках, совместимые с ARPANET FTP/SMTP (с числом из трех цифр [Neigus73, Postel74, Postel82]), для некоторых программ доставки может генерировать в стиле UNIX строку "From" в начале сообщения, и знает, как обработать такую строку на входе. Также, для BerkNet может быть определена своя обработка ошибок.</P>
<P>Рассматривалось также и решение об избежании любого типа доставки (и в особенности локальной доставки), что оказалось хорошей идеей. Даже при локальной доставке возникают вопросы о местонахождении почтового ящика, его формата, используемого протокола блокировки, и т.д., которые намного лучше решаются другими программами. Одним из главных недостатков многих средств доставки почты в internet является то, что местонахождение и формат локальной почты встроен в них. Кажется, что локальная почта настолько проста, что это не должно быть очень важным. Это ощущение абсолютно не согласуется с нашим опытом; наоборот, местонахождение и формат почтовых ящиков очень сильно меняется от системы к системе.</P>
<P>Возможность автоматически генерировать ответ на входящую почту (посредством перенаправления почты в программу) очень полезно ("Я в отпуске до конца августа ...."), но может создать проблемы типа петлей перенаправления (например, два человека в отпуске, а их программы посылают друг другу подобные сообщения туда-сюда) если эти программы плохо написаны. Программа может быть написана так, что она будет выполнять стандартные задачи корректно, но это будет решать только общий случай.</P>
<P>Вполне может быть желательным сделать какое-нибудь ограничение по загрузке. Я не очень-то уверен, что есть какая-либо почтовая система, направленная на решение этой проблемы, так же как и не уверен в том, что в настоящее время существует какое-либо приемлимое решение.</P>
<P>Файл конфигурации сейчас практически необъясним, он содержит всебе очень много загадок; намного удобнее, если бы он был выполнен с помощью высокоуровневого формата.</P>
<P>Ясно, что скоро общие протоколы изменятся, чтобы приспособиться к изменяющимся требованиям и конфигурациям. Эти изменения будут включать в себя модификацию заголовка (например, [NBS80]) или самого тела сообщения (например, для мультимедийных сообщений [Postel80]). Опыт показывает, что для интеграции с существующими системами эти изменения должны быть относительно просты.</P>
<P>Для жестко связанных конфигураций было бы хорошо иметь интегрированный в почтовую систему сервер имен типа Grapvine [Birrell82]. Это поможет сайтам типа "Berkeley" выступать как одному хосту, а не множеству хостов, что позволит людям спокойно менять машины без изменений своих почтовых адресов. Такая гибкость потребует автоматически обновляющуюся базу данных и какие-то методы разрешения конфликтов. В идеале, это должно работать, даже если све хосты не будут иметь единого управления. Однако, не ясно, должно ли это быть интегрированным в средства псевдонимизации, или это должно рассматриваться как "дополнительное" свойство вне самого <U>sendmail</U>.</P>
<P>Более интересен случай, сервера имен CSNET [Solomon81], обеспечивающего подобные свойства в одной жесткосвязанной среде. Однако, подобная вещь может нормально существовать "снаружи" <U>sendmail</U>.</P>
<br>
<hr>
<center><B><P>ACKNOWLEDGEMENTS</P></B></center>
<P>Thanks are due to Kurt Shoens for his continual cheerful assistance and good advice, Bill Joy for pointing me in the correct direction (over and over), and Mark Horton for more advice, prodding, and many of the good ideas. Kurt and Eric Schmidt are to be credited for using <U>delivermail</U> as a server for their programs (<U>Mail</U> and BerkNet respectively) before any sane person should have, and making the necessary modifications promptly and happily. Eric gave me considerable advice about the perils of network software which saved me an unknown amount of work and grief. Mark did the original implementation of the DBM version of aliasing, installed the VFORK code, wrote the current version of <U>rmail</U>, and was the person who really convinced me to put the work into <U>delivermail</U> to turn it into <U>sendmail</U>. Kurt deserves accolades for using <U>sendmail</U> when I was myself afraid to take the risk; how a person can continue to be so enthusiastic in the face of so much bitter reality is beyond me.</P>
<P>Kurt, Mark, Kirk McKusick, Marvin Solomon, and many others have reviewed this paper, giving considerable useful advice.</P>
<P>Special thanks are reserved for Mike Stonebraker at Berkeley and Bob Epstein at Britton-Lee, who both knowingly allowed me to put so much work into this project when there were so many other things I really should have been working on.</P>
<P>
<center><b><P>REFERENCES</P></b></center>
<P>[Birrell82] &#9;Birrell, A. D., Levin, R., Needham, R. M., and Schroeder, M. D., <u>"Grapevine: An Exercise in Distributed Computing."</U> In Comm. A.C.M. 25, 4, April 82.</P>
<P>[Borden79] &#9;Borden, S., Gaines, R. S., and Shapiro, N.Z., <U>The MH Message Handling System: Users' Manual.</U> R-2367-PAF. Rand Corporation. October 1979.</P>
<P>[Crocker77a]&#9;Crocker, D. H., Vittal, J. J., Pogran, K. T., and Henderson, D. A. Jr., <U>Standard for the Format of ARPA Network Text Messages.</U> RFC 733, NIC 41952. In [Feinler78]. November 1977.</P>
<P>[Crocker77b]&#9;Crocker, D. H., <U>Framework and Functions of the MS Personal Message System.</U> R-2134-ARPA, Rand Corporation, Santa Monica, California. 1977.</P>
<P>[Crocker79]&#9;Crocker, D. H., Szurkowski, E. S., and Farber, D. J., <U>An Internetwork Memo Distribution Facility MMDF.</U> 6th Data Communication Symposium, Asilomar. November 1979.</P>
<P>[Crocker82]&#9;Crocker, D. H., <U>Standard for the Format of Arpa Internet Text Messages.</U> RFC 822. Network Information Center, SRI International, Menlo Park, California. August 1982.</P>
<P>[Metcalfe76]&#9;Metcalfe, R., and Boggs, D., <u> "Ethernet: Distributed Packet Switching for Local Computer Networks",</u>  Communications of the ACM 19, 7. July 1976.</P>
<P>[Feinler78]&#9;Feinler, E., and Postel, J. (eds.), <U>ARPANET Protocol Handbook.</U> NIC 7104, Network Information Center, SRI International, Menlo Park, California. 1978.</P>
<P>[NBS80] National Bureau of Standards, <U>Specification of a Draft Message Format Standard.</U> Report No. ICST/CBOS 80-2. October 1980.</P>
<P>[Neigus73] Neigus, N., <U>File Transfer Protocol for the ARPA Network.</U> RFC 542, NIC 17759. In [Feinler78]. August, 1973.</P>
<P>[Nowitz78a]&#9;Nowitz, D. A., and Lesk, M. E., <U>A Dial-Up Network of UNIX Systems.</U> Bell Laboratories. In UNIX Programmer's Manual, Seventh Edition, Volume 2. August, 1978.</P>
<P>[Nowitz78b]&#9;Nowitz, D. A., <U>UUCP Implementation Description.</U> Bell Laboratories. In UNIX Programmer's Manual, Seventh Edition, Volume 2. October, 1978.</P>
<P>[Postel74]&#9;Postel, J., and Neigus, N., <u>Revised FTP Reply Codes.</u> RFC 640, NIC 30843. In [Feinler78]. June, 1974.</P>
<P>[Postel77]&#9;Postel, J., <U>Mail Protocol.</U> NIC 29588. In [Feinler78]. November 1977.</P>
<P>[Postel79a]&#9;Postel, J., <U>Internet Message Protocol.</U> RFC 753, IEN 85. Network Information Center, SRI International, Menlo Park, California. March 1979.</P>
<P>[Postel79b]&#9;Postel, J. B., <U>An Internetwork Message Structure.</U> In  Proceedings of the Sixth Data Communications Symposium, IEEE. New York. November 1979.</P>
<P>[Postel80]&#9;Postel, J. B., <U>A Structured Format for Transmission of Multi-Media Documents.</U> RFC 767. Network Information Center, SRI International, Menlo Park, California. August 1980.</P>
<P>[Postel82]&#9;Postel, J. B., <U>Simple Mail Transfer Protocol. </U>RFC821 (obsoleting RFC788). Network Information Center, SRI International, Menlo Park, California. August 1982.</P>
<P>[Schmidt79]&#9;Schmidt, E., <U>An Introduction to the Berkeley Network. </U>University of California, Berkeley&#9;California. 1979.</P>
<P>[Shoens79]&#9;Shoens, K., <U>Mail Reference Manual.</U> University of California, Berkeley. In UNIX Programmer's Manual, Seventh Edition, Volume 2C. December 1979.</P>
<P>[Sluizer81]&#9;Sluizer, S., and Postel, J. B., <U>Mail Transfer Protocol.</U> RFC 780. Network Information Center, SRI International, Menlo Park, California. May 1981.</P>
<P>[Solomon81]&#9;Solomon, M., Landweber, L., and Neuhengen, D., <u>"The Design of the CSNET Name Server."</u> CS-DN-2, University of Wisconsin, Madison. November 1981.</P>
<P>[Su82]&#9;Su, Zaw-Sing, and Postel, Jon, <U>The Domain Naming Convention for Internet User Applications.</U> RFC819. Network Information Center, SRI International, Menlo Park, California. August 1982.</P>
<P>[UNIX83]&#9;<U>The UNIX Programmer's Manual, Seventh Edition,</U> Virtual VAX-11 Version, Volume 1. Bell Laboratories, modified by the University of California, Berkeley, California. March, 1983.</P>
<p><hr></P>
<FONT size=-1>
<P><a name=1>1 Значительная часть этой работы была выполнена во время работы над проектом INGRES в University of California в Berkeley и Britton Lee. <a href="pap.html#1a">[назад]</a>
<P><a name=2>2 за исключением случая, когда посылка производится в файл, в этом случае sendmail происводит прямую доставку сам. <a href="pap.html#2a">[назад]</a>
<P><a name=3>3 Конечно, если узел сети, выдающий ошибку, не является исходящим узлом, единственным правильным решением будет послать почту назад, к отправителю.  Также, имеется намного больше опций определения ошибок, но все они приводят к сообщению об ошибке - функция "return to sender" всегда обслуживается одним из этих двух способов. <a href="pap.html#3a">[назад]</a>
<P><a name=4>4 Примечание: после перезаписи локальных имен производится некоторая особая обработка; смотри ниже. <a href="pap.html#4a">[назад]</a>
<P><a name=5>5 В настоящее время для MMDF рассматриваются динамические таблицы конфигурации; позволяющие выбыирать при инсталляции выбирать или вкомпиллированые, или динамические таблицы. <a href="pap.html#5a">[назад]</a>
<P><a name=6>6 MMDF - эквивалентен "программе доставки" для sendmail. <a href="pap.html#6a">[назад]</a>
<P><a name=7>7 Это соответствует стандарту NBS. <a href="pap.html#7a">[назад]</a>
</FONT></BODY>
</HTML>
