<html>

<head>
<title>Sendmail Installation and Operation Guide (part 4)</title>
</head>

<body>

<p><a name="toc4"></a><b>4. Настройка</b></p>

<p>В зависимости от потребностей
вашего узла, вы можете захотеть
изменить те или иные
конфигурационные параметры.
Большинство из них устанавливаются
опциями в файле конфигурации.
Например, строка &quot;O
Timeout.queuereturn=5d&quot; устанавливает
опции &quot;Timeout.queuereturn&quot; значение
&quot;5d&quot; (пять дней).</p>

<p>Многие из этих опций имеют такие
значения по умолчанию, которые
подходят к большинству узлов.
Однако, на узлах с большой почтовой
нагрузкой может понадобиться
некоторая соответствующая
настройка под их почтовую загрузку.
В частности, на узлах, через которые
проходит большое количество
небольших почтовых сообщений,
доставляемых многим получателям,
может понадобиться подправить
параметры, связанные с
приоритетами очереди.</p>

<p>Все версии sendmail до 8.7 имели имена
опций, состоящие из одного символа.
С 8.7, опции имеют длинные (состоящие
из нескольких символов) имена. Хотя
старые короткие имена до сих пор
принимаются, многие новые опции не
имеют коротких эквивалентов.</p>

<p>Этот раздел описывает только те
опции, которые вам, вероятно,
захочется изменить; более
детальное описание опций дано в <a
href="sendmail5.html">разделе 5</a>.</p>

<dir>
    <dir>
            <a name="toc41"></a><b>4.1.
                Таймауты</b>
        </dir>
    
</dir>

<p>Все временные интервалы
устанавливаются с использованием
масштабного синтаксиса. Например,
&quot;10m&quot; означает десять минут, в то
время как &quot;2h30m&quot; означает два с
половиной часа. Вот полный набор
масштабов:</p>

<table border="0" cellpadding="7" cellspacing="0" width="100%">
    <tr>
        <td valign="top" width="50%"><p align="center">s </p>
        </td>
        <td valign="top" width="50%">Секунды </td>
    </tr>
    <tr>
        <td valign="top" width="50%"><p align="center">m </p>
        </td>
        <td valign="top" width="50%">Минуты </td>
    </tr>
    <tr>
        <td valign="top" width="50%"><p align="center">h </p>
        </td>
        <td valign="top" width="50%">Часы </td>
    </tr>
    <tr>
        <td valign="top" width="50%"><p align="center">d </p>
        </td>
        <td valign="top" width="50%">Дни </td>
    </tr>
    <tr>
        <td valign="top" width="50%"><p align="center">w </p>
        </td>
        <td valign="top" width="50%">Недели </td>
    </tr>
</table>

<dir>
    <dir>
            <dir>
                    <dir>
                           <a name="toc411"></a> <b>4.1.1. Интервал
                                Очереди</b>
                        </dir>
                    
                </dir>
            
        </dir>
    
</dir>

<p>Аргумент для флага <b>-q</b>
определяет, как часто поддемон
будет обрабатывать очередь. Обычно
это значение меняется от
пятнадцати минут до одного часа.
Секция 5.3.1.1 RFC 1123 рекомендует
устанавливать его равным как
минимум 30 минутам.</p>

<dir>
    <dir>
            <dir>
                    <dir>
                            <a name="toc412"></a><b>4.1.2. Таймауты
                                Чтения</b>
                        </dir>
                    
                </dir>
            
        </dir>
    
</dir>

<p>Все таймауты имеют имена типа
&quot;Timeout.подопция&quot;. Все
распознаваемые подопции, их
значения по умолчанию, и
минимальные значения, позволяемые
секцией 5.3.2 RFC 1123 таковы:</p>

<table border="0" cellpadding="7" cellspacing="0" width="100%">
    <tr>
        <td valign="top" width="20%">connect </td>
        <td valign="top" width="80%">Время ожидания
        открытия SMTP соединения
        (системный вызов connect(2)) [0,
        неопределенное]. Если оно равно
        нулю, то используется значение
        из ядра системы. Эта опция ни в
        каком случае не может иметь
        значение больше, чем это
        позволяет ядро, но может быть
        меньше. Это сделано, чтобы
        обойти ядра, позволяющие
        абсурдно длительный таймаут
        соединения (в некоторых
        случаях 90 минут). </td>
    </tr>
    <tr>
        <td valign="top" width="20%">iconnect </td>
        <td valign="top" width="80%">То же самое, что
        connect, кроме того, что оно
        применяется только для
        первичной попытки соединения с
        хостом для заданного сообщения
        [0, неопределенное]. Концепция
        такова: это значение должно
        быть очень небольшим
        (несколько секунд); хосты с
        хорошим соединением и
        отвечающие хосты, таким
        образом, будут обслужены
        немедленно. Медленные хосты не
        будут задерживать остальные
        доставки на стадии начальной
        попытки доставки. </td>
    </tr>
    <tr>
        <td valign="top" width="20%">initial </td>
        <td valign="top" width="80%">Ожидание
        начального приветственного
        сообщения 220 [5m, 5m]. </td>
    </tr>
    <tr>
        <td valign="top" width="20%">helo </td>
        <td valign="top" width="80%">Ожидание
        ответа на команду HELO или EHLO [5m,
        неопределенное]. Это может
        потребовать просмотра имени
        хоста, поэтому пять минут,
        возможно, вполне приемлемый
        минимум. </td>
    </tr>
    <tr>
        <td valign="top" width="20%">mail| </td>
        <td valign="top" width="80%">Время ожидания
        ответа на команду MAIL [10m, 5m]. </td>
    </tr>
    <tr>
        <td valign="top" width="20%">rcpt| </td>
        <td valign="top" width="80%">Время ожидания
        ответа на команду RCPT [1h, 5m]. Это
        значение должно быть большим,
        из-за того, что оно может
        указывать на список, и его
        расширение может занять много
        времени (смотри ниже). </td>
    </tr>
    <tr>
        <td valign="top" width="20%">datainit| </td>
        <td valign="top" width="80%">Время ожидания
        ответа на команду DATA [5m, 2m]. </td>
    </tr>
    <tr>
        <td valign="top" width="20%">datablock| </td>
        <td valign="top" width="80%">Ожидание
        прочтения блока данных (то
        есть, тела сообщения). [1h, 3m]. Это
        значение должно быть большим,
        потому что оно также
        применяется к программам,
        которые могут достаточно
        медленно выводить данные в
        sendmail. </td>
    </tr>
    <tr>
        <td valign="top" width="20%">datafinal| </td>
        <td valign="top" width="80%">Время ожидания
        ответа на точку, завершающую
        сообщение. [1h, 10m]. Если это
        значение короче, чем время,
        необходимое получателю для
        получения сообщения, будет
        сделана повторная передача.
        Это описывается в RFC 1047.</td>
    </tr>
    <tr>
        <td valign="top" width="20%">rset </td>
        <td valign="top" width="80%">Время ожидания
        ответа на команду RSET [5m,
        неопределенное]. </td>
    </tr>
    <tr>
        <td valign="top" width="20%">quit </td>
        <td valign="top" width="80%">Время ожидания
        ответа на команду QUIT [2m,
        неопределенное]. </td>
    </tr>
    <tr>
        <td valign="top" width="20%">misc </td>
        <td valign="top" width="80%">Время ожидания
        ответа на различные (но
        короткие) команды, типа NOOP (нет
        операции) и VERB (переход в
        подробный режим). [2m,
        неопределенное]. </td>
    </tr>
    <tr>
        <td valign="top" width="20%">command| </td>
        <td valign="top" width="80%">Для сервера SMTP,
        время ожидания следующей
        команды. [1h, 5m]. </td>
    </tr>
    <tr>
        <td valign="top" width="20%">ident</td>
        <td valign="top" width="80%">Время ожидания
        ответа на запрос IDENT [30s<a name="b1"></a><a
        href="sendmail4.html#r1"><sup>1</sup></a>,
        неопределенное].</td>
    </tr>
    <tr>
        <td valign="top" width="20%">hoststatus</td>
        <td valign="top" width="80%">Сколько
        времени информация о хосте
        (например, о том, что он
        отключен) будет кэширована,
        прежде чем она устареет [30m,
        неопределеное]. </td>
    </tr>
</table>

<p>Для совместимости со старыми
файлами конфигурации, если ни одна
подопция не определена, таймауты
обозначенные знаком |
устанавливаются равными
указанному значению.</p>

<p>Многие из минимальных значений в
RFC 1123 слишком малы. Sendmail был
разработан для протоколов RFC 822,
которые не определяют таймауты
чтения; следовательно, версии sendmail
до 8.1 не гарантируют быстрого
ответа на сообщения. В частности,
команда &quot;RCPT&quot; определяющая
список рассылки будет расширена и
проверит весь список полностью;
большой список на медленной
системе может запросто занять
времени больше, чем пять минут<a
name="b2"></a><a href="sendmail4.html#r1"><sup>2</sup></a>.
Я рекомендую таймаут в один час -
так как обрыв соединения во время
фазы RCPT достаточно редки,
длительный таймаут не
обременителен, но может сильно
помочь в уменьшении загрузки сети и
повторных сообщений.</p>

<p>Например, строки:</p>

<dir>
    <dir>
            <font color="#008000">O Timeout.command=25<p>
            O Timeout.datablock=3h</font></p>
    </dir>
</dir>

<p>Устанавливает серверу SMTP таймаут
на команды 25 минут и таймаут на ввод
блока данных 3 часа.</p>

<dir>
    <dir>
            <dir>
                    <dir>
                            <a name="toc413"></a><b>4.1.3. Таймауты Сообщений</b>
                        </dir>
                    
                </dir>
            
        </dir>
    
</dir>

<p>Если сообщение будет находиться в
очереди несколько дней, то время
его обработки закончится. Это
делается для того, чтобы быть
уверенным, что отправитель, по
крайней мере, предупрежден о
невозможности доставки сообщения.
Обычно таймаут равен пяти дням.
Иногда удобно также посылать
предупреждение, если сообщение
находится в очереди на протяжении
нескольких часов (подразумевается,
что обычно у вас хорошая связь; если
же обычно отсылка ваших сообщений
занимает несколько часов, то вам не
захочется получать такие
сообщения, так как это вполне
нормальное событие). Эти таймауты
выставляются опциями <b>Timeout.queuereturn</b>
и <b>Timeout.queuewarn</b> в файле
конфигурации (раньше оба значения
выставлялись опцией <b>T</b>).</p>

<p>Так как эти опции глобальны, и вы
не знаете заранее, сколько времени
хост вне вашего домена будет
отключен, рекомендуемый таймаут
составляет пять дней. Это позволяет
получателю исправить проблему,
даже если она случилась в самом
начале длительных выходных. Секция
5.3.1.1 RFC 1123 говорит, что этот параметр
должен быть &quot;как минимум 4-5
дней&quot;.</p>

<p>Значение <b>Timeout.queuewarn</b> может быть
вложено в опцию <b>T</b> указанием
времени, по истечении которого
должно быть послано
предупреждение; два таймаута
разделяются слешем. Например,
строка</p>

<dir>
    <dir>
            <font color="#008000">OT5d/4h </font>
        </dir>
    
</dir>

<p>говорит о том, что посылка
сообщения должна быть прекращена
через пять дней, а предупреждение
должно быть послано через четыре
часа. Это значение должно быть
достаточно большим, чтобы
несколько раз попытаться доставить
сообщение.</p>

<dir>
    <dir>
            <a name="toc42"></a><b>4.2.
                Ветвление во время
                проходов очереди</b>
        </dir>
    
</dir>

<p>Указанием опции <b>ForkEachJob</b> (<b>Y</b>),
можно заставить sendmail ветвиться
перед каждым отдельным сообщением
во время прохода очереди. Это
защитит вас от потребления sendmail
большого количества памяти, что
очень полезно, если у вас не очень
много памяти. Однако если опция <b>ForkEachJob</b>
не выставлена, sendmail во время
прохода очереди будет помнить об
отключенных хостах, что может
повысить производительность
системы.</p>

<p>Если опция <b>ForkEachJob</b> не
выставлена, sendmail не может
использовать кэшированные
соединения.</p>

<dir>
    <dir>
            <a name="toc43"></a><b>4.3.
                Приоритеты Очереди</b>
        </dir>
    
</dir>

<p>Каждому сообщению при первичной
обработке назначается приоритет,
состоящий из размера сообщения (в
байтах) минус класс сообщения
(определяемый из заголовка Precedence:)
умноженный на &quot;рабочий
коэффициент класса&quot; и количества
получателей, умноженного на
&quot;рабочий коэффициент
получателя&quot;. Приоритет
используется для построения
порядка очереди. Более высокое
значение приоритета подразумевает,
что сообщение будет обработано
позднее при проходе очереди.</p>

<p>Размер сообщения здесь
используется для того, чтобы более
большие сообщения обрабатывались
после относительно небольших.
Класс сообщения позволяет
пользователям посылать
&quot;высокоприоритетные&quot;
сообщения включая поле
&quot;Precedence:&quot; в свои сообщения;
Значение этого поля
просматривается в строках <b>P</b>
файла конфигурации. Вследствие
того, что количество получателей
сообщения может влиять на загрузку,
оно также включено в приоритет.</p>

<p>Коэффициенты получателя и класса
могут быть установлены в файле
конфигурации, используя опции <b>RecipientFactor</b>
(<b>y</b>) и <b>ClassFactor</b> (<b>z</b>)
соответственно. По умолчанию, они
равны: 30000 (для коэффициента
получателя) и 1800 (для коэффициента
класса). Первичный приоритет таков:</p>

<p>pri = msgsize - (class умноженный на <b>ClassFactor</b>)
+ (nrcpt умноженное на <b>RecipientFactor</b>)</p>

<p>(Запомните, более высокое
значение этого параметра на самом
деле означает, что работа будет
обработана с низким приоритетом.)</p>

<p>Приоритет работы скорректирован
при каждой обработке сообщения (то
есть, при каждой попытке его
доставки) использованием
&quot;рабочего коэффициента
времени&quot;, установленного опцией <b>RetryFactor</b>
(<b>Z</b>). Он добавляется к приоритету,
поэтому обычно он уменьшает
старшинство работы, на основании
того, что работа, не выполненная
много раз, вполне может быть не
выполнена опять. Опция <b>RetryFactor</b> по
умолчанию равна 90000.</p>

<dir>
    <dir>
            <a name="toc44"></a><b>4.4.
                Ограничение Загрузки</b>
        </dir>
    
</dir>

<p>Sendmail можно попросить принимать и
откладывать в очередь (но не
доставлять) почту, если средняя
загрузка системы становиться
слишком большой. Для этого
используется опция <b>QueueLA</b> (<b>x</b>).
Когда средняя загрузка системы
превышает значение опции <b>QueueLA</b>,
устанавливается режим <b>q</b> (только
очередь), если опция <b>QueueFactor</b> (<b>q</b>)
деленная на разность средней
загрузки системы и значения опции <b>QueueLA</b>
плюс единица, превысит приоритет
сообщения - то есть, сообщение
откладывается в очередь, если, и
только если:</p>

<p>pri &gt; { <b>QueueFactor</b> } / { LA - { <b>QueueLA</b> } +
1 }</p>

<p>По умолчанию опция <b>QueueFactor</b>
равна 600000, так что каждая единица
средней загрузки стоит 600000 пунктов
приоритета (как описано выше).</p>

<p>Для крутых случаев, опция <b>RefuseLA</b>
(<b>X</b>) определяет среднюю загрузку,
при которой sendmail будет
отказываться принимать сетевые
соединения. Локально созданная
почта (включая входящую почту UUCP)
будет приниматься.</p>

<dir>
    <dir>
            <a name="toc45"></a><b>4.5. Режим
                Доставки</b>
        </dir>
    
</dir>

<p>Существует большое количество
режимов доставки, в которых может
работать sendmail, указанных
конфигурационной опцией <b>DeliveryMode</b>
(<b>d</b>). Эти режимы определяют, как
быстро почта будет доставлена.
Доступные режимы:</p>

<table border="0" cellpadding="7" cellspacing="0" width="100%">
    <tr>
        <td valign="top" width="20%"><p align="center">i </p>
        </td>
        <td valign="top" width="80%">Интерактивная
        доставка (синхронная) </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">b </p>
        </td>
        <td valign="top" width="80%">Доставка в фоне
        (асинхронная) </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">q </p>
        </td>
        <td valign="top" width="80%">Только очередь
        (не доставлять) </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">d </p>
        </td>
        <td valign="top" width="80%">Отложить
        попытку доставки (не
        доставлять) </td>
    </tr>
</table>

<p>Есть и компромиссы. Режим &quot;i&quot;
дает отправителю быстрейшую
обратную связь, но может замедлить
некоторые почтовые программы
намного больше необходимого. Режим
&quot;b&quot; доставляет быстро, но может
наплодить кучу процессов, если ваша
почтовая программа тратит много
времени на доставку сообщений.
Режим &quot;q&quot; минимизирует
загрузку вашей машины, но доставка
сообщений будет задержана до
наступления очередного интервала.
Режим &quot;d&quot; идентичен режиму
&quot;q&quot;, за исключением того, что он
также предотвращает работу всех
просмотров; он предназначен для
узлов &quot;dial on demand&quot;, где просмотр
DNS может стоить реальные деньги.
Некоторые простые сообщения об
ошибках (например, host unknown during the SMTP
protocol) в этом режиме будут задержаны.
По умолчанию обычно используется
режим &quot;b&quot;.</p>

<p>Если вы запускаете sendmail в режиме
&quot;q&quot; (только очередь), &quot;d&quot;
(отсрочка), или &quot;b&quot; (доставка в
фоне), то он не будет разворачивать
псевдонимы и следовать файлам .forward,
вплоть до первого получения почты.
Это ускоряет ответ на команду RCPT.
Режим &quot;i&quot; не может быть
использован сервером SMTP.</p>

<dir>
    <dir>
            <a name="toc46"></a><b>4.6. Уровни
                Протоколирования</b>
        </dir>
    
</dir>

<p>Sendmail'у может быть указан уровень
протоколирования. По умолчанию
стандартной таблицей конфигурации
используется уровень 9. Имеются
следующие уровни:</p>

<table border="0" cellpadding="7" cellspacing="0" width="100%">
    <tr>
        <td valign="top" width="20%"><p align="center">0 </p>
        </td>
        <td valign="top" width="80%">Минимальный
        протокол </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">1 </p>
        </td>
        <td valign="top" width="80%">Серьезные
        системные ошибки и
        потенциальные проблемы
        безопасности </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">2 </p>
        </td>
        <td valign="top" width="80%">Потери
        соединений (сетевые проблемы) и
        ошибки протокола </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">3 </p>
        </td>
        <td valign="top" width="80%">Другие
        серьезные ошибки, неправильные
        адреса, временные ошибки
        forward/include, таймауты соединений. </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">4 </p>
        </td>
        <td valign="top" width="80%">Несущественные
        неисправности, устаревание
        базы данных псевдонимов,
        отказы соединений из-за
        проверочных наборов правил
        (check_rulests)</td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">5 </p>
        </td>
        <td valign="top" width="80%">Статистика
        сбора сообщений </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">6 </p>
        </td>
        <td valign="top" width="80%">Создание
        сообщений об ошибках, командах
        VRFY и EXPN. </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">7 </p>
        </td>
        <td valign="top" width="80%">Ошибки
        доставки (хост или
        пользователь не известен и т.д.)
        </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">8 </p>
        </td>
        <td valign="top" width="80%">Успешные
        доставки и перестроения базы
        псевдонимов. </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">9 </p>
        </td>
        <td valign="top" width="80%">Отложенные
        сообщения (из-за того, что хост
        отключен и т.д.) </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">10 </p>
        </td>
        <td valign="top" width="80%">Расширение
        базы данных (просмотры
        псевдонимов, перенаправлений и
        пользователей) </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">11</p>
        </td>
        <td valign="top" width="80%">Ошибки NIS и
        окончание обработок</td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">12 </p>
        </td>
        <td valign="top" width="80%">Протоколирование
        всех соединений SMTP. </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">13</p>
        </td>
        <td valign="top" width="80%">Протоколирование
        плохих пользовательских
        оболочек, файлов с
        несоответствующими
        пермиссиями, и других спорных
        ситуаций.</td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">14</p>
        </td>
        <td valign="top" width="80%">Протоколирование
        всех отказов от соединений</td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">15</p>
        </td>
        <td valign="top" width="80%">Протоколирование
        всех входящих и исходящих
        команд SMTP.</td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">20 </p>
        </td>
        <td valign="top" width="80%">Протоколирует
        попытки обработки
        заблокированных файлов в
        очереди. Это не ошибки, но может
        быть полезно, если ваша очередь
        становится перегруженной. </td>
    </tr>
    <tr>
        <td valign="top" width="20%"><p align="center">30 </p>
        </td>
        <td valign="top" width="80%">Потерянные
        блокировки (только если вы
        используете lockf вместо flock). </td>
    </tr>
</table>

<p>Дополнительно, значения выше 64
зарезервированы для очень
болтливого вывода при отладке.
Никто в здравом уме не поставит
такой уровень.</p>

<dir>
    <dir>
            <a name="toc47"></a><b>4.7.
                Файловые Режимы</b>
        </dir>
    
</dir>

<p>Режимы, используемые для файлов,
зависят от желаемой
функциональности и требуемого
уровня безопасности. Во многих
случаях sendmail производит осторожную
проверку режимов доступа к файлам и
каталогам, во избежание различных
опасных ситуаций; если вам нужно,
чтобы группа имела разрешение на
запись в поддерживающие файлы, то
вам нужно использовать опцию <b>DontBlameSendmail</b>
для отключения некоторых из этих
проверок.</p>

<dir>
    <dir>
            <dir>
                    <dir>
                            <a name="toc471"></a><b>4.7.1.
                                suid или не suid?</b>
                        </dir>
                    
                </dir>
            
        </dir>
    
</dir>

<p>Sendmail может вполне безопасно
сделан setuid на root. Тогда, когда он
собирается запустить с помощью exec(2)
почтовую программу, он проверяет,
равен ли userid нулю; если равен, то он
переустанавливает userid и groupid на
значения по умолчанию
(выставляемые равенством <b>U=</b> в
строке почтовой программы; если это
равенство не установлено,
используется опция <b>DefaultUser</b>). Это
может быть преодолено выставкой
флага <b>S</b> у почтовой программы для
доверенных почтовых программ,
которые могут быть запущены от root.
Однако, это заставит обработку
почты быть засчитанной sa(8) как
потребление пользователем root
системных ресурсов, вместо того,
чтобы засчитать это пользователю,
посылающему почту.</p>

<p>Если вы не делаете sendmail setuid'ным на
root, он все равно будет работать, но
вы потеряете большиую часть
функциональности и
конфиденциальности, а так же вам
придется открыть всем на запись
каталог очереди. Также вы можете
сделать sendmail setuid'ным на какого-либо
псевдопользователя (например,
создав пользователя &quot;sendmail&quot; и
сделав sendmail setuid'ным на него) что
исправит проблему
конфиденциальности, но не вопросы
функциональности. Также, это не
будет являться гарантией
безопасности: например,
пользователь root посылает почту, и
демон будет часто работать от
пользователя root.</p>

<p>В качестве компромисса можно
сделать sendmail setuid'ным на
пользователя root, но выставить опцию
<b>RunAsUser</b>. В результате это заставит
sendmail стать указанным пользователем
сразу же после запуска, требующего
привилегии пользователя root
(главным образом, открытия порта
SMTP). Если вы используете опцию <b>RunAsUser</b>,
каталог очереди (обычно /var/spool/mqueue)
должен принадлежать этому
пользователю, а все файлы и базы
данных (включая пользовательские
файлы .forward, файлы псевдонимов,
файлы :include, и внешние базы данных)
должны быть открыты для этого
пользователя на чтение. <b>RunAsUser</b>
скорее всего наиболее подходит для
конфигурации на брандмауэрах, не
имеющих регулярных заходов
пользователей.</p>

<dir>
    <dir>
            <dir>
                    <dir>
                            <a name="toc472"></a><b>4.7.2.
                                Отключение
                                Проверок
                                Безопасности</b>
                        </dir>
                    
                </dir>
            
        </dir>
    
</dir>

<p>Sendmail очень сильно обращает
внимание на режимы доступа к
файлам, которые он читает и в
которые пишет. Например, по
умолчанию, он отказывается читать
большинство файлов, открытых на
запись для группы на основании
того, что они могут быть искажены
кем-либо из группы, а не владельцем;
он даже откажется прочитать файлы в
каталогах, открытых на запись для
группы.</p>

<p>Если вы совершенно уверены, что
ваша конфигурация находится в
безопасности, и вы хотите, чтобы
sendmail не производил таких проверок,
вы можете отключить конкретные
проверки, используя опцию <b>DontBlameSendmail</b>.
Эта опция берет одно или более имен,
для которых проверка отключена. В
последующем описании под
&quot;небезопасным каталогом&quot;
считается каталог, в который может
писать кто-либо еще кроме
владельца. Значения могут быть
такие: </p>

<table border="0" cellpadding="7" cellspacing="0" width="100%">
    <tr>
        <td valign="top" width="40%">Safe</td>
        <td valign="top" width="60%">Никакой
        специальной обработки</td>
    </tr>
    <tr>
        <td valign="top" width="40%">AssumeSafeChown</td>
        <td valign="top" width="60%">Считать, что
        системный вызов chown запрещен
        пользователю root. Из-за того, что
        некоторые версии Unix разрешают
        обычным пользователям
        отдавать свои файлы другим
        пользователям на некоторых
        файловых системах, sendmail часто
        не может считать, что данный
        файл был создан владельцем, в
        частности, если он находится в
        откытом на запись каталоге. Вы
        можете выставить этот флаг,
        если вы знаете, что отдача
        файлов в вашей системе
        запрещена.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">ClassFileInUnsafeDirPath</td>
        <td valign="top" width="60%">Во время чтения
        файлов класса (используя
        строку <b>F</b> в файле
        конфигурации), разрешать файлы,
        находящиеся в небезопасных
        каталогах.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">ErrorHeaderInUnsafeDirPath</td>
        <td valign="top" width="60%">Разрешить
        файлу названному в опции <b>ErrorHeader</b>
        находиться в небезопасном
        каталоге.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">GroupWritableDirPathSafe</td>
        <td valign="top" width="60%">Изменить
        определение &quot;небезопасного
        каталога&quot; так, чтобы
        каталоги, открытые на запись
        для группы считались
        безопасными. Каталоги,
        открытые на запись для всех
        всегда считаются
        небезопасными.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">GroupWritableForwardFileSafe</td>
        <td valign="top" width="60%">Разрешить
        файлы forward открытые на запись
        для группы.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">GroupWritableIncludeFileSafe</td>
        <td valign="top" width="60%">Разрешить
        файлы :include: открытые на запись
        для группы.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">GroupWritableAliasFile</td>
        <td valign="top" width="60%">Разрешить
        файлы псевдонимов открытые на
        запись для группы.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">HelpFileInUnsafeDirPath</td>
        <td valign="top" width="60%">Разрешить
        файлу, названному в опции <b>HelpFile</b>
        находиться в небезопасном
        каталоге</td>
    </tr>
    <tr>
        <td valign="top" width="40%">WorldWritableAliasFile</td>
        <td valign="top" width="60%">Принимать
        файлы псевдонимов, открытые на
        запись для всех.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">ForwardFileInGroupWritableDirPath</td>
        <td valign="top" width="60%">Разрешить
        файлы .forward находящиеся в
        каталогах, открытых на запись
        для группы.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">IncludeFileInGroupWritableDirPath</td>
        <td valign="top" width="60%">Разрешить
        файлы :include: находящиеся в
        каталогах, открытых на запись
        для группы.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">ForwardFileInUnsafeDirPath</td>
        <td valign="top" width="60%">Разрешить
        файлы .forward находящиеся в
        небезопасных каталогах.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">IncludeFileInUnsafeDirPath</td>
        <td valign="top" width="60%">Разрешить
        файлы :include: находящиеся в
        небезопасных каталогах</td>
    </tr>
    <tr>
        <td valign="top" width="40%">ForwardFileInUnsafeDirPathSafe</td>
        <td valign="top" width="60%">Разрешить
        файлам .forward находящимся в
        небезопасных каталогах
        включать ссылки на программы и
        файлы.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">IncludeFileInUnsafeDirPathSafe</td>
        <td valign="top" width="60%">Разрешить
        файлам :include: находящимся в
        небезопасных каталогах
        включать ссылки на программы и
        файлы.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">MapInUnsafeDirPath</td>
        <td valign="top" width="60%">Разрешить
        файлы преобразований
        (например, файлы hash, btree, и dbm) в
        небезопасных каталогах.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">LinkedAliasFileInWritableDir</td>
        <td valign="top" width="60%">Разрешить файл
        псевдонимов, являющийся
        ссылкой в каталоге, открытом на
        запись.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">LinkedClassFileInWritableDir</td>
        <td valign="top" width="60%">Разрешить
        файлы классов, являющиеся
        ссылками в каталогах, открытых
        на запись.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">LinkedForwardFileInWritableDir</td>
        <td valign="top" width="60%">Разрешить
        файлы .forward, являющиеся
        ссылками в каталогах, открытых
        на запись.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">LinkedIncludeFileInWritableDir</td>
        <td valign="top" width="60%">Разрешить
        файлы :include:, являющиеся
        ссылками в каталогах, открытых
        на запись.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">LinkedMapInWritableDir</td>
        <td valign="top" width="60%">Разрешить
        файлы преобразований,
        являющиеся ссылками в
        каталогах, открытых на запись.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">LinkedServiceSwitchFileInWritableDir</td>
        <td valign="top" width="60%">Разрешить
        файлу сервисного
        переключателя быть ссылкой,
        даже если каталог открыт на
        запись.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">FileDeliveryToHardLink</td>
        <td valign="top" width="60%">Разрешить
        доставку в файлы, являющиеся
        жесткими ссылками.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">FileDeliveryToSymLink</td>
        <td valign="top" width="60%">Разрешить
        доставку в файлы, являющиеся
        символическими ссылками.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">RunProgramInUnsafeDirPath</td>
        <td valign="top" width="60%">Поехали,
        давайте еще и запускать
        программы в каталогах,
        открытых на запись┘</td>
    </tr>
    <tr>
        <td valign="top" width="40%">RunWritableProgram</td>
        <td valign="top" width="60%">Ну, давайте еще
        и запускать те программы, в
        которые может писать и группа,
        и вообще кто угодно.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">WriteMapToHardLink</td>
        <td valign="top" width="60%">Разрешить
        запись в преобразования,
        являющиеся жесткими ссылками.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">WriteMapToSymLink</td>
        <td valign="top" width="60%">Разрешить
        запись в преобразования,
        являющиеся символическими
        ссылками.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">WriteStatsToHardLink</td>
        <td valign="top" width="60%">Разрешить
        файлу статуса быть жесткой
        ссылкой.</td>
    </tr>
    <tr>
        <td valign="top" width="40%">WriteStatsToSymLink</td>
        <td valign="top" width="60%">Разрешить
        файлу статуса быть
        символической ссылкой.</td>
    </tr>
</table>

<dir>
    <dir>
            <a name="toc48"></a><b>4.8.
                Кэширование Соединения</b>
        </dir>
    
</dir>

<p>При обработке очереди, sendmail будет
пытаться держать несколько
последних соединений открытыми, во
избежание потерь при запуске и
остановке. Это применяется только к
IPC соединениям.</p>

<p>При попытке открыть соединение,
первым проверяется кэш. Если
найдено открытое соединение, оно
проверяется на предмет активности
посылкой команды RSET. Если
произойдет ошибка, то соединение
будет закрыто и заново открыто.</p>

<p>Кэшем соединений управляют два
параметра. Опция <b>ConnectionCacheSize</b> (<b>k</b>)
определяет количество позволенных
одновременно открытых соединений.
Если оно равно нулю, соединения
будут закрываться, как только это
станет возможным. По умолчанию оно
равно одному. Его можно установить
такого размера, как вам
потребуется; оно будет
ограничивать количество системных
ресурсов, используемых sendmail при
обработке очереди. Никогда не
устанавливайте это значение больше
4.</p>

<p>Опция <b>ConnectionCacheTimeout</b> (<b>K</b>)
определяет максимальное время
бездеятельности любого
кэшированного соединения. Когда
время простоя превысит это
значение, соединение будет закрыто.
Это число должно быть небольшим (до
10 минут), чтобы вы не занимали
системные ресурсы других машин.
Значение по умолчанию пять минут.</p>

<dir>
    <dir>
            <a name="toc49"></a><b>4.9. Доступ
                к Серверу Имен</b>
        </dir>
    
</dir>

<p>Управление просмотром адресов
хостов назначается вхождением
сервиса <b>hosts</b> в вашем файле
сервисного переключателя. Если
ваша система имеет встроенную
поддержку сервисного
переключателя (например, Ultrix, Solaris,
или DEC OSF/1) то вполне вероятно, что
ваша система уже нормально
сконфигурирована. В ином случае,
sendmail проконсультируется с файлом <b>/etc/service.switch</b>,
который должен быть создан. Sendmail
использует только два вхождения: <b>hosts</b>
и <b>aliases</b>, хотя системные программы
могут использовать иные сервисы
(особенно сервис <b>passwd</b> для
просмотра имени пользователя с
помощью getpwname).</p>

<p>Однако, некоторые системы (типа
SunOS) будут производить просмотр DNS
независимо от установленных
значений сервисного переключателя.
В частности, системная
подпрограмма gethostbyname(3)
используется для просмотра имен
хостов, а многие версии поставщиков
пытаются использовать комбинации
DNS, NIS, и просмотр файла /etc/hosts без
консультации с сервисным
переключателем. Sendmail не пытается
обойти эту проблему, и просмотр DNS
будет сделан в любом случае. Если же
у вас вообще не сконфигурирован
сервер имен, например, у вас чисто
UUCP узел, sendmail будет получать
сообщения &quot;connection refused&quot; при
попытке соединения с сервером имен.
Если вхождение <b>hosts</b>
переключателя имеет перечисленным
в любом месте списка сервис
&quot;dns&quot;, sendmail будет считать это
временной неудачей и поставит
сообщение в очередь для
последующей обработки; другими
словами, он игнорирует данные
сервера имен.</p>

<p>Такая же технология используется
при решении о просмотре MX. Если вы
хотите иметь поддержку MX, вы должны
иметь &quot;dns&quot; перечисленным как
сервис во вхождении <b>hosts</b>
переключателя.</p>

<p>Опция <b>ResolverOptions</b> (<b>I</b>)
позволяет вам изменять опции
сервера имен. Командная строка
принимает последовательность
флагов, как описано в resolver(3) (с
удаленным первым &quot;RES_&quot;). Каждый
из них может быть предварен
опциональным &quot;+&quot; или &quot;-&quot;.
Например, строка</p>

<dir>
    <dir>
            <font color="#008000">O ResolverOptions=+AAONLY
                -DNSRCH </font>
        </dir>
    
</dir>

<p>включает опцию AAONLY (принимать
только авторитативные сообщения) и
выключает опцию DNSRCH (поиск по
доменному пути). По умолчанию
большинство флагов библиотеки
разрешителя отключены, включены
только DNSRCH, DEFNAMES, и RECURSE. Вы также
можете включить &quot;HasWildcardMX&quot;,
чтобы указать, что существует
масочная запись MX, соответствующая
вашему домену; это отключает
сопоставление MX при канонификации
имен, что может привести к неверной
канонификации.</p>

<p>Версия конфигурации уровня 1
выключает DNSRCH и DEFNAMES для
просмотров, делаемых при доставке,
но оставляет их включенными во всех
остальных случаях. Версия 8 sendmail
игнорирует их при
канонификационных просмотрах (при
использовании $[ ... $]), и всегда
делает поиск. Если вы не хотите
автоматического расширения имен,
не вызывайте $[ ... $].</p>

<p>Правила поиска для $[ ... $] - это
что-то непохожее, чем необычное.
Если просматриваемое имя имеет
хотя бы одну точку, оно всегда будет
опробовано без изменений. Если это
не удастся, будет опробован
уменьшенный путь поиска, и в конце
концов будет опробовано
неизмененное имя (но только для
имен без точек, потому что имена с
точками уже были опробованы). Это
позволяет именам типа &quot;utc.CS&quot;
совпадать с узлами в Чехословакии,
а не с узлами в вашем местном
отделении Computer Science. Они также
предпочитают записи типов A и CNAME
записям типа MX- поэтому, если
находится запись MX, о ней делается
заметка, но просмотр продолжается.
Таким образом, если вы имеете
масочную запись MX, соответствующую
вашему домену, то это не будет
распознано, как будто все имена
совпадают с ней.</p>

<p>Для полного выключения доступа к
серверу имен в, системах без
поддержки сервисного
переключателя (типа SunOS), вы должны
будете перекомпилировать sendmail с
-DNAMED_BIND=0 и удалив -lresolv из списка
искомых при линковании библиотек.</p>

<dir>
    <dir>
            <a name="toc410"></a><b>4.10.
                Перемещение
                Пользовательских Файлов
                Перенаправления</b>
        </dir>
    
</dir>

<p>Некоторые узлы монтируют
домашние каталоги пользователей с
локальных дисков их рабочих
станций, потому, что локальный
доступ быстрее. Однако при этом
замедляется просмотр файлов .forward. В
некоторых случаях, почта может быть
доставлена неправильно, из-за
отключения файлового сервера.
Быстродействие может быть особенно
медленным, если вы используете
автоматическое монтирование.</p>

<p>Опция <b>ForwardPath</b> (<b>J</b>) позволяет
вам назначить путь к файлам
перенаправления. Например, строка
файла конфигурации</p>

<dir>
    <dir>
            <font color="#008000">O
                ForwardPath=/var/forward/$u:$z/.forward.$w </font>
        </dir>
    
</dir>

<p>Сначала будет искать файл с
именем, совпадающим с именем
пользователя в /var/forward; если он не
найден, или к нему нет доступа, в
домашнем каталоге пользователя
будет искаться файл
&quot;.forward.machinename&quot;. Только узел
настоящих извращенцев может также
искать по отправителю, используя $r,
$s, или $f.</p>

<p>Если вы создаете каталог типа
/var/forward, он должен иметь пермиссии
1777 (то есть, должен быть выставлен
sticky bit). Пользователи должны
создавать файлы с пермиссиями 644.
Заметьте, что для разрешения файлов
перенаправления в каталоге,
открытом всем на запись, вы должны
использовать флаги ForwardFileInUnsafeDirPath и
ForwardFileInUnsafeDirPathSafe с опцией DontBlameSendmail.</p>

<dir>
    <dir>
            <a name="toc411a"></a><b>4.11.
                Свободное Пространство</b> 
        </dir>
    
</dir>

<p>В системах, имеющих один из
системных вызовов семейства statfs(2)
(включая statvfs и ustat), вы можете
указать минимальное количество
свободных блоков в файловой
системе очереди, используя опцию <b>MinFreeBlocks</b>
(<b>b</b>). Если в файловой системе,
содержащей очередь, доступно
меньше, чем указанное количество
блоков, сервер SMTP будет
отказываться от почты кодом ошибки
452. Такой отказ приглашает клиентов
SMTP попытаться установить
соединение позднее.</p>

<p>Не устанавливайте значение этой
опции слишком высоким; это может
повлечь отказ от почты в тех
случаях, когда она может быть
спокойно обработана.</p>

<dir>
    <dir>
            <a name="toc412a"></a><b>4.12.
                Максимальный размер
                сообщения</b> 
        </dir>
    
</dir>

<p>Во избежание переполнения вашей
системы большим сообщением, может
быть выставлена опция <b>MaxMessageSize</b>,
указывающая абсолютное
ограничение размера любого
сообщения. Это будет сообщено в
диалоге ESMTP и проверено при
передаче сообщения.</p>

<dir>
    <dir>
            <a name="toc413a"></a><b>4.13. Флаги
                Конфиденциальности</b> 
        </dir>
    
</dir>

<p>Опция <b>PrivacyOptions</b> (<b>p</b>) позволяет
вам установить конкретные
&quot;конфиденциальные&quot; флаги. На
самом деле, многие из них не дадут
вам экстра конфиденциальности, а
только лишь настоят на том, чтобы
клиентские сервера SMTP использовали
команду HELO до использования
конкретных команд, или добавлением
дополнительных заголовков, для
распознания попыток подкачки.</p>

<p>Опция принимает
последовательности имен флагов;
крайняя конфиденциальность -
включение всех этих флагов.
Например:</p>

<dir>
    <dir>
            <font color="#008000">O
                PrivacyOptions=needmailhelo, noexpn </font>
        </dir>
    
</dir>

<p>Настоит на том, чтобы команда HELO
или EHLO была использована до
принятия команды MAIL и отключает
команду EXPN.</p>

<p>Флаги подробно описаны в разделе
5.6.</p>

<dir>
    <dir>
            <a name="toc414"></a><b>4.14. И Мне
                Тоже Пришлите </b>
        </dir>
    
</dir>

<p>Обычно, sendmail удаляет (конвертного)
отправителя из любого списка
расширений. Например, если &quot;matt&quot;
посылает письмо в список,
содержащий &quot;matt&quot; как одного из
своих членов, то он, скорее всего, не
захочет получить копию своего же
сообщения. Если в командной строке
есть флаг <b>-m</b> (мне тоже), или в
файле конфигурации выставлена
опция <b>MeToo</b> (<b>m</b>), это свойство не
используется. Некоторые узлы любят
запускать демон SMTP с <b>-m</b>.</p>

<hr>

<p><a name="r1"><font size="-1"></a>
1. В некоторых системах по умолчанию
нуль, чтобы окончательно отключить
протокол. <a href="sendmail4.html#b1">[назад]</a></p>

<p>2. Эта проверка включает
просмотр каждого адреса сервером
имен; что добавляет сетевые
задержки, но в некоторых случаях
может быть приемлемо. <a href="sendmail4.html#b2">[назад] </a></p>
</body>
</html>
