<HTML>
<HEAD>
 <TITLE>Примеры изменения конфигурации XKB.</TITLE>
</HEAD>

<BODY BGCOLOR="#FFFFFF">
     <H2>Примеры изменения конфигурации XKB.</H2>


 
<P>
 Прежде всего, хочу заметить, что все решения, рассмотренные в примерах,
не претендуют на "правильность".

<P>
  Более того, многие из них я сам считаю или излишне "корявыми" (громоздкими),
или "идеологически неправильными".

<P>
  Но, с другой стороны, я не предлагаю готовые решения для всех проблем,
а только хочу показать - чего можно добиться простым изменением текстовых
"конфигов" XKB.


<P>
  Во-первых, давайте решим вопрос -

  <H3>Где будем экспериментировать?</H3>



<P>
  Конечно, все изменения конфигурации можно сделать непосредственно в 
соответствующих файлах настройки XKB. Но это очень неудобно по нескольким
причинам
<UL>
 <LI> всегда хочется иметь возможность "откатиться" к стандартной конфигурации,
поэтому придется сохранять отдельно оригинальные файлы;
 <LI> если в следующих версиях "иксов" эти файлы изменятся, то вам придется
либо переносить свои изменения вручную, либо продолжать пользоваться старыми
файлами;
 <LI> ну и, наконец, если мы вносим изменения только в одно-два определения,
зачем нам искать их каждый раз в "многоэтажном" тексте.
</UL>


<P>
  При этом <B>xkbcomp</B> позволяет легко "нанизывать" несколько файлов при
описании одного компонента настройки XKB. Например, файл (блок) описания
компонента <B>xkb_types</B> может выглядеть как

<PRE>
xkb_types {
  include "basic+pc+мои_типы+еще_один_полезный_тип";
};
</PRE>
 
Что означает -
<UL>
<LI> взять описание из файла <B>basic</B>;
<LI> добавить к нему описание из файла <B>pc</B>;
<LI> добавить описание из файла <B>мои_типы</B>;
<LI> и, наконец, добавить еще описание из файла <B>еще_один_полезный_тип</B>.
</UL>


<P>
  При этом, если в добавляемом файле встретится определение для какого-то
элемента, уже описанного в предыдущих файлах, новое определение, обычно,
замещает старое, не затрагивая все остальные определения.


<P>
  Итак. Давайте все изменения/исправления/дополнения помещать в отдельных
файлах и просто "приплюсовывать" эти файла к уже имеющимся.


<P>
  Хотя, в некоторых случаях (особенно это касается добавлений в <B>xkb_symbols</B>),
боле эффективным может оказаться не "приплюсовывание", а объявление
добавляемого файла отдельной инструкцией - replace.

<P>
  Напомню, что "плюсик" в инструкции <B>include</B> означает, что инструкции из
файла будут добавляться в режиме override (см <A HREF="gram-common.html#merge">"Способ добавления"</A>.). А при
переопределении клавиш часто требуется способ replace.
<BR>  Поэтому, при добавлении в <B>xkb_symbols</B>, вместо одного длинного <B>include</B>
лучше использовать конструкцию типа
<PRE>
xkb_symbols {	include "en_US(pc104)"
		replace "my.symbols"
		replace "one_another_symbol" };
</PRE>


<P>
  Теперь осталось решить вопрос - куда "приплюсовывать"?
<BR>  Во-первых, напомню, что программа <B>xkbcomp</B> может "на ходу" поменять настройки
XKB прямо в работающем X-сервере. Для этого вторым ее аргументом ("куда")
нужно указать "X дисплей". Если вы работаете на той же машине, где и
запущен X-сервер, то это выглядит как
<PRE>
xkbcomp ... :0.0
</PRE>
(можно еще проще - ":0")


<P>
  А вот первым аргументом должен быть файл с описанием одного или нескольких
компонентов настройки. Для того, чтобы одной командой загружать все
необходимые компоненты настройки, давайте сначала составим файл с полным
описанием всех компонентов, соответствующий вашей текущей конфигурации.

<P>
  Это совсем не сложно, но зависит от того - какой способ задания полной
конфигурации используется у вас в XF86Config (см. <A HREF="setup.html">"Настройка XKB"</A>)
<BR>  (Надеюсь, что у вас используется один из способов "в чистом виде", а не
"каша" из всех возможных инструкций).

   <H3>"Первый способ"</H3>

<P>
  Если у вас используется первый способ - перечислением необходимых
компонентов (<B>keycodes, types, compat, symbols, geometry</B>).

<P>
  Просто скопируем из файла XF86Config все инструкции типа <B>Xkb****</B> из секции
"<B>Keyboard</B>" в наш файл. И слегка подправим.
<BR>  Например, у вас там написано

<PRE>
  XkbKeycodes	"xfree86"
  XkbTypes	"default"
  XkbCompat	"default"
  XkbSymbols	"us(pc104)+ru"
  XkbGeometry	"pc(pc104)"
</PRE>

  Надо -
<UL>
<LI> во всех строчках заменить префикс <B>Xkb</B> на <B>Xkb</B>_ ("case" букв менять
не обязательно),
<LI> вставить в каждую строчку инструкцию <B>include</B>,
<LI> получившиеся инструкции i<B>nclude "..."</B> взять в фигурные скобки и закончить
знаком "<B>;</B>",
<LI> и, наконец, добавить "обрамление" - <B>xkb_keymap { .... };</B> .
</UL>
  Должно получится

<PRE>
xkb_keymap {
  Xkb_Keycodes	{ include "xfree86" };
  Xkb_Types	{ include "default" };
  Xkb_Compat	{ include "default" };
  Xkb_Symbols	{ include "us(pc104)+ru" };
  Xkb_Geometry	{ include "pc(pc104)" };
};
</PRE>

<P>
  Это и есть полное описание настройки XKB. Которое можно загружать в X-сервер,
программой xkbcomp.

<P>
  Все наши добавки мы можем "приплюсовывать" в соответствующие строчки этого
описания.

<H3>"Второй способ"</H3>

<P>
  Если у вас используется второй способ - указание полной <B>keymap</B>.
В этом случае надо просто найти конкретную <B>keymap</B> и скопировать в наш файл.

<P>
  Например, у вас в XGF86Config есть только строчка

<PRE>
XkbKeymap  "xfree86(ru)"
</PRE>

  Она указывает на то, что полное описание лежит в файле
<B>{XKBROOT}/keymap/xfree86</B>, в блоке "<B>ru</B>".

<P>
  Находим этот файл. Находим в нем блок
<PRE>
xkb_keymap "ru" {
 ....
};
</PRE>
  И "выкусываем" его оттуда. (Поскольку в нашем файле только один блок, название
блока можно убрать).

<P>
  Больше никаких исправлений не требуется.

<H3>"Третий способ".</H3>



<P>
  Если у вас используется третий способ - через задание <B>"правил", "модели",
"схемы"</B>.

<P>
  В этом случае все немного сложнее, поскольку непосредственно <B>xkbcomp</B> не
понимает этот способ.

<P>
  Однако, в этом случае можно "вручную" выполнить преобразование
правил/модели/схемы в компоненты настройки (<B>keycodes,symbols </B>и т.п.).
<BR>  Например, у вас в файле конфигурации написано

<PRE>
XkbRules	"xfree86"
XkbModel	"pc104"
XkbLayout	"ru"
XkbOptions	"grp:shift_toggle"
</PRE>


<P>
  Сначала надо найти файл <B>"правил</B>" (<B>rules</B>). Это будет файл
<B>{XKBROOT}/rules/xfree86</B>.

<P>
  В первой секции, которая после "шаблона"
<PRE>
! model = keycodes	geometry
</PRE>
по вашей модели - <B>"pc104"</B> находим название файлов (блоков) для <B>xkb_keycodes</B>
и <B>xkb_geometry</B>. Скорее всего это будет
<PRE>
xkb_keycodes - "xfree86"
xkb_geometry - "pc(104)"
</PRE>


<P>
  Теперь, во второй секции, после "шаблона"
<PRE>
! model	layout	=	symbols
</PRE>
найдем по <B>"модели" - "pc104"</B> и <B>"схеме" - "ru"</B> подходящий файл для <B>xkb_symbols</B>.

<P>
  Скорее всего, схема <B>"ru"</B> там не упомянута. Но зато есть правило
<PRE>
pc104	*	= en_US(pc104)+%l%(v)
</PRE>
где <B>%l</B> надо "заместить" названием <B>"схемы"</B> (<B>layout</B>), а <B>%(v)</B> - названием
<B>"варианта"</B>.
<BR>  Поскольку "вариант" у вас не задан, то это правило "развернется" в

<PRE>
xkb_symbols - "en_US(pc104)+ru"
</PRE>


<P>
  Следующая секция, после "шаблона"
<PRE>
! model	layout	=	compat	types
</PRE>
вообще очень простая
<PRE>
*	*	=	complete	complete
</PRE>
  То есть, независимо от конкретных значений <B>model</B> и <B>layout</B>, и <B>xkb_compat</B>,
и <B>xkb_types</B> надо брать из файлов <B>"complete"</B>.
<BR>  Таким образом, для нашего файла полной конфигурации значения
<PRE>
xkb_types  - "complete"
xkb_compat - "complete"
</PRE>


<P>
  И, наконец, последняя секция, после "шаблона"
<PRE>
! option	=	symbols
</PRE>
указывает, что для нашей <B>"опции" - grp:shift_toggle</B>, к уже выбранному
файлу для <B>xkb_symbols</B> надо "приплюсовать" еще и блок "<B>group(shift_toggle)</B>"


<P>
  Теперь не забудьте добавить слова <B>include</B>, скобки в нужном месте и
"обрамление" <B>xkb_keymap { ... }</B>;

<P>
  Должно получится
<PRE>
xkb_keymap {
  xkb_keycodes	{ include "xfree86" };
  xkb_types	{ include "complete" };
  xkb_compat	{ include "complete" };
  xkb_symbols	{ include "us(pc104)+ru+group(shift_toggle)" };
  xkb_geometry	{ include "pc(pc104)" };
};
</PRE>
  Это и есть наша рабочая "полная конфигурация", к которой можно писать
"добавки" - исправления/дополнения.


<P>
  Наконец, надо заметить, что делать все это (и полное описание и фалы-добавки)
вы можете в отдельной директории, поскольку <B>xkbcomp</B> при "разборке" <B>include</B>
сначала ищет файла в текущей директории, а только потом в "стандартном" месте -
<B>{XROOT}/lib/X11/xkb</B>. Естественно, подразумевается, что мы при экспериментах
запускаем <B>xkbcomp</B>, находясь в этой директории.


<P>
  А вот потом, если вы решите, что "это хорошо", можно будет разложить
файлы с исправлениями в соответствующие поддиректории (<B>keycodes, types, symbols</B>
и т.д ) "домашней директории" XKB - <B>{XROOT}/lib/X11/xkb</B>. И подправить файл
конфигурации X-сервера так, чтобы он при старте загрузил вашу конфигурацию.

 <H2> Итак. Примеры изменения конфигурации XKB.</H2>
<UL>
	<LI><A HREF="example1.html">Новый тип для клавиши Enter.</A>
	<LI><A HREF="example2.html">Добавляем новую "старую" раскладку клавиатуры.</A>
	<LI><A HREF="example3.html">"Вариации на тему" переключатели "рус/лат" (и еще раз - "рус").</A>
	<LI><A HREF="example4.html">Еще несколько "переключателей".</A>
</UL>



<hr>
<p>Иван Паскаль <a href=mailto:pascal@tsu.ru> pascal@tsu.ru </a>

</BODY>
</HTML>
