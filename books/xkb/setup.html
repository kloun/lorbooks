<HTML>
<HEAD>
 <TITLE>Настройка XKB.</TITLE>
</HEAD>

<BODY BGCOLOR="#FFFFFF">

   <H2>Настройка XKB.</H2>
<UL>
	<LI><A HREF="setup.html#tables">База данных, необходимых XKB,</A>
	<LI><A HREF="setup.html#setup">Три способа задания полной конфигурации XKB.</A>
	<UL>
		<LI><A HREF="setup.html#1">Первый способ.</A>
		<LI><A HREF="setup.html#2">Второй способ.</A>
		<LI><A HREF="setup.html#3">Третий способ.</A>
	</UL>
	<LI><A HREF="setup.html#suggest">Несколько практических рекомендаций.</A>
</UL>
<P>
  При старте X-сервера, модуль XKB зачитывает все необходимые данные
из текстовых файлов, которые образуют "базу данных" настроек XKB.

<P>
  Строго говоря, большинство из этих файлов сам модуль XKB не читает.
Он вызывает программу <B>xkbcomp</B>, которая переводит содержимое этих файлов
в двоичный формат, понятный непосредственно модулю XKB.

<P>
  Но для настройки это не так уж важно, поскольку вызов <B>xkbcomp</B> происходит
автоматически, незаметно для пользователя.

<A NAME="tables"></A>


<P>
  База данных, необходимых XKB, состоит из 5 компонентов

<DL>
<DT><B>keycodes</B></DT>
<DD> таблицы, которые просто задают символические имена для скан-кодов.
<BR>Например

<BR>&lt;TLDE&gt;= 49;
<BR>&lt;AE01&gt; = 10;

</DD>

<DT><B>types</B></DT>
<DD> описывает типы клавиш. Тип клавиши определяет - как должно
меняться значение, выдаваемое клавишей в зависимости от модификаторов
(Control, Shift и т.п.). Так, например, "буквенные" клавиши относятся
к типу ALPHABETIC, что означает, что они имеют разное значение в зависимости
от состояния Shift и CapsLock. А клавиша [Enter] имеет тип - ONE_LEVEL,
что означает, что ее значение всегда одно и то же, независимо от состояния
модификаторов.
</DD>

<DT><B>compat</B> (сокращенное от compability)</DT>
<DD>  описывает "поведение" модификаторов.
 В XKB имеется несколько внутренних переменных, которые, в конечном счете,
и определяют - какой символ будет генерироваться при нажатии клавиши в
конкретной ситуации.
  Так вот, в compat как-раз описывается - как должны меняться эти переменные
при нажатии различных клавиш-модификаторов. В этом же разделе обычно
описывается и поведение "лампочек"-индикаторов на клавиатуре.
</DD>

<DT><B>symbols</B></DT>
<DD>	 таблицы, в которых для каждого скан-кода (имени скан-кода,
определенного в keycodes) перечисляются все значения (symbols), которые
должна выдавать клавиша. Естественно, количество различных значений
зависит от типа клавиши (котрые описываются в types), а какое именно
значение будет выдано в конкретной ситуации, определяется состоянием
модификаторов и их "поведением" (которое описывается в compat) 
</DD>

<DT><B>geometry</B></DT>
<DD>  описывает "геометрию" клавиатуры - то есть расположение клавиш
на клавиатуре. Эти описания нужны не столько самому X-серверу, сколько
прикладным программам, которые рисуют изображение клавиатуры.
</DD>
</DL>


<P>
  Все эти компоненты разложены по одноименным директориям в директории
<B>{XROOT}/lib/X11/xkb</B> (в дальнейшем, я буду обозначать ее <B>{XKBROOT}</B>).

<P>
  Надо сказать, что в каждой такой директории имеется несколько файлов
(иногда, довольно много) с разными настройками. Более того, каждый
файл внутри себя может содержать несколько блоков (секций, разделов)
типа
<PRE>
   тип_компонента "имя_блока" {........};
</PRE>

<P>
  Поэтому, для того, чтобы выбрать конкретную настройку, ее обычно
указывают в виде
<BR> <B>имя_файла(имя_блока)</B>
<BR>например,
<BR> <B>us(pc104)</B>


<P>
  В тоже время, обычно один из блоков в файле (не обязательно самый первый)
помечается флагом <B>default</B>, например
<PRE>
        xkb_symbols "pc101" {...};
default xkb_symbols "pc101euro" {...};
        xkb_symbols "pc102" {...};
        xkb_symbols "pc102euro" {...};
</PRE>

<P>
  Это означает, что если указать только имя файла, то будет выбран именно
этот блок.

   <H2><A NAME="setup">Три способа задания полной конфигурации XKB.</A></H2>


<P>
   Весь набор компонентов, необходимых для настройки XKB, описывается
в файле конфигурации X-сервера в секции <B>Keyboard</B>.

<H3><A NAME="1">Первый способ.</A></H3>

<P>
  Первый способ задания конфигурации заключается в том, что вы можете
указать непосредственно каждый из компонентов, например

<PRE>
XkbKeycodes	"xfree86"
XkbTypes	"default"
XkbCompat	"default"
XkbSymbols	"us(pc104)"
XkbGeometry	"pc(pc104)"
</PRE>


<P>
  Как легко догадаться, это означает, что
<UL>
<LI> описание <B>keycodes</B> берется из файла <B>"xfree86"</B> в директории
<B>{XKBROOT}/keycodes</B>, причем из файла будет выбран тот блок,
который помечен в нем флагом <B>default</B>;
<LI> описание <B>types</B> берется из файла <B>"default"</B> в директории <B>{XKBROOT}/types</B>;
<LI> описание <B>compat</B> берется из файла <B>"default"</B> в директории <B>{XKBROOT}/compat</B>;
<LI> описание <B>symbols</B> берется из файла <B>"us"</B> в директории <B>{XKBROOT}/symbols</B>,
блок <B>"pc104"</B>;
<LI> описание <B>geometry</B> берется из файла <B>"pc"</B> в директории <B>{XKBROOT}/geometry</B>,
блок <B>"pc104"</B>;
</UL>


<P>
  Надо заметить, что в любом блоке (в любых компонентах) может встретиться
инструкция

<P>
<B>include "имя_файла(имя_блока)"</B>  (естественно, имя_блока может отсутствовать)

<P>
что, как нетрудно догадаться, означает, что в текущий блок должно быть
вставлено другое описание из указанного файла (указанного блока).

<P>
  Поэтому полное описание может неявно включать в себя данные из многих
других файлов, кроме тех, которые вы явно укажете в файле конфигурации
X-сервера.

<H3><A NAME="2">Второй способ.</A></H3>

<P>
  Второй способ заключается в том, что вы можете указать одной инструкцией
сразу полный набор настроек. Такие наборы называются <B>keymaps</B> и, также
как и обычные компоненты конфигурации XKB, располагаются в отдельных
файлах (которые, тоже содержат в себе несколько именованных блоков) в
директории <B>{XKBROOT}/keymap</B>.

<P>
  Обычно, каждом блоке <B>keymap</B> просто указывается - из каких файлов XKB
должен извлечь соответствующие компоненты (хотя, в принципе, там может быть
и полное описание всех компонентов), например

<PRE>
xkb_keymap "ru"	{
    xkb_keycodes	{ include "xfree86"		};
    xkb_types		{ include "default"		};
    xkb_compatibility	{ include "default"		};
    xkb_symbols		{ include "en_US(pc105)+ru"	};
    xkb_geometry 	{ include "pc(pc102)"		};
};
</PRE>
  Обратите внимание, что в одной инструкции <B>include</B> может быть указано
несколько файлов (блоков) через знак "+". Понятно, что это означает, что
должны быть вставлены последовательно все указанные файлы.


<P>
  Таким образом, в файле конфигурации X-сервера можно вместо пяти компонентов
указать сразу один их готовых наборов - <B>keymap</B>'ов, например

<PRE>
XkbKeymap	"xfree86(ru)"
</PRE>

  Кроме того, эти два способа можно комбинировать. Например, если вы выбрали
одну из подходящих <B>keymap</B>, но вас не устраивает один из компонентов, например
<B>geometry</B>, то в файле конфигурации можно указать

<PRE>
XkbKeymap	"xfree86(ru)"
XkbGeometry	"pc(pc104)"
</PRE>


<P>
  При этом, в соответствии с первой инструкцией, все компоненты будут взяты
из <B>keymap "xfree86(ru)"</B>, а вторая инструкция "перепишет" <B>geometry</B>, не
затрагивая остальные компоненты (хотя я в этом не уверен :)

<H3><A NAME="3">Третий способ.</A></H3>

<P>
  И, наконец, третий способ. Он несколько отличается от предыдущих.


<P>
Набор настроек можно указывать не перечислением компонентов, а с помощью
задания "правил" (Rules), "модели" (Model), "схемы" (Layout), "варианта"
(Variant) и "опций" (Option). В этом наборе только Rules представляют собой
некий файл, в котором находится таблица правил - "как выбрать все пять
компонентов настроек XKB в зависимости от значений Model, Layout и т.д.".

<P>
  Все остальные параметры представляют собой просто "ключевые слова" по
которым в таблицах "правил" ищутся подходящие файлы настроек (<B>keycodes,
types, compat, symbols</B> и <B>geometry</B>). Естественно, искать будет сам
модуль XKB при старте.

<P>
  Другими словами, Rules определяет некоторую функцию, аргументами которой
являются Model, Layout, Variant и Options, а значение, которое возвращает
эта функция представляет собой полный набор из компонентов настроек XKB -
<B>keycodes, types, compat, symbols</B> и <B>geometry</B> (или полная <B>keymap</B>).

<P>
  Если рассмотреть какой-нибудь файл rules (эти файлы тоже находятся в
<B>{XKBROOT}</B> в поддиректории <B>rules</B>), то можно заметить, что в них есть строчки,
начинающиеся со знака "!". Это "шаблоны", которые описывают - как
интерпретировать следующие за ними строчки "правил".

<P>
  Например, "шаблон"

<PRE>
! model = keycodes	geometry
</PRE>

говорит о том, что в следующих строках описываются правила - как по имени
"модели" XKB должен выбрать файлы <B>keycodes</B> и <B>geometry</B>.
  Например,

<PRE>
pc104 = xfree86 pc(pc104)
</PRE>

надо понимать так, что если значение аргумента Model - слово <B>"pc104"</B>,
то <B>keycodes</B> надо взять из файла <B>{XKBROOT}/keycodes/xfree86</B>, а <B>geometry</B> -
из файла <B>{XKBROOT}/geometry/pc</B>, блок с именем <B>"pc104"</B>.
 <BR> А, например, "шаблон"

<PRE>
! model	layout	=	symbols
</PRE>

говорит о том, что следующие за ним правила описывают - как по названию
"модели" и "схемы" выбрать файл (и блок), с нужными <B>symbols</B>.


<P>
   Рассматривая файл <B>rules</B> можно заметить, что в нем также есть строчки
с wildcards - знаком "*". То есть, в качестве аргументов можно использовать
не только те слова, которые встречаются в "правилах". Если программа не
найдет указанные вами слова в левой части правила, то все равно подберет
какие-нибудь названия для файлов - компонентов настройки.
<BR>  Например, правило

<PRE>
! model	layout	=	symbols
....
   *	  *	=	en_US(pc102)+%l%(v)
</PRE>

означает, что если указанные вами Model и Layout не были найдены в предыдущих
правилах, то в качестве <B>symbols</B> надо взять блок <B>pc102</B> из файла <B>en_US</B>, и добавить
к нему блок, название которого задано параметром Variant из файла, название
которого задано аргументом Layout. (Таким образом, в некоторых случаях,
некоторые из параметров могут являться и названиями файлов или блоков. Но
в общем случае это все-таки просто "ключевые слова").


<P>
  Можно также заметить, что...
<BR>  Во-первых, не все параметры обязательно задавать
для выбора всех компонентов. Обычно достаточно указать Model и Layout
(ну и, естественно, Rules), а Variant и Options нужны только в некоторых
случаях.
<BR>  А во-вторых, что
<UL>
<LI>  Model обычно определяет тип "железа" - клавиатуры;
<LI>  Layout - язык или, точнее, алфавит, который "навешивается" на кнопки
клавиатуры;
<LI>  Variant - ну "вариант" он и есть вариант - различные варианты размещения
знаков алфавита (заданных Layout'ом);
<LI>  Options - обычно меняет "поведение" или "расположение" модификаторов -
Control и Group (переключатель групп - это переключатель "языка", например -
русский/латинский).
</UL>


<P>
  Кстати, заметьте также, что хотя Options как правило состоят из двух
слов, разделенных двоеточием, это не означает, что вы можете самостоятельно
комбинировать левую и правую часть (двоеточие в данном случае просто делает
их более понятными). Так, например, в rules есть правила для значений
Options <B>"grp:toggle"</B> и <B>"ctrl:ctrl_aa"</B>. Но если вы попробуете "сконструировать"
что-то типа <B>"ctrl:toggle"</B>, ничего хорошего из этого не получится, поскольку
такого слова в правилах нет. 


<P>
  Итак, если вы используете третий способ указания конфигурации XKB, то в
файле конфигурации X-сервера, надо задать параметры XkbRules, XkbModel,
XkbLayout и, если вам нужно что-то не совсем стандартное - XkbVariant и
XkbOptions.
<BR>  Например,

<PRE>
XkbRules	"xfree86"
XkbModel	"pc104"
XkbLayout	"ru"
XkbVariant	""
XkbOptions	"ctrl:ctrl_ac"
</PRE>

означает, что XKB должен
<UL>
<LI> в соответствии с правилами, описанными в файле <B>{XKBROOT}/rules/xfree86</B>,
выбрать настройки для
<LI> клавиатуры типа <B>"pc104"</B> (104 кнопки),
<LI> русского алфавита (английский алфавит будет включен "по умолчанию"),
<LI> вариант - "стандартный" (то есть, этот параметр можно было не писать)
<LI> и, наконец, дополнительные опции для вашей "раскладки клавиатуры" -
<B>"ctrl:ctrl_aa"</B>.
</UL>

<P>
  Кстати, что означают различные опции, а также - какие "модели" и "схемы"
определены в "правилах" (и что они означают) можно посмотреть в файле
<B>xfree86.lst</B> (или другом файле <B>*.lst</B>, если вы выбрали "правила" не <B>xfree86</B>),
который находится в той же директории, что и файл "правил", то есть -
<B>{XKBROOT}/rules</B>.

  <H2><A NAME="suggest">Несколько практических рекомендаций.</A></H2>

<P> Небольшое отступление - "о клавише - переключателе рус/лат".
<br> Когда был написан первый вариант этих рекомендаций, сама раскладка
"русской" клавиатуры (<b>symbols/ru</b>) включала в себя и "переключатель
групп" - рус/лат, "подвешенный" на клавишу <b>CapsLock</b>. С одной стороны
это было удобно - в простейшем случае достаточно было выбрать "русскую
раскладку" и вы автоматически получали и клавишу для переключения "на русский".
Но, с другой стороны, это было неудобно для тех, кто предпочитает в качестве
переключателя рус/лат другую клавишу (или комбинацию клавиш). Конечно, выбрать
другой переключатель не составляло труда, но при этом оставался и переключатель
на CapsLock, что многим не нравилось. Для того, чтобы убрать его, надо было
"залезть" в соответствующий файл и вручную подправлять соответствующую
раскладку.

<P> В конце концов (начиная с версии 3.3.4) сами разработчики XFree убрали
этот "переключатель" из "русской раскладки". Но, в связи с этим появились
и некторые проблемы - теперь клавишу-переключатель надо явно "заказывать"
при конфигурировании <b>XKB</b>. Что я и попытся отразить в своих рекомендациях.
<br> Итак...


<h4>  Самый простой способ - использовать программу для автоматической настройки
"иксов".</h4>

<P> В XFree86 такая программа называется XF86Setup. Она использует
третий метод задания конфигурации XKB. При этом "по умолчанию" используются
"правила" (<B>XkbRules</B>) - xfree86. Вам нужно будет только выбрать
"модель" (<B>XkbModel</B>), "схему" (<B>XkbLayout</B>) и
"способ переключения групп" (переключатель "РУС/ЛАТ").

<P> Кроме того, при желании вы можете изменить "положение клавиши Ctrl".
Естественно, в конфигурации это будет выглядеть как соответствующие строчки
<B>XkbOptions</B>.
 
<P> Итак. Запустите программу XF86Setup, выберите раздел <B>Keyboard</B>.
В этом разделе выберите из меню <B>Model</B> (тип клавиатуры) и <B>Layout</B>
(язык). Не забудьте отметить в отдельных списках (в правой части)
подходящий "переключатель групп" и, если хотите - "расположение Ctrl".

<P> При выходе из программы она запишет соответствующие строчки в файл
конфигурации XFree в секции <B>Keyboard</B>.

<P>
 Но, если вы захотите вписать эти строчки самостоятельно, могу дать
еще несколько советов.

<P>
  Прежде всего, надо сказать, что "ключевыми словами" в этих настройках
будут
<UL>
	<LI> <B>xfree86</B> - название "архитектуры" X-Window;
	<LI> <B>pc101</B> (<B>pc104, pc105</B> и т.п.) - тип клавиатуры (количество кнопок);
	<LI> <B>ru</B> - название "раскладки клавиатуры" с русским алфавитом.
</UL>

  (Если у вас другая "архитектура"/клавиатура/алфавит, то подберите названия
самостоятельно.)

<P>
  Итак...

 <h4> Начнем со второго способа - полная keymap.</h4>

В файлах конфигурации есть набор "полных <B>keymap'ов</B>" для архитектуры <B>xfree86</B>,
отличающихся "языком". Все они лежат в файле <B>xfree86</B>, а название блока
внутри файла отражает название "языка" (точнее - алфавита) - <B>xfree86(us),
xfree86(fr), xfree86(ru)</B> и т.д. Полный список <B>keymap'ов</B> можно посмотреть
в файле <B>{XKBROOT}/keymap.dir</B>.


<P>
  Для "руссифицированной" клавиатуры вполне подойдет
<PRE>
XkbKeymap	"xfree86(ru)"
</PRE>

<P> К сожалению, после "выкидывания" CapsLock как переключателя рус/лат
из русской раскладки (см. замечание в начале этого раздела) получилось так,
что "полная <B>keymap</B>" для русского языка осталась вообще без
какого-либо переключателя "по умолчанию". Но вы можете добавить его "вручную".
Для этого придется найти в файле <b>{XKBROOT}/keymap/xfree86</b> блок
<b>"ru"</b>. И дописать в строчку <b>xkb_symbols</b> ссылку на описание
соответствующего переключателя групп. Для <b>CapsLock</b> это будет -
<b>group(caps_toggle)</b>. То есть, строчка будет выглядеть как
<pre>
xkb_symbols 	{ include "en_US(pc105)+ru+group(caps_toggle)"};
</pre>

<h4> Если вы выбираете третий способ - через "правила", "модель",
"схему" и т.д.</h4>

<P>
  Как я уже говорил,
<UL>
	<LI> название "правил" (<B>rules</B>) соответствет "архитектуре" (<B>xfree86</B>);
	<LI> "модель" (<B>model</B>) соответствует типу клавиатуры (<B>pc101, pc102</B> и т.п.);
	<LI> "схема" (<B>layout</B>) отражает "язык" (<B>ru</B>).
</UL>

  Поэтому, подходящая конфигурация будет выглядеть примерно так -
<PRE>
XkbRules	"xfree86"
XkbModel	"pc104"
XkbLayout	"ru"
</PRE>
  С помощью <B>XkbOptions</B> можно подобрать "поведение" управляющих клавиш.
Возможные значения <B>XkbOptions</B> и их смысл можно подсмотреть в файле
<B>{XKBROOT}/rules/xfree86.lst</B>.

<P> Не забудьте, что в последних версиях надо явно выбрать переключатель
групп. Для <b>CapsLock</b> это будет -
<pre>
XkbOptions	"grp:caps_toggle"
</pre>

<h4>
  И, наконец, первый способ - описание отдельных компонентов настройки
(keycodes, compat, types, symbols, geometry).</h4>

<P>
  Если вы не знаете с чего начать, подсмотрите соответствующий набор
в <B>keymap</B>. Или попробуйте "вычислить" его "вручную" через <B>rules/model/layout</B>.
(Подробнее об этом можно прочитать в 
<A HREF="examples.html">"Примеры: Где будем экспериментировать?"</A>)

<P>
  Могу посоветовать
<UL>
	<LI>- для <B>keycodes</B> выбрать файл <B>xfree86</B>;
	<LI>- для <B>types</B> и <B>compat</B> подойдут файлы <B>default</B> ("по умолчанию")
	 или <B>complete</B> ("полная");
	<LI>- <B>geometry</B>, скорее всего, <B>"pc"</B>, а количество кнопок задается названием блока
	в файле <B>pc - pc(pc101), pc(pc102), pc(pc104)</B>. (Полный список "геометрий" в
	файле <B>{XKBROOT}/geometry.dir</B>.)
</UL>


<P>
  А вот на <B>symbols</B> обратите особое внимание. Файл <B>symbols/ru</B> описывает только
"буквенные" клавиши. Если вы укажете только его, то у вас не будут работать
все остальные кнопки (включая Enter, Shift/Ctrl/Alt, F1-F12 и т.д.).

<P>
  Поэтому <B>symbols</B> должен состоять по крайней мере из двух файлов -
<B>en_US(pc101)</B> (в скобках - тип клавиатуры) и, собственно, <B>ru</B>.
<BR>  Полный список symbols в файле <B>{XKBROOT}/symbols.dir</B>.

<P> Сюда же надо добавить и описание подходящего "переключателя рус/лат"
<BR> Описание всех возможных переключателей групп находится в файле
<B>{XKBROOT}/symbols/group</B>.

<P>
  Итак. Для первого метода список может выглядеть так -
<PRE>
XkbKeycodes	"xfree86"
XkbTypes	"complete"
XkbCompat	"complete"
XkbSymbols	"en_US(pc101)+ru+group(caps_toggle)"
XkbGeometry	"pc(pc101)"
</PRE>

  Если вам хочется дополнительные изменения "поведения" управляющих клавиш
(то, что в третьем методе задается <B>XkbOptions</B>), то подсмотрите подходящую
"добавку" в <B>{XKBROOT}/rules/xfree86.lst</B> и "приплюсуйте" ее в строчку
<B>XkbSymbols</B>. Например,

<PRE>
XkbSymbols	"en_US(pc101)+ru+group(shift_toggle)+ctrl(ctrl_ac)"
</PRE>

<hr>
<p>Иван Паскаль <a href=mailto:pascal@tsu.ru> pascal@tsu.ru </a>

</BODY>
</HTML>
