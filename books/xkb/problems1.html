<HTML>
<HEAD>
 <TITLE>Почему руссификация через XKB не работает? (часть вторая)</TITLE>
</HEAD>

<BODY BGCOLOR="#FFFFFF">

<H3><a name="What-programs"> Что делать с "неправильными" программами?</a></H2>


<P> Вообще-то, первый ответ - узнайте - не решены ли эти проблемы в последней
версии данной программы. Возможно "бороться" уже не надо. И только если
проблемы остались, то ...

<P> Прежде чем пытаться давать какие-то рецепты, я хотел бы поделить все
"неправильные" программы на несколько категорий.

<Ul>
  <li> <a href="problems1.html#prog-src"> Программы "в исходниках".</a>
  <li> <a href="problems1.html#prog-multi"> Мультиязыковые программы.</a>
  <li> <a href="problems1.html#prog-bin"> Программы "в бинарниках".</a>
</UL>

  <H4><A NAME="prog-src">Программы в "исходниках".</A></H4>

<P>
  Если программы доступны в "исходниках", то их можно исправить.
Обычно для этого достаточно вставить вызов <B>setlocale()</B>
где нибудь в самом начале программы (и уговорить авторов или
maintainer'ов - включить этот вызов в официальный дистрибутив).

<P>
  Не забудьте при этом о "иксовой заглушке" <B>setlocale()</B>.
<BR>Если у вас <B>Xlib</B> собрана с <B>X_LOCALE</B>, то ...
<UL>
<LI>  Самое правильное - "выкинуть" ваши "иксы" и поставить "нормальные".
<LI>  Если же этого сделать нельзя, то и программы "лечить" с помощью "иксовой"
<B>setlocale()</B> (что для этого нужно делать - я уже написал).
</UL>

<P> Надо также отметить, что не всегда для "лечения" требуется именно
<B>setlocale(...)</B>. В некоторых библиотеках-"тулкитах" (toolkits) существуют
свои функции, которые выполняют те же действия. В конечном счете они вызывают
ту же <B>setlocale()</B>, но могут выполнять и какие-то дополнительные
настройки, необходимые для работы остальных подпрограмм своего "тулкита".

<P> Естественно, программы использующие эти "тулкиты" лучше исправлять
с помощью "родной" подпрограммы настройки locale.

<P> Например. Своя собственная процедура для установки locale в приложении
имеется в библиотеке <B>Xt</B>, которая работает "поверх" <B>Xlib</B>
и, в свою очередь, является основой для популярных "тулкитов" <B>Xaw*</B>
и <B>Motif</B> (<B>lesstif</B>).

<P> Поэтому, как сказано в документации Андрея Чернова
(<A HREF="http://nagual.pp.ru/~ache/koi8.html">о "коификации" всего
и вся</A>):

<P>
  Если программа использует один из перечисленных "тулкитов"
(<B>Xt, Xaw*, Motif/lesstif</B>), то для ее исправления лучше вставить
вызов процедуры <b>XtSetLanguageProc</b>, например в таком виде
<pre>
XtSetLanguageProc(NULL, NULL, NULL);
</pre>

<P> Также своя процедура имеется и в библиотеке <b>GTK</b> -
<b>gtk_set_locale()</b> (без аргументов). Хотя она делает практически то же,
что и обычная <B>setlocale(...)</B>, но по крайней мере еще и выдает
разнообразную диагностику, "если что не так".

<P> Еще одна проблема, на которую надо обратить внимание при "исправлении"
программ - шрифты (fonts). В некоторых программах могут оказаться "вшитыми"
названия шрифтов, которыми эта программа должна отображать вводимые символы.

<P> К сожалению, никаких общих рекомендаций для этого случая я дать не могу.
Замечу только, что ...
<ul>
 <li> если русские буквы "вводятся, но не так" (то есть, вместо русских букв
печатаются какие-то "западноевропейские")
 <li> и ни в каких настройках (конфигурационных файлах) исправить "фонт" не
удается
 <li> то имеет смысл поискать в "исходниках" - не прописаны ли там полные
названия "фонтов".
</ul>

<P> И наконец, особые проблемы могут возникнуть с "мультиязыковыми"
программами ...

  <H4><A NAME="prog-multi">Мультиязыковые программы.</A></H4>

<P> Это программы, которые пытаются обеспечить ввод на нескольких
языках и, соответственно, ввод символов из нескольких "несовместимых"
алфавитов (западноевропейского, русского, греческого и т.п.). Обычно,
это - разнообразные редакторы и "текстпроцессоры" (Lyx, emacs и т.п.)

<P> Как я уже говорил, процедуры Xlib, ответственные за перевод кодов
клавиш в однобайтные символы (<b>XLookupString, XmbLookupString</b>),
"на выходе" дают только те символы, которые являются "допустимыми" в
текущей locale. То есть, если текущая locale - русская, то будут
преобразовываться в байтовые коды только русские буквы, а, например,
греческие или "западноевропейские" - будут подавляться. И наоборот,
при греческой locale, эти процедуры будут подавлять ввод руссих букв. 

<P> Поэтому, многоязыковые программы просто игнорируют однобайтные
коды, которые им возвращают процедуры <b>X*LookupString</b>, а используют
двубайтные коды клавиш (symbols в терминах XKB) и интерпретируют
непосредственно их в меру своего понимания.

<P> К сожалению, далеко не все из этих программ правильно понимаю - что
делать с кодами типа Cyrillic_*.

<P> Естественно, "лечить" эти программы с помощью <B>setlocale()</B>
бесполезно. Во-первых, большинство из них и так уже используют этот
вызов. А во-вторых, установка locale повлияет только на то - какие
символы будут подавляться при преобразовании, а какие - нет.
Как я уже сказал, многоязыковые программы это как-раз и не интересует.

<P> К сожалению, общих рецептов и в этом случае нет. Но, с другой стороны,
некоторые из таких и программ и не надо "патчить". Им можно объяснить,
что "Cyrillic коды" - это обычные "буквенные" коды, с помощью их же файлов
конфигурации.

<P> Некоторые решения можно найти ...
<ul>
 <li> "Лечение" xemacs можно найти на сайте Алексея Выскубова -
<a href=http://woe.transas.com/penguin/emacs.zip> emacs.zip </a>.
 <li> То же самое для Lyx (и некоторых других программ) на сайте
<a href=http://liposome.genebee.msu.su/~oldcat/> "Пингвин при галстуке" </a>.
</ul>

<P>
  Кстати, исправления для популярного "тулкита" <B>Tcl/Tk</B> можно найти
на сайте Виктора Вагнера -
<A HREF="http://www.ice.ru/~vitus/tcl/locale-tcl.html">
http://www.ice.ru/~vitus/tcl/locale-tcl.html</A>.

  <H4><A NAME="prog-bin">Программы в "бинарниках".</A></H4>

<P>
  Что делать, если программы имеются только в "бинарниках"?

<P> К сожалению - это самый трудный случай. Конечно, речь идет не о тех
программах, исходные коды которых доступны, но почему-то отсутствуют у вас.
Хуже всего то, что программы, распространяемые только в "бинарном" виде,
зачастую еще и "статически слинкованы". То есть, они используют свою
библиотеку Xlib "встроенную" в само приложение, а не ту, что в вашей системе.
Поэтому, изменить "поведение" такой программы внешними настройками
(о некоторых из них я расскажу позже), часто бывает просто невозможно.

<P>
  В этом случае, самое правильное - попробовать уговорить авторов на
соответствующую правку.

<P>
  Но в некоторых случаях может помочь один из "хакерских" способов ...


  <H3><A NAME="hack"> Методы "грубого хака".</A></H3>

  <H4><A NAME="hack1">Первый метод - самый плохой.</A></H4>

<P>
  Можно "откатиться" к методам, которые использует <B>xmodmap</B>.

<P>
  Для этого в раскладке клавиатуры Cyrillic коды надо заменить на однобайтные
коды <B>koi8-r</B> (раскладку можно взять <A HREF="ru-koi-2gr">здесь</A>).
При этом "неправильные" программы начнут их воспринимать, принимая за
"западноевропейские" символы.

<P>
  А чтобы "правильные" программы их не "давили", нужно "испортить" <B>XLC_LOCALE</B>
для <B>koi8</B>. Для этого достаточно "закомментарить" (или вообще выкинуть)
строчку с <B>encoding_name</B> в файле <B>koi8-r/XLC_LOCALE</B>.

<P> Этот метод будет работать почти со всеми приложениями. Даже со "статически
слинкованными бинарниками". Хотя могут возникнуть проблемы с некоторыми
мультиязыковыми программами. Но он же, как я уже сказал - самый плохой.
По сути, это "возврат к старому". Ради нескольких старых "глупых" программ,
придется обманывать все новые "правильные" программы.

  <H4><A NAME="hack2"> Второй метод - намного лучше.</A></H4>

<P> Идея этого метода принадлежит Александру Канавину (хотя реализовал он
его немного по-другому).

<P>
  Поскольку "неправильные" программы, забывая установить нужную locale,
используют locale <B>"C"</B>, можно им вместо <B>C</B> "подсунуть" русскую
locale, например - <B>ru_RU.KOI8-R</B>.

<P>
  Для этого достаточно в файле "алиасов локалей"
(<B>X11R6/lib/X11/locale/locale.alias</B>) добавить строчку
<pre>
C                        ru_RU.KOI8-R
</pre>

<P>
  Таким образом, "правильные" программы будут пользоваться правильной
locale - <B>KOI8-R</B>, а "неправильные" вместо <B>C</B> получат ту же
<B>KOI8-R</B>.

<P> К сожалению, и этот способ неидеальный.
<UL>
<LI> Во-первых, это "локальный хак" (для территорий с преобладанием
"русскопишущего" населения :-). Поэтому, он не имеют никаких шансов войти
в официальные дистрибутивы XFree. И следовательно, эти действия придется
повторять каждый раз при установке новой версии "иксов".
<LI> Во-вторых, он может и "не сработать" для программ "статически
слинкованных".
<LI> Ну и наконец, тем самым вы "испортите" locale "C", и если какой-то
из программ требуется именно она, то ... будет плохо. (Я слабо представляю -
кому нужна именно такая "локаль", но - кто его знает.)
</UL>

  <H4><A NAME="hack3">Третий способ - самый правильный.</A></H4>

<P>
  Еще один способ описан в <A HREF="example2.html">"Примеры: Новая 'старая' раскладка"</A>.
<BR>В нем вводятся две русские раскладки - одна для "неправильных" программ,
другая - для "правильных".

<P> <a href="ru-koi-3gr">Эту раскладку</a> можно положить в
<b>X11R6/lib/X11/xkb/symbols</b>, переименовав ее в <b>ru</b> (или подправить
название русской раскладки в других файлах конфигурации <b>XKB</b>).

<P> Тогда клавиша "переключатель групп" будет циклически перебирать три группы,
что конечно же не очень-то удобно в работе. Чтобы "облегчить жизнь", можно
воспользоваться моим индикатором-переключателем клавиатуры
<a href=http://www.tsu.ru/~pascal/other/xxkb/>xxkb </a>.
(Для работы с тремя раскладками надо немного изменить настройки <b>xxkb</b>.
Об этом подробно написано в соответствующей
<a href=http://www.tsu.ru/~pascal/other/xxkb/3gr.html> инструкции </a>.)

<P> Как я уже заметил, этот способ - самый правильный. "Правильные" программы
будут работать с "правильной" раскладкой (если вы настроите <b>xxkb</b>,
то эта раскладка будет включаться "по умолчанию"), а для "неправильных"
программ вам придется при старте такой программы выбрать "неправильную"
раскладку. В этом есть, конечно, некоторые неудобства, но <b>xxkb</b>
сведет их к минимуму.

<hr>
<p>Иван Паскаль <a href=mailto:pascal@tsu.ru> pascal@tsu.ru </a>

</BODY>
</HTML>
