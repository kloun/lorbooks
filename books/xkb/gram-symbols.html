<HTML>
<HEAD>
 <TITLE>Файл типа xkb_symbols.</TITLE>
</HEAD>

<BODY BGCOLOR="#FFFFFF">

   <H2>Файл типа xkb_symbols.</H2>

<P>
   В этих файлах собственно и описыватся "раскладка клавиатуры". То есть,
для каждой физической клавиши (скан-кода) задается набор всех возможных
символов, которые будут выдаваться  в зависимости от текущего "состояния
клавиатуры" (номера группы и состояния модификаторов).

<P>
  Напомню, что с каждой клавишей связана двумерная таблица символов (<B>symbols</B>).
Эта таблица делится на группы (<B>group</B>), выбор конкретной группы зависит от
текущего номера группы в "состоянии клавиатуры". Каждая группа, в свою очередь
делится на уровни (<B>shift level</B>), выбор уровня зависит от типа клавиши (<B>type</B>)
и состояния модификаторов.

<P>
  Надо заметить, что разные клавиши могут иметь разное количество групп,
и разные группы одной клавиши могут иметь разное количество уровней.

<P>
  Также, с некоторыми клавишами может быть связана аналогичная двумерная
таблица "действий" (<B>actions</B>). Хотя обычно, действия "привязывают" не к
скан-кодам в файлах <B>xkb_symbols</B>, а к соответствующим символам в файлах
типа <B>xkb_compat</B>.

<P>
  Прежде чем рассматривать грамматику файла <B>xkb_symbols</B>, рассмотрим -
какие еще данные могут быть связанны со скан-кодами, кроме таблиц символов
и "действий". Как правило, для всех этих данных есть значения по умолчанию,
поэтому, обычно они в файлах <B>xkb_symbols</B> явно не указываются. Но, если
есть необходимость, их можно также явно задать в файлах этого типа.

<P>
  Итак. С каждым скан-кодом связаны
<UL>
<LI> <B>тип клавиши</B> - типы описываются в файлах <B>xkb_types</B> и определяют зависимость
уровня от состояния модификаторов. Каждая группа одно и той же клавиши
может иметь разный тип.
<LI> <B>"метод выравнивания" номера группы</B> - напомню, что некоторые клавши могут
иметь меньшее количество групп, чем все остальные. Поэтому, при нажатии
такой клавиши может оказаться, что номер группы в "состоянии клавиатуры"
выходит за границы, допустимые для данной клавши. В этом случае он
"выравнивается" до приемлимого значения. "Методы выравнивания" для отдельных
клавиш такие же, как и глобальные (см.
<A HREF="internals.html#wrap">"Внутренности...":Метод Выравнивания</A>)
<LI> <B>автоповтор (autorepeat)</B> - логический "флаг", который определяет - нужен ли
автоповтор для данной клавиши.
<LI> <B>"поведение" клавиши (behavior)</B> - набор флагов и дополнительный аргумент,
которые определяют...
<UL>
  <LI> <B>"залипание" (locking)</B> - если клавиша "залипающая", то при первом
нажатии/отжатии выдается только сообщение о нажатии клавиши, а при повторном
нажатии/отжатии - только сообщение об отжатии клавиши.
  <LI> <B>"радио-группа"</B> - клавиша принадлежит к радио-группе клавиши,
дополнительный аргумент определяет номер этой радио-группы. Напомню, что
клавши одной радио-группы являются взаимозависимыми. То есть, при нажатии
одной из клавиш группы, она "залипает", а остальные клавиши этой группы
"отжимаются".
  <LI> <B>допускается "отжатие всех" (allow none)</B> - имеет смысл для клавиш
радио-группы. если этот флаг установлен, то повторное нажатие на клавшу -
члена радио-группы, она "отжимается". При этом все члены группы могут
находиться в отжатом состоянии. Если же этот флаг не стоит, то для отжатия
клавиши надо нажать любую другую из той же группы. При этом в группе одна из
клавиш остается нажатой.
  <LI> <B>перекрытие 1</B> - указывает, что клавиша относится к группе "перекрывающихся"
клавиш (<B>overlay</B>). Если в состоянии клавиатуры установлен "управляющий флаг"
<B>Overlay1</B>, то эта клавиша должна "отослать" XKB к другому скан-коду, который
задан дополнительным аргументом.
  <LI> <B>перекрытие 2</B> - то же самое, что и предыдущий, только эти клавиши зависят
от "управляющего флага" <B>Overlay2</B>.
  <LI> <B>permanent</B> - может комбинироваться с другими флагами и означает, что
соответствующая функция выполняется "железом" клавиатуры и нет необходимости
эмулировать её в XKB программно.
</UL>

<LI> <B>виртуальный модификатор</B> (или несколько модификаторов) - этот модификатор
может использоваться в качестве аргумента для "действия", если с клавишей
связаны какие-нибудь "действия". Надо заметить, что, как правило, виртуальные
модификатооры "назначаются" не в файлах <B>xkb_symbols</B>, а, как и "действия", в
файлах <B>xkb_compat</B>.
<LI> <B>"набор исключений"</B> - запрещает выполнении "интепретаций" - изменения
привязки "действий" при изменении привязки символов к скан-кодам. Можно
запретить выполнение всех действий "интерпретации" для данной клавиши
или только отдельных ее шагов -  перенос виртуального модификатора,
перенос "автоповтора", перенос "залипания".
<LI> и, наконец, в отдельной таблице может быть задана "привязка" реальных
модификаторов к скан-кодам. Если с клавишей связан реальный модификатор,
то, при нажатии клавиши, автоматически меняется состояние соответствующего
модификатора в наборе "традиционных модификаторов", который эмулируется XKB
для старых клиентских программ, "не знающих об XKB". Кроме того, "привязка"
реальных модификаторов может использоваться при выполнении "интерпретаций"
(<B>interpretation</B>).
</UL>

  <H3><A NAME="decl">Объявления в файле xkb_symbols.</A></H3>

<P>
  В файлах этого типа могут встретиться
<UL>
	<LI><A HREF="gram-symbols.html#vmodDec">Объявление виртуальных модификаторов.</A>
	<LI><A HREF="gram-symbols.html#name">Объявление имени группы.</A>
	<LI><A HREF="gram-symbols.html#key">Описание клавиши.</A>
	<LI><A HREF="gram-symbols.html#modmap">Объявление "привязки" реальных модификаторов.</A>
	<LI><A HREF="gram-symbols.html#defaults">Объявление "умолчаний".</A>
</UL>

    <H3><A NAME="vmodDec">Объявление виртуальных модификаторов.</A></H3>

<P>
  Просто перечисляет названия виртуальных модификаторов, которые могут
встретиться в описаниях "действий" и в качестве модификатора "привязанного"
к клавише.

<P>
  Имеет вид
<PRE>
'virtual_vodifiers' список_модификаторов ';'
</PRE>

<P>
  Надо заметить, что обычно ни действия, ни связанные с клавишей виртуальные
модификаторы, не "привязываются" непосредственно к скан-кодам. Как правило,
они описываются в файле <B>xkb_compat</B>, как часть "интерпретаций". Поэтому,
это обявление, обычно, в файлах <B>xkb_symbols</B> не встречается.

  <H3><A NAME="name">Объявление имени группы.</A></H3>

<P>
  Задает символическое имя для группы. Это имя может потом использоваться
прикладными программами, которые рисуют изображение клавиатуры или показывают
"состояние клавиатуры". Для самого XKB эти имена значаения не имеют.

<P>
   Это объявление имеет вид
<PRE>
'name[' название_группы ']=' имя_группы  ';'
</PRE>
  Например,
<PRE>
name[Group1] = "English" ;
name[Group2] = "Russian" ;
</PRE>

  <H3><A NAME="key">Описание клавиши.</A></H3>

<P>
  Это основное обявление в файлах этого типа. Именно оно описывает таблицу
символов (и, если надо, "действий") связанных со скан-кодом.

<P>
  Имеет вид
<PRE>
'key' имя_скан-кода '{' описания  '};'
</PRE>
  Напомню, что "имя_скан-кода" описывается в файлах типа <B>xkb_keycodes</B>
и представляет собой произвольную строчку символов (но длиной не более
четырех), ограниченную "угловыми скобками".
<BR>  Например,

<PRE>
key &lt;LCTL&gt; {...};
</PRE>

<P>
  "Описания" внутри фигурных скобок разделяются запятой. Обратите внимание,
что именно "запятой", а не "точкой с запятой", как это делается в файлах
других типов.

<P>
  Итак, внутри скобок могут быть строчки типа

<UL>
	<LI><A HREF="gram-symbols.html#type">type = ...,  или type = ...,</A>
	<LI><A HREF="gram-symbols.html#locks">locks = ...,</A> (синоним - <B>locking</B>)
	<LI><A HREF="gram-symbols.html#repeat">repeat = ...,</A> (синонимы - <B>repeats, repeating</B>)
	<LI><A HREF="gram-symbols.html#wrap">groupswrap, или warpgroups,</A>
	<LI><A HREF="gram-symbols.html#wrap">groupsclanp, или clampgroups,</A>
	<LI><A HREF="gram-symbols.html#wrap">groupsredirect = ..., или redirectgroups = ...,</A>
	<LI><A HREF="gram-symbols.html#radiogroup">radiogroup = ...,</A>
	<LI><A HREF="gram-symbols.html#radiogroup">allownone = ...,</A>
	<LI><A HREF="gram-symbols.html#overlay">overlay1 = ..., или overlay2 = ...,</A>
	<LI><A HREF="gram-symbols.html#permanent">permanent...</A>
	<LI><A HREF="gram-symbols.html#vmods">vmods = ...,</A> (синонимы - <B>virtualmods, virtualmodifiers</B>)
	<LI><A HREF="gram-symbols.html#symbols">symbols[...] = ...,</A>
	<LI><A HREF="gram-symbols.html#actions">actions[...] = ...,</A>
	<LI><A HREF="gram-symbols.html#brackets">просто [...]</A>
</UL>

   <H4><A NAME="type">type</A></H4>

<P>
  Определяет тип клавиши. Справа от присваивания должно стоять название
одного из типов, определенных в файле <B>xkb_types</B>.

<P>
  Обратите внимание, поскольку разные группы могут иметь разные типы
(напомню, что тип определяет количество уровней в группе), то это описание
в общем случае должно иметь вид

<PRE>
type[ номер_группы ] = название_типа,
</PRE>
например,
<PRE>
type[ Group1 ] = "ONE_LEVEL",
type[ Group2 ] = "ALPHABETIC",
</PRE>

<P>
  Но, если все группы имеют одинаковое количество уровней и относятся
к одному типу, то указание группы (вместе с квадратными скобками) можно
пропустить. Например,

<PRE>
type = "ALPHABETIC",
</PRE>

<P>
  Надо заметить, что для всех клавиш, внутри XKB имется значения типа
"по умолчанию". Поэтому, как правило, тип клавиши (группы) не указывется.

  <H4><A NAME="locks">locks</A></H4>

<P>
  Логический флаг, который указывает на то, что клавиша должна быть
"залипающей".

<P>
  Справа от присваивания могут стоять слова - <B>true, yes, on</B> ("поднять" флаг)
или - <B>false, no, off</B> ("сбросить" флаг). Кроме того, там же может встретиться
слово <B>permanent</B>. В этом случае подразумевается, что клавиша "залипающая",
но ее "залипание" делается "железом" клавиатуры (в общем-то, это означает,
что самому XKB об этой клавише заботиться не надо).

<P>
 По умолчанию все клавише не "залипающие".

  <H4><A NAME="repeat">repeat</A></H4>

<P>
  Логический флаг, который определяет - нужен ли "автоповтор" для данной
клавиши. Так же, как и для флага <B>locks</B>, справа от присваивания могут быть
слова  - <B>true, yes, on</B> (нужен автоповтор) или - <B>false, no, off</B> (автоповтор
не нужен).

<P>
  Кроме того, там же может стоять слово <B>default</B>. Дело в том, что автоповтор,
обычно, выполняет само "железо" клавиатуры. Поэтому, XKB не надо заботиться
о повторении нажатия клавши. Чаще всего, ему приходится наоборот - "подавлять"
автоповтор для некоторых клавиш. Так вот, значение "<B>default</B>" означает, что
автоповтор надо "оставить на совести" "железа" и не пытаться что-либо менять.

<P>
  По умолчанию большинство клавиш отрабатывают автоповтор и значения <B>repeat</B>
для них - <B>default</B>. А для клавиш-модификаторов - <B>Control, Shift, Alt, CapsLock,
NumLock</B> и т.п., автоповтор подавляется, и <B>repeat</B> для них - <B>false</B>.

  <H4><A NAME="wrap">groupswrap, groupsclanp, groupsredirect</A></H4>

<P>
  Определяют "метод выравнивания" номера группы (подробности см. в
<A HREF="internals.html#wrap">"Внутренности":Метод выравнивания</A>).
 Естественно, имеет смысл в описании
клавиши указывать только один из них.

<P>
  Объявления <B>groupswrap</B> и <B>groupsclamp</B> являются просто логическими переменными.
Поэтому они задаются либо в виде присваивания, где в правой части могут быть
только слова <B>True</B> или <B>False</B>, либо в виде
<BR><B>groupswrap,</B> - подразумевается "<B>= True</B>"
<BR>или
<BR><B>!groupswrap,</B> - подразумевается "<B>= False</B>"

<P>
  А вот метод <B>groupsredirect</B> подразумевает дополнительный аргумент -
"куда redirect". Поэтому всегда имеет вид присваивания, где в правой части
должен стоять номер группы. Например,
<PRE>
groupsredirect = 1,
</PRE>
  По умолчанию для всех клавиш метод выравнивания - <B>Wrap</B>.

  <H4><A NAME="radiogroup">radiogroup и allownone</A></H4>

<P>
  Означает, что данная клавиша является членом радио-группы. Справа от
знака присваивания должен быть номер группы.

<P>
  Номер группы может быть произвольный, в пределах 2-128 (обратите
внимание, что нельзя сделать радио-группу номер 1, хотя это скорее всего
"баг" в реализации XKB).

<P>
  <B>Allownone</B> устанавливает соответствующий флаг для этой радио-группы и
является просто логической переменной.

<P>
  По умолчанию никаких радио-групп нет. 

  <H4><A NAME="overlay">overlay1  или overlay2</A></H4>

<P>
  Означает, что данная клавиша принадлежит к одной из двух групп
"перекрытий". Напомню, что когда режим "перекрытия" активен (установлен
соответствующий "управляющий флаг" в состоянии клавиатуры), такая клавиша
эмулирут нажатие клавиши с другим скан-кодом. Поэтому, справа от знака
присваивания должно быть "название скан-кода" клавиши, нажатие которой
эмулируется. Это название имеет такой же вид, как и в заголовке описания
клавиши и должно быть определено в файле типа <B>xkb_keycodes</B>.
<BR>  Например,
<PRE>
overlay1 = &lt;XY01&gt;,
</PRE>
  По умолчанию никаих "групп перекрытий" нет.

  <H4><A NAME="permanent">permanent...</A></H4>

<P>

  Это не отдельное слово, а префикс, который может соединяться со словами
<B>radiogroup, overlay1, overlay2.</B> Например,
<PRE>
permanentradiogroup = ...,
permanentoverlay1 = ...,
permanentoverlay2 = ...,
</PRE>

<P>
  Означает, что данная функция и так отрабатывается "железом" и XKB не
надо об этом заботиться.

   <H4><A NAME="vmods">vmods</A></H4>

<P>
  Задает список виртуальных модификаторов, связанных с этой клавишей.
Справа от знака присваивания должно быть название модификатора (или
нескольких модификаторов через знак '+').

<P>
  Напомню, что обычно виртуальные модификаторы "привязываются" не здесь,
а в файлах <B>xkb_compat</B>.

   <H4><A NAME="symbols">symbols</A></H4>

<P>
  Основная часть описания. Задает набор символов для клавиши. Одно такое
объявление задает набор символов для одной группы. Поэтому, в левой
части, в квадратных скобках указывается название группы, а в правой части,
опять же в квадратных скобках - список символов для всех уровней этой группы
(через запятую).
<BR>  Например,
<PRE>
symbols[Group1] = [   semicolon, colon       ],
symbols[Group1] = [Cyrillic_zhe, Cyrillic_ZHE],
</PRE>

  В качестве "символов" могут быть числовые значения кодов (десятичные,
восьмеричные, шестнадцатеричные) или специальные "названия символов".

<P>
  Названия символов можно найти в файле <B>X11R6/include/X11/keysymdefs.h</B>.
Только там они еще имеют префикс "<B>XK_</B>". То есть, если в это файле есть,
например, определения

<PRE>
#define XK_Escape 0xFF1B
#define XK_Delete 0xFFFF
....
</PRE>
это означает, что в файле типа <B>xkb_symbols</B> можно использовать слова
<B>Escape</B> и <B>Delete</B> в качестве "названий символов".

<P>
  Надо заметить, что если в качестве символа указаны числа 0 - 9, то они
интерпретируются как коды символов '<B>0</B>' - '<B>9</B>', а не как числовой код символа.

<P>
  Если для какого-то уровня в группе символ не нужен (не определен), можно
использовать специальное "название символа" - <B>NoSymbol</B>.

   <H4><A NAME="actions">actions</A></H4>

<P>
  Аналогично предыдущему объявлению, только задает не список символов, а список
"действий" для данной клавиши. Имеет такой же вид как объявление <B>symbols</B>,
только вместо "имен символов" должны быть описания "действий". Немного
подробнее об этих описаниях смотри <A HREF="gram-action.html">"Описание действий"</A>.

<P>
  Здесь замечу только, что если какой-то уровень не имеет соответствующего
"действия", можно использовать специальное название - <B>NoAction()</B>.

<H4><A NAME="brackets">просто [...]</A></H4>

<P>
  Чаще всего, описание клавиши состоит из списков символов, заключенных
в квадратные скобки без всякого указания типа - "<B>symbols[...] =</B>".
Поскольку обычно для клавиши задается только набор символов, можно использовать
сокращенную форму описания.
<BR>  Например, описание
<PRE>
key &lt;AE03&gt; { [   3,      numbersign ], [  apostrophe,  3 ] };
</PRE>

полностью эквивалентно описанию

<PRE>
key &lt;AE03&gt; {
   symbols[Group1]= [               3,      numbersign ],
   symbols[Group2]= [      apostrophe,               3 ]
};
</PRE>

<P>
  То есть, первая пара квадратных скобок (с неким содержимым внутри)
интерпретируется как описание <B>symbols</B> для первой группы, втора пара скобок -
как описание <B>symbols</B> для второй группы и т.д.

  <H4><A NAME="explicit">"Набор исключений".</A></H4>

<P>
  Напомню, что с каждой клавишей может быть связан набор исключений, который
запрещает изменять "привязку" "действий", флагов "залипания" и автоповтора
и набора виртуальных модификаторов при выполнении "интерпретаций".

<P>
  Заметьте, что в описании клавиши нет явных инструкций для задания
"набора исключений". Но этот набор все-таки создается в некоторых случаях
<UL>
 <LI> если в описании клавши явно указан набор "действий" (инструкция <B>actions</B>),
то устанавливается запрет "выполнения интерпретации" для этой клавиши;
 <LI> если задан явно автоповтор (инструкция <B>repeat</B>) - запрещается "изменение
автоповтора";
 <LI> если задан явно флаг "залипания" или радио-группа (инструкции <B>locks</B> и
<B>radiogroup</B>) - запрещается "изменение залипания";
 <LI> и, наконец, если указан явно список виртуальных модификаторов
(инструкция <B>vmod</B>), то устанавливается "запрет изменения" набора модификаторов.
</UL>

  <H3><A NAME="modmap">Объявление "привязки" реальных модификаторов.</A></H3>

<P>
  Это объявление заполняет внутреннюю табицу XKB - <B>modmap</B>, которая "привязывает"
реальные модификаторы к клавишам (скан-кодам). Напомню, что эти модификаторы
будут автоматически устанавливаться/сбрасываться, при нажатии/отпускании
клавиши, в "эмулируемом наборе модификаторов".

<P>
  Объявление имеет вид
<PRE>
'modifier_map' имя_модификатора '{' список_клавиш '};'
</PRE>
  Вместо слова "<B>modifier_map</B>" могут использоваться синонимы - <B>modmap</B> или
<B>mod_map</B>.

<P>
  "<B>Имя_модификатора</B>" должно быть названием одного из реальных модификаторов -
<B>Shift, Lock, Control, Mod1, Mod2, Mod3, Mod4, Mod5</B>.

<P>
  А вот "<B>список_клавиш</B>" может состоять из названий скан-кодов (через запятую),
например,
<PRE>
modifier_map Control { &lt;LCTL&gt;, &lt;RCTL&gt; };
</PRE>

или из названий символов, например,

<PRE>
modifier_map Mod1 { Alt_L, Alt_R };
</PRE>

<P>
  Во втором случае, XKB (точнее - <B>xkbcomp</B>) должен найти скан-коды, к которым
"привязаны" эти символы и занести в <B>modmap</B> эти скан-коды.

<P>
  Обратите внимание, один и тот же модификатор может быть "привязан" ко многим
скан-кодам, но не наоборот - разные модификаторы к одному скан-коду.
Это означает, что название скан-кода может появиться в определениях <B>modmap</B>
только один раз. Это же ограниичение действует, если клавиши предствлены не
скан-кодами, а символами.

<P>
  Однако, как ни странно, <B>xkbcomp</B> не проверяет ситуацию, когда одна и та же
клавиша представлена один раз скан-кодом, а другой - символом, или разными
символами "привязанными" к одному скан-коду. В этом случае может получиться
ситуация, когда к одному скан-коду "привязаны" несколько реальных
модификаторов.

  <H3><A NAME="defaults">Объявление "умолчаний".</A></H3>

<P>
  Это объявление задает значение "по умолчанию" для некоторых аттрибутов
клавиш и выглядит как присвоение значения "полю структуры" в языке C.
<BR>  Например,
<PRE>
key.repeat = no;
</PRE>

<P>
  При этом, в левой части присваивания первое слово (до точки) должно быть
слово "<B>key</B>", а второе - любое из допустимых в описании клавиши (<B>type, locks,
radiogroup</B> и т.п.).

<P>
  Естественно, это "умолчание" будет действовать, пока в тексте не встретится
другое объявление для того же аттрибута.

<P>
  Кроме того, объявление "умолчаний" может спользоваться для "умолчаний"
в описании "действий" (подробнее см. <A HREF="gram-action.html">"Описание действий"</A>).
В этом случае первое слово будет названием "действия", например,

<PRE>
SetMods.clearLocks = True;
</PRE>

<P>
  И, наконец, к объявлениям "умолчания" можно отнести инструкцию, которая
устанавливает флаг "<B>допускается отжатие всех</B>" (<B>allownone</B>) для радио-групп.

<P>
  Напомню, что этот флаг можно указать непосредственно в описании клавиши,
относящейся к радио-группе. Но, поскольку радио-группа "размазана" по
нескольким клавишам, а флаг <B>allownone</B> является аттрибутом радио-группы,
а не конкретной клавиши, можно указать флаг для нее отдельной инструкцией
(не внутри описании какой-либо клавиши). Например,

<PRE>
allownone = 10;
</PRE>

означает, что для радио-группы 10 устанавливается соответствующий флаг.

<hr>
<p>Иван Паскаль <a href=mailto:pascal@tsu.ru> pascal@tsu.ru </a>
</BODY>
</HTML>
