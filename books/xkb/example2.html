<HTML>
<HEAD>
 <TITLE>Добавляем новую "старую" раскладку клавиатуры.</TITLE>
</HEAD>

<BODY BGCOLOR="#FFFFFF">

    <H2>Добавляем новую "старую" раскладку клавиатуры.</H2>



<P>
   Рассмотрим - как добавить еще одну группу с другой расскладкой клавиатуры.

<P>
   Зачем это может понадобится?

<P>
   Ну, например, проблема (описанная в <A HREF="problems.html">"Почему руссификация не работает?"</A>)
 - у вас есть программы,
в "бинарниках", статически слинкованные, которые напрочь отказываются понимать
коды типа <B>Cyrillic_*</B>. Можно специально для них изготовить раскладку, в которой
будут не двубайтные коды русских букв, а однобайтные коды <B>KOI8-R</B>.

<P>
  Возможно, вам захочется добавить раскладку в кодировке <B>cp1251</B> или еще
какой-нибудь, которая отличается от стандартной расположением русских букв.


<P>
(Надо заметить, что этот путь (добавление новой кодировки русских букв с
помощью дополнительной группы) - в общем-то, плохое решение. Тем более,
если вы не используете новую locale. Правильно было бы - добавить
соответствующую таблицу перекодировки в Xlib и изготовить подходящую "иксовую"
locale.
 <BR> Но, как я уже сказал, я не предлагаю правильные решения :-), а только
привожу примеры - как это можно сделать.)


<P>
  Итак, давайте в этом примере сосредоточимся на задаче - добавление
"однобайтной <B>koi8-r</B> кодировки" для "старых" или "тупых" клиентских программ.

<P>
  Прежде всего, надо заметить, что у вас должны быть задействованы уже
две группы. Первая - "латиница", вторая - "кириллица" с "правильными" кодами
для русских букв (<B>Cyrillic_*</B>).

<P>
  Новую группу надо добавлять не "в конец" (как третью), а "в середину" -
так чтобы она была второй, а "правильная" кириллица - третьей.

<P>
  Почему? Потому, что "традиционные" программы (со старой Xlib) понимают
только первую и вторую группу. Причем, вторую выбирают тогда, когда установлен
модификатор, соответствующий символу <B>Mode_switch</B>. Ну, об установке модификатора
позаботится "таблица" совместимости XKB. Если она у вас стандартная, то
соответствующий модификатор будет выставляться для всех групп, кроме первой
(то есть, в нашем случае и для "старой" кодировки и для "новой").

<P>
  А вот искать символы "старые" программы будут всегда только во второй группе
(об остальных они даже не подозревают). А "новые" программы, совместимые с XKB
и так найдут свою раскладку, будь она во второй, третей, или даже в четвертой
группе.


<P>
  Еще одно замечание. Естественно, добавлять новые символы мы будем в
<B>xkb_symbols</B>. При этом будет логично не писать ее "с нуля", а взять за основу
уже существующий файл <B>symbols/ru</B> и дополнить его. Если мы наш файл "приплюсуем"
к соответствующему описанию <B>xkb_symbols</B>, то у нас получится два фйла
описания одних и тех же клавиш, при этом второй полностью переписывает первый.

<P>
  Поэтому, логично, если мы из описания вообще выкинем "стандартный" файл "<B>ru</B>",
а оставим только свой.

<P>
  То есть соответствующая строчка в нашем "полном описании конфигурации"
будет выглядеть не как
<PRE>
xkb_symbols { include "en_US(105)+ru+new-ru" };
</PRE>
а немного короче
<PRE>
xkb_symbols { include "en_US(105)+new-ru" };
</PRE>


<P>
  Итак. Берем в свою директорию файл <B>symbols/ru</B> и начинаем его "корежить".
<BR>  Надо заметить, что, скорее всего в нем вы обнаружите три блока -
<PRE>
xkb_symbols "toggle" {...};
xkb_symbols "shift_toggle" {...};
xkb_symbols "basic" {...};
</PRE>


<P>
  Причем, реально расположение русских букв описывает только третий, а первые
два просто добавляют два разных способа преключения "рус/лат".

<P>
  Обычно, если у вас в полной конфигурации указан просто файл <B>ru</B>, загружается
первый блок. И переключателем "рус/лат" становится клавиша <B>CapsLock</B>.

<P>
  Во-первых, для нашей задачи это очень плохо (то, как описаны символы для
этой конопки). Но об этом поговорим немного <A HREF="example2.html#Lock">позже</A>.

<P>
  А сейчас я предлагаю просто выкинуть ("вычистить") два первых блока и
оставить только блок "<B>basic</B>". А переключатель допишем потом прямо в блок
"<B>basic</B>", или "приплюсуем" подходящий блок из файла <B>symbols/group</B> (в нем
описано аж шесть разных способов переключения).


<P>
  Итак. Выкинули два первых блока и начали исправлять/дополнять блок "<B>basic</B>".
 <BR> Нам нужно для каждой кнопки, которая в описаниях содержит символы <B>Cyrillic</B>,
дописать в середину (второй группой) еще одну группу с однобайтными символами
в кодировке <B>koi8</B>. Напомню, что символы можно задавать не только символическими
именами (типа <B>Cyrillic_*</B>), а просто цифровым кодом.
  Например, клавишу

<PRE>
key &lt;AB01&gt; {	[		z,		 Z	],
		[     Cyrillic_ya,     Cyrillic_YA	]	};

</PRE>
мы должны описать как

<PRE>
key &lt;AB01&gt; {	[		z,		 Z	],
		[            0xd1,            0xf1	],
		[     Cyrillic_ya,     Cyrillic_YA	]	};
</PRE>
  Естественно, первый код соответсвует маленькой букве, а второй - большой.


<P>
  Как подобрать коды? Ну, во-первых, по названию букв можно догадаться -
какую русскую букву они имеют ввиду и, если у вас есть под рукой табличка -
какой русской букве, какой код <B>koi8-r</B> соответствует, просто переписать оттуда.

<P>
  А во-вторых, могу подсказать, что младший байт кода <B>Cyrillic</B> на самом деле
соответствует коду этой буквы в <B>koi8</B>, а в старшем байте всегда шестерка.

<P>
  Поэтому, можно взять файл, в котором описываются числовые значения для
кодов типа <B>Cyrillic_*</B> - это файл <B>/usr/X11R6/include/X11/keysymdef.h</B>.
И списать соответствующие коды оттуда, отбрасывая первую шестерку.


<P>
  Особо ленивые могут взять готовый файл <A HREF="ru-koi-3gr">здесь</A>.


<P>
  Итак, мы составили новый файл описания клавиатуры, в котором теперь три
группы. Надо не забыть о переключателе меджу группами.

<P>
  Во-первых, надо заметить, что все варианты переключателей используют
для своих целей специальный символ - <B>ISO_Next_Group</B>, а его семантика,
описанная в <B>xkb_compat</B> такова, что он просто перебирает все возможные
группы. То есть, при нажатии клавиши (или комбинации клавиш) с таким
символом просто текущее значение группы увеличивается на единицу, а
когда счетчик доходит до последней группы, он просто возвращается на
первую (см. <A HREF="internals.html#wrap">"Внутренности":"Методы выравнивания номера группы"</A>).

<P>
  Таким образом тем же самым перключателем "рус/лат" мы можем последовательно
перебирать все три группы.


<P>
  Вы можете выбрать ваш любимый способ переключения из файла <B>symbols/group</B>
и "приплюсовать" его к описанию <B>xkb_symbols</B>, например,
<PRE>
xkb_symbols { include "en_US(105)+new_ru+group(shift_toggle)" };
</PRE>

<A NAME="Lock"></A>
<P>
  Только одно замечание о переключении клавишей <B>CapsLock</B>.
<BR>Дело в том, что традиционно на эту же клавишу "подвешивают" и символ <B>Caps_Lock</B>,
чтобы она могла выполнять и свою основную функцию (нажатая с Shift'ом).

<P>
  Проблема в том, что к этому символу присоединен реальный модификатор <B>Lock</B>.
При этом, в конечном счете, XKB привязывает реальные модификаторы не к символу,
а к скан-коду клавиши. Поэтому при нажатии этой клавиши в
"состоянии модификаторов" появится не только модификатор, который указывает
на то, что выбрана альтернативная группа, но и реальный модификатор <B>Lock</B>
(хотя вы нажимаете клавишу как <B>ISO_Next_Group</B>, а не как <B>Caps_Lock</B>).

<P>
  В результате, клиентская программа увидит, что вы не только выбрали
альтернативную группу, но "намертво" прижали <B>Shift</B> (хотя <B>Shift</B> должен
отменять действие <B>Lock</B>, но... почему-то не работает).
Естественно, при этом жми, не жми <B>Shift</B> - у вас всегда будут получаться
только маленькие (или только большие буквы).


<P>
  Для того, чтобы этого не происходило, надо бы "отцепить" реальный модификатор
<B>Lock</B> от этой клавиши. К сожалению, "привязка" модификатора к символу <B>Caps_Lock</B>
"зарыта" глубоко в файлах, которые "инклюдятся" в <B>en_US</B>. А отменить это
присвоение в дополнительных файлах уже нельзя.

<P>
  Поэтому, чтобы не "перелопачивать" все файлы, которые неявно включаются
в нашу полную конфигурацию, лучше просто убрать символ <B>Caps_Lock</B> из описания
клавиши <B>&lt;CAPS&gt;</B>.

<P>
  Если вам жалко расставаться с этой функцией - "подвесьте" ее на какую-нибудь
другую клавишу. А если вы используете для "рус/лат" другой способ - то и
описанной проблемы у вас не будет.


<P>
  Итак. Если ваш любимый способ переключения - клавиша <B>CapsLock</B>, то последнее,
что нам надо сделать - не "приплюсовывать" этот способ из файла <B>symbols/group</B>
(там эта клавиша с кодом <B>Caps_Lock</B>), а просто вписать в нашу новую раскладку
определение для клавиши <B>&lt;CAPS&gt;</B> -

<PRE>
key &lt;CAPS&gt; { [ISO_Next_Group] };
</PRE>


<P>
  Теперь можно прегрузить конфигурацию программой <B>xkbcomp</B> и посмотреть
результат.


<P>
  Кстати, забавно, что "старые" программы теперь работают когда у вас
включена и вторая группа и третья. Потому, что они в обоих случаях видят
в "состоянии модификаторов" модификатор, который указывает, что включена
альтернативная группа, а коды символов всегда берут из второй группы.
То есть, для них не заметна разница между двумя состояниями XKB (включена
вторая или третья группы).
<BR>  Интересно, что некоторые "новые" программы, например - xterm, тоже
правильно работают с обоими группами. Потому, что... фиг его знает - почему :-)


<P>
  Единственное неудобство - сложное переключение групп (особенно, если
вы не пользуетесь никаким индикаторами перключения групп). Очень непривычно,
когда переключатель "рус/лат" вдруг обретает не два, а три состояния.


<P>
  А вот о том, как сделать переключение между тремя (и больше) группами
более приятным, мы рассмотрим в следующем примере -

  <H3><A HREF="example3.html">"Вариации на тему" - переключатели "рус/лат" (и еще раз - "рус").</A></H3>


<hr>
<p>Иван Паскаль <a href=mailto:pascal@tsu.ru> pascal@tsu.ru </a>
</BODY>
</HTML>
