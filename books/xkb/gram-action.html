<HTML>
<HEAD>
 <TITLE> Описание "действий".</TITLE>
</HEAD>

<BODY BGCOLOR="#FFFFFF">


  <H2> Описание "действий".</H2>

<UL>
	<LI> "Действия" для -
<UL>
	<LI><A HREF="gram-action.html#group">Изменения номера группы.</A>
	<LI><A HREF="gram-action.html#mods">Изменения виртуальных модификаторов.</A>
	<LI><A HREF="gram-action.html#controls">Изменения управляющих флагов.</A>
</UL>
	<LI><A HREF="gram-action.html#actions">Как описываются "действия" в файлах настройки.</A>
	<LI><A HREF="gram-action.html#defaults">Объявление "умолчания".</A>
</UL>


<P>
  Описание "действий" (<B>actions</B>) используются в файлах типа <B>xkb_symbols</B>,
где они "привязываются" к скан-кодам клавиш, и в файлах типа <B>xkb_compat</B>,
где они "привязываются" к управляющим символам. (Напомню, что в <B>xkb_compat</B>,
описываются "интерпретации" - таблички, которые помогают менять привязку
"действия" к скан-кодам, когда прикладные программы меняют привязку
соответствующих "управляющих символов").

 
<P>
 В XKB определен большой набор возможных "действий" (функций). Поэтому,
описывать все действия здесь я не буду. Упомяну только, что с помощью
действий можно
<UL>
<LI> менять номера групп, наборы модификаторов и управляющие флаги
<LI> менять положение и состояние кнопок "указателя" ("мышки")
<LI> посылать сообщения программам
<LI> перключать виртуальные экраны X-сервера
<LI> и т.п.
</UL>


<P>
  Естественно, от типа "действия" зависит набор (и количество) аргументов
и возможные значения этих аргументов.

<P>
  Надо также заметить, что XKB отслеживает как нажатие, так и отпускание
клавиши. При этом "действие" может срабатывать только при нажатии или
только при отпускании клавиши. А может, также, выполнять различные действия
при нажатии и при отпускании (обычно - противоположные, см. <A HREF="gram-action.html#press-release">ниже</A>).


<P>
  Рассмотрим подробнее несколько "действий". Те, которые меняют модификаторы,
номера групп и "управляющие флаги" в "состоянии XKB".
<UL>
	<LI><A HREF="gram-action.html#group">Изменение номера группы.</A>
	<LI><A HREF="gram-action.html#mods">Изменение виртуальных модификаторов.</A>
	<LI><A HREF="gram-action.html#controls">Изменение управляющих флагов.</A>
</UL>

  <H3><A NAME="group">Изменение номера группы.</A></H3>

<P>
  Напомню, что номер группы "размазан" по трем переменным (<B>base, locked</B> и
<B>latched</B>). Поэтому для его измения используются три разных действия
<UL>
<LI><B>SetGroup</B> - меняет переменную <B>base group</B>
<LI><B>LockGroup</B> - меняет переменную <B>locked group</B>
<LI><B>LatchGroup</B> - меняет переменную <B>latched group</B>
</UL>


<P>
  Все эти действия имеют два аргумента
<UL>
<LI> номер группы (естественно)
<LI> набор флагов
</UL>


<P>
  Флаги для этих "действий"
<UL>
<LI> <B>groupAbsolute</B> - определяет, что аргумент "номер группы" задает абсолютное
значение, которое нужно занести в соответствующую переменную. В противном
случае в поле "номер группы" задана "добавка", которую нужно добавить или
вычесть из соответствующей переменной.
</UL>

<P>
  Заметьте, что этот флаг в описании "действий" явно не указывается.
Если необходимо задать относительное значение для "номера группы" оно
пишется со знаком (+ или -), абсолютное - без знака. Таким образом,
"номер группы" = 2, означает, что в соответствующую переменную надо
записать двойку, а "номер группы" = +2 означает, что к переменной
надо добавить двойку.

<UL>
<LI> <B>clearLock</B> - применяется в "действиях" <B>SetGroup</B> и <B>LatchGroup</B> и означает,
что попутно с этим действием надо "почистить" переменную <B>lock group</B>
(точнее установить в ней <B>group = 1</B>).

<LI> <B>latchToLock</B> - применяется только в <B>LatchGroup</B> и означает, что при
нажатии кнопки значение "номер группы" помещается в <B>latched group</B>
(точнее, это всегда делается при выполнении <B>LatchGroup</B>), а вот при
отпускании кнопки, перенсти значение из <B>latched group</B> в <B>locked group</B>.
</UL>

<A NAME="press-release"></A>
<P>
  Есть еще одна тонкость в поведении этих трех "действий". Как уже
говорилось, "действие" может по разному вести снебя при нажатии и
при отпускании кнопки.

<P>
  Так вот. <B>SetGroup</B> и <B>LatchGroup</B> при нажатии заносят в соответствующие
переменные номер группы (или добавляют/отнимают "добавку"), а при
отпускании - делают обратное действие, возвращают "все как было".

<P>
  И только <B>LockGroup</B> при отпускании "запоминает" значение в <B>locked
group</B>.

<P>
  Таким образом, изменения в <B>base group</B> и <B>latched group</B> "держатся"
только пока соответствующая клавиша нажата.

  <H3><A NAME="mods">Изменение виртуальных модификаторов.</A></H3>



<P>
  Также, как и для номеров групп, для изменения виртуальных модификаторов
в "состоянии XKB" предназначены три разных "действия"
<UL>
<LI><B>SetMods</B> - меняет переменную <B>base modifiers</B>
<LI><B>LatchMods</B> - меняет переменную <B>latched modifiers</B>
<LI><B>LockMods</B> - меняет переменную <B>locked modifiers</B>
</UL>


<P>
  Аргументы - список модификаторов и набор флагов.


<P>
  Значение флагов
<UL>
<LI><B>useModMapMods</B> - означает, что аргумент "список модификаторов" игнорируется,
а сами модификаторы берутся из переменных "привязанных" к клавише (скан-коду).
Напомню, что с каждой клавишей могут быть связаны набор реальных модификаторов
(<B>modmap</B>) и набор виртуальных модификаторов (<B>vmodmap</B>), именно эти два набора
и используются в качестве аргумента.
<LI><B>clearLocks</B> - имеет смысл только для <B>SetMods</B> и <B>LatchMods</B>, означает, что попутно
надо очистить <B>locked modifiers</B> (имеется ввиду - "сбросить" указанные
модификаторы).
<LI><B>latchToLock</B> - имеет смысл только для <B>LatchMods</B>, означает, что при отжатии
кнопки значение из <B>latched modifiers</B> переписывается в <B>locked modifiers</B>.
<LI><B>LockNoLock</B> - имеет смысл только для <B>LockMods</B>, означает, что указанные
модификаторы не записываются по нажатию в <B>locked modifiers</B> (какой в этом
смысл - см.ниже)
<LI><B>LockNoUnlock</B> - также имеет смысл только для <B>LockMods</B> и означает, что
при отжатии кнопки модификаторы не "сбрасываются".
</UL>


<P>
  Рассмотрим немного подробнее поведение этих "действий" при нажатии
и при отжатии кнопок.
<UL>
<LI>  <B>SetMods</B>
<UL>
   <LI>при нажатии: заносит модификаторы в base <B>modifiers</B>
   <LI>при отжатии: "сбрасывает" модификаторы в <B>base modifiers</B>;
если стоит флаг <B>clearLocks</B>, то эти модификаторы "сбрасываются" также
и в <B>locked modifiers</B>.
</UL>
<LI>  <B>LatchMods</B>
<UL>
   <LI>при нажатии: заносит модификаторы в <B>latched modifiers</B>
   <LI>при отжатии: "сбрасывает" модификаторы в <B>latched modifiers</B>;
если стоит флаг <B>clearLocks</B>, то эти модификаторы "сбрасываются" также
и в <B>locked modifiers</B>, если стоит флаг <B>latchToLock</B>, то эти модификаторы
переносятся в <B>locked modifiers</B> (получается аналог <B>LockMods</B>)
</UL>
<LI>  <B>LockMods</B>
<UL>
   <LI>при нажатии: заносит модификаторы в <B>base modifiers</B>, если при этом
в <B>locked modifiers</B> указанный модификатор не активен, то он "взводится"
в <B>locked modifiers</B>, в противном случае - наоборот, "сбрасывается".
если стоит флаг <B>LockNoLock</B>, модификаторы устанавливаются только в <B>base</B>
(получается аналог <B>SetMods</B>).
   <LI>при отжатии: "сбрасывает" модификаторы в <B>base modifiers</B>, но оставляет
его в <B>locked modifiers</B> (если, конечно, он там "взвелся", а не "сбросился")
  То есть, при первом нажатии/отжатии модификаторы запоминаются в (и после
отжатия клавиши), а при повторном - сбрасываются (по нажатию).
</UL>
</UL>

  <H3><A NAME="controls">Изменение управляющих флагов.</A></H3>



<P>
  Поскольку набор управляющих флагов в XKB только один (а не три, как для
модификаторов и номера группы), для изменения это набора существует
только два действия
<UL>
<LI> <B>SetControls</B> - действует как <B>Set(Group|Mods)</B>, то есть - при нажатии кнопки
устанавливает флаги, при отжатии - сбрасывает
<LI> <B>LockControls</B> -  действует как <B>Lock(Group|Mods)</B>, то есть - не сбрасывает
установленные флаги при отжатии кнопки.
</UL>


<P>
  Аргумент только один - список "управляющих флагов".
<BR>Строго говоря, флаги у <B>LockControls</B> тоже есть, но при описании этой
функции в файлах настройки они игнорируются (их можно установить, только
если действие модифицируется прикладной программой с помощью специальных
запросов к XKB).

  <H3><A NAME="actions">Как описываются "действия" в файлах настройки.</A></H3>

<P>
  Описание "действия" имеет такой же вид, как вызов функции в языке С.
то есть
<PRE>
 название функции '(' список аргументов через запятую ')'
</PRE>

<P>
  Небольшое отличие только внутри списка аргументов. Флаги, обычно,
просто указываются по имени. А вот другие аргументы (номер группы, список
модификаторов и т.п.) указываются как
<PRE>
 название аргумента '=' аргумент
</PRE>

<P>
  Для описанных выше "действий" аргументы называются
<UL>
 <LI> для xxx<B>Group - group</B>
 <LI> для xxx<B>Mods - modifiers</B>
 <LI> для xxx<B>Controls - controls</B>
</UL>


<P>
  Например

<PRE>
LockGroup(group=2)
</PRE>

заметьте, подразумевается флаг <B>groupAbsolute</B>

<PRE>
SetGroup(group=+1,clearLock)
</PRE>

здесь указывается относительная "добавка" и флаг <B>clearLock</B>

<PRE>
SetMods(modifiers=NumLock, clearLock)
</PRE>

здесь явно задан модификатор, и флаг <B>clearLock</B>

<PRE>
LockMods(modifiers=useModMapMods)
</PRE>

обратите внимание - флаг <B>useModMapMods</B> указывается вместо списка
модификаторов, а не как отдельный флаг.
<BR>  Кстати, флаги <B>lockNoLock</B> и <B>lockNoUnlock</B> в описаниях игнорируются
(их можно выставить только с помощью отдельных программ).

<PRE>
LockControls(controls=Overlay1)
</PRE>

устанавливается флаг <B>Overlay1</B> (включения "режима перекрытия" для
"перекрытия" номер 1).

  <H3><A NAME="defaults">Объявление "умолчания".</A></H3>



<P>
  В тех файлах, где могут появиться описания "действий" - <B>xkb_compat</B>
и <B>xkb_symbols</B>, могут также использоваться объявления "умолчания".

<P>
  Они выглядят как оператор присваивания полю структуры в языке C.
То есть, в левой части присваивания стиот конструкция состоящая из двух
слов, разделенных точкой.

<P>
  Эти объявления могут использоваться для задания значений флагов
"по умолчанию" для "действий" встречающихся в файле. В этом случае
первое слово - название "действия", а второе - название флага.
Естественно, справа от знака присваивания может быть только логическое
значение - <B>True/False</B>.


<P>
  Например

<PRE>
setMods.clearLock = True;
</PRE>
означает - во всех дальнейших описаниях <B>SetMods</B>, добавляется флаг <B>clearlock</B>.

<PRE>
latchMods.clearLock = True;
latchMods.latchToLock = True;
</PRE>

во всех дальнейших описаниях <B>LatchMods</B>, добавляются флаги <B>clearLock</B> и
<B>latchToLock</B>.


<hr>
<p>Иван Паскаль <a href=mailto:pascal@tsu.ru> pascal@tsu.ru </a>
</BODY>
</HTML>
